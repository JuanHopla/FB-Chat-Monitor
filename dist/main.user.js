// ==UserScript==
// @license      MIT
!function(){var e={};Object.assign(e,{version:"1.0.0",operationMode:"manual",get modo(){return this.operationMode},set modo(e){"auto"!==e&&"manual"!==e||(this.operationMode=e,void 0!==t&&t.debug(`Mode updated via 'modo' property: ${e}`))},apiKey:null,AI:{apiKey:null,model:"gpt-4.1-mini",maxTokens:2048,temperature:.7,useAssistantAPI:!0,provider:"openai",assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},syncWithLegacyConfig:function(){e.apiKey&&!this.apiKey?this.apiKey=e.apiKey:this.apiKey&&!e.apiKey&&(e.apiKey=this.apiKey),e.model&&e.model!==this.model&&(this.model=e.model),e.assistants&&(e.assistants.seller&&(this.assistants.seller={...this.assistants.seller,...e.assistants.seller}),e.assistants.buyer&&(this.assistants.buyer={...this.assistants.buyer,...e.assistants.buyer}))}},model:"gpt-4.1-mini",autoResponseDelay:5e3,simulateHumanTyping:!0,audioTranscription:{enabled:!1,apiKey:null,model:"whisper-1",maxDuration:120},assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},autoSendMessages:!0,sendMessageDelay:2e3,selectors:{chatList:{container:'div[class*="x78zum5"][class*="xdt5ytf"], div[role="main"]',chatItem:'a[href*="/marketplace/t/"][role="link"]',unreadIndicator:'span[class*="x6s0dn4"][data-visualcompletion="ignore"]',chatUserName:{selector:["span.x1lliihq.x193iq5w.x6ikm8r.x10wlt62.xlyipyv.xuxw1ft:not(.x1j85h84)",'span[dir="auto"][class*="x1lliihq"]:not([class*="x1j85h84"])'],filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}))},timestamp:'span[aria-hidden="true"]',messagePreview:{selector:'span[dir="auto"]:not([class*="x1lliihq"])',filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"",n=/^\s*\d+[smhdwy]\s*$/i.test(t),o=t.includes("Marketplace ·"),a=t.includes(":")||t.length>8;return!n&&!o&&a}))}},activeChat:{container:'div.x1ey2m1c.xds687c.xixxii4.x1vjfegm, div[role="main"] > div > div > div:last-child',messageWrapper:'div.x4k7w5x > div > div > div, div[role="main"] > div > div > div:last-child > div',messageRow:'div[role="row"]',senderAvatar:'img.x1rg5ohu[alt]:not([alt="Open photo"])',messageContent:['span.x1lliihq.x1plvlek > div[dir="auto"]','div[role="presentation"] span.x1lliihq > div[dir="auto"]','div[dir="auto"].html-div[class*="xexx8yu"]'],messageTimestamp:["span[data-tooltip-content][aria-label]",'span[title][aria-label*=":"]',"span.x1lliihq.x1plvlek.xryxfnj[aria-label]",'span[aria-label*="sent at"]','span[aria-label*="enviado a las"]'],messageImageElement:['a[href*="/messenger_media/"] img.x1rg5ohu','img[alt]:not([width="16"]):not([height="16"])','img[data-visualcompletion="media-vc-image"]',"div.x1ey2m1c img",'div[role="img"]',"div.x6ikm8r.x10wlt62 > img"],messageAudioElement:'div[aria-label="Play"][role="button"] ~ audio[src], div[aria-label*="audio message"] audio[src], audio[src]',messageAudioPlayButton:['div.x6s0dn4 div[aria-label="Play"][role="button"]','div[role="button"][aria-label="Play"]','div[aria-label="Play"][role="button"]','div[role="button"][aria-label*="audio"]','div[aria-label*="reproducir"][role="button"]','div[aria-label*="Audio message"]','div.xzg4506 > div.x1qjc9v5 > div[role="button"]','div[aria-label*="Play" i][role="button"]'],messageAudioUrlSource:null,messageAudioUrlAttribute:null,messageVideoElement:["video",'div[aria-label="Expand video"] video','div[aria-label="Play video"][role="button"]','div[data-testid="media-container"] video','div[data-visualcompletion="media-vc-image"][style*="background-image"]','div[role="button"][aria-label*="video"]','a[href*="video_redirect"]','div.x78zum5.xdt5ytf.x16ldp7u > div[role="button"]'],messageFileElement:['a[href*="attachment.php"]','a[href*="cdn.fbsbx.com"][download]','div[data-testid="attachment"]','div[role="button"][aria-label*="file"]','div[aria-label*="archivo adjunto"]'],messageLocationElement:['div[data-testid="map_container"]','a[href*="l.facebook.com/l.php"][href*="maps"]','a[href*="google.com/maps"]','div[aria-label*="location"]','div[aria-label*="ubicación"]'],messageGifElement:['div[data-testid="sticker"] img','img[src*="tenor.com"]','img[src*="giphy.com"]','div[aria-label*="GIF"]'],sellerIndicators:['div[aria-label="Mark as pending"]','span:contains("Mark as pending")','div[aria-label="Create plan"]','div[aria-label="Mark as available"]','div[aria-label="Mark as sold"]'],buyerIndicators:['a[aria-label="See details"]','span:contains("See details")'],productLink:'a[href*="/marketplace/item/"]',productInfo:'div[class*="x1sliqq"], div[role="main"] > div > div > div:first-child',messageInput:'div[contenteditable="true"][role="textbox"], div[aria-label="Message"], p.xat24cr.xdj266r',sendButton:['div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][aria-label*="send"]','div[role="button"][aria-label*="enviar"]','div.x1i10hfl[role="button"].xjbqb8w','div.x78zum5[role="button"].xjbqb8w','div.x1i10hfl[role="button"]:not([aria-hidden="true"])','div[role="button"][tabindex="0"]:not([style*="visibility: hidden"])'],scrollbar:[".x1uipg7g > div:nth-child(1) > div:nth-child(1)",'div[style*="overflow-y: auto"][style*="height"]','div[style*="overflow: auto"][style*="height"]','div.x4k7w5x > div[style*="height"]','div[role="main"] div.x1n2onr6[style*="height"]'],chatBeginningIndicators:['div[role="img"][aria-label]',"h4.xdj266r.x11i5rnm.xat24cr.x1mh8g0r","ul.x6s0dn4.x78zum5.xl56j7k.xsag5q8.x1y1aw1k","div.x1eb86dx.xsag5q8.x1ye3gou.xn6708d.x1cnzs8"]}},init(){if(this.loadFromStorage(),this.initializeExtras(),this.AI&&"function"==typeof this.AI.syncWithLegacyConfig&&this.AI.syncWithLegacyConfig(),void 0!==t){t.debug(`Configuration initialized. Mode: ${this.operationMode}, modo property: ${this.modo}`);const e="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):null,n="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):null,o=localStorage.getItem("FB_CHAT_MODE"),a=localStorage.getItem("FB_CHAT_OPERATION_MODE");t.debug(`Storage status - GM: modo=${e}, opMode=${n} | LS: modo=${o}, opMode=${a}`)}return!0},initializeExtras(){return document.addEventListener("configUpdated",(e=>{const n=e?.detail||{};n.operationMode&&(this.operationMode=n.operationMode,t.debug(`Mode updated by event: ${this.operationMode}, source: ${n.source||"unknown"}`))})),!0},loadFromStorage(){try{const e=this.getStorage(),n=e.FB_CHAT_OPERATION_MODE,o=e.FB_CHAT_MODE;void 0!==t&&t.debug(`Mode values found - FB_CHAT_OPERATION_MODE: ${n}, FB_CHAT_MODE: ${o}`);let a=null;if("auto"===n||"manual"===n?(a=n,void 0!==t&&t.debug(`Mode loaded from FB_CHAT_OPERATION_MODE: ${a}`)):"auto"===o||"manual"===o?(a=o,void 0!==t&&t.debug(`Mode loaded from FB_CHAT_MODE (legacy): ${a}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",o),void 0!==t&&t.debug(`Mode migrated from FB_CHAT_MODE to FB_CHAT_OPERATION_MODE: ${o}`)):(a="manual",void 0!==t&&t.debug(`No saved value found for mode. Assigning default value: ${a}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",a),this.saveToStorage("FB_CHAT_MODE",a)),a&&(this.operationMode=a),e.FB_CHAT_API_KEY&&(this.apiKey=e.FB_CHAT_API_KEY,this.AI&&(this.AI.apiKey=e.FB_CHAT_API_KEY)),e.FB_CHAT_MODEL&&(this.model=e.FB_CHAT_MODEL,this.AI&&(this.AI.model=e.FB_CHAT_MODEL)),e.FB_CHAT_ASSISTANTS)try{const t="string"==typeof e.FB_CHAT_ASSISTANTS?JSON.parse(e.FB_CHAT_ASSISTANTS):e.FB_CHAT_ASSISTANTS;t&&"object"==typeof t&&(t.seller&&(this.assistants.seller={...this.assistants.seller,...t.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...t.seller})),t.buyer&&(this.assistants.buyer={...this.assistants.buyer,...t.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...t.buyer})))}catch(e){void 0!==t&&t.error(`Error parsing assistants: ${e.message}`)}return void 0!==t&&(t.log("Configuration loaded from storage"),t.debug(`Final state after loading: operationMode=${this.operationMode}, modo=${this.modo}`)),this}catch(e){return void 0!==t&&t.error(`Error loading configuration: ${e.message}`),this}},updateOperationMode(e){return"auto"!==e&&"manual"!==e?(t.error(`Invalid operation mode: ${e}. Must be 'auto' or 'manual'`),!1):(this.operationMode=e,"function"==typeof GM_setValue?(GM_setValue("FB_CHAT_OPERATION_MODE",e),GM_setValue("FB_CHAT_MODE",e)):(localStorage.setItem("FB_CHAT_OPERATION_MODE",e),localStorage.setItem("FB_CHAT_MODE",e)),t.log(`Operation mode updated to: ${e.toUpperCase()}`),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:e,modo:e,source:"updateOperationMode"}})),window.ui&&"function"==typeof window.ui.updateModeUI&&window.ui.updateModeUI(e),window.responseManager&&(window.responseManager.isAutomodeEnabled="auto"===e,t.debug(`ResponseManager updated: automode=${window.responseManager.isAutomodeEnabled}`)),t.debug(`Mode updated: operationMode=${this.operationMode}, modo=${this.modo}`),!0)},saveApiKey(e){return e&&"string"==typeof e?(this.apiKey=e,this.AI&&(this.AI.apiKey=e),this.saveToStorage("FB_CHAT_API_KEY",e),t.log("API Key saved"),!0):(t.error("Invalid API Key"),!1)},saveModel(e){return e&&"string"==typeof e?(this.model=e,this.AI&&(this.AI.model=e),this.saveToStorage("FB_CHAT_MODEL",e),t.log(`Model changed to: ${e}`),!0):(t.error("Invalid model"),!1)},saveAssistants(e){return e&&"object"==typeof e?(e.seller&&(this.assistants.seller={...this.assistants.seller,...e.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...e.seller})),e.buyer&&(this.assistants.buyer={...this.assistants.buyer,...e.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...e.buyer})),this.saveToStorage("FB_CHAT_ASSISTANTS",JSON.stringify(this.assistants)),t.log("Assistants configuration updated"),!0):(t.error("Invalid assistants configuration"),!1)},getStorage(){const e={};if("function"==typeof GM_getValue&&"function"==typeof GM_setValue){let n=[];"function"==typeof GM_listValues&&(n=GM_listValues()),n.length||(n=["FB_CHAT_MODE","FB_CHAT_OPERATION_MODE","FB_CHAT_API_KEY","FB_CHAT_MODEL","FB_CHAT_ASSISTANTS"]),n.forEach((n=>{try{e[n]=GM_getValue(n)}catch(e){t.debug(`Error reading key ${n} from GM_getValue: ${e.message}`)}}))}else for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o&&o.startsWith("FB_CHAT_"))try{let t=localStorage.getItem(o);try{t=JSON.parse(t)}catch(e){}e[o]=t}catch(e){t.debug(`Error reading key ${o} from localStorage: ${e.message}`)}}return e},saveToStorage(e,n){try{if("function"==typeof GM_setValue)return GM_setValue(e,n),!0;const t="object"==typeof n?JSON.stringify(n):n;return localStorage.setItem(e,t),!0}catch(n){return t.error(`Error saving to storage [${e}]: ${n.message}`),!1}},checkStatus(){const e=!!this.apiKey||this.AI&&!!this.AI.apiKey,t=!!this.model||this.AI&&!!this.AI.model,n="auto"===this.operationMode||"manual"===this.operationMode,o=this.assistants.seller&&this.assistants.seller.id||this.assistants.buyer&&this.assistants.buyer.id||this.AI&&this.AI.assistants&&(this.AI.assistants.seller&&this.AI.assistants.seller.id||this.AI.assistants.buyer&&this.AI.assistants.buyer.id);return{isReady:e&&t&&n,isApiKeySet:e,isModelSet:t,isOperationModeValid:n,operationMode:this.operationMode,hasAssistants:o}}}),window.CONFIG=e,window.diagnoseModeConfig=function(){const t="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):"N/A",n="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):"N/A",o=localStorage.getItem("FB_CHAT_MODE"),a=localStorage.getItem("FB_CHAT_OPERATION_MODE"),i={currentConfig:{operationMode:e.operationMode,modo:e.modo,areSynced:e.operationMode===e.modo},storage:{GM:{FB_CHAT_MODE:t,FB_CHAT_OPERATION_MODE:n},localStorage:{FB_CHAT_MODE:o,FB_CHAT_OPERATION_MODE:a}},responseManager:window.responseManager?{isAutomodeEnabled:window.responseManager.isAutomodeEnabled}:"Not available"};return console.log("[Mode Diagnosis]",i),i};const t={logs:[],maxLogs:100,log(e,t={}){const n={type:"INFO",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.log(`[FB-Chat-Monitor] ${e}`,t)},debug(t,n={}){if(e.debug){const e={type:"DEBUG",timestamp:(new Date).toISOString(),message:t,data:n};this._addLog(e),console.log(`[FB-Chat-Monitor][DEBUG] ${t}`,n)}},error(e,t={},n=null){const o={type:"ERROR",timestamp:(new Date).toISOString(),message:e,data:t,stack:n?.stack||(new Error).stack};this._addLog(o),console.error(`[FB-Chat-Monitor][ERROR] ${e}`,t,n)},warn(e,t={}){const n={type:"WARN",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.warn(`[FB-Chat-Monitor][WARN] ${e}`,t)},notify(e,t="success",n={}){const o={type:"NOTIFICATION",notificationType:t,timestamp:(new Date).toISOString(),message:e};this._addLog(o);const a=document.createElement("div");a.style.position="fixed",a.style.bottom="20px",a.style.right="20px",a.style.padding="10px 15px",a.style.color="white",a.style.borderRadius="5px",a.style.zIndex="9999",a.style.opacity="0.9",a.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="14px",a.style.display="flex",a.style.alignItems="center",a.style.transition="all 0.3s ease",a.style.maxWidth="80%",a.style.wordBreak="break-word","success"===t?(a.style.backgroundColor="#4CAF50",a.innerHTML=`<span style="margin-right:8px;">✓</span>${e}`):"error"===t?(a.style.backgroundColor="#f44336",a.innerHTML=`<span style="margin-right:8px;">⚠️</span>${e}`):"warning"===t?(a.style.backgroundColor="#ff9800",a.innerHTML=`<span style="margin-right:8px;">⚠</span>${e}`):"info"===t&&(a.style.backgroundColor="#2196F3",a.innerHTML=`<span style="margin-right:8px;">ℹ</span>${e}`);const i=document.createElement("span");if(i.innerHTML="×",i.style.marginLeft="10px",i.style.cursor="pointer",i.style.fontWeight="bold",i.style.fontSize="18px",i.onclick=()=>document.body.removeChild(a),a.appendChild(i),document.body.appendChild(a),n.buttons&&Array.isArray(n.buttons)){const e=document.createElement("div");e.style.marginTop="10px",e.style.display="flex",e.style.gap="10px",n.buttons.forEach((t=>{if(t.text&&"function"==typeof t.action){const n=document.createElement("button");n.textContent=t.text,n.style.padding="5px 10px",n.style.border="none",n.style.borderRadius="3px",n.style.cursor="pointer",n.style.backgroundColor=t.color||"#fff",n.style.color=t.textColor||"#333",n.onclick=()=>{t.action(),!1!==t.closeOnClick&&document.body.removeChild(a)},e.appendChild(n)}})),a.appendChild(e)}if(n.timeoutSeconds){const e=document.createElement("span");e.className="countdown",e.textContent=n.timeoutSeconds,e.style.marginLeft="8px",e.style.padding="2px 6px",e.style.backgroundColor="rgba(255,255,255,0.2)",e.style.borderRadius="10px",a.appendChild(e)}const r=n.duration||5e3;return setTimeout((()=>{document.body.contains(a)&&(a.style.opacity="0",setTimeout((()=>{document.body.contains(a)&&document.body.removeChild(a)}),300))}),r),a},_addLog(t){this.logs.unshift(t),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),e.logging&&e.logging.saveLogs&&this._saveLogs()},_saveLogs(){try{localStorage.setItem("FB_CHAT_MONITOR_LOGS",JSON.stringify(this.logs))}catch(e){console.error("Error saving logs to localStorage",e)}},loadLogs(){try{const e=localStorage.getItem("FB_CHAT_MONITOR_LOGS");e&&(this.logs=JSON.parse(e))}catch(e){console.error("Error loading logs from localStorage",e)}},getAllLogs(){return[...this.logs]},getLogsByType(e){return this.logs.filter((t=>t.type===e))},clearLogs(){this.logs=[];try{localStorage.removeItem("FB_CHAT_MONITOR_LOGS")}catch(e){console.error("Error clearing logs from localStorage",e)}},notify:function(e,t="info",n=2e3){console.log(`[${t.toUpperCase()}] ${e}`);const o=document.createElement("div");o.className="fb-chat-monitor-notification";const a=this.getOptimalAlertPosition();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)},getOptimalAlertPosition:function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n=document.getElementById("fbChatMonitorQuickResponse");if(e&&window.uiState?.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}if(n&&"none"!==window.getComputedStyle(n).display){const e=n.getBoundingClientRect();return{top:e.top-10-40+"px",right:window.innerWidth-e.right+"px",left:"auto"}}return{top:"60px",right:"20px",left:"auto"}}},n={findElement(e,n=document){if(Array.isArray(e)){for(const o of e)try{const e=n.querySelector(o);if(e)return e}catch(e){t.debug(`Error with selector "${o}": ${e.message}`)}return null}try{return n.querySelector(e)}catch(n){return t.debug(`Error with selector "${e}": ${n.message}`),null}},findAllElements(e,n=document){try{return[...n.querySelectorAll(e)]}catch(n){return t.debug(`Error with selector "${e}": ${n.message}`),[]}},waitForElement:(t,n=e.waitElementTimeout)=>new Promise(((e,o)=>{let a=0;const i=Array.isArray(t)?t:[t],r=()=>{for(const t of i)try{const n=document.querySelector(t);if(n)return void e(n)}catch(e){}a+=100,a>=n?o(new Error(`Timeout waiting for elements: ${JSON.stringify(i)}`)):setTimeout(r,100)};r()})),scrollToTop:(e,t=10)=>new Promise((n=>{let o=e.scrollHeight,a=0,i=0;const r=()=>{e.scrollTop=0,setTimeout((()=>{if(i++,e.scrollHeight===o){if(a++,a>=3||i>=t)return void n({success:!0,fullyScrolled:!0})}else a=0,o=e.scrollHeight;r()}),300)};r()})),scrollToBottom:e=>new Promise((t=>{e?(e.scrollTop=e.scrollHeight,setTimeout((()=>t(!0)),100)):t(!1)})),injectStyles(e){const t=document.createElement("style");return t.textContent=e,document.head.appendChild(t),t},insertTextIntoField(e,n){if(!e)return!1;try{e.focus();const o=[()=>(document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,n)),()=>"true"===e.contentEditable&&(e.innerText=n,e.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>"value"in e&&(e.value=n,e.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>{for(;e.firstChild;)e.removeChild(e.firstChild);return e.appendChild(document.createTextNode(n)),e.dispatchEvent(new Event("input",{bubbles:!0})),!0}];for(const e of o)try{if(e())return t.debug("Text inserted successfully"),!0}catch(e){}return e.innerText=n,e.value=n,e.textContent=n,["input","change","keyup"].forEach((t=>{try{e.dispatchEvent(new Event(t,{bubbles:!0}))}catch(e){}})),!0}catch(e){return t.error(`Error inserting text into field: ${e.message}`),!1}},insertTextIntoField(e,n){if(!e||!n)return!1;try{if("true"===e.getAttribute("contenteditable")){e.innerHTML="",e.focus();if(!document.execCommand("insertText",!1,n)){e.textContent=n;const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}return!0}return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?(e.value=n,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),!0):(e.innerText=n,!0)}catch(e){return t.error(`Error insertando texto en campo: ${e.message}`),!1}},insertTextIntoField(e,n){if(!e||!n)return!1;try{if(("true"===e.getAttribute("contenteditable")?!e.textContent||""===e.textContent.trim():!e.value||""===e.value.trim())||("true"===e.getAttribute("contenteditable")?(e.innerHTML="",e.textContent=""):"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(e.value=""),t.debug("Campo limpiado adicionalmente antes de insertar texto")),"true"===e.getAttribute("contenteditable")){e.innerHTML="",e.focus();if(!document.execCommand("insertText",!1,n)){e.textContent=n;const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}return!0}return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?(e.value=n,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),!0):(e.innerText=n,!0)}catch(e){return t.error(`Error insertando texto en campo: ${e.message}`),!1}},insertTextIntoField(e,n){if(!e||!n)return!1;try{const o="true"===e.getAttribute("contenteditable"),a=o?(e.textContent||"").trim():(e.value||"").trim();if(a){if(t.warn(`Campo aún contiene texto antes de insertar: "${a.substring(0,30)}..."`),o){e.innerHTML="",e.textContent="";try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t.deleteFromDocument()}catch(e){t.debug(`Error usando selection API: ${e.message}`)}}else e.value="";["input","change"].forEach((t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))}))}if(o){e.focus();document.execCommand("insertText",!1,n)||(e.textContent=n,e.dispatchEvent(new Event("input",{bubbles:!0})))}else"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(e.value=n,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})));return setTimeout((()=>{const a=o?e.textContent:e.value;a!==n?t.warn(`Posible problema al insertar texto. Esperado: "${n.substring(0,30)}...", Actual: "${a.substring(0,30)}..."`):t.debug("Texto insertado correctamente verificado")}),50),!0}catch(e){return t.error(`Error insertando texto en campo: ${e.message}`),!1}},simulateKeyPress(e,n="Enter",o=13){if(!e)return!1;try{e.focus();const t=[new KeyboardEvent("keydown",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0}),new KeyboardEvent("keypress",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0}),new KeyboardEvent("keyup",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0})];let a=!0;return t.forEach((t=>{e.dispatchEvent(t)||(a=!1)})),a}catch(e){return t.error(`Error simulando tecla ${n}: ${e.message}`),!1}},simulateKeyPress(e,n,o){if(!e)return!1;try{return e.focus(),setTimeout((()=>{try{let a=!0;return["keydown","keypress","keyup"].forEach((i=>{const r=new KeyboardEvent(i,{key:n,code:1===n.length?`Key${n.toUpperCase()}`:n,keyCode:o,which:o,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(r)||(t.warn(`Evento ${i} no fue despachado correctamente`),a=!1),"keyup"!==i&&setTimeout((()=>{}),0)})),t.debug(`Simulación de tecla ${n} ${a?"exitosa":"con problemas"}`),a}catch(e){return t.error(`Error en simulación de tecla: ${e.message}`),!1}}),50),!0}catch(e){return t.error(`Error preparando simulación de tecla: ${e.message}`),!1}}},o={set:function(e,n){try{if("function"==typeof GM_setValue&&GM_setValue(e,n),"undefined"!=typeof localStorage){const t="object"==typeof n?JSON.stringify(n):n;localStorage.setItem(e,t)}return!0}catch(n){return t.error(`Error storing data: ${n.message}`,{key:e}),!1}},get:function(e,n=null){try{if("function"==typeof GM_getValue){const t=GM_getValue(e,void 0);if(void 0!==t)return t}if("undefined"!=typeof localStorage){const t=localStorage.getItem(e);if(null!==t)try{return JSON.parse(t)}catch(e){return t}}return n}catch(o){return t.error(`Error retrieving data: ${o.message}`,{key:e}),n}},remove:function(e){try{return"function"==typeof GM_deleteValue&&GM_deleteValue(e),"undefined"!=typeof localStorage&&localStorage.removeItem(e),!0}catch(n){return t.error(`Error removing data: ${n.message}`,{key:e}),!1}},migrateSettings:function(){t.debug("Running settings migration check...");let e=0;return"function"==typeof GM_setValue&&"undefined"!=typeof localStorage&&["FB_CHAT_MONITOR_OPENAI_KEY","FB_CHAT_MONITOR_AI_MODEL","FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","FB_CHAT_MONITOR_OPERATION_MODE","FB_CHAT_MONITOR_SELLER_ASSISTANT_NAME","FB_CHAT_MONITOR_BUYER_ASSISTANT_NAME","FB_CHAT_MONITOR_SELLER_INSTRUCTIONS","FB_CHAT_MONITOR_BUYER_INSTRUCTIONS","FB_CHAT_MONITOR_AI_TEMP"].forEach((n=>{const o=localStorage.getItem(n);if(null!==o&&void 0===GM_getValue(n,void 0)){let a=o;try{a=JSON.parse(o)}catch(e){}GM_setValue(n,a),e++,t.debug(`Migrated ${n} from localStorage to GM_storage`)}})),e>0?t.log(`Settings migration complete: ${e} items migrated`):t.debug("No settings needed migration"),e},checkStorageHealth:function(){const e="function"==typeof GM_setValue&&"function"==typeof GM_getValue,n="undefined"!=typeof localStorage;if(t.debug(`Storage availability: GM_storage=${e}, localStorage=${n}`),!e&&!n)return t.error("No storage mechanisms available. Data persistence will not work."),!1;try{const e="STORAGE_TEST_"+Date.now(),n="test_"+Date.now();this.set(e,n);return this.get(e,null)!==n?(t.error("Storage verification failed: write/read mismatch"),!1):(this.remove(e),t.debug("Storage health check passed successfully"),!0)}catch(e){return t.error("Storage health check failed",e),!1}}},a={isActive:!1,lastActivity:Date.now(),listeners:[],initialize(){document.addEventListener("mousemove",(()=>this.recordActivity())),document.addEventListener("keydown",(()=>this.recordActivity())),document.addEventListener("click",(()=>this.recordActivity())),setInterval((()=>this.checkInactivity()),6e4),t.debug("User activity tracker initialized")},recordActivity(){const e=!this.isActive;this.isActive=!0,this.lastActivity=Date.now(),e&&this.notifyListeners()},checkInactivity(){Date.now()-this.lastActivity>3e5&&this.isActive&&(this.isActive=!1,this.notifyListeners())},onActivityChange(e){"function"==typeof e&&this.listeners.push(e)},notifyListeners(){for(const e of this.listeners)try{e(this.isActive,this.lastActivity)}catch(e){t.error("Error in activity listener",{},e)}}},i={async withExponentialBackoff(e,n={}){const{maxRetries:o=3,baseDelay:a=1e3,maxDelay:i=3e4,factor:r=2,jitter:s=.1}=n;let l=0,c=null;for(;l<=o;)try{return await e()}catch(e){if(c=e,l++,l>o)throw t.error(`Operation failed after ${o} retries`,{},e),e;const n=Math.min(a*Math.pow(r,l-1),i),d=n*s,u=n+(Math.random()*d*2-d);t.debug(`Retry attempt ${l} after ${Math.round(u)}ms`),await new Promise((e=>setTimeout(e,u)))}throw c}},r={formatDate:e=>new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e),getRelativeTime(e){const t=new Intl.RelativeTimeFormat("en",{numeric:"auto"}),n=e-Date.now(),o=Math.floor(n/1e3),a=Math.floor(o/60),i=Math.floor(a/60),r=Math.floor(i/24);return Math.abs(r)>0?t.format(r,"day"):Math.abs(i)>0?t.format(i,"hour"):Math.abs(a)>0?t.format(a,"minute"):t.format(o,"second")},sleep:e=>new Promise((t=>setTimeout(t,e)))},s={isMarketplaceMessenger(){const e=window.location.href;return e.includes("facebook.com/messages")||e.includes("messenger.com")},redirectToMarketplace:()=>!(!window.location.href.includes("messenger.com")||window.location.href.includes("marketplace"))&&(window.location.href="https://www.facebook.com/messages/t/marketplace",!0)};function l(e,n="info",o={}){return t.notify(e,n,o)}async function c(e){return r.sleep(e)}t.loadLogs(),a.initialize(),window.logger=t,window.domUtils=n,window.storageUtils=o,window.userActivityTracker=a,window.retryUtils=i,window.timeUtils=r,window.pageUtils=s,window.showSimpleAlert=l,window.delay=c,window.insertTextDirectly=function(e,t){return n.insertTextIntoField(e,t)},window.getFbDtsg=function(){const e=document.querySelector('input[name="fb_dtsg"], meta[name="fb_dtsg"]');if(e)return e.value||e.content||"";const t=document.body.innerHTML.match(/"DTSGInitData",\[\],\{"token":"([^"]+)"/);return t?t[1]:""},window.getFacebookUserID=function(){const e=document.cookie.match(/c_user=(\d+)/);return e?e[1]:""},window.__reqCounter||(window.__reqCounter=0),window.nextReq=function(){return(++window.__reqCounter).toString(36)},window.getRevision=function(){return document.querySelector('meta[name="revision"]')?.content||"1007773680"},window.jsonToFormUrlEncoded=function(e){return Object.entries(e).map((([e,t])=>encodeURIComponent(e)+"="+encodeURIComponent(t))).join("&")},window.diagnoseModeConfig=function(){const e={storage:{GM:"function"==typeof GM_getValue?{FB_CHAT_MODE:GM_getValue("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:GM_getValue("FB_CHAT_OPERATION_MODE")}:"GM storage no disponible",localStorage:{FB_CHAT_MODE:localStorage.getItem("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:localStorage.getItem("FB_CHAT_OPERATION_MODE")}},memory:{CONFIG_operationMode:window.CONFIG?.operationMode,CONFIG_modo:window.CONFIG?.modo,ui_modeState:window.ui?.currentMode||"No disponible"},responseManager:{isAutomodeEnabled:window.responseManager?.isAutomodeEnabled||"No disponible"}};return t.log("=== DIAGNÓSTICO DE MODO OPERACIÓN ==="),t.log(JSON.stringify(e,null,2)),t.log("====================================="),e};const d={isTyping:!1,intervalId:null,chatId:null};function u(t){const n=t.length*e.humanSimulation.baseTypingSpeed,o=Math.random()*e.humanSimulation.typingVariation*t.length;return Math.max(e.humanSimulation.minResponseDelay,n+o)}function g(){return Math.floor(Math.random()*(e.humanSimulation.maxResponseDelay-e.humanSimulation.minResponseDelay)+e.humanSimulation.minResponseDelay)}function m(e){return/[áéíóúñ¿¡]/i.test(e)||/\b(hola|gracias|buenos días|buenas tardes|disponible)\b/i.test(e)?"es":/[ãõçâêôáéíóú]/i.test(e)||/\b(obrigado|bom dia|boa tarde|disponível)\b/i.test(e)?"pt":/[àââçéèêëîïôœùûüÿ]/i.test(e)||/\b(bonjour|merci|bonne journée|disponible)\b/i.test(e)?"fr":"en"}function p(e){const t={en:"Hello! Thank you for your message. I'll get back to you as soon as possible.",es:"¡Hola! Gracias por tu mensaje. Te responderé lo antes posible.",pt:"Olá! Obrigado pela sua mensagem. Responderei o mais rápido possível.",fr:"Bonjour! Merci pour votre message. Je vous répondrai dès que possible."};return t[m("string"==typeof e?e:e?.text||"")]||t.en}async function h(n=null){try{const o=document.querySelector(e.selectors.activeChat.messageInput);return o?(o.focus(),d.isTyping=!0,d.chatId=n,d.intervalId=setInterval((()=>{if(o&&d.isTyping){const e=new KeyboardEvent("keypress",{bubbles:!0,cancelable:!0,key:" ",code:"Space"});o.dispatchEvent(e),o.innerText.endsWith(" ")?o.innerText=o.innerText.slice(0,-1):o.innerText+=" ",o.dispatchEvent(new Event("input",{bubbles:!0}))}}),2e3),t.debug("Typing indicator activated"),!0):(t.debug("Input field not found for typing indicator"),!1)}catch(e){return t.debug(`Error activating typing indicator: ${e.message}`),!1}}async function f(){try{d.intervalId&&(clearInterval(d.intervalId),d.intervalId=null),d.isTyping=!1;try{const t=document.querySelector(e.selectors.activeChat.messageInput);t&&t.innerText&&(t.innerText="",t.dispatchEvent(new Event("input",{bubbles:!0}))),t.blur()}catch(e){}return t.debug("Typing indicator deactivated"),!0}catch(e){return t.debug(`Error deactivating typing indicator: ${e.message}`),!1}}async function y(e){try{return e.focus(),["keydown","keypress","keyup"].forEach((t=>{e.dispatchEvent(new KeyboardEvent(t,{key:"Enter",code:"Enter",bubbles:!0}))})),!0}catch(e){return t.debug(`Error sending via Enter: ${e.message}`),!1}}async function b(a,i,r){try{t.debug("Processing auto mode response");const s=g();let l;await c(s),await h(i.chatId);try{l=await O.generateResponse(i),t.debug(`AI response generated: "${l.substring(0,30)}..."`)}catch(e){t.error(`Error generating AI response: ${e.message}`),l=p(a[a.length-1]?.content||"")}const d=u(l);t.debug(`Simulating typing for ${Math.round(d/1e3)} seconds`),await c(d),await f();const m=await n.waitForElement(e.selectors.activeChat.messageInput);if(!m)throw new Error("Message input field not found");n.insertTextIntoField(m,l),await y(m),t.log("Auto response sent successfully");const b=v();return b.unshift({timestamp:(new Date).toISOString(),mode:"auto",context:{chatId:i.chatId,role:i.role,productDetails:i.productDetails?{id:i.productDetails.id,title:i.productDetails.title}:null,lastMessage:a[a.length-1]?.content||null},response:l,sent:!0}),o.set("RESPONSE_LOGS",b),r&&r(l),l}catch(e){throw t.error(`Auto mode error: ${e.message}`),await f(),r&&r(null),e}}async function w(a,i,r){try{let s;t.debug("Processing manual mode response"),await h(i.chatId);try{s=await O.generateResponse(i),t.debug(`AI response generated in manual mode: "${s.substring(0,30)}..."`)}catch(e){t.error(`Error generating AI response: ${e.message}`),s=p(a[a.length-1]?.content||"")}await f();const c=await n.waitForElement(e.selectors.activeChat.messageInput);if(!c)throw new Error("Message input field not found");n.insertTextIntoField(c,s),l("Response generated and inserted in the chat input field. Review and press Enter to send.","info"),t.log("Manual response generated and inserted");const d=v();return d.unshift({timestamp:(new Date).toISOString(),mode:"manual",context:{chatId:i.chatId,role:i.role,productDetails:i.productDetails?{id:i.productDetails.id,title:i.productDetails.title}:null,lastMessage:a[a.length-1]?.content||null},response:s,sent:!1}),o.set("RESPONSE_LOGS",d),r&&r(s),s}catch(e){throw t.error(`Manual mode error: ${e.message}`),await f(),r&&r(null),e}}function v(){return window.storageUtils.get("RESPONSE_LOGS",[])}const A={typingState:d,calculateTypingTime:u,getRandomResponseDelay:g,detectLanguage:m,getDefaultResponse:p,startTypingIndicator:h,stopTypingIndicator:f,sendViaEnter:y,generateAndHandleResponse:async function(e,n,o,a){try{if(e.length>0&&e[e.length-1].sentByUs)return;switch(o){case"auto":await b(e,n,a);break;case"manual":await w(e,n,a);break;default:t.debug(`Unknown operation mode: ${o}`),"function"==typeof a&&a({success:!1,error:"Unknown operation mode"})}}catch(e){t.debug(`Error handling response: ${e.message}`),await f(),"function"==typeof a&&a({success:!1,error:e.message})}},handleAutoMode:b,handleManualMode:w,getConversationHistory:v,clearConversationHistory:function(){window.storageUtils.remove("RESPONSE_LOGS")},exportConversationHistory:function(){const e=v(),t={timestamp:(new Date).toISOString(),history:e},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}};window.responseManager=A;window.responseManager=new class{constructor(){this.isAutomodeEnabled=!1,this.lastChatId=null,this.lastResponseTime=0,this.cooldownPeriod=3e4,this.processingChat=!1,this.initialize()}initialize(){this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,t.debug(`ResponseManager initialized with automode: ${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`),document.addEventListener("configUpdated",(e=>{this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,t.debug(`ResponseManager detected mode change: Auto=${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`)}))}setAutoMode(e){this.isAutomodeEnabled=e,t.log("Automatic mode "+(e?"activated":"deactivated")),e&&this.verifyOpenAIAvailability()}verifyOpenAIAvailability(){if(!window.openaiManager)return t.error("OpenAI Manager is not available. Automatic mode will not work."),l("OpenAI Manager is not available. Automatic mode will not work.","error"),!1;const e="function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():!!window.openaiManager.apiKey;return e?(e&&!window.openaiManager.isInitialized&&(window.openaiManager.isInitialized=!0,t.debug("isInitialized=true has been corrected since the API key is present")),t.log("OpenAI Manager is ready for automatic responses."),!0):(t.error("OpenAI Manager does not have an API key configured. Automatic mode will not work correctly."),l("OpenAI does not have an API key configured. Configure it in the options.","error"),!1)}async processAutoResponse(o,a){if(this.processingChat||o===this.lastChatId)return t.debug(`Skipping chat ${o} - already processed or in process`),!1;try{if(this.processingChat=!0,t.debug(`Processing chat ${o} for automatic response`),!this.checkForUnrespondedMessages(a.messages))return t.debug(`No unresponded messages in chat ${o}`),!1;let i;if("function"==typeof this.handleAutoMode?(t.debug("Using handleAutoMode to generate automatic response"),i=await this.handleAutoMode(a.messages,a)):(t.debug("Generating response with OpenAI Manager directly"),i=await window.openaiManager.generateResponse(a)),!i||!i.text&&"string"!=typeof i)throw new Error("A valid response was not received");const r=i.text||i;if(window.chatManager&&"function"==typeof window.chatManager.insertResponseInInputField)window.chatManager.insertResponseInInputField(r);else{t.debug("chatManager.insertResponseInInputField not available, using alternative method");const o=document.querySelector(e.selectors.activeChat.messageInput);if(!o)throw new Error("Could not find the input field to insert the response");n.insertTextIntoField(o,r)}return await this.simulateTypingAndSend(),this.lastChatId=o,this.lastResponseTime=Date.now(),t.log(`Automatic response sent successfully to chat ${o}`),!0}catch(e){return t.error(`Error in processAutoResponse for chat ${o}: ${e.message}`,{chatId:o},e),!1}finally{this.processingChat=!1}}checkForUnrespondedMessages(e){if(!e||0===e.length)return!1;const t=e.slice(-10);let n=0;for(let e=t.length-1;e>=0;e--){if(t[e].sentByUs)break;n++}return n>0}async simulateTypingAndSend(){try{const e=document.querySelector('div[aria-label="Press Enter to send"] button, button[data-testid="send-button"]');if(!e)return void t.warn("Send button not found");const n=window.CONFIG?.humanSimulation?.autoSendDelay||2e3;t.debug(`Sending automatic message in ${n/1e3} seconds...`),await new Promise((e=>setTimeout(e,n))),e.click(),t.log("Automatic message sent")}catch(e){t.error(`Error sending automatic message: ${e.message}`,{},e)}}};const x=new class{constructor(){this.config=e.AI.humanSimulation,this.recentMessages=[],this.maxRecentMessages=10}async processMessageNaturally(n){try{await this.startTypingIndicator();const t=this.calculateTypingTime(n);if(await c(t),await this.stopTypingIndicator(),this.shouldSplitMessage(n))return await this.sendSplitMessage(n);{const t=document.querySelector(e.selectors.activeChat.messageInput);if(!t)throw new Error("Input field not found");return await this.insertTextNaturally(t,n),await this.sendViaEnter(t),this.recordMessageLength(n),!0}}catch(e){return t.error(`Error processing message: ${e.message}`),await this.stopTypingIndicator(),!1}}async insertTextNaturally(e,n){if(!e||!n)return!1;try{e.focus(),e.innerText="",e.textContent="",document.execCommand&&(document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null)),e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(200);let o=!1;if("true"===e.contentEditable&&(e.innerText=n,e.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,t.debug("Text inserted using contentEditable innerText method")),!o&&document.execCommand)try{document.execCommand("insertText",!1,n),o=!0,t.debug("Text inserted using execCommand method")}catch(e){t.debug(`execCommand failed: ${e.message}`)}if(!o&&"value"in e&&(e.value=n,e.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,t.debug("Text inserted using value property method")),!o){for(;e.firstChild;)e.removeChild(e.firstChild);const a=document.createTextNode(n);e.appendChild(a),e.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,t.debug("Text inserted using DOM manipulation method")}return e.innerText&&""!==e.innerText.trim()?t.debug(`Text verification: field contains "${e.innerText.substring(0,30)}..."`):(t.warn("Text insertion succeeded but field appears empty"),e.textContent=n,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))),!0}catch(e){return t.error(`Error in insertTextNaturally: ${e.message}`),!1}}createTypoVersion(e){if(e.length<10)return e;const t=Math.floor(Math.random()*(e.length-3)+1),n=Math.random();if(n<.33)return e.substring(0,t)+e[t]+e.substring(t);if(!(n<.66))return e.substring(0,t)+e.substring(t+1);{const n={a:"sqzw",b:"vghn",c:"xdfv",d:"serfcx",e:"wsrdf",f:"drtgv",g:"ftyhb",h:"gyujn",i:"ujko",j:"hyuikn",k:"jiol",l:"kop",m:"njk",n:"bhjm",o:"iklp",p:"ol",q:"wa",r:"edft",s:"awedxz",t:"rfgy",u:"yhji",v:"cfgb",w:"qase",x:"zsdc",y:"tghu",z:"asx"},o=e[t].toLowerCase();if(n[o]){const a=n[o][Math.floor(Math.random()*n[o].length)];return e.substring(0,t)+a+e.substring(t+1)}}return e}async sendViaEnter(n){try{n.focus();const t=new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"Enter",code:"Enter",keyCode:13});return n.dispatchEvent(t),setTimeout((()=>{if(n.innerText&&""!==n.innerText.trim()){const t=document.querySelector(e.selectors.activeChat.sendButton);t&&t.click()}}),200),!0}catch(e){return t.error(`Error sending message: ${e.message}`),!1}}shouldSplitMessage(e){return!!this.config.fragmentMessages&&(!!(e&&e.length>2*this.config.fragmentThreshold)||!!(e&&e.length>this.config.fragmentThreshold)&&Math.random()<.7)}async sendSplitMessage(n){try{const t=this.splitTextIntoFragments(n);for(let n=0;n<t.length;n++){if(n>0){const e=this.calculateFragmentInterval();await c(e),await this.startTypingIndicator(),await c(Math.min(30*t[n].length,1500)),await this.stopTypingIndicator()}const o=document.querySelector(e.selectors.activeChat.messageInput);if(!o)throw new Error("Input field not found");await this.insertTextNaturally(o,t[n]),await this.sendViaEnter(o)}return this.recordMessageLength(n),!0}catch(e){return t.error(`Error sending split message: ${e.message}`),!1}}splitTextIntoFragments(e){if(!e)return[e];if(e.includes("\n\n"))return e.split(/\n\n+/).filter((e=>e.trim()));const t=e.match(/[^.!?]+[.!?]+/g)||[e],n=[];let o="",a=0;for(const e of t)o.length+e.length>this.config.fragmentThreshold||a>=2&&Math.random()<.5?(o&&n.push(o.trim()),o=e,a=1):(o+=e,a++);return o&&n.push(o.trim()),n.length>0?n:[e]}calculateFragmentInterval(){const e=this.config.fragmentDelay[0],t=this.config.fragmentDelay[1],n=Math.random()<.3?1e3+2e3*Math.random():0;return Math.floor(e+Math.random()*(t-e)+n)}calculateTypingTime(e){if(!e)return this.config.minResponseDelay;let t=e.length*(this.config.baseTypingSpeed/1e3);const n=Math.random()*this.config.typingVariation*e.length/100;return Math.max(this.config.minResponseDelay,Math.min(t+n,this.config.maxResponseDelay))}recordMessageLength(e){e&&(this.recentMessages.push(e),this.recentMessages.length>this.maxRecentMessages&&this.recentMessages.shift())}getAverageMessageLength(){if(0===this.recentMessages.length)return 50;return this.recentMessages.reduce(((e,t)=>e+t.length),0)/this.recentMessages.length}async startTypingIndicator(){try{const n=document.querySelector(e.selectors.activeChat.messageInput);return n?(n.focus(),!0):(t.debug("Input field not found for typing indicator"),!1)}catch(e){return t.debug(`Error activating indicator: ${e.message}`),!1}}async stopTypingIndicator(){try{const t=document.querySelector(e.selectors.activeChat.messageInput);return t&&t.innerText&&(t.innerText="",t.dispatchEvent(new Event("input",{bubbles:!0}))),!0}catch(e){return t.debug(`Error deactivating indicator: ${e.message}`),!1}}};window.humanSimulator=x;const I=new class{constructor(){this.pendingChats=[],this.currentChatId=null,this.chatHistory=new Map,this.isProcessing=!1,this.conversationLogs=JSON.parse(localStorage.getItem("FB_CHAT_MONITOR_LOGS")||"[]"),this.lastProcessedMessageCount=0,this.manualChatChangeDetected=!1,this.activeChatObserver=null,this.lastScrollHeight=0,this.isProcessingChat=!1,this.typingState={isTyping:!1,intervalId:null,chatId:null},this._setupUrlChangeDetection()}_setupUrlChangeDetection(){this._lastUrl=window.location.href,setInterval((()=>{const e=window.location.href;this._lastUrl!==e&&(this._lastUrl=e,this._handleUrlChange(e))}),1e3)}_handleUrlChange(e){try{const n=e.match(/\/marketplace\/t\/(\d+)/);if(n&&n[1]){const e=n[1];e!==this.currentChatId&&(t.debug(`Manual chat change detected to ID: ${e}`),this.currentChatId=e,t.debug("Chat ID updated. The chat will be processed when Generate Response is clicked."))}}catch(e){t.error("Error handling URL change",{},e)}}async scanForUnreadChats(){t.log("Scanning for unread chats...");try{const o=n.findElement(e.selectors.chatList.container);if(!o)return t.error("Chat list container not found"),0;const a=n.findAllElements(e.selectors.chatList.chatItem,o);t.log(`Found ${a.length} chat elements`),this.pendingChats=[];for(const e of a)if(this.isUnreadChat(e)){const n=this.extractChatId(e),o=this.extractChatUsername(e),a=this.extractMessageTime(e);if(n&&/^\d+$/.test(n)){const i=this.convertTimeToMinutes(a);this.pendingChats.push({chatId:n,userName:o,messageTime:i,formattedTime:a,element:e}),t.debug(`Chat added to queue: ${o} (${n}), time: ${a}`)}else t.debug(`Chat ignored with non-numeric ID: ${n}`)}return this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime)),t.log(`Total valid unread chats: ${this.pendingChats.length}`),this.pendingChats.length>0?t.notify(`${this.pendingChats.length} unread chats found`,"success"):t.notify("No unread chats found","info"),this.pendingChats.length}catch(e){return t.error(`Error scanning chats: ${e.message}`),0}}isUnreadChat(n){try{const o=n.querySelector(e.selectors.chatList.unreadIndicator);if(o){if(!(o.textContent||"").includes("Marketplace ·"))return t.debug("Unread chat detected with specific indicator"),!0}const a=Array.from(n.querySelectorAll(e.selectors.chatList.chatUserName.selector.join(", ")));for(const e of a){const n=window.getComputedStyle(e);if(n&&parseInt(n.fontWeight)>=600)return t.debug("Unread chat detected by bold font style"),!0}return!1}catch(e){return t.error(`Error evaluating unread chat: ${e.message}`),!1}}extractChatId(e){const n=e.getAttribute("href");if(n&&n.includes("/marketplace/t/")){const e=n.match(/\/marketplace\/t\/(\d+)\//);if(e&&e[1])return t.debug(`ID extracted from href: ${e[1]}`),e[1]}const o=e.querySelectorAll('a[href*="/marketplace/t/"]');for(const e of o){const n=e.getAttribute("href").match(/\/marketplace\/t\/(\d+)\//);if(n&&n[1])return t.debug(`ID extracted from secondary link: ${n[1]}`),n[1]}const a=e.getAttribute("data-testid");if(a&&/^\d+$/.test(a))return t.debug(`ID extracted from data-testid: ${a}`),a;const i=`chat_${this.extractChatUsername(e).replace(/\s+/g,"_").toLowerCase()}`;return t.debug(`ID generated as fallback: ${i}`),i}extractChatUsername(n){try{if(Array.isArray(e.selectors.chatList.chatUserName.selector)){const t=e.selectors.chatList.chatUserName.selector.join(", "),o=Array.from(n.querySelectorAll(t)),a=e.selectors.chatList.chatUserName.filter?e.selectors.chatList.chatUserName.filter(o):o;if(a&&a.length>0){const e=a[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}else{const t=Array.isArray(e.selectors.chatList.chatUserName)?e.selectors.chatList.chatUserName.join(", "):e.selectors.chatList.chatUserName,o=Array.from(n.querySelectorAll(t)).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}));if(o.length>0){const e=o[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}const t=Array.from(n.querySelectorAll(e.selectors.chatList.chatUserName.selector.join(", ")))[0];return t?.innerText?.trim()||"Unknown User"}catch(e){return t.error(`Error extracting username: ${e.message}`),"Unknown User"}}extractMessageTime(o){try{const t=n.findElement(e.selectors.chatList.timestamp,o);return t?.innerText||"0m"}catch(e){return t.error(`Error extracting message time: ${e.message}`),"0m"}}convertTimeToMinutes(e){if(!e)return 0;const t=e.match(/(\d+)([mhdsw])/);if(!t)return 0;const n=parseInt(t[1]);switch(t[2]){case"m":default:return n;case"h":return 60*n;case"d":return 60*n*24;case"w":return 60*n*24*7}}async openNextPendingChat(){if(0===this.pendingChats.length)return t.log("No pending chats"),!1;this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime));const e=this.pendingChats.shift();t.log(`Opening chat with ${e.userName} (${e.chatId})`);try{if(e.element&&"function"==typeof e.element.click){t.log("Using direct click method to open chat"),e.element.scrollIntoView({behavior:"smooth",block:"center"}),t.notify(`Opening chat: ${e.userName}`,"info"),await new Promise((e=>setTimeout(e,1e3))),e.element.click(),this.currentChatId=e.chatId,await new Promise((e=>setTimeout(e,4e3)));const n="auto"===window.CONFIG?.operationMode;return t.debug(`Processing chat in ${n?"AUTO":"MANUAL"} mode (operationMode: ${window.CONFIG?.operationMode})`),await this.processCurrentChat(n),await this.markChatAsRead(),!0}if(/^\d+$/.test(e.chatId)){t.log("Using direct URL navigation to open chat");const n=`https://www.messenger.com/marketplace/t/${e.chatId}/`;return t.notify(`Navigating to: ${e.userName}`,"info"),window.location.href=n,await this.markChatAsRead(),!0}return t.error("Could not open chat - neither by click nor by URL"),!1}catch(e){return t.error(`Error opening chat: ${e.message}`),!1}}async generateResponseForCurrentChat(){if(!this.currentChatId)return t.error("No active chat to generate response"),l("No active chat detected. Please select a chat first.","error"),!1;try{t.debug("Generate Response button clicked - processing current chat"),await this.extractCurrentChatData();const e=this.chatHistory.get(this.currentChatId);if(!e||!e.messages||0===e.messages.length)return t.error("Could not extract chat data"),l("Could not extract chat data. Please try again.","error"),!1;const n={chatId:this.currentChatId,role:e.isSeller?"seller":"buyer",messages:e.messages,productDetails:e.productDetails};return await this.handleResponse(n),!0}catch(e){return t.error(`Error generating response: ${e.message}`),l(`Error generating response: ${e.message}`,"error"),!1}}async extractCurrentChatData(){if(!this.currentChatId)return t.error("No active chat to extract data"),{success:!1,error:"No active chat"};t.log(`Extracting data from chat ${this.currentChatId}`);try{const o=await n.waitForElement(e.selectors.activeChat.container),a=this.determineIfSeller(o);t.log("Role in chat: "+(a?"seller":"buyer"));let i=null;const r=productExtractor.extractProductIdFromCurrentChat(),s=this.extractProductLink(o);r&&(t.log(`Product ID found: ${r}`),t.debug(`Product link found: ${s}`),i=await productExtractor.getProductDetails(r,s));const l=await n.waitForElement(e.selectors.activeChat.messageWrapper),c=n.findElement(e.selectors.activeChat.scrollbar,l)||l;await n.scrollToTop(c),c.scrollTop=c.scrollHeight;const d=await this.extractChatHistory(l);t.log(`Extracted ${d.length} messages from chat`);const u={messages:d,productDetails:i,isSeller:a,lastUpdated:new Date};return this.chatHistory.set(this.currentChatId,u),{success:!0,chatData:u}}catch(e){return t.error(`Error extracting chat data: ${e.message}`),{success:!1,error:e}}}async processCurrentChat(n=!1){if(null==n&&(n="auto"===window.CONFIG?.operationMode,t.debug("Auto-respond not specified, using global setting: "+(n?"AUTO":"MANUAL"))),n)try{t.debug("AUTO mode detected - Preventively clearing input field");const n=document.querySelector(e.selectors.activeChat.messageInput);if(n){"true"===n.getAttribute("contenteditable")?(n.innerHTML="",n.textContent=""):n.value="";const e=new Event("input",{bubbles:!0});n.dispatchEvent(e)}}catch(e){t.error(`Error in preventive cleaning: ${e.message}`)}const o=await this.extractCurrentChatData();if(!o.success)return t.error("Failed to extract chat data during processCurrentChat."),!1;if(n){t.debug(`Automatic response enabled for chat ${this.currentChatId} (operationMode: ${window.CONFIG?.operationMode})`);const e=o.chatData;if(!e||!e.messages||0===e.messages.length)return t.warn("No messages found in extracted data, cannot auto-respond."),!0;const n={chatId:this.currentChatId,role:e.isSeller?"seller":"buyer",messages:e.messages,productDetails:e.productDetails};try{return t.log(`Generating automatic response as ${n.role} for chat ${this.currentChatId}`),await this.handleResponse(n),t.log("Automatic response generated and sent successfully"),!0}catch(e){return t.error(`Error during automatic response generation: ${e.message}`),!1}}else t.debug(`Automatic response disabled for chat ${this.currentChatId}. Only data was extracted.`);return!0}extractProductLink(t){const o=n.findElement(e.selectors.activeChat.productLink,t);return o?.href||null}getAudioTranscription(n){if(!n||!e.audioTranscription.enabled)return null;if("[Audio URL will be detected by Performance API]"===n)return null;if(!window.audioTranscriber)return t.debug(`Audio transcriber not available for URL: ${n}`),null;try{const e=window.audioTranscriber.getTranscription(n);if(e)return t.debug(`Transcription found for audio: ${n.substring(0,50)}...`),e}catch(e){t.warn(`Error accessing audio transcription: ${e.message}`)}return null}async extractChatHistory(o){if(this.isProcessingChat)return t.warn("Chat history extraction already in progress. Skipping."),[];if(!o)return t.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,t.debug("Starting chat history extraction with improved selectors...");const a=[];let i=[],r=null;try{if(t.debug(`Finding message rows using selector: ${e.selectors.activeChat.messageRow}`),i=n.findAllElements(e.selectors.activeChat.messageRow,o),t.debug(`Found ${i.length} message row elements`),0===i.length){t.warn("Main message row selector failed. Trying fallback selectors...");const e=o.querySelectorAll('div[dir="auto"][role="none"]');if(!(e.length>0))throw new Error("No message elements found with main or fallback selectors");i=Array.from(e),t.debug(`Fallback found ${i.length} potential message elements`)}for(let o=0;o<i.length;o++){const s=i[o],l=s,c=l.outerHTML;if(c===r){t.debug(`Message #${o}: Duplicate row skipped`);continue}r=c;const d=n.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],s)||s,u={id:`msg_${this.currentChatId}_${o}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}}};try{u.sentByUs=this.isMessageSentByUs(l);const t=n.findElement(e.selectors.activeChat.messageContent,d);let o="";t&&(o=(t.innerText||t.textContent||"").trim(),o=o.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^Sent \d+d ago:\s*/i,"").trim(),o=o.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const i=this.isSystemMessage(o),r=this.isDividerElement(s);!o||i||r||(u.content.text=o,u.content.type="text");const c=n.findElement(e.selectors.activeChat.messageTimestamp,l);let g=null;c&&(g=c.getAttribute("data-tooltip-content")||c.getAttribute("aria-label")||c.getAttribute("title")||c.textContent.trim(),this.isValidTimestamp(g)?u.timestamp=g:u.timestamp=null),this.detectAndAddImageContent(d,u),this.detectAndAddAudioContent(d,u),this.detectAndAddVideoContent(d,u),this.detectAndAddFileContent(d,u),this.detectAndAddLocationContent(d,u),this.detectAndAddGifContent(d,u),"unknown"===u.content.type&&(u.content.text?u.content.type="text":u.content.media.images.length>0?u.content.type="image":u.content.media.audio?u.content.type="audio":u.content.media.video?u.content.type="video":u.content.media.files.length>0?u.content.type="file":u.content.media.location?u.content.type="location":u.content.media.gif&&(u.content.type="gif")),"unknown"===u.content.type||i||r||a.push(u)}catch(e){t.error(`Error processing message element #${o}:`,{},e)}}this.lastProcessedMessageCount=a.length,t.log(`Extraction completed: ${a.length} messages found`)}catch(e){t.error("Error during chat history extraction:",{},e)}finally{this.isProcessingChat=!1}return a}isValidTimestamp(e){if(!e||"string"!=typeof e)return!1;const t=e.trim();if([/^\d{1,2}:\d{2}$/,/^[a-záéíóúüñ\s]+$/i,/^(Play|Reproducir|Pause|Pausar)$/i,/^Message replied to:/i,/^Message:/i].some((e=>e.test(t))))return!1;return[/\d{1,2}:\d{2}\s*(AM|PM)/i,/\d{1,2}\/\d{1,2}\/\d{2,4}/,/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)/i,/(Today|Yesterday|Hoy|Ayer)/i,/minutes? ago|hours? ago|minutes?|hours?/i,/sent at \d{1,2}:\d{2}\s*(AM|PM)?/i,/sent at \d{1,2}:\d{2}/i].some((e=>e.test(t)))}detectAndAddImageContent(n,o){try{const t=Array.isArray(e.selectors.activeChat.messageImageElement)?e.selectors.activeChat.messageImageElement.join(", "):e.selectors.activeChat.messageImageElement,a=n.querySelectorAll(t);if(a.length>0){const e=Array.from(a).filter((e=>{const t=e.src||"";return t&&!t.startsWith("data:")&&(e.width>30||!e.width)&&(e.height>30||!e.height)&&!t.includes("/emoji.")&&!t.includes("/avatar/")}));e.length>0&&(o.content.imageUrls=e.map((e=>e.src)),o.content.media.images=e.map((e=>({url:e.src,alt:e.alt||"",width:e.width||0,height:e.height||0}))),"unknown"===o.content.type&&(o.content.type="image"))}const i=n.querySelectorAll('div[style*="background-image"]');if(i.length>0)for(const e of i){const t=(e.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(t&&t[1]&&!t[1].startsWith("data:")){const n=t[1];o.content.imageUrls.includes(n)||(o.content.imageUrls.push(n),o.content.media.images.push({url:n,alt:"Background Image",width:e.clientWidth||0,height:e.clientHeight||0}),"unknown"===o.content.type&&(o.content.type="image"))}}}catch(e){t.error(`Error detecting images: ${e.message}`,{},e)}}detectAndAddAudioContent(n,o){try{const t=Array.isArray(e.selectors.activeChat.messageAudioPlayButton)?e.selectors.activeChat.messageAudioPlayButton.join(", "):e.selectors.activeChat.messageAudioPlayButton,a=n.querySelector(t);if(a){const e=a.getAttribute("aria-label")||"";if(e.toLowerCase().includes("video"))return;const t=this.extractAudioDuration(n)||"",i=this.extractAudioUrl(n)||null;if(o.content.hasAudio=!0,o.content.audioUrl=i,o.content.media.audio={exists:!0,url:i,duration:t,label:e},"unknown"===o.content.type&&(o.content.type="audio"),i&&"function"==typeof this.getAudioTranscription){const e=this.getAudioTranscription(i);o.content.transcribedAudio=e||"[Audio Transcription Pending]"}}else{const e=n.querySelector("audio[src]");if(e){const t=e.src;if(o.content.hasAudio=!0,o.content.audioUrl=t,o.content.media.audio={exists:!0,url:t,duration:e.duration?`${Math.round(e.duration)}s`:"",label:"Audio message"},"unknown"===o.content.type&&(o.content.type="audio"),"function"==typeof this.getAudioTranscription){const e=this.getAudioTranscription(t);o.content.transcribedAudio=e||"[Audio Transcription Pending]"}}}}catch(e){t.error(`Error detecting audio: ${e.message}`,{},e)}}extractAudioDuration(e){try{const t=['span[style*="color: rgba"]',"span.x193iq5w",'div[dir="auto"] > span'];for(const n of t){const t=e.querySelectorAll(n);for(const e of t){const t=e.textContent.trim();if(/^\d{1,2}:\d{2}$/.test(t))return t}}return null}catch(e){return t.debug(`Error extracting audio duration: ${e.message}`),null}}extractAudioUrl(e){try{const t=e.querySelector("audio[src]");if(t&&t.src)return t.src;const n=e.querySelector('a[href*=".mp3"], a[href*=".m4a"], a[href*=".wav"], a[href*=".ogg"]');return n&&n.href?n.href:null}catch(e){return t.debug(`Error extracting audio URL: ${e.message}`),null}}detectAndAddVideoContent(n,o){try{const t=n.querySelector('video, a[href*="video_redirect"]');if(t){if("VIDEO"===t.tagName){const e={exists:!0,url:t.src||null,type:"video",thumbnail:this.extractVideoThumbnail(t)||null,duration:t.duration?`${Math.round(t.duration)}s`:null};o.content.media.video=e,"unknown"===o.content.type&&(o.content.type="video")}else if("A"===t.tagName&&t.href){const e={exists:!0,url:t.href,type:"video_link",thumbnail:null,duration:null};o.content.media.video=e,"unknown"===o.content.type&&(o.content.type="video")}}else{const t=Array.isArray(e.selectors.activeChat.messageVideoElement)?e.selectors.activeChat.messageVideoElement.join(", "):e.selectors.activeChat.messageVideoElement,a=n.querySelector(t);if(a){const e=a.getAttribute("aria-label")||"Video Player",t={exists:!0,url:null,type:a.style.backgroundImage||a.querySelector('div[style*="background-image"]')?"video_thumbnail":"video_player",thumbnail:this.extractBackgroundImage(a),label:e};o.content.media.video=t,"unknown"===o.content.type&&(o.content.type="video")}}}catch(e){t.error(`Error detecting video: ${e.message}`,{},e)}}extractBackgroundImage(e){try{const t=(e.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(t&&t[1])return t[1];const n=e.querySelector('div[style*="background-image"]');if(n){const e=(n.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(e&&e[1])return e[1]}return null}catch(e){return t.debug(`Error extracting background image: ${e.message}`),null}}extractVideoThumbnail(e){try{if(e.poster)return e.poster;const t=e.querySelector('source[type^="video/"]');return t&&t.src?t.src.replace(/\.mp4$/,".jpg"):null}catch(e){return t.debug(`Error extracting video thumbnail: ${e.message}`),null}}detectAndAddFileContent(n,o){try{const t=Array.isArray(e.selectors.activeChat.messageFileElement)?e.selectors.activeChat.messageFileElement.join(", "):e.selectors.activeChat.messageFileElement,a=Array.from(n.querySelectorAll(t));if(a.length>0){const e=[];a.forEach((t=>{const n=t.href||null,o=this.extractFileName(t),a=this.detectFileType(t,o);(n||o)&&e.push({url:n,name:o,type:a})})),e.length>0&&(o.content.media.files=e,"unknown"===o.content.type&&(o.content.type="file"))}}catch(e){t.error(`Error detecting files: ${e.message}`,{},e)}}extractFileName(e){try{if(e.hasAttribute("download"))return e.getAttribute("download")||this.extractFileNameFromPath(e.href);const t=e.textContent?.trim();if(t&&t.includes(".")){const e=t.match(/[\w\s\-]+\.\w+/);if(e)return e[0]}if(e.hasAttribute("title"))return e.getAttribute("title");if(e.hasAttribute("aria-label")){const t=e.getAttribute("aria-label");if(t.includes("file")||t.includes("archivo")){const e=t.split(":");if(e.length>1)return e[1].trim()}return t}return e.href?this.extractFileNameFromPath(e.href):"Unnamed file"}catch(e){return t.debug(`Error extracting file name: ${e.message}`),"Unnamed file"}}extractFileNameFromPath(e){if(!e)return"Unnamed file";try{const t=new URL(e).pathname.split("/"),n=t[t.length-1].split("?")[0];return decodeURIComponent(n)||"Unnamed file"}catch(t){const n=e.match(/\/([^\/\?]+)(?:\?|$)/);return n?decodeURIComponent(n[1]):"Unnamed file"}}detectFileType(e,n){try{if(!n)return"unknown";const e=n.split(".").pop().toLowerCase();return{pdf:"pdf",doc:"document",docx:"document",odt:"document",rtf:"document",xls:"spreadsheet",xlsx:"spreadsheet",ods:"spreadsheet",ppt:"presentation",pptx:"presentation",odp:"presentation",txt:"text",zip:"archive",rar:"archive","7z":"archive",jpg:"image",jpeg:"image",png:"image",gif:"image",bmp:"image",mp3:"audio",wav:"audio",ogg:"audio",m4a:"audio",mp4:"video",avi:"video",mov:"video",wmv:"video"}[e]||"unknown"}catch(e){return t.debug(`Error detecting file type: ${e.message}`),"unknown"}}detectAndAddLocationContent(n,o){try{const t=Array.isArray(e.selectors.activeChat.messageLocationElement)?e.selectors.activeChat.messageLocationElement.join(", "):e.selectors.activeChat.messageLocationElement,a=n.querySelector(t);if(a){let e=null;if("A"===a.tagName&&a.href){const t=this.extractLocationLabel(a)||"Shared location",n=this.extractCoordinates(a.href);e={url:a.href,label:t,coordinates:n}}else{const t=this.extractLocationLabel(a)||"Shared location",n=a.querySelector('a[href*="maps"]'),o=n?n.href:null;e={url:o,label:t,coordinates:o?this.extractCoordinates(o):null}}e&&(o.content.media.location=e,"unknown"===o.content.type&&(o.content.type="location"))}}catch(e){t.error(`Error detecting location: ${e.message}`,{},e)}}extractLocationLabel(e){try{if(e.hasAttribute("aria-label"))return e.getAttribute("aria-label").replace(/location|ubicación|shared/i,"").trim();const t=e.textContent?.trim();return t&&!t.startsWith("http")?t:null}catch(e){return t.debug(`Error extracting location label: ${e.message}`),null}}extractCoordinates(e){if(!e)return null;try{if(e.includes("maps")){let t=e.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/i);if(t||(t=e.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/i)),t)return{latitude:parseFloat(t[1]),longitude:parseFloat(t[2])}}return null}catch(e){return t.debug(`Error extracting coordinates: ${e.message}`),null}}detectAndAddGifContent(n,o){try{const t=Array.isArray(e.selectors.activeChat.messageGifElement)?e.selectors.activeChat.messageGifElement.join(", "):e.selectors.activeChat.messageGifElement,a=n.querySelector(t);if(a){let e=null;if("IMG"===a.tagName){const t=a.src,o=t&&(t.includes("giphy.com")||t.includes("tenor.com")||t.endsWith(".gif"));e={url:t,type:!!n.querySelector('[data-testid="sticker"]')?"sticker":o?"gif":"animated_content",alt:a.alt||""}}else{const t=a.getAttribute("aria-label")||"GIF",n=a.querySelector("img");e={url:n?n.src:null,type:t.toLowerCase().includes("sticker")?"sticker":"gif",label:t}}e&&(o.content.media.gif=e,"unknown"===o.content.type&&(o.content.type="gif"))}}catch(e){t.error(`Error detecting GIF/sticker: ${e.message}`,{},e)}}isSystemMessage(e){if(!e)return!1;const n=[/^You sent an attachment\.$/i,/^You sent a photo\.$/i,/^You sent a video\.$/i,/^You sent a GIF\.$/i,/^You shared a location\.$/i,/^You set the nickname for .* to .*$/i,/^You changed the chat colors\.$/i,/^You named the group .*$/i,/^You added .* to the group\.$/i,/^You removed .* from the group\.$/i,/^.* left the group\.$/i,/^You missed a call from .*$/i,/^Missed call$/i,/^Enviaste un adjunto\.$/i,/^Enviaste una foto\.$/i,/^Enviaste un video\.$/i,/^Enviaste un GIF\.$/i,/^Compartiste una ubicación\.$/i,/^Cambiaste los colores del chat\.$/i,/^Llamada perdida$/i,/^Llamada perdida de .*$/i,/^Nombraste al grupo .*$/i,/^Agregaste a .* al grupo\.$/i,/^Eliminaste a .* del grupo\.$/i,/^.* salió del grupo\.$/i,/^Definiste el apodo de .* como .*$/i,/^.*? bumped their message:?/i].some((t=>t.test(e)));return n&&t.debug(`[isSystemMessage] System message detected: "${e.substring(0,30)}..."`),n}isDividerElement(e){try{const n=e.innerText||"";if(e.classList&&(e.classList.contains("x1e56ztr")||e.classList.contains("x78zum5")||e.classList.contains("xh8yej3"))){const n=e.querySelector('div[dir="auto"], span[dir="auto"]');if(!n||n.textContent.length<5)return t.debug(`[isDivider] Element with divider class and little/no text: ${e.className}`),!0}return/^(Today|Yesterday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday|Hoy|Ayer|Lunes|Martes|Miércoles|Jueves|Viernes|Sábado|Domingo)$/i.test(n)?(t.debug(`[isDivider] Element with day text: ${n}`),!0):/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(n)||/^\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)(\w*)(\s+\d{2,4})?$/i.test(n)||/^\d{1,2}\s+(Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)(\w*)(\s+\d{2,4})?$/i.test(n)?(t.debug(`[isDivider] Element with date text: ${n}`),!0):("separator"===e.getAttribute("role")||"HR"===e.tagName||0===e.children.length&&"separator"===e.parentElement?.getAttribute("role"))&&(t.debug("[isDivider] Element with separator role/tag"),!0)}catch(e){return t.error(`Error in isDividerElement: ${e.message}`),!1}}extractMentions(e){try{const t=[];return e.querySelectorAll('a[href*="/user/"], span.xngnso2, span[data-hovercard]').forEach((e=>{const n=e.innerText.trim();let o=null;if(e.href){const t=e.href.match(/\/user\/(\d+)|\?id=(\d+)/);t&&(o=t[1]||t[2])}else if(e.getAttribute("data-hovercard")){const t=e.getAttribute("data-hovercard").match(/id=(\d+)/);t&&(o=t[1])}n&&t.push({name:n,id:o})})),t.length>0?t:null}catch(e){return t.debug(`Error extracting mentions: ${e.message}`),null}}enhanceMessageContext(e,n){try{const t=this.detectQuotedMessage(e);t&&(n.context={...n.context||{},...t},n.content.type="unknown"===n.content.type?"reply":`${n.content.type}_reply`);const o=this.extractMentions(e);o&&(n.context={...n.context||{},mentions:o});const a=this.detectReactions(e);a&&(n.context={...n.context||{},reactions:a});const i=this.detectProductMention(e);i&&(n.context={...n.context||{},productMention:i})}catch(e){t.debug(`Error enhancing message context: ${e.message}`)}}detectReactions(e){try{const t=e.querySelector('div.xq8finb, div.x6s0dn4.x78zum5.xl56j7k, div[role="toolbar"][aria-label*="reaction"]');if(!t)return null;const n=[];return t.querySelectorAll('img.emoji, span[aria-label*=":"], div[aria-label*="Reacted"]').forEach((e=>{let t="unknown",o="";if("IMG"===e.tagName)t="emoji",o=e.alt||e.getAttribute("aria-label")||"";else{const n=e.getAttribute("aria-label")||"";if(n.includes("Like"))t="like",o="👍";else if(n.includes("Love"))t="love",o="❤️";else if(n.match(/Reacted with/i)){t="emoji";const e=n.match(/Reacted with :([^:]+):/);o=e?e[1]:n.replace(/Reacted with\s*/i,"")}else o=n}o&&n.push({type:t,value:o})})),n.length>0?n:null}catch(e){return t.debug(`Error detecting reactions: ${e.message}`),null}}detectProductMention(e){try{const t=e.querySelector('a[href*="/marketplace/item/"]');if(!t)return null;const n=t.href;let o=null;const a=n.match(/\/marketplace\/item\/(\d+)/);a&&(o=a[1]);let i="",r="";const s=t.querySelector('span[dir="auto"], div[dir="auto"]');s&&(i=s.innerText.trim());const l=e.querySelector('a[href*="/marketplace/item/"] img, div.x1ey2m1c img');return l&&l.src&&(r=l.src),{type:"product",productId:o,productUrl:n,title:i,imageUrl:r}}catch(e){return t.debug(`Error detecting product mention: ${e.message}`),null}}detectSpecialSystemEvents(e){if(!e)return null;const t=[{pattern:/marked this item as (sold|pending|available)/i,type:"status_change",action:e=>e[1].toLowerCase()},{pattern:/changed the price from ([\d,\.]+) to ([\d,\.]+)/i,type:"price_change",action:e=>({oldPrice:e[1],newPrice:e[2]})},{pattern:/(canceled|completed) this sale/i,type:"sale_event",action:e=>e[1].toLowerCase()},{pattern:/requested more details about/i,type:"request",action:()=>"details_request"},{pattern:/marcó este artículo como (vendido|pendiente|disponible)/i,type:"status_change",action:e=>{const t=e[1].toLowerCase();return"vendido"===t?"sold":"pendiente"===t?"pending":"available"}}];for(const n of t){const t=e.match(n.pattern);if(t)return{type:n.type,action:n.action(t),originalText:e}}return null}async extractChatHistoryEnhanced(o){if(this.isProcessingChat)return t.warn("Chat history extraction already in progress. Skipping."),[];if(!o)return t.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,t.debug("Starting enhanced chat history extraction...");const a=[];let i=[],r=null;try{if(i=n.findAllElements(e.selectors.activeChat.messageRow,o),t.debug(`Found ${i.length} message row elements`),0===i.length){const e=o.querySelectorAll('div[dir="auto"][role="none"]');if(!(e.length>0))throw new Error("No message elements found with main or fallback selectors");i=Array.from(e)}const s=20,l=Math.ceil(i.length/s);for(let e=0;e<l;e++){const n=e*s,o=Math.min(n+s,i.length),c=i.slice(n,o);t.debug(`Processing batch ${e+1}/${l} (${c.length} messages)`);const d=await this.processBatchOfMessages(c,r,e);d.lastProcessed&&(r=d.lastProcessed),d.messages&&d.messages.length>0&&a.push(...d.messages),e<l-1&&await new Promise((e=>setTimeout(e,5)))}this.lastProcessedMessageCount=a.length,t.log(`Enhanced extraction completed: ${a.length} messages processed in ${l} batches`),this.buildMessageReferences(a)}catch(e){t.error("Error during enhanced chat history extraction:",{},e)}finally{this.isProcessingChat=!1}return a}async processBatchOfMessages(o,a,i){const r=[];let s=a;for(let a=0;a<o.length;a++){const l=o[a],c=l,d=c.outerHTML;if(d===s)continue;s=d;const u=n.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],l)||l,g={id:`msg_${this.currentChatId}_${100*i+a}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}},context:{}};try{g.sentByUs=this.isMessageSentByUs(c);const t=n.findElement(e.selectors.activeChat.messageContent,u);let o="";t&&(o=(t.innerText||t.textContent||"").trim(),o=o.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),o=o.replace(/^Sent \d+d ago:\s*/i,"").trim(),o=o.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const a=this.isSystemMessage(o),i=this.isDividerElement(l);if(o&&!i)if(g.content.text=o,a){const e=this.detectSpecialSystemEvents(o);e?(g.content.type="system_event",g.context.systemEvent=e):g.content.type="system"}else g.content.type="text";this.enhanceMessageContext(u,g);const s=n.findElement(e.selectors.activeChat.messageTimestamp,c);if(s){const e=s.getAttribute("data-tooltip-content")||s.getAttribute("aria-label")||s.getAttribute("title")||s.textContent.trim();this.isValidTimestamp(e)&&(g.timestamp=e)}this.detectAndAddImageContent(u,g),this.detectAndAddAudioContent(u,g),this.detectAndAddVideoContent(u,g),this.detectAndAddFileContent(u,g),this.detectAndAddLocationContent(u,g),this.detectAndAddGifContent(u,g),"unknown"===g.content.type&&(g.content.text?g.content.type="text":g.content.media.images.length>0?g.content.type="image":g.content.media.audio?g.content.type="audio":g.content.media.video?g.content.type="video":g.content.media.files.length>0?g.content.type="file":g.content.media.location?g.content.type="location":g.content.media.gif&&(g.content.type="gif")),"unknown"===g.content.type||i||r.push(g)}catch(e){t.error(`Error processing message element in batch ${i}, item ${a}:`,{},e)}}return{messages:r,lastProcessed:s}}buildMessageReferences(e){if(e&&0!==e.length)try{const n=new Map;for(let t=0;t<e.length;t++){const o=e[t];if(o.content.text){const e=o.content.text.substring(0,50).toLowerCase();n.has(e)||n.set(e,[]),n.get(e).push({index:t,id:o.id})}}for(let t=0;t<e.length;t++){const o=e[t];if(o.context&&"reply"===o.context.type&&o.context.quotedText){const a=o.context.quotedText.substring(0,50).toLowerCase();if(n.has(a)){const i=n.get(a).filter((e=>e.index<t));if(i.length>0){const t=i.reverse()[0];o.context.referencesMessageId=t.id;const n=e[t.index];n&&(n.context=n.context||{},n.context.referencedBy=n.context.referencedBy||[],n.context.referencedBy.push(o.id))}}}}t.debug(`Message references built for ${e.length} messages`)}catch(e){t.error("Error building message references:",{},e)}}determineIfSeller(n){try{for(const o of e.selectors.activeChat.sellerIndicators)if(o.includes(":contains")){const e=o.match(/:contains\("(.+?)"\)/)[1];if(Array.from(n.querySelectorAll("*")).filter((t=>t.textContent&&t.textContent.includes(e))).length>0)return t.debug(`Seller indicator found: ${e}`),!0}else{if(n.querySelectorAll(o).length>0)return t.debug(`Seller indicator found: ${o}`),!0}for(const o of e.selectors.activeChat.buyerIndicators)if(o.includes(":contains")){const e=o.match(/:contains\("(.+?)"\)/)[1];if(Array.from(n.querySelectorAll("*")).filter((t=>t.textContent&&t.textContent.includes(e))).length>0)return t.debug(`Buyer indicator found: ${e}`),!1}else{if(n.querySelectorAll(o).length>0)return t.debug(`Buyer indicator found: ${o}`),!1}t.debug("No definitive role indicators found, using alternative heuristic");return!!n.querySelector('a[href*="/marketplace/item/"]')&&(t.debug("Product link found, likely a buyer"),!1)}catch(e){return t.error(`Error determining seller/buyer role: ${e.message}`,{},e),!1}}isMessageSentByUs(o){const a="row"===o?.getAttribute("role")?o:o?.closest('div[role="row"]');if(!a)return t.debug("[isMessageSentByUs] Could not find the div[role='row'] container. Assuming foreign message."),!1;try{if(a.classList.contains("x1ja2u2z"))return t.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1ja2u2z'. It's own."),!0;if(a.classList.contains("x1yc453h"))return t.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1yc453h'. It's foreign."),!1;t.debug("[isMessageSentByUs] CLASS INDICATOR: No conclusive class detected in the row.");const o=a.firstElementChild;if("gridcell"===o?.getAttribute("role")&&"messages_table"===o.getAttribute("data-scope"))return t.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell has data-scope='messages_table'. It's own."),!0;t.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell does not have data-scope='messages_table'.");try{const e=window.getComputedStyle(a).getPropertyValue("justify-content");if("flex-end"===e)return t.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-end'. It's own."),!0;if("flex-start"===e)return t.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-start'. It's foreign."),!1;t.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is '${e}'. Not conclusive.`)}catch(e){t.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: Error getting style: ${e.message}`)}if(Array.from(a.querySelectorAll("[aria-label]")).some((e=>{const t=e.getAttribute("aria-label");return t&&/you sent|enviaste/i.test(t)})))return t.debug("[isMessageSentByUs] ARIA INDICATOR: Found 'you sent' in aria-label. It's own."),!0;t.debug("[isMessageSentByUs] ARIA INDICATOR: No sending text found in aria-label.");if(n.findElement(e.selectors.activeChat.senderAvatar,a))return t.debug("[isMessageSentByUs] AVATAR INDICATOR: Avatar found in the row. It's foreign."),!1;t.debug("[isMessageSentByUs] AVATAR INDICATOR: No avatar found in the row. Could be own.");const i=a.querySelector("h5 > span");return i&&/you sent|enviaste/i.test(i.textContent||"")?(t.debug(`[isMessageSentByUs] TEXTUAL INDICATOR (H5): Found '${i.textContent.trim()}'. It's own.`),!0):(t.warn("[isMessageSentByUs] Could not determine the sender with certainty after all checks. Assuming foreign message."),!1)}catch(e){return t.error(`[isMessageSentByUs] General error processing the row: ${e.message}`,{html:a.outerHTML.substring(0,200)},e),!1}}async handleResponse(e){try{if(t.log("Generating response for chat..."),!e||!e.messages||0===e.messages.length)throw new Error("Invalid chat context or no messages");const n="seller"===e.role?"seller":"buyer";t.log(`Role in the conversation: ${n}, total messages: ${e.messages.length}`),this.logAssistantContext(e);const o=window.CONFIG?.operationMode||"manual";t.log(`Configured response mode: ${o}`),window.openaiManager&&"function"==typeof window.openaiManager.verifyServiceState&&window.openaiManager.verifyServiceState();const a="object"==typeof window.openaiManager&&"function"==typeof window.openaiManager.generateResponse&&(window.openaiManager.isInitialized||window.openaiManager.apiKey),i="object"==typeof window.assistantManager&&"function"==typeof window.assistantManager.generateResponse;if(t.debug(`Available services: Assistant=${i}, OpenAI=${a}`),t.debug(`openaiManager exists: ${!!window.openaiManager}`),window.openaiManager&&(t.debug(`openaiManager.isInitialized: ${window.openaiManager.isInitialized}`),t.debug(`openaiManager.isReady: ${"function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():"method missing"}`)),i){t.log("Using the OpenAI Assistant..."),l("Consulting the OpenAI Assistant...","info");const n=await window.assistantManager.generateResponse(e);if(n&&n.text){t.log(`Response generated by Assistant: ${n.text.substring(0,100)}...`);return window.CONFIG?.autoSend||!1?window.humanSimulator?(t.log("Sending response automatically..."),await window.humanSimulator.typeAndSendMessage(n.text),l("Response sent automatically","success")):(t.error("HumanSimulator not available for automatic sending"),this.insertResponseInInputField(n.text),l("Response inserted in the input field","info")):(this.insertResponseInInputField(n.text),l("Response inserted in the input field. Review and send when you are ready.","info")),await this.markChatAsRead(),n}throw new Error("Could not generate a valid response from the Assistant")}if(!a){t.log("No AI services available: showing help information");const o=`You are in a conversation as ${n}.\nProduct: ${e.productDetails?`${e.productDetails.title} (${e.productDetails.price})`:"No product information"}\nNo AI services configured. Please configure OpenAI or an Assistant in the options.`,a=o+"\n\n"+`Debug: openaiManager=${!!window.openaiManager}, `+`assistantManager=${!!window.assistantManager}, `+`config.AI.apiKey=${!!window.CONFIG?.AI?.apiKey}`;return l(o,"info"),t.debug(a),{text:o}}t.log("Generating response with OpenAI API..."),l("Generating response with OpenAI...","info"),window.openaiManager&&!window.openaiManager.isInitialized&&(t.debug("Attempting to reinitialize OpenAI Manager..."),"function"==typeof window.openaiManager.verifyServiceState?window.openaiManager.verifyServiceState():"function"==typeof window.openaiManager.initialize?window.openaiManager.initialize():"function"==typeof window.openaiManager.loadConfig&&window.openaiManager.loadConfig());try{const n=await window.openaiManager.generateResponse(e);if(n&&(n.text||"string"==typeof n)){const e=n.text||n;return t.log(`Response generated by OpenAI: ${e.substring(0,100)}...`),this.insertResponseInInputField(e),l("Response inserted in the input field. Review and send when you are ready.","info"),await this.markChatAsRead(),n}throw new Error("Could not generate a valid response from OpenAI")}catch(e){throw t.error(`Error generating response with OpenAI: ${e.message}`,{},e),e}}catch(e){throw t.error(`Error generating response: ${e.message}`,{},e),l(`Error generating response: ${e.message}`,"error"),e}}logAssistantContext(e){try{const t=JSON.parse(JSON.stringify(e)),n={timestamp:(new Date).toISOString(),chatId:this.currentChatId,totalMessages:t.messages?t.messages.length:0,role:t.role||"unknown",hasProductDetails:!!t.productDetails},o={text:0,image:0,audio:0,video:0,file:0,location:0,other:0};t.messages&&Array.isArray(t.messages)&&t.messages.forEach((e=>{const t=e.content?.type||"unknown";"text"===t?o.text++:"image"===t?o.image++:"audio"===t?o.audio++:"video"===t?o.video++:"file"===t?o.file++:"location"===t?o.location++:o.other++}));const a={metadata:n,contentStats:o,context:t};console.group("📤 Context sent to Assistant/OpenAI"),console.log("%cMetadata:","font-weight:bold; color:blue;",n),console.log("%cContent statistics:","font-weight:bold; color:green;",o),t.productDetails&&console.log("%cProduct details:","font-weight:bold; color:purple;",t.productDetails),t.messages&&Array.isArray(t.messages)&&(console.log("%cMessage history:","font-weight:bold; color:brown;"),t.messages.forEach(((e,t)=>{const n=e.sentByUs?"📤 ME":"📥 OTHER",o=e.timestamp?` (${e.timestamp})`:"";if(console.log(`${t+1}. ${n}${o}: ${e.content.text||`[${e.content.type.toUpperCase()}]`}`),e.content.media){const t=e.content.media;t.images&&t.images.length&&console.log(`   🖼️ ${t.images.length} images`),t.audio&&console.log("   🔊 Audio"+(t.audio.duration?` (${t.audio.duration})`:"")),t.video&&console.log("   🎬 Video"+(t.video.type?` (${t.video.type})`:"")),t.files&&t.files.length&&console.log(`   📎 ${t.files.length} files`),t.location&&console.log(`   📍 Location: ${t.location.label||""}`)}e.content.transcribedAudio&&console.log(`   🎤 Transcription: "${e.content.transcribedAudio}"`)}))),console.log("%cComplete object (expand):","font-weight:bold; color:darkblue;"),console.dir(a),console.log("%cComplete JSON (copy from console):","font-weight:bold; color:darkred;"),console.log(JSON.stringify(a,null,2)),console.groupEnd(),window.exportAssistantContext=()=>{const e=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`assistant_context_${this.currentChatId}_${(new Date).toISOString().replace(/[:.]/g,"_")}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),console.log("✅ Context JSON file downloaded. To export again at any time, run: exportAssistantContext()")},console.log("To export this context as a JSON file, run: exportAssistantContext()")}catch(e){t.error(`Error displaying assistant context: ${e.message}`,{},e)}}insertResponseInInputField(n){try{const o=document.querySelector(e.selectors.activeChat.messageInput);if(!o)return t.error("Message input field not found"),!1;const a="auto"===window.CONFIG?.operationMode;return t.debug("Operation mode when inserting response: "+(a?"AUTO":"MANUAL")),setTimeout((()=>{window.openaiManager&&"function"==typeof window.openaiManager.clearInputField&&(window.openaiManager.clearInputField(),t.debug("First cleaning phase completed with openaiManager")),this.forceCleanInputField(o),t.debug("Second direct cleaning phase completed");const e="true"===o.getAttribute("contenteditable")?(o.textContent||"").trim():(o.value||"").trim();if(e&&(t.warn(`Field is NOT empty after two cleaning attempts. Current content: "${e.substring(0,20)}..."`),this.emergencyCleanField(o),a))return t.debug("AUTO mode detected, applying additional pause to ensure complete cleaning"),setTimeout((()=>{this.insertTextAndPotentiallySend(o,n,a)}),500),!0;setTimeout((()=>{this.insertTextAndPotentiallySend(o,n,a)}),100)}),a?300:0),!0}catch(e){return t.error(`Error inserting response in input field: ${e.message}`),!1}}insertTextAndPotentiallySend(o,a,i){try{if(t.debug("Inserting text in input field"),n.insertTextIntoField(o,a),e.autoSendMessages&&i){t.debug("Automatic sending activated in AUTO mode, sending message...");const n=e.sendMessageDelay||2e3;t.debug(`Waiting ${n}ms before sending so that Facebook processes the text...`),setTimeout((()=>{const e="true"===o.getAttribute("contenteditable")?o.textContent||"":o.value||"";e.trim()===a.trim()?(t.debug("Text verified, sending message..."),this.sendMessage(!0)):t.warn(`The final text (${e.length} chars) does not match the expected one (${a.length} chars), aborting automatic sending`)}),n)}else e.autoSendMessages?i||t.debug(`MANUAL mode detected (operationMode: ${window.CONFIG?.operationMode})`):t.debug("Automatic sending deactivated (autoSendMessages: false)")}catch(e){t.error(`Error in insertTextAndPotentiallySend: ${e.message}`)}}sendMessage(o=!1){try{t.debug(`Initiating message sending attempt (${o?"after inserting text":"direct"})`);const a=[...e.selectors.activeChat.sendButton,'div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][tabindex="0"][style*="transform: translateY(0px)"]','div.xjbqb8w:not([style*="opacity: 0"])','div.x1i10hfl[role="button"]:not(.x1hc1fzr)'];t.debug(`Searching for send button with ${a.length} selectors...`);const i=n.findElement(a);if(i){const e=i.getBoundingClientRect(),n=window.getComputedStyle(i);e.width>0&&e.height>0&&"hidden"!==n.visibility&&"none"!==n.display&&"0"!==n.opacity?(t.debug(`Send button found and visible (${e.width}x${e.height}), clicking...`),setTimeout((()=>{try{return i.click(),t.log("Message sent by clicking on the button"),this.markChatAsRead(),!0}catch(e){t.warn(`Error when doing normal click: ${e.message}, trying simulated event...`);try{return i.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),t.log("Message sent using simulated click event"),this.markChatAsRead(),!0}catch(e){t.error(`Error simulating click event: ${e.message}`)}}}),100)):t.warn("Send button found but NOT visible/enabled. Using alternative method.")}else t.debug("Send button not found, trying with Enter key...");const r=document.querySelector(e.selectors.activeChat.messageInput);if(r){if(t.debug("Simulating Enter key in the input field..."),n.simulateKeyPress(r,"Enter",13))return t.log("Message sent simulating Enter key with domUtils.simulateKeyPress"),this.markChatAsRead(),!0;r.focus();const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(r.dispatchEvent(e))return t.log("Message sent simulating Enter key with KeyboardEvent"),this.markChatAsRead(),!0;t.warn("The event was not sent correctly");try{if(document.execCommand("insertText",!1,"\n"))return t.log("Message sent using execCommand insertText"),this.markChatAsRead(),!0}catch(e){t.error(`Error using execCommand: ${e.message}`)}if(!o)return t.debug("First attempt failed, scheduling retry after 1 second..."),setTimeout((()=>this.sendMessage(!0)),1e3),!0}return t.error("Could not send the message after all attempts"),!1}catch(e){return t.error(`Error sending message: ${e.message}`,{},e),!1}}forceCleanInputField(e){try{if(!e)return;if("true"===e.getAttribute("contenteditable")){e.innerHTML="",e.textContent="";try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),document.execCommand("delete",!1,null)}catch(e){t.debug(`Error using selection to clean: ${e.message}`)}}else e.value="";["input","change","keyup"].forEach((t=>{const n=new Event(t,{bubbles:!0});e.dispatchEvent(n)}))}catch(e){t.debug(`Error in forced cleaning: ${e.message}`)}}emergencyCleanField(e){try{if(e.parentNode){const n=e.cloneNode(!1);e.parentNode.replaceChild(n,e);[new KeyboardEvent("keydown",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"Delete",keyCode:46,bubbles:!0}),new KeyboardEvent("keyup",{key:"Delete",keyCode:46,bubbles:!0})].forEach((e=>n.dispatchEvent(e))),t.debug("Emergency cleaning applied (node replacement)")}else t.warn("Could not apply emergency cleaning: the field has no parent node")}catch(e){t.debug(`Error in emergency cleaning: ${e.message}`)}}sendMessage(){try{const o=n.findElement(e.selectors.activeChat.sendButton);if(o)return t.debug("Send button found, clicking..."),o.click(),t.log("Message sent by clicking on the button"),!0;const a=document.querySelector(e.selectors.activeChat.messageInput);if(a){if(t.debug("Simulating Enter key in the input field..."),n.simulateKeyPress(a,"Enter",13))return t.log("Message sent simulating Enter key with simulateKeyPress"),!0;a.focus();const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(a.dispatchEvent(e))return t.log("Message sent simulating Enter key"),!0;t.warn("The keydown event was not processed by the input field");try{return document.execCommand("insertText",!1,"\n"),t.log("Message sent using execCommand"),!0}catch(e){t.debug(`execCommand failed: ${e.message}`)}}return t.error("Could not send the message - send button or input field not found"),!1}catch(e){return t.error(`Error sending message: ${e.message}`,{},e),!1}}async processChatAndAutoRespond(e){try{t.log(`Extracting data from chat ${e}`);if(!("auto"===window.CONFIG?.operationMode))return t.debug(`Auto-response deactivated for chat ${e}. The current mode is: ${window.CONFIG?.operationMode}`),!1;t.log(`Automatic mode activated (operationMode: ${window.CONFIG?.operationMode}), processing automatic response...`);const n=await this.extractChatData(e);if(!n.success)return t.error(`Error extracting chat data for automatic response: ${n.error||"Unknown error"}`),!1;if(t.debug(`AUTO mode activated (${window.CONFIG?.operationMode}), processing automatic response`),!window.responseManager)return t.error("responseManager not found to process automatic response"),!1;if(!window.openaiManager)return t.error("openaiManager not found to process automatic response"),!1;if(!("function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.apiKey&&window.openaiManager.isInitialized))return t.error("OpenAI Manager is not ready to process automatic response"),!1;const o=await window.responseManager.processAutoResponse(e,n.chatData);return t.log("Result of processAutoResponse: "+(o?"success":"failed")),o}catch(e){return t.error(`Error processing chat for automatic response: ${e.message}`,{},e),l(`Error processing automatic response: ${e.message}`,"error"),!1}}async markChatAsRead(o=null){const a=o||this.currentChatId;if(!a)return t.error("No chat ID to mark as read"),!1;t.log(`Attempting to mark chat as read: ${a}`);try{const o=['div[aria-label="Marcar como leído"]','div[aria-label="Mark as read"]','div[aria-label*="read"][role="button"]','div.xuk3077[role="row"] div[aria-label*="unread"]','div.x78zum5[role="row"] div.xzg4506:not(:empty)','div[role="grid"] div[role="row"] div.xzg4506:not(:empty)'];let i=null;if(document.querySelector(`[data-thread-id="${a}"]`)||document.querySelector(`[href*="${a}"]`))for(const e of o)if(i=document.querySelector(e),i){t.debug(`Found unread message indicator with selector: ${e}`);break}if(i&&(t.debug('Simulating click on "mark as read" indicator'),this.simulateCompatibleMouseEvents(i),await new Promise((e=>setTimeout(e,1e3))),!document.querySelector(o.join(", "))))return t.log("Chat marked as read successfully (indicator disappeared)"),!0;try{const e=document.querySelectorAll(`[data-thread-id="${a}"], [href*="${a}"]`);for(const n of e){const e=Object.keys(n).find((e=>e.startsWith("__reactFiber$")));if(e){const o=n[e];if(o){const e=o.return?.stateNode;if(e&&"function"==typeof e.markRead)return t.debug("Found Facebook internal markRead function, attempting to use"),e.markRead(),t.log("Chat marked as read using Facebook internal API"),!0}}}}catch(e){t.debug(`Error attempting to use internal API: ${e.message}`)}if(this.currentChatId===a){const o=n.findElement(e.selectors.activeChat.container);if(o)return o.scrollTop=o.scrollHeight,await new Promise((e=>setTimeout(e,1500))),t.debug("Chat marked as read by scrolling to most recent messages"),!0}return t.warn(`Could not explicitly mark chat ${a} as read, but sending response may have done it automatically`),!0}catch(e){return t.error(`Error marking chat as read: ${e.message}`),!1}}};window.chatManager=I;const C={};function E(e){try{if(!e)return null;const t=[/marketplace\/item\/(\d+)/i,/marketplace\/item\.php\?id=(\d+)/i,/item\/(\d+)/i];for(const n of t){const t=e.match(n);if(t&&t[1])return t[1]}return null}catch(e){return t.error("Error extracting product ID from URL",e),null}}function M(e,n){t.debug("[ProductExtractor] Extracting basic data from DOM...");try{let o="Marketplace";const a=e.querySelectorAll("h1, span.x193iq5w");for(const e of a)if(e.textContent&&e.textContent.trim().length>0&&"Marketplace"!==e.textContent.trim()){o=e.textContent.trim();break}let i="";const r=e.querySelectorAll('.x193iq5w.xeuugli.x13faqbe.x1vvkbs, span[dir="auto"] > span');for(const e of r)if(e.textContent&&/\$|€|£|¥|₹|₽|¢|₩|₴|₦|₫|₱/i.test(e.textContent)){i=e.textContent.trim();break}let s="";const l=e.querySelectorAll('span[dir="auto"], div[data-ad-comet-preview="message"], div[data-contents="true"]');for(const e of l)if(e.textContent&&e.textContent.length>50&&!e.textContent.includes("Marketplace")){s=e.textContent.trim();break}if(!s||s.length<50){const t=e.querySelectorAll('div[role="row"] div[dir="auto"]');t.length>0&&(s=t[t.length-1].textContent.trim())}const c=[],d=e.querySelectorAll('img[src*="scontent"], img[src*="fbcdn"]');for(const e of d)if(e.src&&!e.src.includes("profile")&&!c.includes(e.src)&&(c.push(e.src),c.length>=5))break;const u={id:n,title:o,price:i,description:s,imageUrls:c,extractedFromDOM:!0,extractedFrom:"dom-fallback"};return t.debug("[ProductExtractor] Extracted basic product details from DOM",u),u}catch(e){return t.error("[ProductExtractor] Error extracting from DOM",e),{id:n,title:"Marketplace",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"dom-error"}}}function T(e,n){return new Promise(((o,a)=>(t.debug("[ProductExtractor] Using GM_xmlhttpRequest to fetch HTML for product:",{productId:e,url:n}),C[e]?(t.debug(`[ProductExtractor] Product ${e} found in cache`),console.log("--- CACHED PRODUCT DATA ---"),console.log(JSON.stringify(C[e],null,2)),console.log("--- END PRODUCT DATA ---"),o(C[e])):"function"!=typeof GM_xmlhttpRequest?a(new Error("GM_xmlhttpRequest not available")):void GM_xmlhttpRequest({method:"GET",url:n,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"},timeout:15e3,onload:function(i){if(i.status>=200&&i.status<300)try{const a=(new DOMParser).parseFromString(i.responseText,"text/html");let r=function(e,n){t.debug("[ProductExtractor] Extracting data from embedded JSON...");const o=e.querySelectorAll("script");let a=null,i=null;for(const e of o){const n=e.textContent;if(!n)continue;const o='"adp_MarketplacePDPContainerQueryRelayPreloader_',r='"adp_MarketplacePDPC2CMediaViewerWithImagesQueryRelayPreloader_';let s=-1,l=!1;if(a||(s=n.indexOf(o),-1!==s&&(l=!0)),-1!==s||i||(s=n.indexOf(r),-1!==s&&(l=!1)),-1!==s)try{const e=n.indexOf('"',s+1);if(-1===e)continue;const o=n.indexOf(",",e);if(-1===o)continue;const r=n.indexOf("{",o);if(-1===r)continue;let c=1,d=r+1;for(;d<n.length&&c>0;){const e=n[d];if("{"===e)c++;else if("}"===e)c--;else if('"'===e)for(d++;d<n.length;){if("\\"===n[d])d++;else if('"'===n[d])break;d++}d++}if(0===c){const e=d-1,o=n.substring(r,e+1);try{const e=JSON.parse(o);if(t.debug(`[ProductExtractor] Parsed JSON (${l?"Main":"Media"}).`),l?e?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?a=e:t.debug("[ProductExtractor] Incorrect main structure."):e?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?.listing_photos?i=e:t.debug("[ProductExtractor] Incorrect media structure."),a&&i)break}catch(e){t.warn(`[ProductExtractor] Error parsing JSON (${l?"Main":"Media"}):`,e)}}}catch(e){t.error(`[ProductExtractor] Error processing script (${l?"Main":"Media"}):`,e)}}if(a)try{const e=a.__bbox.result.data.viewer.marketplace_product_details_page.target,o=e.marketplace_listing_seller,r=e.location?.reverse_geocode_detailed;let s=[];if(i)try{const e=i.__bbox.result.data.viewer.marketplace_product_details_page.target.listing_photos;e&&Array.isArray(e)&&(s=e.map((e=>e?.image?.uri)).filter(Boolean))}catch(e){t.warn("[ProductExtractor] Error extracting images from media JSON:",e)}const l=e.primary_listing_photo?.listing_image?.uri;l&&!s.includes(l)&&s.unshift(l);let c=e.formatted_price?.text||"";const d=e.listing_price?.amount||"",u=e.listing_price?.currency||"";!c&&d&&(c="COP"===u?`$${parseInt(d).toLocaleString("es-CO")} COP`:"USD"===u?`$${parseInt(d).toLocaleString("en-US")}`:"EUR"===u?`€${parseInt(d).toLocaleString("de-DE")}`:`${u} ${parseInt(d).toLocaleString()}`,t.debug(`[ProductExtractor] Manually formatted price: ${c}`));const g={source:"inline_json",title:e.marketplace_listing_title||"",description:e.redacted_description?.text||"",price:c,currency:e.listing_price?.currency||"",amount:e.listing_price?.amount||"",url:e.story?.url||n,listingId:e.id||"",image:s.length>0?s[0]:"",imageUrls:s,sellerName:o?.name||"",sellerId:o?.id||"",sellerProfilePic:o?.profile_picture?.uri||"",categoryName:e.marketplace_listing_category_name||"",isSold:e.is_sold||!1,isLive:e.is_live||!1,city:r?.city||"",state:r?.state||"",postalCode:r?.postal_code||"",extractedFrom:"inline_json"};return t.debug("[ProductExtractor] Extraction completed from embedded JSON."),g}catch(e){t.error("[ProductExtractor] Error processing main JSON data:",e)}return null}(a,n);r||(t.warn("[ProductExtractor] Inline JSON extraction failed for "+e+", trying DOM extraction fallback"),r=M(a,e)),C[e]=r,t.debug(`[ProductExtractor] Product ${e} cached`),console.log("--- EXTRACTED PRODUCT DATA ---"),console.log(JSON.stringify(r,null,2)),console.log("--- END PRODUCT DATA ---"),o(r)}catch(n){t.error("[ProductExtractor] Error parsing product HTML",n);try{const t=M((new DOMParser).parseFromString(i.responseText,"text/html"),e);C[e]=t,console.log("--- PRODUCT DATA (FALLBACK) ---"),console.log(JSON.stringify(t,null,2)),console.log("--- END PRODUCT DATA ---"),o(t)}catch(e){a(e)}}else a(new Error(`HTTP Error: ${i.status}`))},onerror:function(n){t.error("[ProductExtractor] GM_xmlhttpRequest network error for product "+e,{error:JSON.stringify(n)}),a(n)},ontimeout:function(){a(new Error("Request timeout"))}}))))}!function(){try{const e=o.get("PRODUCT_CACHE",{});Object.assign(C,e),t.debug(`Loaded ${Object.keys(C).length} cached products from storage`)}catch(e){t.error("Error loading product cache",e)}}(),setInterval((()=>{try{o.set("PRODUCT_CACHE",C),t.debug(`Saved ${Object.keys(C).length} product cache entries to storage`)}catch(e){t.error("Error saving product cache",e)}}),6e4),window.productExtractor={getProductDetails:async function(e,n=null){try{if(!e)throw new Error("Product ID is required");if(C[e])return t.debug(`Retrieved product ${e} from cache`),C[e];n||(n=`https://www.facebook.com/marketplace/item/${e}/`),t.debug(`Fetching product details for ID: ${e} from URL: ${n}`);try{return await T(e,n)}catch(n){t.warn(`Failed to fetch product ${e} from URL: ${n.message}`),t.debug("Attempting DOM extraction fallback");const o=function(){t.debug("[ProductExtractor] Attempting DOM extraction fallback for product details");try{let e=null;const n=document.querySelector('a[href*="/marketplace/item/"]');if(n&&(e=E(n.href)),!e)return t.warn("[ProductExtractor] No product ID found in current page"),null;if(C[e])return console.log("--- CACHED PRODUCT DATA (DOM) ---"),console.log(JSON.stringify(C[e],null,2)),console.log("--- END PRODUCT DATA ---"),C[e];const o=M(document,e);return C[e]=o,t.debug(`[ProductExtractor] Product ${e} cached from DOM extraction`),console.log("--- PRODUCT DATA EXTRACTED FROM DOM ---"),console.log(JSON.stringify(o,null,2)),console.log("--- END PRODUCT DATA ---"),o}catch(e){return t.error("[ProductExtractor] Error extracting product details from current page",e),null}}()||{id:e,title:"Unknown Product",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"fallback-error"};return C[e]=o,"fallback-error"===o.extractedFrom&&(console.log("--- PRODUCT DATA (DEFAULT FALLBACK) ---"),console.log(JSON.stringify(o,null,2)),console.log("--- END PRODUCT DATA ---")),o}}catch(n){throw t.error(`Error getting product details for ${e}:`,n),n}},extractProductIdFromUrl:E,extractProductIdFromCurrentChat:function(){try{t.debug("Attempting to extract product ID from current chat");const e=document.querySelectorAll('a[href*="/marketplace/item/"]');if(0===e.length){const e=document.querySelectorAll('div[role="row"] div[dir="auto"] a');for(const n of e)if(n.href&&n.href.includes("/marketplace/item/")){const e=E(n.href);if(e)return t.debug(`Found product ID ${e} from text reference`),e}const n=document.querySelectorAll('iframe[src*="marketplace"], div[data-testid*="marketplace"]');for(const e of n){const n=e.src||e.getAttribute("data-testid");if(n){const e=n.match(/marketplace\/item\/(\d+)/i);if(e&&e[1])return t.debug(`Found product ID ${e[1]} from embedded element`),e[1]}}return t.debug("No product links found in current chat"),null}const n=e[0].href,o=E(n);return o?(t.debug(`Found product ID ${o} from link`),t.debug(`Product link found: ${n}`),o):(t.debug("Could not extract product ID from link"),null)}catch(e){return t.error("Error extracting product ID from current chat:",e),null}},inspectProduct:function(e){if(!e){const t=document.querySelector('a[href*="/marketplace/item/"]');t&&(e=E(t.href))}return e&&C[e]?(console.log("--- MANUAL PRODUCT INSPECTION ---"),console.log(JSON.stringify(C[e],null,2)),console.log("--- END INSPECTION ---"),C[e]):(console.error("No product with ID "+e+" in cache to inspect"),null)}};class S{constructor(){this.apiKey=o.get("FB_CHAT_MONITOR_OPENAI_KEY","")||"",this.model="gpt-4.1-mini",this.isInitialized=!1,this.activeThreads=new Map,this.threadTTL=18e5,this.assistants={seller:o.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),buyer:o.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),default:o.get("FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","")},this.metrics={totalCalls:0,successfulCalls:0,failedCalls:0,totalTokensUsed:0,avgResponseTime:0,totalResponseTime:0}}initialize(n=null){try{return n&&(this.apiKey=n,e.AI.apiKey=n,o.set("FB_CHAT_MONITOR_OPENAI_KEY",n),e.audioTranscription&&(e.audioTranscription.apiKey=n)),this.model="gpt-4.1-mini",e.AI.model="gpt-4.1-mini",this.apiKey?(this.isInitialized=!0,t.debug("initialize(): API key present, setting isInitialized=true")):(this.isInitialized=!1,t.debug("initialize(): No API key, setting isInitialized=false")),t.log("OpenAI Manager initialized: "+(this.isInitialized?"SUCCESS":"FAILED - No API Key")),setInterval((()=>this.cleanupOldThreads()),9e5),this.schedulePeriodicChecks(),this.isInitialized}catch(e){return t.error(`Error initializing OpenAI Manager: ${e.message}`),!1}}loadConfig(e=null){return t.debug("loadConfig() called - redirecting to initialize()"),this.initialize(e)}async setApiKey(t){this.apiKey=t,e.AI.apiKey=t,o.set("FB_CHAT_MONITOR_OPENAI_KEY",t);const n=await this.validateApiKey();return this.isInitialized=n,n}verifyServiceState(){if(t.log("Verifying OpenAI service status..."),this!==window.openaiManager&&(t.warn("Incorrect openaiManager instance, correcting reference..."),Object.assign(this,window.openaiManager)),!this.isInitialized||!this.apiKey)if(t.debug("OpenAI Manager is not initialized, attempting to recover state"),e?.AI?.apiKey)t.debug("Using API key from CONFIG to initialize OpenAI Manager"),this.apiKey=e.AI.apiKey,this.isInitialized=!0;else{const e=o.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(t.debug("Using API key from localStorage to initialize OpenAI Manager"),this.apiKey=e,this.isInitialized=!0)}const n=!!this.apiKey;return n&&!this.isInitialized&&(this.isInitialized=!0,t.debug("Correcting isInitialized to TRUE because we have apiKey")),t.log("Final status of OpenAI Manager: "+(n?"AVAILABLE":"NOT AVAILABLE")),t.debug(`Details: apiKey exists=${!!this.apiKey}, isInitialized=${this.isInitialized}, isReady()=${n}`),n}schedulePeriodicChecks(){setInterval((()=>this.verifyServiceState()),6e4),t.debug("Periodic service checks scheduled")}isReady(){return!!this.apiKey&&(this.isInitialized||(this.isInitialized=!0,t.debug("Auto-corrected isInitialized to true since API key exists")),!0)}async validateApiKey(){if(!this.apiKey)return!1;try{const e=await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"}});if(e.ok)return t.log("API key validated successfully"),!0;{const n=await e.json();return t.error(`API key validation failed: ${n.error?.message||"Unknown error"}`),!1}}catch(e){return t.error(`API key validation error: ${e.message}`),!1}}async generateResponse(e){if(!this.isReady()&&(this.verifyServiceState(),!this.isReady()))return t.warn("OpenAI Manager is not ready to generate responses"),{text:"I'm sorry, I can't generate a response because I don't have access to the OpenAI API. Please verify your API key in the configuration.",error:!0};const n=Date.now();this.metrics.totalCalls++;try{this.clearInputField();const o=this.getAssistantIdForRole(e.role);if(!o)throw new Error(`No assistant configured for role: ${e.role}`);t.debug(`Using assistant ${o} for role ${e.role}`);const a=await this.getOrCreateThread(e.chatId);await this.addMessageToThread(a.id,e);const i=await this.runAssistant(a.id,o);this.metrics.successfulCalls++;const r=Date.now()-n;return this.metrics.totalResponseTime+=r,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.successfulCalls,t.debug(`Response generated in ${r}ms`),i}catch(e){throw this.metrics.failedCalls++,t.error(`Error generating response: ${e.message}`),e}}clearInputField(){try{const n=document.querySelector(e.selectors.activeChat.messageInput);if(!n)return t.error("Message input field to clear not found"),!1;const o="true"===n.getAttribute("contenteditable"),a=o?(n.textContent||"").trim():(n.value||"").trim();if(!a)return t.debug("Field is already empty, no cleaning needed"),!0;t.debug(`Field has previous content (${a.length} chars): "${a.substring(0,30)}..."`);const i=document.activeElement;if(o){n.innerHTML="",n.textContent="",n.focus(),document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null);const e=document.createRange();e.selectNodeContents(n);const t=window.getSelection();t.removeAllRanges(),t.addRange(e),t.deleteFromDocument(),setTimeout((()=>{n.textContent="",n.innerHTML=""}),0)}else"INPUT"!==n.tagName&&"TEXTAREA"!==n.tagName||(n.value="",n.setAttribute("value",""));if(["input","change","keyup","keydown"].forEach((e=>{n.dispatchEvent(new Event(e,{bubbles:!0}))})),setTimeout((()=>{const e=o?(n.textContent||"").trim():(n.value||"").trim();if(e){t.warn(`Cleaning not effective, remaining content: "${e.substring(0,30)}..."`);try{if(o){n.innerHTML="";const e=n.parentNode;if(e){const t=n.cloneNode(!1);e.replaceChild(t,n),t.dispatchEvent(new Event("input",{bubbles:!0}))}}else"INPUT"!==n.tagName&&"TEXTAREA"!==n.tagName||(Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(n,""),n.dispatchEvent(new Event("input",{bubbles:!0})))}catch(e){t.debug(`Error in emergency cleaning: ${e.message}`)}}else t.debug("Verification: Field clean after process")}),50),i!==n&&i)try{i.focus()}catch(e){}return t.debug("Aggressive cleaning of the input field completed"),!0}catch(e){return t.error(`Error in clearInputField: ${e.message}`,{},e),!1}}getAssistantIdForRole(n){let o=this.assistants[n];return o||(o=this.assistants.default,t.debug(`No assistant for role ${n}, using default assistant`)),o||("seller"===n&&e.AI?.assistants?.seller?.id?o=e.AI.assistants.seller.id:"buyer"===n&&e.AI?.assistants?.buyer?.id&&(o=e.AI.assistants.buyer.id)),o}async getOrCreateThread(e){const n=this.activeThreads.get(e);if(n&&Date.now()-n.lastUsed<this.threadTTL)return n.lastUsed=Date.now(),this.activeThreads.set(e,n),n;try{const n=await fetch("https://api.openai.com/v1/threads",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({})});if(!n.ok){const e=await n.json();throw new Error(e.error?.message||"Failed to create thread")}const o=await n.json();return this.activeThreads.set(e,{id:o.id,lastUsed:Date.now()}),t.debug(`Created new thread ${o.id} for chat ${e}`),o}catch(e){throw t.error(`Error creating thread: ${e.message}`),e}}async addMessageToThread(e,n){try{const o=this.prepareMessageContent(n),a=await fetch(`https://api.openai.com/v1/threads/${e}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({role:"user",content:o})});if(!a.ok){const e=await a.json();throw new Error(e.error?.message||"Failed to add message to thread")}return t.debug(`Added message to thread ${e}`),await a.json()}catch(e){throw t.error(`Error adding message to thread: ${e.message}`),e}}prepareMessageContent(n){const{role:o,messages:a,productDetails:i,analysis:r}=n,s=[{type:"text",text:JSON.stringify({role:o,product:i?{id:i.id,title:i.title,price:i.price,description:i.description,condition:i.condition,location:i.location,category:i.category,imageUrls:i.imageUrls||[]}:null,conversation:a.slice(-(e.AI.messageHistoryLimit||100)).map((e=>{if(!e||!e.content)return{fromUser:!e?.sentByUs,error:"Invalid message structure"};const t={fromUser:!e.sentByUs,timestamp:e.timestamp};return e.content.text&&(t.text=e.content.text),e.content.transcribedAudio&&"string"==typeof e.content.transcribedAudio&&!e.content.transcribedAudio.startsWith("[")?t.transcribedAudio=e.content.transcribedAudio:e.content.audioUrl&&(t.hasAudio=!0,"string"==typeof e.content.transcribedAudio&&e.content.transcribedAudio.startsWith("[")&&(t.audioStatus=e.content.transcribedAudio)),e.content.imageUrls&&Array.isArray(e.content.imageUrls)&&e.content.imageUrls.length>0&&(t.imageUrls=e.content.imageUrls),t})),analysis:r||null})}];return t.debug("[OpenAIManager] Prepared message content for API:",{textLength:s[0].text.length}),s}async runAssistant(e,n){try{const o=await fetch(`https://api.openai.com/v1/threads/${e}/runs`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({assistant_id:n})});if(!o.ok){const e=await o.json();throw new Error(e.error?.message||"Failed to start run")}const a=await o.json();t.debug(`Started run ${a.id} on thread ${e}`);await this.pollRunUntilComplete(e,a.id);return await this.getAssistantResponseFromRun(e,a.id)}catch(e){throw t.error(`Error running assistant: ${e.message}`),e}}async pollRunUntilComplete(e,n){let o=0,a=null,i=1e3;const r=Date.now();for(;o<60&&Date.now()-r<3e4;){o++;const r=await fetch(`https://api.openai.com/v1/threads/${e}/runs/${n}`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!r.ok){const e=await r.json();throw new Error(e.error?.message||"Failed to check run status")}if(a=await r.json(),["completed","failed","cancelled","expired"].includes(a.status))break;t.debug(`Run ${n} status: ${a.status}, attempt ${o}`),await new Promise((e=>setTimeout(e,i))),i=Math.min(1.5*i,5e3)}if("completed"!==a.status)throw new Error(`Run failed with status: ${a.status}`);return a}async getAssistantResponseFromRun(e,n){try{const t=await fetch(`https://api.openai.com/v1/threads/${e}/messages`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!t.ok){const e=await t.json();throw new Error(e.error?.message||"Failed to retrieve messages")}const n=(await t.json()).data.find((e=>"assistant"===e.role));if(!n)throw new Error("No assistant message found");if(n.content&&n.content.length>0){const e=n.content.find((e=>"text"===e.type));if(e)return e.text.value}throw new Error("No text content found in assistant message")}catch(e){throw t.error(`Error retrieving assistant response: ${e.message}`),e}}setAssistantForRole(e,n){if(!["seller","buyer","default"].includes(e))throw new Error(`Invalid role: ${e}`);this.assistants[e]=n,o.set(`FB_CHAT_MONITOR_${e.toUpperCase()}_ASSISTANT_ID`,n),t.log(`Set assistant ${n} for role ${e}`)}async createOrUpdateAssistant(e,t,n){if(!this.isInitialized)throw new Error("API key not initialized");let o=this.assistants[e];const a={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"};if(o){const e=await fetch(`https://api.openai.com/v1/assistants/${o}`,{method:"PATCH",headers:a,body:JSON.stringify({name:t,instructions:n})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to update assistant")}}else{const e=await fetch("https://api.openai.com/v1/assistants",{method:"POST",headers:a,body:JSON.stringify({name:t,instructions:n})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to create assistant")}o=(await e.json()).id}return this.assistants[e]=o,o}async listAssistants(){try{const e=await fetch("https://api.openai.com/v1/assistants?limit=100",{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to list assistants")}return(await e.json()).data}catch(e){throw t.error(`Error listing assistants: ${e.message}`),e}}cleanupOldThreads(){const e=Date.now();let n=0;for(const[t,o]of this.activeThreads.entries())e-o.lastUsed>this.threadTTL&&(this.activeThreads.delete(t),n++);n>0&&t.debug(`Cleaned up ${n} expired threads`)}getMetrics(){return{...this.metrics,activeThreads:this.activeThreads.size}}}const O=new S;window.openaiManager=O,console.log("[OpenAI Manager] Instance exposed globally as window.openaiManager"),window.openaiManager&&window.openaiManager.isReady||(console.warn("[OpenAI Manager] OpenAI Manager not available or missing necessary methods, reinstalling..."),window.openaiManager=O,"function"!=typeof window.openaiManager.initialize&&(console.error("[OpenAI Manager] CRITICAL ERROR! The initialize method is not available after reinstalling"),window.openaiManager.initialize=function(e=null){return O.initialize(e)}),"function"!=typeof window.openaiManager.isReady&&(window.openaiManager.isReady=function(){return!!window.openaiManager.apiKey}),"function"!=typeof window.openaiManager.verifyServiceState&&(window.openaiManager.verifyServiceState=function(){return O.verifyServiceState()})),e?.AI?.apiKey&&!window.openaiManager.apiKey&&(window.openaiManager.apiKey=e.AI.apiKey,window.openaiManager.isInitialized=!0),console.log("[OpenAI Manager] Status after global verification:",`apiKey=${!!window.openaiManager.apiKey}`,`isInitialized=${window.openaiManager.isInitialized}`,`isReady=${"function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():"method not available"}`),window.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{window.openaiManager||(console.error("[OpenAI Manager] Error: openaiManager not detected in window after DOMContentLoaded. Reinstalling..."),window.openaiManager=O),window.openaiManager.isReady()&&"function"==typeof window.openaiManager.listAssistants&&(console.log("[OpenAI Manager] Starting automatic loading of assistants..."),window.openaiManager.listAssistants().then((e=>{console.log(`[OpenAI Manager] ${e.length} assistants found automatically`),window.updateAssistantsList&&window.updateAssistantsList(e)})).catch((e=>{console.warn("[OpenAI Manager] Error loading assistants automatically:",e.message)})))}),1e3)}));const k=new class{constructor(){this.initialized=!1}initialize(){this.initialized||(this.createStyles(),this.createPanel(),this.attachEvents(),this.initialized=!0,t.debug("Assistant Manager UI initialized"))}createStyles(){const e=document.createElement("style");e.textContent="\n          .assistant-manager-panel {\n            position: fixed;\n            right: 20px;\n            top: 60px;\n            width: 300px;\n            background: white;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n            overflow: hidden;\n            z-index: 9999;\n            font-family: Arial, sans-serif;\n            transition: all 0.3s ease;\n          }\n\n          .assistant-manager-header {\n            background: #1877f2;\n            color: white;\n            padding: 10px 15px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n          }\n\n          .assistant-manager-content {\n            padding: 15px;\n            max-height: 400px;\n            overflow-y: auto;\n          }\n\n          .assistant-manager-field {\n            margin-bottom: 15px;\n          }\n\n          .assistant-manager-field label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: bold;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field input,\n          .assistant-manager-field textarea {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field textarea {\n            height: 80px;\n            resize: vertical;\n          }\n\n          .assistant-manager-tabs {\n            display: flex;\n            border-bottom: 1px solid #ddd;\n          }\n\n          .assistant-manager-tab {\n            padding: 8px 15px;\n            cursor: pointer;\n            border-bottom: 2px solid transparent;\n          }\n\n          .assistant-manager-tab.active {\n            border-bottom: 2px solid #1877f2;\n            font-weight: bold;\n          }\n\n          .assistant-manager-tab-content {\n            display: none;\n            padding-top: 10px;\n          }\n\n          .assistant-manager-tab-content.active {\n            display: block;\n          }\n\n          .assistant-manager-button {\n            background: #1877f2;\n            color: white;\n            border: none;\n            padding: 8px 15px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin-top: 5px;\n          }\n\n          .assistant-manager-button:hover {\n            background: #166fe5;\n          }\n\n          .assistant-manager-status {\n            margin-top: 10px;\n            padding: 8px;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-status.success {\n            background: #e6f7e6;\n            color: #25a025;\n          }\n\n          .assistant-manager-status.error {\n            background: #ffebeb;\n            color: #e60000;\n          }\n\n          .assistant-manager-toggle {\n            position: fixed;\n            right: 20px;\n            top: 20px;\n            background: #1877f2;\n            color: white;\n            border: none;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n            z-index: 9999;\n            font-size: 20px;\n          }\n\n          .hidden {\n            display: none;\n          }\n        ",document.head.appendChild(e)}createPanel(){const t=document.createElement("button");t.className="assistant-manager-toggle",t.innerHTML="🤖",t.title="Manage Assistants",document.body.appendChild(t);const n=document.createElement("div");n.className="assistant-manager-panel hidden";const o=document.createElement("div");o.className="assistant-manager-header",o.innerHTML='<span>Assistant Management</span><span id="assistant-close">✕</span>',n.appendChild(o);const a=document.createElement("div");a.className="assistant-manager-content";const i=document.createElement("div");i.className="assistant-manager-field",i.innerHTML=`\n          <label for="openai-api-key">OpenAI API Key:</label>\n          <input type="password" id="openai-api-key" placeholder="sk-..." value="${e.AI.apiKey||""}">\n          <button id="save-api-key" class="assistant-manager-button">Save</button>\n        `,a.appendChild(i);const r=document.createElement("div");r.className="assistant-manager-tabs",r.innerHTML='\n          <div class="assistant-manager-tab active" data-tab="seller">Seller</div>\n          <div class="assistant-manager-tab" data-tab="buyer">Buyer</div>\n        ',a.appendChild(r);const s=document.createElement("div"),l=document.createElement("div");l.className="assistant-manager-tab-content active",l.id="tab-seller",l.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-name">Name:</label>\n            <input type="text" id="seller-assistant-name" value="${e.AI.assistants.seller.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-instructions">Instructions:</label>\n            <textarea id="seller-assistant-instructions">${e.AI.assistants.seller.instructions||""}</textarea>\n          </div>\n          <button id="save-seller-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="seller-assistant-status" class="assistant-manager-status hidden"></div>\n        `,s.appendChild(l);const c=document.createElement("div");c.className="assistant-manager-tab-content",c.id="tab-buyer",c.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-name">Name:</label>\n            <input type="text" id="buyer-assistant-name" value="${e.AI.assistants.buyer.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-instructions">Instructions:</label>\n            <textarea id="buyer-assistant-instructions">${e.AI.assistants.buyer.instructions||""}</textarea>\n          </div>\n          <button id="save-buyer-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="buyer-assistant-status" class="assistant-manager-status hidden"></div>\n        `,s.appendChild(c),a.appendChild(s),n.appendChild(a),document.body.appendChild(n),this.panel=n,this.toggleButton=t}attachEvents(){this.toggleButton.addEventListener("click",(()=>this.panel.classList.toggle("hidden"))),document.getElementById("assistant-close").addEventListener("click",(()=>this.panel.classList.add("hidden"))),document.querySelectorAll(".assistant-manager-tab").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".assistant-manager-tab").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".assistant-manager-tab-content").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.getElementById(`tab-${e.dataset.tab}`).classList.add("active")}))})),document.getElementById("save-api-key").addEventListener("click",(async()=>{const t=document.getElementById("openai-api-key").value.trim();if(t)try{e.AI.apiKey=t,localStorage.setItem("FB_CHAT_MONITOR_OPENAI_KEY",t);const n=this.openAIInitialized=O.initialize(t);this.showStatus(n?"success":"error",n?"API Key saved":"Invalid API Key")}catch(e){this.showStatus("error",`Error: ${e.message}`)}else this.showStatus("error","Please enter a valid API Key")})),document.getElementById("save-seller-assistant").addEventListener("click",(()=>this.saveAssistant("seller"))),document.getElementById("save-buyer-assistant").addEventListener("click",(()=>this.saveAssistant("buyer")))}async saveAssistant(t){const n=document.getElementById(`${t}-assistant-name`).value.trim(),o=document.getElementById(`${t}-assistant-instructions`).value.trim(),a=document.getElementById(`${t}-assistant-status`);if(n&&o)if(e.AI.apiKey){this.showStatus("info","Saving assistant...",a);try{const i=await O.createOrUpdateAssistant(t,n,o);e.AI.assistants[t]={id:i,name:n,instructions:o},localStorage.setItem(`FB_CHAT_MONITOR_${t.toUpperCase()}_ASSISTANT_ID`,i),this.showStatus("success",`Assistant "${n}" saved`,a)}catch(e){this.showStatus("error",`Error: ${e.message}`,a)}}else this.showStatus("error","Set API Key first",a);else this.showStatus("error","Complete all fields",a)}showStatus(e,t,n=null){const o=n||document.querySelector(".assistant-manager-status");o&&(o.textContent=t,o.className=`assistant-manager-status ${e}`,o.classList.remove("hidden"),setTimeout((()=>o.classList.add("hidden")),5e3))}};window.assistantManagerUI=k;const _={isControlPanelVisible:!1,activeTab:"dashboard",floatingButton:null,controlPanel:null,statusIndicator:null,floatingResponseButton:null};function $(){_.floatingButton=function(){const e=document.createElement("div");e.id="fb-chat-monitor-button",e.style.position="fixed",e.style.top="20px",e.style.right="60px",e.style.bottom="auto",e.style.left="auto",e.style.padding="10px 15px",e.style.backgroundColor="#4267B2",e.style.color="white",e.style.borderRadius="5px",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.style.cursor="pointer",e.style.zIndex="9999",e.style.display="flex",e.style.alignItems="center",e.style.transition="all 0.3s ease",e.style.fontFamily="Arial, sans-serif";const t=document.createElement("div");t.id="fb-chat-monitor-status-dot",t.style.width="10px",t.style.height="10px",t.style.backgroundColor="#4CAF50",t.style.borderRadius="50%",t.style.marginRight="8px",e.appendChild(t);const n=document.createElement("span");return n.textContent="FB Chat Monitor",e.appendChild(n),e.addEventListener("mouseover",(function(){this.style.backgroundColor="#365899"})),e.addEventListener("mouseout",(function(){this.style.backgroundColor="#4267B2"})),e.addEventListener("click",N),document.body.appendChild(e),_.statusIndicator=t,e}(),function(){const e="\n        .fb-chat-monitor-panel {\n          position: fixed;\n          bottom: 80px;\n          right: 20px;\n          width: 380px;\n          max-width: 90vw;\n          background-color: white;\n          border-radius: 8px;\n          box-shadow: 0 2px 20px rgba(0,0,0,0.2);\n          z-index: 9998;\n          font-family: Arial, sans-serif;\n          display: flex;\n          flex-direction: column;\n          max-height: calc(100vh - 100px);\n          transition: all 0.3s ease;\n          overflow: hidden;\n        }\n\n        .fb-chat-monitor-panel-header {\n          padding: 15px;\n          background-color: #4267B2;\n          color: white;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-radius: 8px 8px 0 0;\n        }\n\n        .fb-chat-monitor-panel-header h2 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n        }\n\n        .fb-chat-monitor-close {\n          background: none;\n          border: none;\n          color: white;\n          font-size: 20px;\n          cursor: pointer;\n          padding: 0;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 24px;\n          height: 24px;\n        }\n\n        .fb-chat-monitor-panel-tabs {\n          display: flex;\n          border-bottom: 1px solid #ddd;\n          background-color: #f5f5f5;\n        }\n\n        .fb-chat-monitor-tab {\n          padding: 10px 15px;\n          cursor: pointer;\n          position: relative;\n          flex: 1;\n          text-align: center;\n          color: #666;\n          font-size: 14px;\n          transition: all 0.2s ease;\n        }\n\n        .fb-chat-monitor-tab:hover {\n          background-color: rgba(66, 103, 178, 0.05);\n        }\n\n        .fb-chat-monitor-tab.active {\n          color: #4267B2;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-tab.active::after {\n          content: '';\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          width: 100%;\n          height: 3px;\n          background-color: #4267B2;\n        }\n\n        .fb-chat-monitor-panel-content {\n          flex: 1;\n          overflow-y: auto;\n          padding: 15px;\n        }\n\n        .fb-chat-monitor-tab-content {\n          display: none;\n          animation: fadeIn 0.3s ease;\n        }\n\n        .fb-chat-monitor-tab-content.active {\n          display: block;\n        }\n\n        .fb-chat-monitor-status-section {\n          display: flex;\n          align-items: center;\n          margin-bottom: 15px;\n          padding-bottom: 10px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-status-indicator {\n          width: 12px;\n          height: 12px;\n          border-radius: 50%;\n          margin-right: 10px;\n        }\n\n        .fb-chat-monitor-status-text {\n          flex: 1;\n        }\n\n        .fb-chat-monitor-stats-grid {\n          display: grid;\n          grid-template-columns: repeat(2, 1fr);\n          gap: 10px;\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-stat-item {\n          background-color: #f9f9f9;\n          border-radius: 6px;\n          padding: 10px;\n          text-align: center;\n        }\n\n        .fb-chat-monitor-stat-value {\n          font-size: 18px;\n          font-weight: bold;\n          color: #4267B2;\n          margin-bottom: 5px;\n        }\n\n        .fb-chat-monitor-stat-label {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-form-group {\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-form-group label {\n          display: block;\n          font-size: 14px;\n          margin-bottom: 5px;\n          color: #444;\n        }\n\n        .fb-chat-monitor-form-group input,\n        .fb-chat-monitor-form-group select {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid #ddd;\n          border-radius: 4px;\n          font-size: 14px;\n        }\n\n        .fb-chat-monitor-radio-group {\n          margin: 10px 0;\n        }\n\n        .fb-chat-monitor-radio-option {\n          display: flex;\n          align-items: center;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-radio-option input {\n          margin-right: 8px;\n          width: auto;\n        }\n\n        .fb-chat-monitor-radio-label {\n          display: flex;\n          flex-direction: column;\n        }\n\n        .fb-chat-monitor-radio-label span:first-child {\n          font-weight: 500;\n        }\n\n        .fb-chat-monitor-radio-label span:last-child {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-button {\n          padding: 8px 12px;\n          background-color: #4267B2;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n          margin-right: 8px;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-button:hover {\n          background-color: #365899;\n        }\n\n        .fb-chat-monitor-button-secondary {\n          background-color: #eaeaea;\n          color: #333;\n        }\n\n        .fb-chat-monitor-button-secondary:hover {\n          background-color: #d5d5d5;\n        }\n\n        .fb-chat-monitor-button-danger {\n          background-color: #f44336;\n        }\n\n        .fb-chat-monitor-button-danger:hover {\n          background-color: #d32f2f;\n        }\n\n        .fb-chat-monitor-button-success {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-button-success:hover {\n          background-color: #388E3C;\n        }\n\n        .fb-chat-monitor-logs-container {\n          border: 1px solid #eee;\n          border-radius: 4px;\n          max-height: 200px;\n          overflow-y: auto;\n          font-size: 12px;\n          font-family: monospace;\n        }\n\n        .fb-chat-monitor-log-entry {\n          padding: 5px 8px;\n          border-bottom: 1px solid #f0f0f0;\n        }\n\n        .fb-chat-monitor-log-entry:last-child {\n          border-bottom: none;\n        }\n\n        .fb-chat-monitor-log-INFO {\n          color: #2196F3;\n        }\n\n        .fb-chat-monitor-log-ERROR {\n          color: #f44336;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-log-WARN {\n          color: #ff9800;\n        }\n\n        .fb-chat-monitor-log-time {\n          color: #666;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-history-container {\n          width: 100%;\n          border-collapse: collapse;\n          margin-top: 10px;\n          font-size: 13px;\n        }\n\n        .fb-chat-monitor-history-container th {\n          background-color: #f5f5f5;\n          text-align: left;\n          padding: 8px;\n          border-bottom: 2px solid #ddd;\n        }\n\n        .fb-chat-monitor-history-container td {\n          padding: 8px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-history-container tr:hover {\n          background-color: #f9f9f9;\n          cursor: pointer;\n        }\n\n        .fb-chat-monitor-badge {\n          display: inline-block;\n          padding: 3px 6px;\n          border-radius: 10px;\n          font-size: 11px;\n          color: white;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-badge-auto {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-manual {\n          background-color: #2196F3;\n        }\n\n        .fb-chat-monitor-badge-generate {\n          background-color: #ff9800;\n        }\n\n        .fb-chat-monitor-badge-sent {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-notsent {\n          background-color: #f44336;\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        /* Tooltip styles */\n        .fb-chat-monitor-tooltip {\n          position: relative;\n          display: inline-block;\n        }\n\n        .fb-chat-monitor-tooltip .fb-chat-monitor-tooltiptext {\n          visibility: hidden;\n          width: 200px;\n          background-color: rgba(0, 0, 0, 0.8);\n          color: #fff;\n          text-align: center;\n          border-radius: 6px;\n          padding: 5px;\n          position: absolute;\n          z-index: 1;\n          bottom: 125%;\n          left: 50%;\n          transform: translateX(-50%);\n          opacity: 0;\n          transition: opacity 0.3s;\n          font-size: 12px;\n        }\n\n        .fb-chat-monitor-tooltip:hover .fb-chat-monitor-tooltiptext {\n          visibility: visible;\n          opacity: 1;\n        }\n      ";n.injectStyles(e)}();const e=o.get("UI_STATE",{});e.activeTab&&(_.activeTab=e.activeTab),t.debug("UI initialized"),_.floatingResponseButton=function(){const e=document.createElement("button");return e.id="fbChatMonitorQuickResponse",e.classList.add("fb-chat-monitor-floating-button"),e.textContent="✨ Generate Response",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="9998",e.style.padding="8px 12px",e.style.backgroundColor="#1877f2",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="13px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",e.style.display="none",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#166fe5"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#1877f2"})),e.addEventListener("click",(e=>{e.stopPropagation(),window.chatManager&&"function"==typeof window.chatManager.generateResponseForCurrentChat?window.chatManager.generateResponseForCurrentChat():(console.error("chatManager not available or generateResponseForCurrentChat method not found"),l("Error: Could not generate response. Try opening the full panel.","error"))})),e}(),document.body.appendChild(_.floatingResponseButton),setInterval(j,2e3)}function N(){if(_.controlPanel)return _.controlPanel.remove(),_.controlPanel=null,_.isControlPanelVisible=!1,_.isControlPanelMinimized=!1,void j();_.controlPanel=function(){const n=document.createElement("div");n.id="fbChatMonitorPanel",n.className="fb-chat-monitor-panel";const a=document.getElementById("fbChatMonitorButton");if(n.style.position="fixed",n.style.width="390px",n.style.padding="10px",n.style.backgroundColor="#fff",n.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",n.style.borderRadius="8px",n.style.zIndex="9999",n.style.display="block",a){const e=a.getBoundingClientRect();n.style.top=`${e.bottom+5}px`,n.style.right=window.innerWidth-e.right+"px"}else n.style.top="60px",n.style.right="20px";n.style.height="500px",n.style.overflowY="auto";const i=document.createElement("div");i.className="fb-chat-monitor-panel-header";const r=document.createElement("h2");r.textContent=`FB Chat Monitor v${e.version||"1.0"}`;const s=document.createElement("button");s.className="fb-chat-monitor-close",s.innerHTML="&times;",s.addEventListener("click",N),i.appendChild(r),i.appendChild(s),n.appendChild(i);const c=document.createElement("div");c.className="fb-chat-monitor-panel-tabs";[{id:"dashboard",label:"Dashboard"},{id:"assistants",label:"Assistants"},{id:"config",label:"Settings"},{id:"logs",label:"Logs"},{id:"history",label:"History"}].forEach((e=>{const t=document.createElement("div");t.className="fb-chat-monitor-tab "+(_.activeTab===e.id?"active":""),t.setAttribute("data-tab",e.id),t.textContent=e.label,t.addEventListener("click",(()=>{document.querySelectorAll(".fb-chat-monitor-tab").forEach((e=>{e.classList.remove("active")})),t.classList.add("active"),R(e.id),_.activeTab=e.id,o.set("UI_STATE",{activeTab:e.id})})),c.appendChild(t)})),n.appendChild(c);const d=document.createElement("div");d.className="fb-chat-monitor-panel-content";const u=document.createElement("div");u.className="fb-chat-monitor-tab-content",u.id="fb-chat-monitor-tab-dashboard",u.innerHTML='\n        <div class="fb-chat-monitor-form-group"\n             style="display:flex; justify-content:center; align-items:center; gap:8px; text-align:center;">\n          <label for="fb-chat-monitor-mode-toggle" style="margin:0;">\n            Auto Mode (Automatically send responses)\n          </label>\n          <select id="fb-chat-monitor-mode-toggle"\n                  style="width:auto; padding:4px 8px; text-align:center;\n                         background-color:#dc3545; color:white; border:none; border-radius:4px;">\n            <option value="on">ON</option>\n            <option value="off" selected>OFF</option>\n          </select>\n        </div>\n\n        <div class="fb-chat-monitor-stats-grid">\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-processed" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Chats Processed</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-responses" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Responses Sent</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-uptime" class="fb-chat-monitor-stat-value">0m</div>\n            <div class="fb-chat-monitor-stat-label">Uptime</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-errors" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Errors</div>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group" style="text-align:center;">\n          <button\n            id="fb-chat-monitor-generate-response"\n            class="fb-chat-monitor-button"\n            disabled\n          >\n            Generate Response\n          </button>\n        </div>\n      ',d.appendChild(u);const g=document.createElement("div");g.className="fb-chat-monitor-tab-content",g.id="fb-chat-monitor-tab-assistants",g.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <label for="fb-chat-monitor-openai-key">OpenAI API Key</label>\n          <input type="password" id="fb-chat-monitor-openai-key" placeholder="sk-..." value="${e.AI.apiKey||""}">\n          <button id="fb-chat-monitor-save-api-key" class="fb-chat-monitor-button" style="margin-top: 8px;">Save API Key</button>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Seller Assistant</h4>\n          <div id="fb-chat-monitor-seller-assistant-container">\n            <label for="fb-chat-monitor-seller-assistant">Select Seller Assistant</label>\n            <select id="fb-chat-monitor-seller-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're selling an item</small>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Buyer Assistant</h4>\n          <div id="fb-chat-monitor-buyer-assistant-container">\n            <label for="fb-chat-monitor-buyer-assistant">Select Buyer Assistant</label>\n            <select id="fb-chat-monitor-buyer-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're buying an item</small>\n          </div>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-refresh-assistants" class="fb-chat-monitor-button">Refresh Assistants</button>\n        </div>\n      `,d.appendChild(g);const m=document.createElement("div");m.className="fb-chat-monitor-tab-content",m.id="fb-chat-monitor-tab-config",m.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 0; margin-bottom: 10px;">Monitoring Settings</h4>\n\n          <label for="fb-chat-monitor-scan-interval">Scan interval (seconds)</label>\n          <input type="number" id="fb-chat-monitor-scan-interval" min="5" max="300" value="${Math.floor((e.scanInterval||3e4)/1e3)}">\n          <small style="display:block; margin-top:5px; color:#666;">How often to check for new messages</small>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Human Simulation</h4>\n\n          <label for="fb-chat-monitor-typing-speed">Typing speed (characters per second)</label>\n          <input type="number" id="fb-chat-monitor-typing-speed" min="1" max="20" value="${e.AI?.humanSimulation?.baseTypingSpeed||5}">\n          <small style="display:block; margin-top:5px; color:#666;">Higher values = faster typing</small>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-save-config" class="fb-chat-monitor-button">Save Settings</button>\n          <button id="fb-chat-monitor-reset-config" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Reset to Defaults</button>\n        </div>\n      `,d.appendChild(m);const p=document.createElement("div");p.className="fb-chat-monitor-tab-content",p.id="fb-chat-monitor-tab-logs",p.innerHTML='\n        <div class="fb-chat-monitor-form-group" style="display:flex; justify-content:space-between; align-items:center;">\n          <div>\n            <label for="fb-chat-monitor-log-level">Log Level</label>\n            <select id="fb-chat-monitor-log-level">\n              <option value="all">All Logs</option>\n              <option value="error">Errors Only</option>\n              <option value="warn">Warnings & Errors</option>\n              <option value="info">Info & Above</option>\n            </select>\n          </div>\n          <div>\n            <button id="fb-chat-monitor-refresh-logs" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-logs" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear Logs</button>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-logs-container" id="fb-chat-monitor-logs-list">\n          <div class="fb-chat-monitor-log-entry">\n            <span class="fb-chat-monitor-log-time">Loading logs...</span>\n          </div>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-logs" class="fb-chat-monitor-button">Export Logs</button>\n        </div>\n      ',d.appendChild(p);const h=document.createElement("div");return h.className="fb-chat-monitor-tab-content",h.id="fb-chat-monitor-tab-history",h.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">\n          <h4 style="margin: 0;">Conversation History</h4>\n          <div>\n            <button id="fb-chat-monitor-refresh-history" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-history" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear</button>\n          </div>\n        </div>\n\n        <div id="fb-chat-monitor-history-container" style="max-height: 300px; overflow-y: auto;">\n          <table class="fb-chat-monitor-history-container">\n            <thead>\n              <tr>\n                <th>Time</th>\n                <th>Mode</th>\n                <th>Content</th>\n                <th>Status</th>\n              </tr>\n            </thead>\n            <tbody id="fb-chat-monitor-history-list">\n              <tr>\n                <td colspan="4" style="text-align: center;">Loading history...</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-history" class="fb-chat-monitor-button">Export History</button>\n        </div>\n      ',d.appendChild(h),n.appendChild(d),document.body.appendChild(n),function(){const n=[{value:"on",text:"ON",color:"#28a745"},{value:"off",text:"OFF",color:"#dc3545"}],o=document.getElementById("fb-chat-monitor-mode-toggle").parentNode,a="auto"===e.operationMode?"on":"off",i=document.createElement("div");i.className="fb-chat-monitor-custom-dropdown",i.style.position="relative",i.style.display="inline-block",i.style.minWidth="60px";const r=document.createElement("div");r.className="fb-chat-monitor-dropdown-button",r.setAttribute("tabindex","0"),r.style.padding="4px 8px",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.userSelect="none",r.style.textAlign="center",r.style.fontWeight="bold",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="6px",r.style.transition="background-color 0.2s ease-in-out",r.title="Click to toggle Auto Mode";const s=document.createElement("span");s.innerHTML="▼",s.style.fontSize="10px",s.style.marginLeft="2px",s.style.position="relative",s.style.top="1px";const c=document.createElement("div");c.className="fb-chat-monitor-dropdown-content",c.style.display="none",c.style.position="absolute",c.style.zIndex="10000",c.style.left="0",c.style.right="0",c.style.marginTop="2px",c.style.borderRadius="4px",c.style.overflow="hidden",c.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",i.appendChild(r),i.appendChild(c);const d=document.getElementById("fb-chat-monitor-mode-toggle");function u(e){const t=n.find((t=>t.value===e));if(!t)return;r.innerHTML="";const o=document.createElement("span");o.textContent=t.text,r.appendChild(o),r.appendChild(s.cloneNode(!0)),r.style.backgroundColor=t.color,r.style.color="white",r.onmouseover=function(){this.style.backgroundColor=g(t.color,-15)},r.onmouseout=function(){this.style.backgroundColor=t.color},r.dataset.value=e,m()}function g(e,t){let n=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),a=parseInt(e.substring(5,7),16);return n=Math.max(0,Math.min(255,n+t)),o=Math.max(0,Math.min(255,o+t)),a=Math.max(0,Math.min(255,a+t)),"#"+((1<<24)+(n<<16)+(o<<8)+a).toString(16).slice(1)}function m(){c.innerHTML="";const e=r.dataset.value,t=n.find((t=>t.value!==e));if(!t)return;const o=document.createElement("div");o.className="fb-chat-monitor-dropdown-item",o.textContent=t.text,o.dataset.value=t.value,o.style.padding="4px 8px",o.style.cursor="pointer",o.style.backgroundColor=t.color,o.style.color="white",o.style.textAlign="center",o.style.fontWeight="bold",o.style.transition="background-color 0.2s ease-in-out",o.onmouseover=function(){this.style.backgroundColor=g(t.color,-15)},o.onmouseout=function(){this.style.backgroundColor=t.color},o.addEventListener("click",(function(e){e.stopPropagation(),c.style.display="none";const t=this.dataset.value;u(t),p(t)})),c.appendChild(o)}function p(e){const n=document.getElementById("fb-chat-monitor-generate-response");"on"===e?(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("auto"),window.FBChatMonitor.toggleMonitoring(!0)):t.error("FBChatMonitor no disponible"),n&&n.setAttribute("disabled","")):(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("manual"),window.FBChatMonitor.toggleMonitoring(!1)):t.error("FBChatMonitor no disponible"),n&&n.removeAttribute("disabled"))}o.replaceChild(i,d),r.addEventListener("click",(function(e){e.stopPropagation();const t="block"===c.style.display;c.style.display=t?"none":"block",t||m()})),document.addEventListener("click",(function(){c.style.display="none"})),u(a),p(a),document.getElementById("fb-chat-monitor-generate-response").addEventListener("click",(async()=>{try{await I.generateResponseForCurrentChat()||t.debug("Failed to generate response via UI button")}catch(e){l(`Error generating response: ${e.message}`,"error")}})),document.getElementById("fb-chat-monitor-save-api-key").addEventListener("click",(async()=>{const e=document.getElementById("fb-chat-monitor-openai-key").value.trim();if(e)try{const t=document.getElementById("fb-chat-monitor-save-api-key");t.textContent="Validating...",t.disabled=!0;await O.setApiKey(e)?(l("API Key validated and saved successfully","success"),L()):l("Invalid API Key","error")}catch(e){l(`Error: ${e.message}`,"error")}finally{const e=document.getElementById("fb-chat-monitor-save-api-key");e.textContent="Save API Key",e.disabled=!1}else l("Please enter a valid API Key","error")})),document.getElementById("fb-chat-monitor-refresh-assistants").addEventListener("click",L),document.getElementById("fb-chat-monitor-save-config").addEventListener("click",P),document.getElementById("fb-chat-monitor-reset-config").addEventListener("click",B),document.getElementById("fb-chat-monitor-refresh-logs").addEventListener("click",D),document.getElementById("fb-chat-monitor-clear-logs").addEventListener("click",U),document.getElementById("fb-chat-monitor-export-logs").addEventListener("click",H),document.getElementById("fb-chat-monitor-log-level").addEventListener("change",D),document.getElementById("fb-chat-monitor-refresh-history").addEventListener("click",z),document.getElementById("fb-chat-monitor-clear-history").addEventListener("click",K),document.getElementById("fb-chat-monitor-export-history").addEventListener("click",G)}(),n}(),_.isControlPanelVisible=!0,_.floatingResponseButton&&(_.floatingResponseButton.style.display="none"),document.body.appendChild(_.controlPanel);const n=_.controlPanel.getBoundingClientRect();n.bottom>window.innerHeight&&(_.controlPanel.style.top=window.innerHeight-n.height-10+"px"),n.right>window.innerWidth&&(_.controlPanel.style.right="10px"),F();const a=setInterval((()=>{_.isControlPanelVisible?F():clearInterval(a)}),3e3);R(_.activeTab)}function R(e){document.querySelectorAll(".fb-chat-monitor-tab-content").forEach((e=>{e.classList.remove("active")}));const t=document.getElementById(`fb-chat-monitor-tab-${e}`);t&&(t.classList.add("active"),"logs"===e?D():"history"===e&&z())}function F(){try{const e=window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.getMonitoringStats?window.FBChatMonitor.getMonitoringStats():{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1,nextScanIn:null};document.getElementById("fb-chat-monitor-stat-processed").textContent=e.chatsProcessed||0,document.getElementById("fb-chat-monitor-stat-responses").textContent=e.responsesSent||0,document.getElementById("fb-chat-monitor-stat-errors").textContent=e.errors||0;let t="Inactive";if(e.uptime>0){const n=Math.floor(e.uptime/1e3/60),o=Math.floor(n/60);t=o>0?`${o}h ${n%60}m`:`${n}m`}document.getElementById("fb-chat-monitor-stat-uptime").textContent=t,_.statusIndicator&&(_.statusIndicator.style.backgroundColor=e.isMonitoring?"#4CAF50":"#f44336")}catch(e){t.error("Error updating stats",{},e)}}async function L(){try{const t=document.getElementById("fb-chat-monitor-seller-assistant"),n=document.getElementById("fb-chat-monitor-buyer-assistant");t&&(t.innerHTML='<option value="">Loading assistants...</option>'),n&&(n.innerHTML='<option value="">Loading assistants...</option>');const o=await O.listAssistants();if(!o||0===o.length)return t&&(t.innerHTML='<option value="">No assistants found</option>'),void(n&&(n.innerHTML='<option value="">No assistants found</option>'));const a=(e,t)=>{e&&(e.innerHTML='<option value="">Select an assistant</option>',o.forEach((n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,n.id===t&&(o.selected=!0),e.appendChild(o)})),e.addEventListener("change",(function(){const e="fb-chat-monitor-seller-assistant"===this.id?"seller":"buyer";O.setAssistantForRole(e,this.value),l(`${e.charAt(0).toUpperCase()+e.slice(1)} assistant updated`,"success")})))};a(t,e.AI?.assistants?.seller?.id),a(n,e.AI?.assistants?.buyer?.id)}catch(e){t.error("Error refreshing assistants",{},e),l(`Error loading assistants: ${e.message}`,"error");const n=document.getElementById("fb-chat-monitor-seller-assistant"),o=document.getElementById("fb-chat-monitor-buyer-assistant");n&&(n.innerHTML='<option value="">Error loading assistants</option>'),o&&(o.innerHTML='<option value="">Error loading assistants</option>')}}function P(){if("function"==typeof GM_setValue)try{GM_setValue("CONFIG_operationMode",window.CONFIG.operationMode||"manual"),GM_setValue("CONFIG_autoSendMessages",window.CONFIG.autoSendMessages||!1),window.CONFIG.AI&&window.CONFIG.AI.apiKey&&GM_setValue("CONFIG_AI_apiKey",window.CONFIG.AI.apiKey),t.log("Configuration saved to persistent storage")}catch(e){t.error(`Error saving configuration: ${e.message}`)}else t.warn("GM_setValue not available. Cannot save persistent configuration.")}function B(){confirm("Are you sure you want to reset all settings to default values?")&&(o.remove("CONFIG"),l("Settings reset to defaults. Reloading...","info"),setTimeout((()=>window.location.reload()),2e3))}function D(){try{const e=document.getElementById("fb-chat-monitor-logs-list"),n=document.getElementById("fb-chat-monitor-log-level").value,o=t.getAllLogs();if(0===o.length)return void(e.innerHTML='<div class="fb-chat-monitor-log-entry">No logs recorded</div>');let a=o;"error"===n?a=o.filter((e=>"ERROR"===e.type)):"warn"===n?a=o.filter((e=>"ERROR"===e.type||"WARN"===e.type)):"info"===n&&(a=o.filter((e=>"ERROR"===e.type||"WARN"===e.type||"INFO"===e.type))),e.innerHTML="",a.slice(0,100).forEach((t=>{const n=document.createElement("div");n.className=`fb-chat-monitor-log-entry fb-chat-monitor-log-${t.type}`;const o=`${new Date(t.timestamp).toLocaleTimeString()}`;n.innerHTML=`\n            <span class="fb-chat-monitor-log-time">${o}</span>\n            <span class="fb-chat-monitor-log-message">${t.message}</span>\n          `,e.appendChild(n)})),e.scrollTop=e.scrollHeight}catch(e){console.error("Error refreshing logs",e)}}function U(){confirm("Are you sure you want to clear all logs?")&&(t.clearLogs(),D(),l("Logs cleared","success"))}function H(){try{const n=t.getAllLogs(),o={timestamp:(new Date).toISOString(),version:e.version||"1.0",logs:n},a=JSON.stringify(o,null,2),i=new Blob([a],{type:"application/json"}),r=URL.createObjectURL(i),s=document.createElement("a");s.href=r,s.download=`fb-chat-monitor-logs-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),l("Logs exported successfully","success")}catch(e){t.error("Error exporting logs",{},e),l(`Error exporting logs: ${e.message}`,"error")}}function z(){try{const e=document.getElementById("fb-chat-monitor-history-list"),t=v();if(!t||0===t.length)return void(e.innerHTML='<tr><td colspan="4" style="text-align: center;">No conversation history</td></tr>');e.innerHTML="",t.slice(0,50).forEach((t=>{const n=document.createElement("tr");n.addEventListener("click",(()=>function(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="10000";const n=document.createElement("div");n.style.backgroundColor="white",n.style.borderRadius="8px",n.style.padding="20px",n.style.width="600px",n.style.maxWidth="90%",n.style.maxHeight="80%",n.style.overflowY="auto",n.style.position="relative";const o=document.createElement("button");o.innerHTML="&times;",o.style.position="absolute",o.style.top="10px",o.style.right="10px",o.style.background="none",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.addEventListener("click",(()=>document.body.removeChild(t))),n.appendChild(o);const a=document.createElement("h2");a.textContent="Conversation Details",a.style.marginTop="0",a.style.marginBottom="20px",n.appendChild(a);const i=document.createElement("div"),s=new Date(e.timestamp);if(i.innerHTML=`\n        <p><strong>Time:</strong> ${r.formatDate(s)}</p>\n        <p><strong>Mode:</strong> ${e.mode}</p>\n        <p><strong>Status:</strong> ${e.sent?"Sent":"Not sent"}</p>\n      `,e.context){const t=document.createElement("div");if(t.style.marginTop="15px",t.style.marginBottom="15px",t.innerHTML='<h3 style="margin-top:0;">Context</h3>',e.context.role&&(t.innerHTML+=`<p><strong>Role:</strong> ${e.context.role}</p>`),e.context.productDetails){const n=e.context.productDetails;t.innerHTML+=`\n            <div style="margin-top: 10px; margin-bottom: 15px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Product Details</h4>\n              <p style="margin: 2px 0;"><strong>Title:</strong> ${n.title||"N/A"}</p>\n              <p style="margin: 2px 0;"><strong>Price:</strong> ${n.price||"N/A"}</p>\n              ${n.id?`<p style="margin: 2px 0;"><strong>ID:</strong> ${n.id}</p>`:""}\n            </div>\n          `}e.context.lastMessage&&(t.innerHTML+=`\n            <div style="margin-top: 10px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Last Message</h4>\n              <div style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${e.context.lastMessage}</div>\n            </div>\n          `),i.appendChild(t)}if(e.response){const t=document.createElement("div");t.style.marginTop="15px",t.innerHTML=`\n          <h3 style="margin-top: 0;">Response</h3>\n          <div style="background-color: #e9f5ff; padding: 10px; border-radius: 4px; white-space: pre-wrap; margin-bottom: 15px; border: 1px solid #2196F3;">${e.response}</div>\n          <button id="copy-response-btn" style="padding: 5px 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Copy Response</button>\n        `,i.appendChild(t)}n.appendChild(i),t.appendChild(n),document.body.appendChild(t);const l=document.getElementById("copy-response-btn");l&&e.response&&l.addEventListener("click",(()=>{navigator.clipboard.writeText(e.response),l.textContent="Copied!",setTimeout((()=>l.textContent="Copy Response"),2e3)}))}(t)));const o=document.createElement("td"),a=new Date(t.timestamp);o.textContent=r.formatDate(a).split(",")[1].trim();const i=document.createElement("td"),s=document.createElement("span");s.textContent=t.mode,s.className=`fb-chat-monitor-badge fb-chat-monitor-badge-${t.mode}`,i.appendChild(s);const l=document.createElement("td"),c=t.context?.lastMessage||"No content";l.textContent="string"==typeof c?c.substring(0,30)+(c.length>30?"...":""):"Complex content";const d=document.createElement("td"),u=document.createElement("span");u.textContent=t.sent?"Sent":"Not sent",u.className="fb-chat-monitor-badge fb-chat-monitor-badge-"+(t.sent?"sent":"notsent"),d.appendChild(u),n.appendChild(o),n.appendChild(i),n.appendChild(l),n.appendChild(d),e.appendChild(n)}))}catch(e){t.error("Error refreshing history",{},e);document.getElementById("fb-chat-monitor-history-list").innerHTML='<tr><td colspan="4" style="text-align: center;">Error loading history</td></tr>'}}function K(){confirm("Are you sure you want to clear all conversation history?")&&(o.remove("RESPONSE_LOGS"),z(),l("Conversation history cleared","success"))}function G(){try{const t=v(),n={timestamp:(new Date).toISOString(),version:e.version||"1.0",conversations:t},o=JSON.stringify(n,null,2),a=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(a),r=document.createElement("a");r.href=i,r.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),l("History exported successfully","success")}catch(e){t.error("Error exporting history",{},e),l(`Error exporting history: ${e.message}`,"error")}}function v(){return o.get("RESPONSE_LOGS",[])}function q(e){try{const n=document.getElementById("fb-chat-auto-btn"),o=document.getElementById("fb-chat-manual-btn");return n&&o?(n.classList.remove("active","inactive"),o.classList.remove("active","inactive"),"auto"===e?(n.classList.add("active"),o.classList.add("inactive"),t.debug("UI updated: AUTO mode activated")):(n.classList.add("inactive"),o.classList.add("active"),t.debug("UI updated: MANUAL mode activated")),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:e}})),!0):(t.debug("Mode buttons not found to update UI"),!1)}catch(e){return t.error(`Error updating mode UI: ${e.message}`),!1}}function j(){if(!_.floatingResponseButton)return;if(window.CONFIG&&"manual"===window.CONFIG.operationMode&&!_.isControlPanelVisible&&window.chatManager&&window.chatManager.currentChatId){const t=document.querySelector(e.selectors.activeChat.messageInput),o=n.findElement(e.selectors.activeChat.sendButton);if(t||o){const e=(t||o).getBoundingClientRect();_.floatingResponseButton.style.bottom=window.innerHeight-e.top+10+"px",_.floatingResponseButton.style.right="20px"}_.floatingResponseButton.style.display="block"}else _.floatingResponseButton.style.display="none"}function l(e,t="info",n=3e3){const o=document.createElement("div");o.className="fb-chat-monitor-alert";const a=function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n={top:"60px",right:"20px",left:"auto"};if(e&&_.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}return n}();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)}window.initializeUI=$,window.toggleControlPanel=N,window.updateMonitoringStatus=function(e){_.statusIndicator&&(_.statusIndicator.style.backgroundColor=e?"#4CAF50":"#f44336"),_.isControlPanelVisible&&F()},window.ui={updateModeUI:q,handleModeClick:function(e){try{if("auto"!==e&&"manual"!==e)return t.error(`Invalid mode: ${e}`),!1;if(!window.CONFIG.updateOperationMode(e))return t.error(`Could not update mode to ${e}`),!1;q(e);return l(`Mode ${"auto"===e?"automatic":"manual"} activated`,"success"),!0}catch(e){return t.error(`Error changing mode: ${e.message}`),!1}}};const V={isMonitoring:!1,monitorInterval:null,errorCount:0,scansSinceLastSuccess:0,startTime:null,stats:{chatsProcessed:0,messagesProcessed:0,responsesSent:0,errors:0},lastScanTime:null,baseInterval:e.scanInterval||3e4};async function J(){t.log("Initializing FB-Chat-Monitor",{version:e.version});try{const n=o.get("OPENAI_KEY",null);if(n&&(e.AI.apiKey=n,t.log("Loaded OpenAI API Key from storageUtils")),s.redirectToMarketplace())return void t.log("Redirecting to Marketplace messenger, please wait...");k.initialize(),t.debug("UI components initialized");O.initialize(e.AI.apiKey,e.AI.model)?t.log("OpenAI Manager initialized successfully"):t.warn("OpenAI Manager initialized but no valid API key is set"),function(){const n=o.get("FB_CHAT_MONITOR_OPENAI_KEY",null);if(n)e.AI.apiKey=n,t.debug("OpenAI API Key loaded from storageUtils");else{const n=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");n&&(e.AI.apiKey=n,o.set("FB_CHAT_MONITOR_OPENAI_KEY",n),t.debug("OpenAI API Key migrated from localStorage to storageUtils"))}e.operationMode=o.get("OPERATION_MODE",e.defaultOperationMode),e.AI.assistants||(e.AI.assistants={seller:{},buyer:{}});e.AI.assistants.seller.id=o.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),e.AI.assistants.buyer.id=o.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),t.debug("Saved settings loaded",{operationMode:e.operationMode,hasApiKey:!!e.AI.apiKey,sellerAssistant:!!e.AI.assistants.seller.id,buyerAssistant:!!e.AI.assistants.buyer.id})}(),a.onActivityChange((e=>{V.isMonitoring&&Y(),t.debug("User activity changed",{isActive:e})}));return o.get("MONITORING_ACTIVE",!1)&&(t.log("Restoring previous monitoring state"),W(!0)),l("FB-Chat-Monitor initialized successfully","success"),t.log("Initialization complete",{status:"success"}),!0}catch(e){return t.error("Error during initialization",{},e),l("Error initializing FB-Chat-Monitor: "+e.message,"error"),!1}}function Y(){let n=V.baseInterval;return a.isActive||(n*=1.5),V.errorCount>0&&(n=Math.min(n*Math.pow(1.5,V.errorCount),e.maxScanInterval||3e5)),V.isMonitoring&&V.monitorInterval&&(clearTimeout(V.monitorInterval),V.monitorInterval=setTimeout(X,n),t.debug("Scan interval updated",{interval:n,userActive:a.isActive,errorCount:V.errorCount})),n}function W(e){return V.isMonitoring=e,e?(V.startTime=Date.now(),V.monitorInterval=setTimeout(X,1e3),o.set("MONITORING_ACTIVE",!0),t.log("Chat monitoring started")):(V.monitorInterval&&(clearTimeout(V.monitorInterval),V.monitorInterval=null),o.set("MONITORING_ACTIVE",!1),t.log("Chat monitoring stopped")),e?l("Chat monitoring started","success"):l("Chat monitoring stopped","info"),e}async function X(){if(V.isMonitoring){V.lastScanTime=Date.now(),t.debug("Starting chat scan");try{if(!s.isMarketplaceMessenger())return t.warn("Not on marketplace messenger page, skipping scan"),void Q();const e=await i.withExponentialBackoff((()=>I.scanForUnreadChats()),{maxRetries:2,baseDelay:1e3});if(e>0){t.log(`Found ${e} unread chats`);await I.openNextPendingChat()?(t.log("Chat opened and processed successfully"),V.stats.chatsProcessed++,V.errorCount=0,V.scansSinceLastSuccess=0):(t.error("Could not open the chat"),Z())}else t.debug("No unread chats found"),V.scansSinceLastSuccess++}catch(e){t.error("Error during chat monitoring",{errorCount:V.errorCount,scansSinceLastSuccess:V.scansSinceLastSuccess},e),Z()}Q()}}function Q(){if(!V.isMonitoring)return;V.monitorInterval&&clearTimeout(V.monitorInterval);const e=Y();V.monitorInterval=setTimeout(X,e),t.debug(`Next scan scheduled in ${e}ms`)}function Z(){V.errorCount++,V.stats.errors++,V.scansSinceLastSuccess++,V.scansSinceLastSuccess>=e.maxConsecutiveFailures&&(t.warn(`Too many consecutive failures (${V.scansSinceLastSuccess}), pausing monitoring`),l("Monitoring paused due to consecutive failures. Check console for details.","warning",{buttons:[{text:"Resume",action:()=>{V.errorCount=0,V.scansSinceLastSuccess=0,Q()}}]}),V.errorCount=Math.min(V.errorCount,5))}function ee(){const e=Date.now();return{...V.stats,isMonitoring:V.isMonitoring,uptime:V.startTime?e-V.startTime:0,lastScan:V.lastScanTime?e-V.lastScanTime:null,nextScanIn:V.monitorInterval?V.lastScanTime+Y()-e:null,errorRate:V.stats.chatsProcessed>0?(V.stats.errors/V.stats.chatsProcessed).toFixed(2):0}}function J(){if(window.initializationInProgress)return;window.initializationInProgress=!0,t.log("Initializing FB Chat Monitor"),$();const n=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");if(n&&(e.AI.apiKey=n,e.AI.enabled=!0,t.log("API Key loaded from localStorage in init")),e.operationMode=localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||e.defaultOperationMode,e.AI.apiKey)if(e.AI.enabled=!0,t.log("API key loaded from localStorage"),window.openAIManager){const n=O.initialize(e.AI.apiKey,e.AI.model);t.log(`OpenAI Manager auto-initialized: ${n}`)}else t.error("openAIManager not available for auto-initialization.");window.openaiManager?t.log("OpenAI Manager is available to generate responses"):t.warn("OpenAI Manager is not available. Some functions may not be operational."),window.assistantManager&&t.log("Assistant Manager is available to generate responses");try{window.location.href.includes("/marketplace/")?(t.log("We are in Marketplace, starting monitoring..."),setTimeout((()=>{window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.manualScan?window.FBChatMonitor.manualScan():t.warn("FBChatMonitor.manualScan not available yet")}),2500)):(t.log("We are not in Marketplace, trying redirection..."),window.pageUtils&&window.pageUtils.redirectToMarketplace?window.pageUtils.redirectToMarketplace():t.error("pageUtils.redirectToMarketplace not available"))}catch(e){t.error(`Error in initialization: ${e.message}`)}finally{window.initializationInProgress=!1}}window.FBChatMonitor={initialize:J,toggleMonitoring:W,manualScan:async function(){t.log("Manual chat scan triggered");const e=V.isMonitoring;e&&clearTimeout(V.monitorInterval);try{await X()}catch(e){t.error("Error during manual scan",{},e),l("Error during manual scan: "+e.message,"error")}finally{e&&Q()}},getMonitoringStats:ee,changeOperationMode:t=>("auto"!==t&&"manual"!==t&&(t="manual"),e.operationMode=t,o.set("OPERATION_MODE",t),W("auto"===t),!0)},window.getMonitoringStats=ee,"loading"!==document.readyState?J():document.addEventListener("DOMContentLoaded",J),window.addEventListener("load",(()=>{function n(){if(t.log("Verifying OpenAI Manager consistency..."),window.openaiManager||(t.warn("OpenAI Manager is not available, creating backup instance"),window.openaiManager=new S),!window.openaiManager.isInitialized)if(e?.AI?.apiKey)t.log("Recovering OpenAI Manager state with API key from CONFIG"),window.openaiManager.initialize(e.AI.apiKey);else{const e=o.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(t.log("Recovering OpenAI Manager state with API key from localStorage"),window.openaiManager.initialize(e))}let n=!1;"function"==typeof window.openaiManager.isReady?(n=window.openaiManager.isReady(),t.debug(`openaiManager.isReady() = ${n}`)):(n=window.openaiManager.isInitialized&&!!window.openaiManager.apiKey,t.debug(`Fallback isReady check = ${n}`)),!n&&window.openaiManager.apiKey&&(t.warn("Inconsistency detected - forcing isInitialized=true since there is API key"),window.openaiManager.isInitialized=!0,n=!0),t.log("Final state of OpenAI Manager: "+(n?"READY":"NOT AVAILABLE"))}window.storageUtils?(o.checkStorageHealth(),o.migrateSettings(),function(){try{if(!window.CONFIG||!window.CONFIG.AI)return void console.warn("CONFIG is not correctly initialized");e.AI.apiKey=o.get("FB_CHAT_MONITOR_OPENAI_KEY","")||localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY")||"",e.AI.assistants.seller.id=o.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID")||"",e.AI.assistants.buyer.id=o.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID")||"",e.operationMode=o.get("FB_CHAT_MONITOR_OPERATION_MODE",e.defaultOperationMode)||localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||e.defaultOperationMode,e.audioTranscription&&(e.audioTranscription.apiKey=e.AI.apiKey),console.log("[CONFIG] Configuration loaded:",{apiKey:e.AI.apiKey?"********":"(no key)",model:e.AI.model,assistants:{seller:e.AI.assistants.seller.id?"(configured)":"(not configured)",buyer:e.AI.assistants.buyer.id?"(configured)":"(not configured)"},mode:e.operationMode})}catch(e){console.error("[CONFIG] Error loading configuration:",e)}}()):console.error("storageUtils is not available for migration and verification"),window.FBChatMonitor||(window.FBChatMonitor={},console.error("FBChatMonitor is not available on load. An empty object has been created to prevent errors.")),window.FBChatMonitor.getMonitoringStats||(window.FBChatMonitor.getMonitoringStats=function(){return{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1}},console.warn("A temporary version of getMonitoringStats has been created")),window.FBChatMonitor.initialized||"function"!=typeof window.FBChatMonitor.initialize||(window.FBChatMonitor.initialized=!0,window.FBChatMonitor.initialize()),function(){if(t.log("Verifying availability of AI services..."),window.openaiManager){const e=window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.isInitialized&&!!window.openaiManager.apiKey;if(t.log(`OpenAI Manager auto-initialized: ${e}`),!e&&window.storageUtils){const e=window.storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(window.openaiManager.setApiKey(e),t.log("OpenAI Manager re-initialized with stored API key"))}}else t.warn("OpenAI Manager is not available. Some functions will not be operational."),window.openaiManager={isInitialized:!1,generateResponse:async()=>{throw new Error("OpenAI Manager is not initialized correctly")},isReady:()=>!1},t.debug("A backup implementation of OpenAI Manager has been created");window.assistantManager&&t.log("Assistant Manager is available to generate responses")}(),n(),setInterval(n,6e4)}))}();