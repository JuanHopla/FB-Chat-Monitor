// ==UserScript==
// @name         FB-Chat-Monitor
// @namespace    https://github.com/JuanHopla/FB-Chat-Monitor
// @version      1.1.0
// @description  Monitor and auto-respond to Facebook Marketplace messages with AI assistance
// @author       JuanHopla
// @match        https://www.messenger.com/*
// @match        https://www.facebook.com/marketplace/inbox*
// @match        https://www.facebook.com/messages*
// @match        https://www.facebook.com/marketplace/item/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_deleteValue
// @grant        GM_listValues
// @connect      api.openai.com
// @connect      facebook.com
// @connect      messenger.com
// @updateURL    https://juanhopla.github.io/FB-Chat-Monitor/main.user.js
// @downloadURL  https://juanhopla.github.io/FB-Chat-Monitor/main.user.js
// @license      MIT
// @run-at       document-idle
// ==/UserScript==

!function(){var CONFIG={};Object.assign(CONFIG,{version:"1.0.0",operationMode:"manual",get modo(){return this.operationMode},set modo(e){"auto"!==e&&"manual"!==e||(this.operationMode=e,void 0!==logger&&logger.debug(`Mode updated via 'modo' property: ${e}`))},apiKey:null,AI:{apiKey:null,model:"gpt-4.1-mini",maxTokens:2048,temperature:.7,useAssistantAPI:!0,provider:"openai",assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},syncWithLegacyConfig:function(){CONFIG.apiKey&&!this.apiKey?this.apiKey=CONFIG.apiKey:this.apiKey&&!CONFIG.apiKey&&(CONFIG.apiKey=this.apiKey),CONFIG.model&&CONFIG.model!==this.model&&(this.model=CONFIG.model),CONFIG.assistants&&(CONFIG.assistants.seller&&(this.assistants.seller={...this.assistants.seller,...CONFIG.assistants.seller}),CONFIG.assistants.buyer&&(this.assistants.buyer={...this.assistants.buyer,...CONFIG.assistants.buyer}))}},model:"gpt-4.1-mini",autoResponseDelay:5e3,simulateHumanTyping:!0,audioTranscription:{enabled:!1,apiKey:null,model:"whisper-1",maxDuration:120},assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},autoSendMessages:!0,sendMessageDelay:2e3,selectors:{chatList:{container:'div[class*="x78zum5"][class*="xdt5ytf"], div[role="main"]',chatItem:'a[href*="/marketplace/t/"][role="link"]',unreadIndicator:'span[class*="x6s0dn4"][data-visualcompletion="ignore"]',chatUserName:{selector:["span.x1lliihq.x193iq5w.x6ikm8r.x10wlt62.xlyipyv.xuxw1ft:not(.x1j85h84)",'span[dir="auto"][class*="x1lliihq"]:not([class*="x1j85h84"])'],filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}))},timestamp:'span[aria-hidden="true"]',messagePreview:{selector:'span[dir="auto"]:not([class*="x1lliihq"])',filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"",n=/^\s*\d+[smhdwy]\s*$/i.test(t),o=t.includes("Marketplace ·"),a=t.includes(":")||t.length>8;return!n&&!o&&a}))}},activeChat:{container:'div.x1ey2m1c.xds687c.xixxii4.x1vjfegm, div[role="main"] > div > div > div:last-child',messageWrapper:'div.x4k7w5x > div > div > div, div[role="main"] > div > div > div:last-child > div',messageRow:'div[role="row"]',senderAvatar:'img.x1rg5ohu[alt]:not([alt="Open photo"])',messageContent:['span.x1lliihq.x1plvlek > div[dir="auto"]','div[role="presentation"] span.x1lliihq > div[dir="auto"]','div[dir="auto"].html-div[class*="xexx8yu"]'],messageTimestamp:["span[data-tooltip-content][aria-label]",'span[title][aria-label*=":"]',"span.x1lliihq.x1plvlek.xryxfnj[aria-label]",'span[aria-label*="sent at"]','span[aria-label*="enviado a las"]'],messageImageElement:['a[href*="/messenger_media/"] img.x1rg5ohu','img[alt]:not([width="16"]):not([height="16"])','img[data-visualcompletion="media-vc-image"]',"div.x1ey2m1c img",'div[role="img"]',"div.x6ikm8r.x10wlt62 > img"],messageAudioElement:'div[aria-label="Play"][role="button"] ~ audio[src], div[aria-label*="audio message"] audio[src], audio[src]',messageAudioPlayButton:['div.x6s0dn4 div[aria-label="Play"][role="button"]','div[role="button"][aria-label="Play"]','div[aria-label="Play"][role="button"]','div[role="button"][aria-label*="audio"]','div[aria-label*="reproducir"][role="button"]','div[aria-label*="Audio message"]','div.xzg4506 > div.x1qjc9v5 > div[role="button"]','div[aria-label*="Play" i][role="button"]'],messageAudioUrlSource:null,messageAudioUrlAttribute:null,messageVideoElement:["video",'div[aria-label="Expand video"] video','div[aria-label="Play video"][role="button"]','div[data-testid="media-container"] video','div[data-visualcompletion="media-vc-image"][style*="background-image"]','div[role="button"][aria-label*="video"]','a[href*="video_redirect"]','div.x78zum5.xdt5ytf.x16ldp7u > div[role="button"]'],messageFileElement:['a[href*="attachment.php"]','a[href*="cdn.fbsbx.com"][download]','div[data-testid="attachment"]','div[role="button"][aria-label*="file"]','div[aria-label*="archivo adjunto"]'],messageLocationElement:['div[data-testid="map_container"]','a[href*="l.facebook.com/l.php"][href*="maps"]','a[href*="google.com/maps"]','div[aria-label*="location"]','div[aria-label*="ubicación"]'],messageGifElement:['div[data-testid="sticker"] img','img[src*="tenor.com"]','img[src*="giphy.com"]','div[aria-label*="GIF"]'],sellerIndicators:['div[aria-label="Mark as pending"]','span:contains("Mark as pending")','div[aria-label="Create plan"]','div[aria-label="Mark as available"]','div[aria-label="Mark as sold"]'],buyerIndicators:['a[aria-label="See details"]','span:contains("See details")'],productLink:'a[href*="/marketplace/item/"]',productInfo:'div[class*="x1sliqq"], div[role="main"] > div > div > div:first-child',messageInput:'div[contenteditable="true"][role="textbox"], div[aria-label="Message"], p.xat24cr.xdj266r',sendButton:['div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][aria-label*="send"]','div[role="button"][aria-label*="enviar"]','div.x1i10hfl[role="button"].xjbqb8w','div.x78zum5[role="button"].xjbqb8w','div.x1i10hfl[role="button"]:not([aria-hidden="true"])','div[role="button"][tabindex="0"]:not([style*="visibility: hidden"])'],scrollbar:[".x1uipg7g > div:nth-child(1) > div:nth-child(1)",'div[style*="overflow-y: auto"][style*="height"]','div[style*="overflow: auto"][style*="height"]','div.x4k7w5x > div[style*="height"]','div[role="main"] div.x1n2onr6[style*="height"]'],chatBeginningIndicators:['div[role="img"][aria-label]',"h4.xdj266r.x11i5rnm.xat24cr.x1mh8g0r","ul.x6s0dn4.x78zum5.xl56j7k.xsag5q8.x1y1aw1k","div.x1eb86dx.xsag5q8.x1ye3gou.xn6708d.x1cnzs8"]}},init(){if(this.loadFromStorage(),this.initializeExtras(),this.AI&&"function"==typeof this.AI.syncWithLegacyConfig&&this.AI.syncWithLegacyConfig(),void 0!==logger){logger.debug(`Configuration initialized. Mode: ${this.operationMode}, modo property: ${this.modo}`);const e="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):null,t="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):null,n=localStorage.getItem("FB_CHAT_MODE"),o=localStorage.getItem("FB_CHAT_OPERATION_MODE");logger.debug(`Storage status - GM: modo=${e}, opMode=${t} | LS: modo=${n}, opMode=${o}`)}return!0},initializeExtras(){return document.addEventListener("configUpdated",(e=>{const t=e?.detail||{};t.operationMode&&(this.operationMode=t.operationMode,logger.debug(`Mode updated by event: ${this.operationMode}, source: ${t.source||"unknown"}`))})),!0},loadFromStorage(){try{const e=this.getStorage(),t=e.FB_CHAT_OPERATION_MODE,n=e.FB_CHAT_MODE;void 0!==logger&&logger.debug(`Mode values found - FB_CHAT_OPERATION_MODE: ${t}, FB_CHAT_MODE: ${n}`);let o=null;if("auto"===t||"manual"===t?(o=t,void 0!==logger&&logger.debug(`Mode loaded from FB_CHAT_OPERATION_MODE: ${o}`)):"auto"===n||"manual"===n?(o=n,void 0!==logger&&logger.debug(`Mode loaded from FB_CHAT_MODE (legacy): ${o}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",n),void 0!==logger&&logger.debug(`Mode migrated from FB_CHAT_MODE to FB_CHAT_OPERATION_MODE: ${n}`)):(o="manual",void 0!==logger&&logger.debug(`No saved value found for mode. Assigning default value: ${o}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",o),this.saveToStorage("FB_CHAT_MODE",o)),o&&(this.operationMode=o),e.FB_CHAT_API_KEY&&(this.apiKey=e.FB_CHAT_API_KEY,this.AI&&(this.AI.apiKey=e.FB_CHAT_API_KEY)),e.FB_CHAT_MODEL&&(this.model=e.FB_CHAT_MODEL,this.AI&&(this.AI.model=e.FB_CHAT_MODEL)),e.FB_CHAT_ASSISTANTS)try{const t="string"==typeof e.FB_CHAT_ASSISTANTS?JSON.parse(e.FB_CHAT_ASSISTANTS):e.FB_CHAT_ASSISTANTS;t&&"object"==typeof t&&(t.seller&&(this.assistants.seller={...this.assistants.seller,...t.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...t.seller})),t.buyer&&(this.assistants.buyer={...this.assistants.buyer,...t.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...t.buyer})))}catch(e){void 0!==logger&&logger.error(`Error parsing assistants: ${e.message}`)}return void 0!==logger&&(logger.log("Configuration loaded from storage"),logger.debug(`Final state after loading: operationMode=${this.operationMode}, modo=${this.modo}`)),this}catch(e){return void 0!==logger&&logger.error(`Error loading configuration: ${e.message}`),this}},updateOperationMode(e){return"auto"!==e&&"manual"!==e?(logger.error(`Invalid operation mode: ${e}. Must be 'auto' or 'manual'`),!1):(this.operationMode=e,"function"==typeof GM_setValue?(GM_setValue("FB_CHAT_OPERATION_MODE",e),GM_setValue("FB_CHAT_MODE",e)):(localStorage.setItem("FB_CHAT_OPERATION_MODE",e),localStorage.setItem("FB_CHAT_MODE",e)),logger.log(`Operation mode updated to: ${e.toUpperCase()}`),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:e,modo:e,source:"updateOperationMode"}})),window.ui&&"function"==typeof window.ui.updateModeUI&&window.ui.updateModeUI(e),window.responseManager&&(window.responseManager.isAutomodeEnabled="auto"===e,logger.debug(`ResponseManager updated: automode=${window.responseManager.isAutomodeEnabled}`)),logger.debug(`Mode updated: operationMode=${this.operationMode}, modo=${this.modo}`),!0)},saveApiKey(e){return e&&"string"==typeof e?(this.apiKey=e,this.AI&&(this.AI.apiKey=e),this.saveToStorage("FB_CHAT_API_KEY",e),logger.log("API Key saved"),!0):(logger.error("Invalid API Key"),!1)},saveModel(e){return e&&"string"==typeof e?(this.model=e,this.AI&&(this.AI.model=e),this.saveToStorage("FB_CHAT_MODEL",e),logger.log(`Model changed to: ${e}`),!0):(logger.error("Invalid model"),!1)},saveAssistants(e){return e&&"object"==typeof e?(e.seller&&(this.assistants.seller={...this.assistants.seller,...e.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...e.seller})),e.buyer&&(this.assistants.buyer={...this.assistants.buyer,...e.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...e.buyer})),this.saveToStorage("FB_CHAT_ASSISTANTS",JSON.stringify(this.assistants)),logger.log("Assistants configuration updated"),!0):(logger.error("Invalid assistants configuration"),!1)},getStorage(){const e={};if("function"==typeof GM_getValue&&"function"==typeof GM_setValue){let t=[];"function"==typeof GM_listValues&&(t=GM_listValues()),t.length||(t=["FB_CHAT_MODE","FB_CHAT_OPERATION_MODE","FB_CHAT_API_KEY","FB_CHAT_MODEL","FB_CHAT_ASSISTANTS"]),t.forEach((t=>{try{e[t]=GM_getValue(t)}catch(e){logger.debug(`Error reading key ${t} from GM_getValue: ${e.message}`)}}))}else for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n&&n.startsWith("FB_CHAT_"))try{let t=localStorage.getItem(n);try{t=JSON.parse(t)}catch(e){}e[n]=t}catch(e){logger.debug(`Error reading key ${n} from localStorage: ${e.message}`)}}return e},saveToStorage(e,t){try{if("function"==typeof GM_setValue)return GM_setValue(e,t),!0;const n="object"==typeof t?JSON.stringify(t):t;return localStorage.setItem(e,n),!0}catch(t){return logger.error(`Error saving to storage [${e}]: ${t.message}`),!1}},checkStatus(){const e=!!this.apiKey||this.AI&&!!this.AI.apiKey,t=!!this.model||this.AI&&!!this.AI.model,n="auto"===this.operationMode||"manual"===this.operationMode,o=this.assistants.seller&&this.assistants.seller.id||this.assistants.buyer&&this.assistants.buyer.id||this.AI&&this.AI.assistants&&(this.AI.assistants.seller&&this.AI.assistants.seller.id||this.AI.assistants.buyer&&this.AI.assistants.buyer.id);return{isReady:e&&t&&n,isApiKeySet:e,isModelSet:t,isOperationModeValid:n,operationMode:this.operationMode,hasAssistants:o}}}),window.CONFIG=CONFIG,window.diagnoseModeConfig=function(){const e="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):"N/A",t="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):"N/A",n=localStorage.getItem("FB_CHAT_MODE"),o=localStorage.getItem("FB_CHAT_OPERATION_MODE"),a={currentConfig:{operationMode:CONFIG.operationMode,modo:CONFIG.modo,areSynced:CONFIG.operationMode===CONFIG.modo},storage:{GM:{FB_CHAT_MODE:e,FB_CHAT_OPERATION_MODE:t},localStorage:{FB_CHAT_MODE:n,FB_CHAT_OPERATION_MODE:o}},responseManager:window.responseManager?{isAutomodeEnabled:window.responseManager.isAutomodeEnabled}:"Not available"};return console.log("[Mode Diagnosis]",a),a};const logger={logs:[],maxLogs:100,log(e,t={}){const n={type:"INFO",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.log(`[FB-Chat-Monitor] ${e}`,t)},debug(e,t={}){if(CONFIG.debug){const n={type:"DEBUG",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.log(`[FB-Chat-Monitor][DEBUG] ${e}`,t)}},error(e,t={},n=null){const o={type:"ERROR",timestamp:(new Date).toISOString(),message:e,data:t,stack:n?.stack||(new Error).stack};this._addLog(o),console.error(`[FB-Chat-Monitor][ERROR] ${e}`,t,n)},warn(e,t={}){const n={type:"WARN",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.warn(`[FB-Chat-Monitor][WARN] ${e}`,t)},notify(e,t="success",n={}){const o={type:"NOTIFICATION",notificationType:t,timestamp:(new Date).toISOString(),message:e};this._addLog(o);const a=document.createElement("div");a.style.position="fixed",a.style.bottom="20px",a.style.right="20px",a.style.padding="10px 15px",a.style.color="white",a.style.borderRadius="5px",a.style.zIndex="9999",a.style.opacity="0.9",a.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="14px",a.style.display="flex",a.style.alignItems="center",a.style.transition="all 0.3s ease",a.style.maxWidth="80%",a.style.wordBreak="break-word","success"===t?(a.style.backgroundColor="#4CAF50",a.innerHTML=`<span style="margin-right:8px;">✓</span>${e}`):"error"===t?(a.style.backgroundColor="#f44336",a.innerHTML=`<span style="margin-right:8px;">⚠️</span>${e}`):"warning"===t?(a.style.backgroundColor="#ff9800",a.innerHTML=`<span style="margin-right:8px;">⚠</span>${e}`):"info"===t&&(a.style.backgroundColor="#2196F3",a.innerHTML=`<span style="margin-right:8px;">ℹ</span>${e}`);const r=document.createElement("span");if(r.innerHTML="×",r.style.marginLeft="10px",r.style.cursor="pointer",r.style.fontWeight="bold",r.style.fontSize="18px",r.onclick=()=>document.body.removeChild(a),a.appendChild(r),document.body.appendChild(a),n.buttons&&Array.isArray(n.buttons)){const e=document.createElement("div");e.style.marginTop="10px",e.style.display="flex",e.style.gap="10px",n.buttons.forEach((t=>{if(t.text&&"function"==typeof t.action){const n=document.createElement("button");n.textContent=t.text,n.style.padding="5px 10px",n.style.border="none",n.style.borderRadius="3px",n.style.cursor="pointer",n.style.backgroundColor=t.color||"#fff",n.style.color=t.textColor||"#333",n.onclick=()=>{t.action(),!1!==t.closeOnClick&&document.body.removeChild(a)},e.appendChild(n)}})),a.appendChild(e)}if(n.timeoutSeconds){const e=document.createElement("span");e.className="countdown",e.textContent=n.timeoutSeconds,e.style.marginLeft="8px",e.style.padding="2px 6px",e.style.backgroundColor="rgba(255,255,255,0.2)",e.style.borderRadius="10px",a.appendChild(e)}const s=n.duration||5e3;return setTimeout((()=>{document.body.contains(a)&&(a.style.opacity="0",setTimeout((()=>{document.body.contains(a)&&document.body.removeChild(a)}),300))}),s),a},_addLog(e){this.logs.unshift(e),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),CONFIG.logging&&CONFIG.logging.saveLogs&&this._saveLogs()},_saveLogs(){try{localStorage.setItem("FB_CHAT_MONITOR_LOGS",JSON.stringify(this.logs))}catch(e){console.error("Error saving logs to localStorage",e)}},loadLogs(){try{const e=localStorage.getItem("FB_CHAT_MONITOR_LOGS");e&&(this.logs=JSON.parse(e))}catch(e){console.error("Error loading logs from localStorage",e)}},getAllLogs(){return[...this.logs]},getLogsByType(e){return this.logs.filter((t=>t.type===e))},clearLogs(){this.logs=[];try{localStorage.removeItem("FB_CHAT_MONITOR_LOGS")}catch(e){console.error("Error clearing logs from localStorage",e)}},notify:function(e,t="info",n=2e3){console.log(`[${t.toUpperCase()}] ${e}`);const o=document.createElement("div");o.className="fb-chat-monitor-notification";const a=this.getOptimalAlertPosition();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)},getOptimalAlertPosition:function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n=document.getElementById("fbChatMonitorQuickResponse");if(e&&window.uiState?.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}if(n&&"none"!==window.getComputedStyle(n).display){const e=n.getBoundingClientRect();return{top:e.top-10-40+"px",right:window.innerWidth-e.right+"px",left:"auto"}}return{top:"60px",right:"20px",left:"auto"}}},domUtils={findElement(e,t=document){if(Array.isArray(e)){for(const n of e)try{const e=t.querySelector(n);if(e)return e}catch(e){logger.debug(`Error with selector "${n}": ${e.message}`)}return null}try{return t.querySelector(e)}catch(t){return logger.debug(`Error with selector "${e}": ${t.message}`),null}},findAllElements(e,t=document){try{return[...t.querySelectorAll(e)]}catch(t){return logger.debug(`Error with selector "${e}": ${t.message}`),[]}},waitForElement:(e,t=CONFIG.waitElementTimeout)=>new Promise(((n,o)=>{let a=0;const r=Array.isArray(e)?e:[e],s=()=>{for(const e of r)try{const t=document.querySelector(e);if(t)return void n(t)}catch(e){}a+=100,a>=t?o(new Error(`Timeout waiting for elements: ${JSON.stringify(r)}`)):setTimeout(s,100)};s()})),scrollToTop:(e,t=10)=>new Promise((n=>{let o=e.scrollHeight,a=0,r=0;const s=()=>{e.scrollTop=0,setTimeout((()=>{if(r++,e.scrollHeight===o){if(a++,a>=3||r>=t)return void n({success:!0,fullyScrolled:!0})}else a=0,o=e.scrollHeight;s()}),300)};s()})),scrollToBottom:e=>new Promise((t=>{e?(e.scrollTop=e.scrollHeight,setTimeout((()=>t(!0)),100)):t(!1)})),injectStyles(e){const t=document.createElement("style");return t.textContent=e,document.head.appendChild(t),t},insertTextIntoField(e,t){if(!e)return!1;try{e.focus();const n=[()=>(document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,t)),()=>"true"===e.contentEditable&&(e.innerText=t,e.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>"value"in e&&(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>{for(;e.firstChild;)e.removeChild(e.firstChild);return e.appendChild(document.createTextNode(t)),e.dispatchEvent(new Event("input",{bubbles:!0})),!0}];for(const e of n)try{if(e())return logger.debug("Text inserted successfully"),!0}catch(e){}return e.innerText=t,e.value=t,e.textContent=t,["input","change","keyup"].forEach((t=>{try{e.dispatchEvent(new Event(t,{bubbles:!0}))}catch(e){}})),!0}catch(e){return logger.error(`Error inserting text into field: ${e.message}`),!1}},insertTextIntoField(e,t){if(!e||!t)return!1;try{if("true"===e.getAttribute("contenteditable")){e.innerHTML="",e.focus();if(!document.execCommand("insertText",!1,t)){e.textContent=t;const n=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(n)}return!0}return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),!0):(e.innerText=t,!0)}catch(e){return logger.error(`Error insertando texto en campo: ${e.message}`),!1}},insertTextIntoField(e,t){if(!e||!t)return!1;try{if(("true"===e.getAttribute("contenteditable")?!e.textContent||""===e.textContent.trim():!e.value||""===e.value.trim())||("true"===e.getAttribute("contenteditable")?(e.innerHTML="",e.textContent=""):"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(e.value=""),logger.debug("Campo limpiado adicionalmente antes de insertar texto")),"true"===e.getAttribute("contenteditable")){e.innerHTML="",e.focus();if(!document.execCommand("insertText",!1,t)){e.textContent=t;const n=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(n)}return!0}return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),!0):(e.innerText=t,!0)}catch(e){return logger.error(`Error insertando texto en campo: ${e.message}`),!1}},insertTextIntoField(e,t){if(!e||!t)return!1;try{const n="true"===e.getAttribute("contenteditable"),o=n?(e.textContent||"").trim():(e.value||"").trim();if(o){if(logger.warn(`Campo aún contiene texto antes de insertar: "${o.substring(0,30)}..."`),n){e.innerHTML="",e.textContent="";try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),t.deleteFromDocument()}catch(e){logger.debug(`Error usando selection API: ${e.message}`)}}else e.value="";["input","change"].forEach((t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))}))}if(n){e.focus();document.execCommand("insertText",!1,t)||(e.textContent=t,e.dispatchEvent(new Event("input",{bubbles:!0})))}else"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})));return setTimeout((()=>{const o=n?e.textContent:e.value;o!==t?logger.warn(`Posible problema al insertar texto. Esperado: "${t.substring(0,30)}...", Actual: "${o.substring(0,30)}..."`):logger.debug("Texto insertado correctamente verificado")}),50),!0}catch(e){return logger.error(`Error insertando texto en campo: ${e.message}`),!1}},simulateKeyPress(e,t="Enter",n=13){if(!e)return!1;try{e.focus();const o=[new KeyboardEvent("keydown",{key:t,code:t,keyCode:n,which:n,bubbles:!0,cancelable:!0}),new KeyboardEvent("keypress",{key:t,code:t,keyCode:n,which:n,bubbles:!0,cancelable:!0}),new KeyboardEvent("keyup",{key:t,code:t,keyCode:n,which:n,bubbles:!0,cancelable:!0})];let a=!0;return o.forEach((t=>{e.dispatchEvent(t)||(a=!1)})),a}catch(e){return logger.error(`Error simulando tecla ${t}: ${e.message}`),!1}},simulateKeyPress(e,t,n){if(!e)return!1;try{return e.focus(),setTimeout((()=>{try{let o=!0;return["keydown","keypress","keyup"].forEach((a=>{const r=new KeyboardEvent(a,{key:t,code:1===t.length?`Key${t.toUpperCase()}`:t,keyCode:n,which:n,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(r)||(logger.warn(`Evento ${a} no fue despachado correctamente`),o=!1),"keyup"!==a&&setTimeout((()=>{}),0)})),logger.debug(`Simulación de tecla ${t} ${o?"exitosa":"con problemas"}`),o}catch(e){return logger.error(`Error en simulación de tecla: ${e.message}`),!1}}),50),!0}catch(e){return logger.error(`Error preparando simulación de tecla: ${e.message}`),!1}}},storageUtils={set:function(e,t){try{if("function"==typeof GM_setValue&&GM_setValue(e,t),"undefined"!=typeof localStorage){const n="object"==typeof t?JSON.stringify(t):t;localStorage.setItem(e,n)}return!0}catch(t){return logger.error(`Error storing data: ${t.message}`,{key:e}),!1}},get:function(e,t=null){try{if("function"==typeof GM_getValue){const t=GM_getValue(e,void 0);if(void 0!==t)return t}if("undefined"!=typeof localStorage){const t=localStorage.getItem(e);if(null!==t)try{return JSON.parse(t)}catch(e){return t}}return t}catch(n){return logger.error(`Error retrieving data: ${n.message}`,{key:e}),t}},remove:function(e){try{return"function"==typeof GM_deleteValue&&GM_deleteValue(e),"undefined"!=typeof localStorage&&localStorage.removeItem(e),!0}catch(t){return logger.error(`Error removing data: ${t.message}`,{key:e}),!1}},migrateSettings:function(){logger.debug("Running settings migration check...");let e=0;return"function"==typeof GM_setValue&&"undefined"!=typeof localStorage&&["FB_CHAT_MONITOR_OPENAI_KEY","FB_CHAT_MONITOR_AI_MODEL","FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","FB_CHAT_MONITOR_OPERATION_MODE","FB_CHAT_MONITOR_SELLER_ASSISTANT_NAME","FB_CHAT_MONITOR_BUYER_ASSISTANT_NAME","FB_CHAT_MONITOR_SELLER_INSTRUCTIONS","FB_CHAT_MONITOR_BUYER_INSTRUCTIONS","FB_CHAT_MONITOR_AI_TEMP"].forEach((t=>{const n=localStorage.getItem(t);if(null!==n&&void 0===GM_getValue(t,void 0)){let o=n;try{o=JSON.parse(n)}catch(e){}GM_setValue(t,o),e++,logger.debug(`Migrated ${t} from localStorage to GM_storage`)}})),e>0?logger.log(`Settings migration complete: ${e} items migrated`):logger.debug("No settings needed migration"),e},checkStorageHealth:function(){const e="function"==typeof GM_setValue&&"function"==typeof GM_getValue,t="undefined"!=typeof localStorage;if(logger.debug(`Storage availability: GM_storage=${e}, localStorage=${t}`),!e&&!t)return logger.error("No storage mechanisms available. Data persistence will not work."),!1;try{const e="STORAGE_TEST_"+Date.now(),t="test_"+Date.now();this.set(e,t);return this.get(e,null)!==t?(logger.error("Storage verification failed: write/read mismatch"),!1):(this.remove(e),logger.debug("Storage health check passed successfully"),!0)}catch(e){return logger.error("Storage health check failed",e),!1}}},e={isActive:!1,lastActivity:Date.now(),listeners:[],initialize(){document.addEventListener("mousemove",(()=>this.recordActivity())),document.addEventListener("keydown",(()=>this.recordActivity())),document.addEventListener("click",(()=>this.recordActivity())),setInterval((()=>this.checkInactivity()),6e4),logger.debug("User activity tracker initialized")},recordActivity(){const e=!this.isActive;this.isActive=!0,this.lastActivity=Date.now(),e&&this.notifyListeners()},checkInactivity(){Date.now()-this.lastActivity>3e5&&this.isActive&&(this.isActive=!1,this.notifyListeners())},onActivityChange(e){"function"==typeof e&&this.listeners.push(e)},notifyListeners(){for(const e of this.listeners)try{e(this.isActive,this.lastActivity)}catch(e){logger.error("Error in activity listener",{},e)}}},t={async withExponentialBackoff(e,t={}){const{maxRetries:n=3,baseDelay:o=1e3,maxDelay:a=3e4,factor:r=2,jitter:s=.1}=t;let i=0,l=null;for(;i<=n;)try{return await e()}catch(e){if(l=e,i++,i>n)throw logger.error(`Operation failed after ${n} retries`,{},e),e;const t=Math.min(o*Math.pow(r,i-1),a),c=t*s,d=t+(Math.random()*c*2-c);logger.debug(`Retry attempt ${i} after ${Math.round(d)}ms`),await new Promise((e=>setTimeout(e,d)))}throw l}},n={formatDate:e=>new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e),getRelativeTime(e){const t=new Intl.RelativeTimeFormat("en",{numeric:"auto"}),n=e-Date.now(),o=Math.floor(n/1e3),a=Math.floor(o/60),r=Math.floor(a/60),s=Math.floor(r/24);return Math.abs(s)>0?t.format(s,"day"):Math.abs(r)>0?t.format(r,"hour"):Math.abs(a)>0?t.format(a,"minute"):t.format(o,"second")},sleep:e=>new Promise((t=>setTimeout(t,e)))},o={isMarketplaceMessenger(){const e=window.location.href;return e.includes("facebook.com/messages")||e.includes("messenger.com")},redirectToMarketplace:()=>!(!window.location.href.includes("messenger.com")||window.location.href.includes("marketplace"))&&(window.location.href="https://www.facebook.com/messages/t/marketplace",!0)};function a(e,t="info",n={}){return logger.notify(e,t,n)}async function r(e){return n.sleep(e)}logger.loadLogs(),e.initialize(),window.logger=logger,window.domUtils=domUtils,window.storageUtils=storageUtils,window.userActivityTracker=e,window.retryUtils=t,window.timeUtils=n,window.pageUtils=o,window.showSimpleAlert=a,window.delay=r,window.insertTextDirectly=function(e,t){return domUtils.insertTextIntoField(e,t)},window.getFbDtsg=function(){const e=document.querySelector('input[name="fb_dtsg"], meta[name="fb_dtsg"]');if(e)return e.value||e.content||"";const t=document.body.innerHTML.match(/"DTSGInitData",\[\],\{"token":"([^"]+)"/);return t?t[1]:""},window.getFacebookUserID=function(){const e=document.cookie.match(/c_user=(\d+)/);return e?e[1]:""},window.__reqCounter||(window.__reqCounter=0),window.nextReq=function(){return(++window.__reqCounter).toString(36)},window.getRevision=function(){return document.querySelector('meta[name="revision"]')?.content||"1007773680"},window.jsonToFormUrlEncoded=function(e){return Object.entries(e).map((([e,t])=>encodeURIComponent(e)+"="+encodeURIComponent(t))).join("&")},window.diagnoseModeConfig=function(){const e={storage:{GM:"function"==typeof GM_getValue?{FB_CHAT_MODE:GM_getValue("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:GM_getValue("FB_CHAT_OPERATION_MODE")}:"GM storage no disponible",localStorage:{FB_CHAT_MODE:localStorage.getItem("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:localStorage.getItem("FB_CHAT_OPERATION_MODE")}},memory:{CONFIG_operationMode:window.CONFIG?.operationMode,CONFIG_modo:window.CONFIG?.modo,ui_modeState:window.ui?.currentMode||"No disponible"},responseManager:{isAutomodeEnabled:window.responseManager?.isAutomodeEnabled||"No disponible"}};return logger.log("=== DIAGNÓSTICO DE MODO OPERACIÓN ==="),logger.log(JSON.stringify(e,null,2)),logger.log("====================================="),e};const s={isTyping:!1,intervalId:null,chatId:null};function i(e){const t=e.length*CONFIG.humanSimulation.baseTypingSpeed,n=Math.random()*CONFIG.humanSimulation.typingVariation*e.length;return Math.max(CONFIG.humanSimulation.minResponseDelay,t+n)}function l(){return Math.floor(Math.random()*(CONFIG.humanSimulation.maxResponseDelay-CONFIG.humanSimulation.minResponseDelay)+CONFIG.humanSimulation.minResponseDelay)}function c(e){return/[áéíóúñ¿¡]/i.test(e)||/\b(hola|gracias|buenos días|buenas tardes|disponible)\b/i.test(e)?"es":/[ãõçâêôáéíóú]/i.test(e)||/\b(obrigado|bom dia|boa tarde|disponível)\b/i.test(e)?"pt":/[àââçéèêëîïôœùûüÿ]/i.test(e)||/\b(bonjour|merci|bonne journée|disponible)\b/i.test(e)?"fr":"en"}function d(e){const t={en:"Hello! Thank you for your message. I'll get back to you as soon as possible.",es:"¡Hola! Gracias por tu mensaje. Te responderé lo antes posible.",pt:"Olá! Obrigado pela sua mensagem. Responderei o mais rápido possível.",fr:"Bonjour! Merci pour votre message. Je vous répondrai dès que possible."};return t[c("string"==typeof e?e:e?.text||"")]||t.en}async function u(e=null){try{const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);return t?(t.focus(),s.isTyping=!0,s.chatId=e,s.intervalId=setInterval((()=>{if(t&&s.isTyping){const e=new KeyboardEvent("keypress",{bubbles:!0,cancelable:!0,key:" ",code:"Space"});t.dispatchEvent(e),t.innerText.endsWith(" ")?t.innerText=t.innerText.slice(0,-1):t.innerText+=" ",t.dispatchEvent(new Event("input",{bubbles:!0}))}}),2e3),logger.debug("Typing indicator activated"),!0):(logger.debug("Input field not found for typing indicator"),!1)}catch(e){return logger.debug(`Error activating typing indicator: ${e.message}`),!1}}async function g(){try{s.intervalId&&(clearInterval(s.intervalId),s.intervalId=null),s.isTyping=!1;try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);e&&e.innerText&&(e.innerText="",e.dispatchEvent(new Event("input",{bubbles:!0}))),e.blur()}catch(e){}return logger.debug("Typing indicator deactivated"),!0}catch(e){return logger.debug(`Error deactivating typing indicator: ${e.message}`),!1}}async function m(e){try{return e.focus(),["keydown","keypress","keyup"].forEach((t=>{e.dispatchEvent(new KeyboardEvent(t,{key:"Enter",code:"Enter",bubbles:!0}))})),!0}catch(e){return logger.debug(`Error sending via Enter: ${e.message}`),!1}}async function p(e,t,n){try{logger.debug("Processing auto mode response");const o=l();let a;await r(o),await u(t.chatId);try{a=await openAIManager.generateResponse(t),logger.debug(`AI response generated: "${a.substring(0,30)}..."`)}catch(t){logger.error(`Error generating AI response: ${t.message}`),a=d(e[e.length-1]?.content||"")}const s=i(a);logger.debug(`Simulating typing for ${Math.round(s/1e3)} seconds`),await r(s),await g();const c=await domUtils.waitForElement(CONFIG.selectors.activeChat.messageInput);if(!c)throw new Error("Message input field not found");domUtils.insertTextIntoField(c,a),await m(c),logger.log("Auto response sent successfully");const p=f();return p.unshift({timestamp:(new Date).toISOString(),mode:"auto",context:{chatId:t.chatId,role:t.role,productDetails:t.productDetails?{id:t.productDetails.id,title:t.productDetails.title}:null,lastMessage:e[e.length-1]?.content||null},response:a,sent:!0}),storageUtils.set("RESPONSE_LOGS",p),n&&n(a),a}catch(e){throw logger.error(`Auto mode error: ${e.message}`),await g(),n&&n(null),e}}async function h(e,t,n){try{let o;logger.debug("Processing manual mode response"),await u(t.chatId);try{o=await openAIManager.generateResponse(t),logger.debug(`AI response generated in manual mode: "${o.substring(0,30)}..."`)}catch(t){logger.error(`Error generating AI response: ${t.message}`),o=d(e[e.length-1]?.content||"")}await g();const r=await domUtils.waitForElement(CONFIG.selectors.activeChat.messageInput);if(!r)throw new Error("Message input field not found");domUtils.insertTextIntoField(r,o),a("Response generated and inserted in the chat input field. Review and press Enter to send.","info"),logger.log("Manual response generated and inserted");const s=f();return s.unshift({timestamp:(new Date).toISOString(),mode:"manual",context:{chatId:t.chatId,role:t.role,productDetails:t.productDetails?{id:t.productDetails.id,title:t.productDetails.title}:null,lastMessage:e[e.length-1]?.content||null},response:o,sent:!1}),storageUtils.set("RESPONSE_LOGS",s),n&&n(o),o}catch(e){throw logger.error(`Manual mode error: ${e.message}`),await g(),n&&n(null),e}}function f(){return window.storageUtils.get("RESPONSE_LOGS",[])}const responseManager={typingState:s,calculateTypingTime:i,getRandomResponseDelay:l,detectLanguage:c,getDefaultResponse:d,startTypingIndicator:u,stopTypingIndicator:g,sendViaEnter:m,generateAndHandleResponse:async function(e,t,n,o){try{if(e.length>0&&e[e.length-1].sentByUs)return;switch(n){case"auto":await p(e,t,o);break;case"manual":await h(e,t,o);break;default:logger.debug(`Unknown operation mode: ${n}`),"function"==typeof o&&o({success:!1,error:"Unknown operation mode"})}}catch(e){logger.debug(`Error handling response: ${e.message}`),await g(),"function"==typeof o&&o({success:!1,error:e.message})}},handleAutoMode:p,handleManualMode:h,getConversationHistory:f,clearConversationHistory:function(){window.storageUtils.remove("RESPONSE_LOGS")},exportConversationHistory:function(){const e=f(),t={timestamp:(new Date).toISOString(),history:e},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}};window.responseManager=responseManager;window.responseManager=new class{constructor(){this.isAutomodeEnabled=!1,this.lastChatId=null,this.lastResponseTime=0,this.cooldownPeriod=3e4,this.processingChat=!1,this.initialize()}initialize(){this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,logger.debug(`ResponseManager initialized with automode: ${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`),document.addEventListener("configUpdated",(e=>{this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,logger.debug(`ResponseManager detected mode change: Auto=${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`)}))}setAutoMode(e){this.isAutomodeEnabled=e,logger.log("Automatic mode "+(e?"activated":"deactivated")),e&&this.verifyOpenAIAvailability()}verifyOpenAIAvailability(){if(!window.openaiManager)return logger.error("OpenAI Manager is not available. Automatic mode will not work."),a("OpenAI Manager is not available. Automatic mode will not work.","error"),!1;const e="function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():!!window.openaiManager.apiKey;return e?(e&&!window.openaiManager.isInitialized&&(window.openaiManager.isInitialized=!0,logger.debug("isInitialized=true has been corrected since the API key is present")),logger.log("OpenAI Manager is ready for automatic responses."),!0):(logger.error("OpenAI Manager does not have an API key configured. Automatic mode will not work correctly."),a("OpenAI does not have an API key configured. Configure it in the options.","error"),!1)}async processAutoResponse(e,t){if(this.processingChat||e===this.lastChatId)return logger.debug(`Skipping chat ${e} - already processed or in process`),!1;try{if(this.processingChat=!0,logger.debug(`Processing chat ${e} for automatic response`),!this.checkForUnrespondedMessages(t.messages))return logger.debug(`No unresponded messages in chat ${e}`),!1;let n;if("function"==typeof this.handleAutoMode?(logger.debug("Using handleAutoMode to generate automatic response"),n=await this.handleAutoMode(t.messages,t)):(logger.debug("Generating response with OpenAI Manager directly"),n=await window.openaiManager.generateResponse(t)),!n||!n.text&&"string"!=typeof n)throw new Error("A valid response was not received");const o=n.text||n;if(window.chatManager&&"function"==typeof window.chatManager.insertResponseInInputField)window.chatManager.insertResponseInInputField(o);else{logger.debug("chatManager.insertResponseInInputField not available, using alternative method");const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!e)throw new Error("Could not find the input field to insert the response");domUtils.insertTextIntoField(e,o)}return await this.simulateTypingAndSend(),this.lastChatId=e,this.lastResponseTime=Date.now(),logger.log(`Automatic response sent successfully to chat ${e}`),!0}catch(t){return logger.error(`Error in processAutoResponse for chat ${e}: ${t.message}`,{chatId:e},t),!1}finally{this.processingChat=!1}}checkForUnrespondedMessages(e){if(!e||0===e.length)return!1;const t=e.slice(-10);let n=0;for(let e=t.length-1;e>=0;e--){if(t[e].sentByUs)break;n++}return n>0}async simulateTypingAndSend(){try{const e=document.querySelector('div[aria-label="Press Enter to send"] button, button[data-testid="send-button"]');if(!e)return void logger.warn("Send button not found");const t=window.CONFIG?.humanSimulation?.autoSendDelay||2e3;logger.debug(`Sending automatic message in ${t/1e3} seconds...`),await new Promise((e=>setTimeout(e,t))),e.click(),logger.log("Automatic message sent")}catch(e){logger.error(`Error sending automatic message: ${e.message}`,{},e)}}};const humanSimulator=new class{constructor(){this.config=CONFIG.AI.humanSimulation,this.recentMessages=[],this.maxRecentMessages=10}async processMessageNaturally(e){try{await this.startTypingIndicator();const t=this.calculateTypingTime(e);if(await r(t),await this.stopTypingIndicator(),this.shouldSplitMessage(e))return await this.sendSplitMessage(e);{const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!t)throw new Error("Input field not found");return await this.insertTextNaturally(t,e),await this.sendViaEnter(t),this.recordMessageLength(e),!0}}catch(e){return logger.error(`Error processing message: ${e.message}`),await this.stopTypingIndicator(),!1}}async insertTextNaturally(e,t){if(!e||!t)return!1;try{e.focus(),e.innerText="",e.textContent="",document.execCommand&&(document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null)),e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(200);let n=!1;if("true"===e.contentEditable&&(e.innerText=t,e.dispatchEvent(new Event("input",{bubbles:!0})),n=!0,logger.debug("Text inserted using contentEditable innerText method")),!n&&document.execCommand)try{document.execCommand("insertText",!1,t),n=!0,logger.debug("Text inserted using execCommand method")}catch(e){logger.debug(`execCommand failed: ${e.message}`)}if(!n&&"value"in e&&(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),n=!0,logger.debug("Text inserted using value property method")),!n){for(;e.firstChild;)e.removeChild(e.firstChild);const o=document.createTextNode(t);e.appendChild(o),e.dispatchEvent(new Event("input",{bubbles:!0})),n=!0,logger.debug("Text inserted using DOM manipulation method")}return e.innerText&&""!==e.innerText.trim()?logger.debug(`Text verification: field contains "${e.innerText.substring(0,30)}..."`):(logger.warn("Text insertion succeeded but field appears empty"),e.textContent=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))),!0}catch(e){return logger.error(`Error in insertTextNaturally: ${e.message}`),!1}}createTypoVersion(e){if(e.length<10)return e;const t=Math.floor(Math.random()*(e.length-3)+1),n=Math.random();if(n<.33)return e.substring(0,t)+e[t]+e.substring(t);if(!(n<.66))return e.substring(0,t)+e.substring(t+1);{const n={a:"sqzw",b:"vghn",c:"xdfv",d:"serfcx",e:"wsrdf",f:"drtgv",g:"ftyhb",h:"gyujn",i:"ujko",j:"hyuikn",k:"jiol",l:"kop",m:"njk",n:"bhjm",o:"iklp",p:"ol",q:"wa",r:"edft",s:"awedxz",t:"rfgy",u:"yhji",v:"cfgb",w:"qase",x:"zsdc",y:"tghu",z:"asx"},o=e[t].toLowerCase();if(n[o]){const a=n[o][Math.floor(Math.random()*n[o].length)];return e.substring(0,t)+a+e.substring(t+1)}}return e}async sendViaEnter(e){try{e.focus();const t=new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"Enter",code:"Enter",keyCode:13});return e.dispatchEvent(t),setTimeout((()=>{if(e.innerText&&""!==e.innerText.trim()){const e=document.querySelector(CONFIG.selectors.activeChat.sendButton);e&&e.click()}}),200),!0}catch(e){return logger.error(`Error sending message: ${e.message}`),!1}}shouldSplitMessage(e){return!!this.config.fragmentMessages&&(!!(e&&e.length>2*this.config.fragmentThreshold)||!!(e&&e.length>this.config.fragmentThreshold)&&Math.random()<.7)}async sendSplitMessage(e){try{const t=this.splitTextIntoFragments(e);for(let e=0;e<t.length;e++){if(e>0){const n=this.calculateFragmentInterval();await r(n),await this.startTypingIndicator(),await r(Math.min(30*t[e].length,1500)),await this.stopTypingIndicator()}const n=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!n)throw new Error("Input field not found");await this.insertTextNaturally(n,t[e]),await this.sendViaEnter(n)}return this.recordMessageLength(e),!0}catch(e){return logger.error(`Error sending split message: ${e.message}`),!1}}splitTextIntoFragments(e){if(!e)return[e];if(e.includes("\n\n"))return e.split(/\n\n+/).filter((e=>e.trim()));const t=e.match(/[^.!?]+[.!?]+/g)||[e],n=[];let o="",a=0;for(const e of t)o.length+e.length>this.config.fragmentThreshold||a>=2&&Math.random()<.5?(o&&n.push(o.trim()),o=e,a=1):(o+=e,a++);return o&&n.push(o.trim()),n.length>0?n:[e]}calculateFragmentInterval(){const e=this.config.fragmentDelay[0],t=this.config.fragmentDelay[1],n=Math.random()<.3?1e3+2e3*Math.random():0;return Math.floor(e+Math.random()*(t-e)+n)}calculateTypingTime(e){if(!e)return this.config.minResponseDelay;let t=e.length*(this.config.baseTypingSpeed/1e3);const n=Math.random()*this.config.typingVariation*e.length/100;return Math.max(this.config.minResponseDelay,Math.min(t+n,this.config.maxResponseDelay))}recordMessageLength(e){e&&(this.recentMessages.push(e),this.recentMessages.length>this.maxRecentMessages&&this.recentMessages.shift())}getAverageMessageLength(){if(0===this.recentMessages.length)return 50;return this.recentMessages.reduce(((e,t)=>e+t.length),0)/this.recentMessages.length}async startTypingIndicator(){try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);return e?(e.focus(),!0):(logger.debug("Input field not found for typing indicator"),!1)}catch(e){return logger.debug(`Error activating indicator: ${e.message}`),!1}}async stopTypingIndicator(){try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);return e&&e.innerText&&(e.innerText="",e.dispatchEvent(new Event("input",{bubbles:!0}))),!0}catch(e){return logger.debug(`Error deactivating indicator: ${e.message}`),!1}}};window.humanSimulator=humanSimulator;const chatManager=new class{constructor(){this.pendingChats=[],this.currentChatId=null,this.chatHistory=new Map,this.isProcessing=!1,this.conversationLogs=JSON.parse(localStorage.getItem("FB_CHAT_MONITOR_LOGS")||"[]"),this.lastProcessedMessageCount=0,this.manualChatChangeDetected=!1,this.activeChatObserver=null,this.lastScrollHeight=0,this.isProcessingChat=!1,this.typingState={isTyping:!1,intervalId:null,chatId:null},this._setupUrlChangeDetection()}_setupUrlChangeDetection(){this._lastUrl=window.location.href,setInterval((()=>{const e=window.location.href;this._lastUrl!==e&&(this._lastUrl=e,this._handleUrlChange(e))}),1e3)}_handleUrlChange(e){try{const t=e.match(/\/marketplace\/t\/(\d+)/);if(t&&t[1]){const e=t[1];e!==this.currentChatId&&(logger.debug(`Manual chat change detected to ID: ${e}`),this.currentChatId=e,logger.debug("Chat ID updated. The chat will be processed when Generate Response is clicked."))}}catch(e){logger.error("Error handling URL change",{},e)}}async scanForUnreadChats(){logger.log("Scanning for unread chats...");try{const e=domUtils.findElement(CONFIG.selectors.chatList.container);if(!e)return logger.error("Chat list container not found"),0;const t=domUtils.findAllElements(CONFIG.selectors.chatList.chatItem,e);logger.log(`Found ${t.length} chat elements`),this.pendingChats=[];for(const e of t)if(this.isUnreadChat(e)){const t=this.extractChatId(e),n=this.extractChatUsername(e),o=this.extractMessageTime(e);if(t&&/^\d+$/.test(t)){const a=this.convertTimeToMinutes(o);this.pendingChats.push({chatId:t,userName:n,messageTime:a,formattedTime:o,element:e}),logger.debug(`Chat added to queue: ${n} (${t}), time: ${o}`)}else logger.debug(`Chat ignored with non-numeric ID: ${t}`)}return this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime)),logger.log(`Total valid unread chats: ${this.pendingChats.length}`),this.pendingChats.length>0?logger.notify(`${this.pendingChats.length} unread chats found`,"success"):logger.notify("No unread chats found","info"),this.pendingChats.length}catch(e){return logger.error(`Error scanning chats: ${e.message}`),0}}isUnreadChat(e){try{const t=e.querySelector(CONFIG.selectors.chatList.unreadIndicator);if(t){if(!(t.textContent||"").includes("Marketplace ·"))return logger.debug("Unread chat detected with specific indicator"),!0}const n=Array.from(e.querySelectorAll(CONFIG.selectors.chatList.chatUserName.selector.join(", ")));for(const e of n){const t=window.getComputedStyle(e);if(t&&parseInt(t.fontWeight)>=600)return logger.debug("Unread chat detected by bold font style"),!0}return!1}catch(e){return logger.error(`Error evaluating unread chat: ${e.message}`),!1}}extractChatId(e){const t=e.getAttribute("href");if(t&&t.includes("/marketplace/t/")){const e=t.match(/\/marketplace\/t\/(\d+)\//);if(e&&e[1])return logger.debug(`ID extracted from href: ${e[1]}`),e[1]}const n=e.querySelectorAll('a[href*="/marketplace/t/"]');for(const e of n){const t=e.getAttribute("href").match(/\/marketplace\/t\/(\d+)\//);if(t&&t[1])return logger.debug(`ID extracted from secondary link: ${t[1]}`),t[1]}const o=e.getAttribute("data-testid");if(o&&/^\d+$/.test(o))return logger.debug(`ID extracted from data-testid: ${o}`),o;const a=`chat_${this.extractChatUsername(e).replace(/\s+/g,"_").toLowerCase()}`;return logger.debug(`ID generated as fallback: ${a}`),a}extractChatUsername(e){try{if(Array.isArray(CONFIG.selectors.chatList.chatUserName.selector)){const t=CONFIG.selectors.chatList.chatUserName.selector.join(", "),n=Array.from(e.querySelectorAll(t)),o=CONFIG.selectors.chatList.chatUserName.filter?CONFIG.selectors.chatList.chatUserName.filter(n):n;if(o&&o.length>0){const e=o[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}else{const t=Array.isArray(CONFIG.selectors.chatList.chatUserName)?CONFIG.selectors.chatList.chatUserName.join(", "):CONFIG.selectors.chatList.chatUserName,n=Array.from(e.querySelectorAll(t)).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}));if(n.length>0){const e=n[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}const t=Array.from(e.querySelectorAll(CONFIG.selectors.chatList.chatUserName.selector.join(", ")))[0];return t?.innerText?.trim()||"Unknown User"}catch(e){return logger.error(`Error extracting username: ${e.message}`),"Unknown User"}}extractMessageTime(e){try{const t=domUtils.findElement(CONFIG.selectors.chatList.timestamp,e);return t?.innerText||"0m"}catch(e){return logger.error(`Error extracting message time: ${e.message}`),"0m"}}convertTimeToMinutes(e){if(!e)return 0;const t=e.match(/(\d+)([mhdsw])/);if(!t)return 0;const n=parseInt(t[1]);switch(t[2]){case"m":default:return n;case"h":return 60*n;case"d":return 60*n*24;case"w":return 60*n*24*7}}async openNextPendingChat(){if(0===this.pendingChats.length)return logger.log("No pending chats"),!1;this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime));const e=this.pendingChats.shift();logger.log(`Opening chat with ${e.userName} (${e.chatId})`);try{if(e.element&&"function"==typeof e.element.click){logger.log("Using direct click method to open chat"),e.element.scrollIntoView({behavior:"smooth",block:"center"}),logger.notify(`Opening chat: ${e.userName}`,"info"),await new Promise((e=>setTimeout(e,1e3))),e.element.click(),this.currentChatId=e.chatId,await new Promise((e=>setTimeout(e,4e3)));const t="auto"===window.CONFIG?.operationMode;return logger.debug(`Processing chat in ${t?"AUTO":"MANUAL"} mode (operationMode: ${window.CONFIG?.operationMode})`),await this.processCurrentChat(t),await this.markChatAsRead(),!0}if(/^\d+$/.test(e.chatId)){logger.log("Using direct URL navigation to open chat");const t=`https://www.messenger.com/marketplace/t/${e.chatId}/`;return logger.notify(`Navigating to: ${e.userName}`,"info"),window.location.href=t,await this.markChatAsRead(),!0}return logger.error("Could not open chat - neither by click nor by URL"),!1}catch(e){return logger.error(`Error opening chat: ${e.message}`),!1}}async generateResponseForCurrentChat(){if(!this.currentChatId)return logger.error("No active chat to generate response"),a("No active chat detected. Please select a chat first.","error"),!1;try{logger.debug("Generate Response button clicked - processing current chat"),await this.extractCurrentChatData();const e=this.chatHistory.get(this.currentChatId);if(!e||!e.messages||0===e.messages.length)return logger.error("Could not extract chat data"),a("Could not extract chat data. Please try again.","error"),!1;const t={chatId:this.currentChatId,role:e.isSeller?"seller":"buyer",messages:e.messages,productDetails:e.productDetails};return await this.handleResponse(t),!0}catch(e){return logger.error(`Error generating response: ${e.message}`),a(`Error generating response: ${e.message}`,"error"),!1}}async extractCurrentChatData(){if(!this.currentChatId)return logger.error("No active chat to extract data"),{success:!1,error:"No active chat"};logger.log(`Extracting data from chat ${this.currentChatId}`);try{const e=await domUtils.waitForElement(CONFIG.selectors.activeChat.container),t=this.determineIfSeller(e);logger.log("Role in chat: "+(t?"seller":"buyer"));let n=null;const o=productExtractor.extractProductIdFromCurrentChat(),a=this.extractProductLink(e);o&&(logger.log(`Product ID found: ${o}`),logger.debug(`Product link found: ${a}`),n=await productExtractor.getProductDetails(o,a));const r=await domUtils.waitForElement(CONFIG.selectors.activeChat.messageWrapper),s=domUtils.findElement(CONFIG.selectors.activeChat.scrollbar,r)||r;await domUtils.scrollToTop(s),s.scrollTop=s.scrollHeight;const i=await this.extractChatHistory(r);logger.log(`Extracted ${i.length} messages from chat`);const l={messages:i,productDetails:n,isSeller:t,lastUpdated:new Date};return this.chatHistory.set(this.currentChatId,l),{success:!0,chatData:l}}catch(e){return logger.error(`Error extracting chat data: ${e.message}`),{success:!1,error:e}}}async processCurrentChat(e=!1){if(null==e&&(e="auto"===window.CONFIG?.operationMode,logger.debug("Auto-respond not specified, using global setting: "+(e?"AUTO":"MANUAL"))),e)try{logger.debug("AUTO mode detected - Preventively clearing input field");const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(e){"true"===e.getAttribute("contenteditable")?(e.innerHTML="",e.textContent=""):e.value="";const t=new Event("input",{bubbles:!0});e.dispatchEvent(t)}}catch(e){logger.error(`Error in preventive cleaning: ${e.message}`)}const t=await this.extractCurrentChatData();if(!t.success)return logger.error("Failed to extract chat data during processCurrentChat."),!1;if(e){logger.debug(`Automatic response enabled for chat ${this.currentChatId} (operationMode: ${window.CONFIG?.operationMode})`);const e=t.chatData;if(!e||!e.messages||0===e.messages.length)return logger.warn("No messages found in extracted data, cannot auto-respond."),!0;const n={chatId:this.currentChatId,role:e.isSeller?"seller":"buyer",messages:e.messages,productDetails:e.productDetails};try{return logger.log(`Generating automatic response as ${n.role} for chat ${this.currentChatId}`),await this.handleResponse(n),logger.log("Automatic response generated and sent successfully"),!0}catch(e){return logger.error(`Error during automatic response generation: ${e.message}`),!1}}else logger.debug(`Automatic response disabled for chat ${this.currentChatId}. Only data was extracted.`);return!0}extractProductLink(e){const t=domUtils.findElement(CONFIG.selectors.activeChat.productLink,e);return t?.href||null}getAudioTranscription(e){if(!e||!CONFIG.audioTranscription.enabled)return null;if("[Audio URL will be detected by Performance API]"===e)return null;if(!window.audioTranscriber)return logger.debug(`Audio transcriber not available for URL: ${e}`),null;try{const t=window.audioTranscriber.getTranscription(e);if(t)return logger.debug(`Transcription found for audio: ${e.substring(0,50)}...`),t}catch(e){logger.warn(`Error accessing audio transcription: ${e.message}`)}return null}async extractChatHistory(e){if(this.isProcessingChat)return logger.warn("Chat history extraction already in progress. Skipping."),[];if(!e)return logger.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,logger.debug("Starting chat history extraction with improved selectors...");const t=[];let n=[],o=null;try{if(logger.debug(`Finding message rows using selector: ${CONFIG.selectors.activeChat.messageRow}`),n=domUtils.findAllElements(CONFIG.selectors.activeChat.messageRow,e),logger.debug(`Found ${n.length} message row elements`),0===n.length){logger.warn("Main message row selector failed. Trying fallback selectors...");const t=e.querySelectorAll('div[dir="auto"][role="none"]');if(!(t.length>0))throw new Error("No message elements found with main or fallback selectors");n=Array.from(t),logger.debug(`Fallback found ${n.length} potential message elements`)}for(let e=0;e<n.length;e++){const a=n[e],r=a,s=r.outerHTML;if(s===o){logger.debug(`Message #${e}: Duplicate row skipped`);continue}o=s;const i=domUtils.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],a)||a,l={id:`msg_${this.currentChatId}_${e}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}}};try{l.sentByUs=this.isMessageSentByUs(r);const e=domUtils.findElement(CONFIG.selectors.activeChat.messageContent,i);let n="";e&&(n=(e.innerText||e.textContent||"").trim(),n=n.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^Sent \d+d ago:\s*/i,"").trim(),n=n.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const o=this.isSystemMessage(n),s=this.isDividerElement(a);!n||o||s||(l.content.text=n,l.content.type="text");const c=domUtils.findElement(CONFIG.selectors.activeChat.messageTimestamp,r);let d=null;c&&(d=c.getAttribute("data-tooltip-content")||c.getAttribute("aria-label")||c.getAttribute("title")||c.textContent.trim(),this.isValidTimestamp(d)?l.timestamp=d:l.timestamp=null),this.detectAndAddImageContent(i,l),this.detectAndAddAudioContent(i,l),this.detectAndAddVideoContent(i,l),this.detectAndAddFileContent(i,l),this.detectAndAddLocationContent(i,l),this.detectAndAddGifContent(i,l),"unknown"===l.content.type&&(l.content.text?l.content.type="text":l.content.media.images.length>0?l.content.type="image":l.content.media.audio?l.content.type="audio":l.content.media.video?l.content.type="video":l.content.media.files.length>0?l.content.type="file":l.content.media.location?l.content.type="location":l.content.media.gif&&(l.content.type="gif")),"unknown"===l.content.type||o||s||t.push(l)}catch(t){logger.error(`Error processing message element #${e}:`,{},t)}}this.lastProcessedMessageCount=t.length,logger.log(`Extraction completed: ${t.length} messages found`)}catch(e){logger.error("Error during chat history extraction:",{},e)}finally{this.isProcessingChat=!1}return t}isValidTimestamp(e){if(!e||"string"!=typeof e)return!1;const t=e.trim();if([/^\d{1,2}:\d{2}$/,/^[a-záéíóúüñ\s]+$/i,/^(Play|Reproducir|Pause|Pausar)$/i,/^Message replied to:/i,/^Message:/i].some((e=>e.test(t))))return!1;return[/\d{1,2}:\d{2}\s*(AM|PM)/i,/\d{1,2}\/\d{1,2}\/\d{2,4}/,/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)/i,/(Today|Yesterday|Hoy|Ayer)/i,/minutes? ago|hours? ago|minutes?|hours?/i,/sent at \d{1,2}:\d{2}\s*(AM|PM)?/i,/sent at \d{1,2}:\d{2}/i].some((e=>e.test(t)))}detectAndAddImageContent(e,t){try{const n=Array.isArray(CONFIG.selectors.activeChat.messageImageElement)?CONFIG.selectors.activeChat.messageImageElement.join(", "):CONFIG.selectors.activeChat.messageImageElement,o=e.querySelectorAll(n);if(o.length>0){const e=Array.from(o).filter((e=>{const t=e.src||"";return t&&!t.startsWith("data:")&&(e.width>30||!e.width)&&(e.height>30||!e.height)&&!t.includes("/emoji.")&&!t.includes("/avatar/")}));e.length>0&&(t.content.imageUrls=e.map((e=>e.src)),t.content.media.images=e.map((e=>({url:e.src,alt:e.alt||"",width:e.width||0,height:e.height||0}))),"unknown"===t.content.type&&(t.content.type="image"))}const a=e.querySelectorAll('div[style*="background-image"]');if(a.length>0)for(const e of a){const n=(e.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(n&&n[1]&&!n[1].startsWith("data:")){const o=n[1];t.content.imageUrls.includes(o)||(t.content.imageUrls.push(o),t.content.media.images.push({url:o,alt:"Background Image",width:e.clientWidth||0,height:e.clientHeight||0}),"unknown"===t.content.type&&(t.content.type="image"))}}}catch(e){logger.error(`Error detecting images: ${e.message}`,{},e)}}detectAndAddAudioContent(e,t){try{const n=Array.isArray(CONFIG.selectors.activeChat.messageAudioPlayButton)?CONFIG.selectors.activeChat.messageAudioPlayButton.join(", "):CONFIG.selectors.activeChat.messageAudioPlayButton,o=e.querySelector(n);if(o){const n=o.getAttribute("aria-label")||"";if(n.toLowerCase().includes("video"))return;const a=this.extractAudioDuration(e)||"",r=this.extractAudioUrl(e)||null;if(t.content.hasAudio=!0,t.content.audioUrl=r,t.content.media.audio={exists:!0,url:r,duration:a,label:n},"unknown"===t.content.type&&(t.content.type="audio"),r&&"function"==typeof this.getAudioTranscription){const e=this.getAudioTranscription(r);t.content.transcribedAudio=e||"[Audio Transcription Pending]"}}else{const n=e.querySelector("audio[src]");if(n){const e=n.src;if(t.content.hasAudio=!0,t.content.audioUrl=e,t.content.media.audio={exists:!0,url:e,duration:n.duration?`${Math.round(n.duration)}s`:"",label:"Audio message"},"unknown"===t.content.type&&(t.content.type="audio"),"function"==typeof this.getAudioTranscription){const n=this.getAudioTranscription(e);t.content.transcribedAudio=n||"[Audio Transcription Pending]"}}}}catch(e){logger.error(`Error detecting audio: ${e.message}`,{},e)}}extractAudioDuration(e){try{const t=['span[style*="color: rgba"]',"span.x193iq5w",'div[dir="auto"] > span'];for(const n of t){const t=e.querySelectorAll(n);for(const e of t){const t=e.textContent.trim();if(/^\d{1,2}:\d{2}$/.test(t))return t}}return null}catch(e){return logger.debug(`Error extracting audio duration: ${e.message}`),null}}extractAudioUrl(e){try{const t=e.querySelector("audio[src]");if(t&&t.src)return t.src;const n=e.querySelector('a[href*=".mp3"], a[href*=".m4a"], a[href*=".wav"], a[href*=".ogg"]');return n&&n.href?n.href:null}catch(e){return logger.debug(`Error extracting audio URL: ${e.message}`),null}}detectAndAddVideoContent(e,t){try{const n=e.querySelector('video, a[href*="video_redirect"]');if(n){if("VIDEO"===n.tagName){const e={exists:!0,url:n.src||null,type:"video",thumbnail:this.extractVideoThumbnail(n)||null,duration:n.duration?`${Math.round(n.duration)}s`:null};t.content.media.video=e,"unknown"===t.content.type&&(t.content.type="video")}else if("A"===n.tagName&&n.href){const e={exists:!0,url:n.href,type:"video_link",thumbnail:null,duration:null};t.content.media.video=e,"unknown"===t.content.type&&(t.content.type="video")}}else{const n=Array.isArray(CONFIG.selectors.activeChat.messageVideoElement)?CONFIG.selectors.activeChat.messageVideoElement.join(", "):CONFIG.selectors.activeChat.messageVideoElement,o=e.querySelector(n);if(o){const e=o.getAttribute("aria-label")||"Video Player",n={exists:!0,url:null,type:o.style.backgroundImage||o.querySelector('div[style*="background-image"]')?"video_thumbnail":"video_player",thumbnail:this.extractBackgroundImage(o),label:e};t.content.media.video=n,"unknown"===t.content.type&&(t.content.type="video")}}}catch(e){logger.error(`Error detecting video: ${e.message}`,{},e)}}extractBackgroundImage(e){try{const t=(e.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(t&&t[1])return t[1];const n=e.querySelector('div[style*="background-image"]');if(n){const e=(n.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(e&&e[1])return e[1]}return null}catch(e){return logger.debug(`Error extracting background image: ${e.message}`),null}}extractVideoThumbnail(e){try{if(e.poster)return e.poster;const t=e.querySelector('source[type^="video/"]');return t&&t.src?t.src.replace(/\.mp4$/,".jpg"):null}catch(e){return logger.debug(`Error extracting video thumbnail: ${e.message}`),null}}detectAndAddFileContent(e,t){try{const n=Array.isArray(CONFIG.selectors.activeChat.messageFileElement)?CONFIG.selectors.activeChat.messageFileElement.join(", "):CONFIG.selectors.activeChat.messageFileElement,o=Array.from(e.querySelectorAll(n));if(o.length>0){const e=[];o.forEach((t=>{const n=t.href||null,o=this.extractFileName(t),a=this.detectFileType(t,o);(n||o)&&e.push({url:n,name:o,type:a})})),e.length>0&&(t.content.media.files=e,"unknown"===t.content.type&&(t.content.type="file"))}}catch(e){logger.error(`Error detecting files: ${e.message}`,{},e)}}extractFileName(e){try{if(e.hasAttribute("download"))return e.getAttribute("download")||this.extractFileNameFromPath(e.href);const t=e.textContent?.trim();if(t&&t.includes(".")){const e=t.match(/[\w\s\-]+\.\w+/);if(e)return e[0]}if(e.hasAttribute("title"))return e.getAttribute("title");if(e.hasAttribute("aria-label")){const t=e.getAttribute("aria-label");if(t.includes("file")||t.includes("archivo")){const e=t.split(":");if(e.length>1)return e[1].trim()}return t}return e.href?this.extractFileNameFromPath(e.href):"Unnamed file"}catch(e){return logger.debug(`Error extracting file name: ${e.message}`),"Unnamed file"}}extractFileNameFromPath(e){if(!e)return"Unnamed file";try{const t=new URL(e).pathname.split("/"),n=t[t.length-1].split("?")[0];return decodeURIComponent(n)||"Unnamed file"}catch(t){const n=e.match(/\/([^\/\?]+)(?:\?|$)/);return n?decodeURIComponent(n[1]):"Unnamed file"}}detectFileType(e,t){try{if(!t)return"unknown";const e=t.split(".").pop().toLowerCase();return{pdf:"pdf",doc:"document",docx:"document",odt:"document",rtf:"document",xls:"spreadsheet",xlsx:"spreadsheet",ods:"spreadsheet",ppt:"presentation",pptx:"presentation",odp:"presentation",txt:"text",zip:"archive",rar:"archive","7z":"archive",jpg:"image",jpeg:"image",png:"image",gif:"image",bmp:"image",mp3:"audio",wav:"audio",ogg:"audio",m4a:"audio",mp4:"video",avi:"video",mov:"video",wmv:"video"}[e]||"unknown"}catch(e){return logger.debug(`Error detecting file type: ${e.message}`),"unknown"}}detectAndAddLocationContent(e,t){try{const n=Array.isArray(CONFIG.selectors.activeChat.messageLocationElement)?CONFIG.selectors.activeChat.messageLocationElement.join(", "):CONFIG.selectors.activeChat.messageLocationElement,o=e.querySelector(n);if(o){let e=null;if("A"===o.tagName&&o.href){const t=this.extractLocationLabel(o)||"Shared location",n=this.extractCoordinates(o.href);e={url:o.href,label:t,coordinates:n}}else{const t=this.extractLocationLabel(o)||"Shared location",n=o.querySelector('a[href*="maps"]'),a=n?n.href:null;e={url:a,label:t,coordinates:a?this.extractCoordinates(a):null}}e&&(t.content.media.location=e,"unknown"===t.content.type&&(t.content.type="location"))}}catch(e){logger.error(`Error detecting location: ${e.message}`,{},e)}}extractLocationLabel(e){try{if(e.hasAttribute("aria-label"))return e.getAttribute("aria-label").replace(/location|ubicación|shared/i,"").trim();const t=e.textContent?.trim();return t&&!t.startsWith("http")?t:null}catch(e){return logger.debug(`Error extracting location label: ${e.message}`),null}}extractCoordinates(e){if(!e)return null;try{if(e.includes("maps")){let t=e.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/i);if(t||(t=e.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/i)),t)return{latitude:parseFloat(t[1]),longitude:parseFloat(t[2])}}return null}catch(e){return logger.debug(`Error extracting coordinates: ${e.message}`),null}}detectAndAddGifContent(e,t){try{const n=Array.isArray(CONFIG.selectors.activeChat.messageGifElement)?CONFIG.selectors.activeChat.messageGifElement.join(", "):CONFIG.selectors.activeChat.messageGifElement,o=e.querySelector(n);if(o){let n=null;if("IMG"===o.tagName){const t=o.src,a=t&&(t.includes("giphy.com")||t.includes("tenor.com")||t.endsWith(".gif"));n={url:t,type:!!e.querySelector('[data-testid="sticker"]')?"sticker":a?"gif":"animated_content",alt:o.alt||""}}else{const e=o.getAttribute("aria-label")||"GIF",t=o.querySelector("img");n={url:t?t.src:null,type:e.toLowerCase().includes("sticker")?"sticker":"gif",label:e}}n&&(t.content.media.gif=n,"unknown"===t.content.type&&(t.content.type="gif"))}}catch(e){logger.error(`Error detecting GIF/sticker: ${e.message}`,{},e)}}isSystemMessage(e){if(!e)return!1;const t=[/^You sent an attachment\.$/i,/^You sent a photo\.$/i,/^You sent a video\.$/i,/^You sent a GIF\.$/i,/^You shared a location\.$/i,/^You set the nickname for .* to .*$/i,/^You changed the chat colors\.$/i,/^You named the group .*$/i,/^You added .* to the group\.$/i,/^You removed .* from the group\.$/i,/^.* left the group\.$/i,/^You missed a call from .*$/i,/^Missed call$/i,/^Enviaste un adjunto\.$/i,/^Enviaste una foto\.$/i,/^Enviaste un video\.$/i,/^Enviaste un GIF\.$/i,/^Compartiste una ubicación\.$/i,/^Cambiaste los colores del chat\.$/i,/^Llamada perdida$/i,/^Llamada perdida de .*$/i,/^Nombraste al grupo .*$/i,/^Agregaste a .* al grupo\.$/i,/^Eliminaste a .* del grupo\.$/i,/^.* salió del grupo\.$/i,/^Definiste el apodo de .* como .*$/i,/^.*? bumped their message:?/i].some((t=>t.test(e)));return t&&logger.debug(`[isSystemMessage] System message detected: "${e.substring(0,30)}..."`),t}isDividerElement(e){try{const t=e.innerText||"";if(e.classList&&(e.classList.contains("x1e56ztr")||e.classList.contains("x78zum5")||e.classList.contains("xh8yej3"))){const t=e.querySelector('div[dir="auto"], span[dir="auto"]');if(!t||t.textContent.length<5)return logger.debug(`[isDivider] Element with divider class and little/no text: ${e.className}`),!0}return/^(Today|Yesterday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday|Hoy|Ayer|Lunes|Martes|Miércoles|Jueves|Viernes|Sábado|Domingo)$/i.test(t)?(logger.debug(`[isDivider] Element with day text: ${t}`),!0):/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(t)||/^\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)(\w*)(\s+\d{2,4})?$/i.test(t)||/^\d{1,2}\s+(Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)(\w*)(\s+\d{2,4})?$/i.test(t)?(logger.debug(`[isDivider] Element with date text: ${t}`),!0):("separator"===e.getAttribute("role")||"HR"===e.tagName||0===e.children.length&&"separator"===e.parentElement?.getAttribute("role"))&&(logger.debug("[isDivider] Element with separator role/tag"),!0)}catch(e){return logger.error(`Error in isDividerElement: ${e.message}`),!1}}detectQuotedMessage(e){try{const t=e.querySelector('div[data-testid="message-quote"]');if(!t)return null;const n=t.querySelector('span[data-testid="message-text"]'),o=n?n.innerText.trim():"";let a=null;const r=t.querySelector("span.x1ncwhqj, h4.xexx8yu");r&&(a=r.innerText.trim());let s=null;const i=t.querySelector(CONFIG.selectors.activeChat.messageTimestamp.join(", "));return i&&(s=i.getAttribute("aria-label")||i.getAttribute("data-tooltip-content")||i.innerText),{type:"reply",quotedText:o,originalSender:a,originalTimestamp:s}}catch(e){return logger.debug(`Error detecting quoted message: ${e.message}`),null}}extractMentions(e){try{const t=[];return e.querySelectorAll('a[href*="/user/"], span.xngnso2, span[data-hovercard]').forEach((e=>{const n=e.innerText.trim();let o=null;if(e.href){const t=e.href.match(/\/user\/(\d+)|\?id=(\d+)/);t&&(o=t[1]||t[2])}else if(e.getAttribute("data-hovercard")){const t=e.getAttribute("data-hovercard").match(/id=(\d+)/);t&&(o=t[1])}n&&t.push({name:n,id:o})})),t.length>0?t:null}catch(e){return logger.debug(`Error extracting mentions: ${e.message}`),null}}enhanceMessageContext(e,t){try{const n=this.detectQuotedMessage(e);n&&(t.context={...t.context||{},...n},t.content.type="unknown"===t.content.type?"reply":`${t.content.type}_reply`);const o=this.extractMentions(e);o&&(t.context={...t.context||{},mentions:o});const a=this.detectReactions(e);a&&(t.context={...t.context||{},reactions:a});const r=this.detectProductMention(e);r&&(t.context={...t.context||{},productMention:r})}catch(e){logger.debug(`Error enhancing message context: ${e.message}`)}}detectReactions(e){try{const t=e.querySelector('div.xq8finb, div.x6s0dn4.x78zum5.xl56j7k, div[role="toolbar"][aria-label*="reaction"]');if(!t)return null;const n=[];return t.querySelectorAll('img.emoji, span[aria-label*=":"], div[aria-label*="Reacted"]').forEach((e=>{let t="unknown",o="";if("IMG"===e.tagName)t="emoji",o=e.alt||e.getAttribute("aria-label")||"";else{const n=e.getAttribute("aria-label")||"";if(n.includes("Like"))t="like",o="👍";else if(n.includes("Love"))t="love",o="❤️";else if(n.match(/Reacted with/i)){t="emoji";const e=n.match(/Reacted with :([^:]+):/);o=e?e[1]:n.replace(/Reacted with\s*/i,"")}else o=n}o&&n.push({type:t,value:o})})),n.length>0?n:null}catch(e){return logger.debug(`Error detecting reactions: ${e.message}`),null}}detectProductMention(e){try{const t=e.querySelector('a[href*="/marketplace/item/"]');if(!t)return null;const n=t.href;let o=null;const a=n.match(/\/marketplace\/item\/(\d+)/);a&&(o=a[1]);let r="",s="";const i=t.querySelector('span[dir="auto"], div[dir="auto"]');i&&(r=i.innerText.trim());const l=e.querySelector('a[href*="/marketplace/item/"] img, div.x1ey2m1c img');return l&&l.src&&(s=l.src),{type:"product",productId:o,productUrl:n,title:r,imageUrl:s}}catch(e){return logger.debug(`Error detecting product mention: ${e.message}`),null}}detectSpecialSystemEvents(e){if(!e)return null;const t=[{pattern:/marked this item as (sold|pending|available)/i,type:"status_change",action:e=>e[1].toLowerCase()},{pattern:/changed the price from ([\d,\.]+) to ([\d,\.]+)/i,type:"price_change",action:e=>({oldPrice:e[1],newPrice:e[2]})},{pattern:/(canceled|completed) this sale/i,type:"sale_event",action:e=>e[1].toLowerCase()},{pattern:/requested more details about/i,type:"request",action:()=>"details_request"},{pattern:/marcó este artículo como (vendido|pendiente|disponible)/i,type:"status_change",action:e=>{const t=e[1].toLowerCase();return"vendido"===t?"sold":"pendiente"===t?"pending":"available"}}];for(const n of t){const t=e.match(n.pattern);if(t)return{type:n.type,action:n.action(t),originalText:e}}return null}async extractChatHistoryEnhanced(e){if(this.isProcessingChat)return logger.warn("Chat history extraction already in progress. Skipping."),[];if(!e)return logger.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,logger.debug("Starting enhanced chat history extraction...");const t=[];let n=[],o=null;try{if(n=domUtils.findAllElements(CONFIG.selectors.activeChat.messageRow,e),logger.debug(`Found ${n.length} message row elements`),0===n.length){const t=e.querySelectorAll('div[dir="auto"][role="none"]');if(!(t.length>0))throw new Error("No message elements found with main or fallback selectors");n=Array.from(t)}const a=20,r=Math.ceil(n.length/a);for(let e=0;e<r;e++){const s=e*a,i=Math.min(s+a,n.length),l=n.slice(s,i);logger.debug(`Processing batch ${e+1}/${r} (${l.length} messages)`);const c=await this.processBatchOfMessages(l,o,e);c.lastProcessed&&(o=c.lastProcessed),c.messages&&c.messages.length>0&&t.push(...c.messages),e<r-1&&await new Promise((e=>setTimeout(e,5)))}this.lastProcessedMessageCount=t.length,logger.log(`Enhanced extraction completed: ${t.length} messages processed in ${r} batches`),this.buildMessageReferences(t)}catch(e){logger.error("Error during enhanced chat history extraction:",{},e)}finally{this.isProcessingChat=!1}return t}async processBatchOfMessages(e,t,n){const o=[];let a=t;for(let t=0;t<e.length;t++){const r=e[t],s=r,i=s.outerHTML;if(i===a)continue;a=i;const l=domUtils.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],r)||r,c={id:`msg_${this.currentChatId}_${100*n+t}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}},context:{}};try{c.sentByUs=this.isMessageSentByUs(s);const e=domUtils.findElement(CONFIG.selectors.activeChat.messageContent,l);let t="";e&&(t=(e.innerText||e.textContent||"").trim(),t=t.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),t=t.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),t=t.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),t=t.replace(/^Sent \d+d ago:\s*/i,"").trim(),t=t.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const n=this.isSystemMessage(t),a=this.isDividerElement(r);if(t&&!a)if(c.content.text=t,n){const e=this.detectSpecialSystemEvents(t);e?(c.content.type="system_event",c.context.systemEvent=e):c.content.type="system"}else c.content.type="text";this.enhanceMessageContext(l,c);const i=domUtils.findElement(CONFIG.selectors.activeChat.messageTimestamp,s);if(i){const e=i.getAttribute("data-tooltip-content")||i.getAttribute("aria-label")||i.getAttribute("title")||i.textContent.trim();this.isValidTimestamp(e)&&(c.timestamp=e)}this.detectAndAddImageContent(l,c),this.detectAndAddAudioContent(l,c),this.detectAndAddVideoContent(l,c),this.detectAndAddFileContent(l,c),this.detectAndAddLocationContent(l,c),this.detectAndAddGifContent(l,c),"unknown"===c.content.type&&(c.content.text?c.content.type="text":c.content.media.images.length>0?c.content.type="image":c.content.media.audio?c.content.type="audio":c.content.media.video?c.content.type="video":c.content.media.files.length>0?c.content.type="file":c.content.media.location?c.content.type="location":c.content.media.gif&&(c.content.type="gif")),"unknown"===c.content.type||a||o.push(c)}catch(e){logger.error(`Error processing message element in batch ${n}, item ${t}:`,{},e)}}return{messages:o,lastProcessed:a}}buildMessageReferences(e){if(e&&0!==e.length)try{const t=new Map;for(let n=0;n<e.length;n++){const o=e[n];if(o.content.text){const e=o.content.text.substring(0,50).toLowerCase();t.has(e)||t.set(e,[]),t.get(e).push({index:n,id:o.id})}}for(let n=0;n<e.length;n++){const o=e[n];if(o.context&&"reply"===o.context.type&&o.context.quotedText){const a=o.context.quotedText.substring(0,50).toLowerCase();if(t.has(a)){const r=t.get(a).filter((e=>e.index<n));if(r.length>0){const t=r.reverse()[0];o.context.referencesMessageId=t.id;const n=e[t.index];n&&(n.context=n.context||{},n.context.referencedBy=n.context.referencedBy||[],n.context.referencedBy.push(o.id))}}}}logger.debug(`Message references built for ${e.length} messages`)}catch(e){logger.error("Error building message references:",{},e)}}determineIfSeller(e){try{for(const t of CONFIG.selectors.activeChat.sellerIndicators)if(t.includes(":contains")){const n=t.match(/:contains\("(.+?)"\)/)[1];if(Array.from(e.querySelectorAll("*")).filter((e=>e.textContent&&e.textContent.includes(n))).length>0)return logger.debug(`Seller indicator found: ${n}`),!0}else{if(e.querySelectorAll(t).length>0)return logger.debug(`Seller indicator found: ${t}`),!0}for(const t of CONFIG.selectors.activeChat.buyerIndicators)if(t.includes(":contains")){const n=t.match(/:contains\("(.+?)"\)/)[1];if(Array.from(e.querySelectorAll("*")).filter((e=>e.textContent&&e.textContent.includes(n))).length>0)return logger.debug(`Buyer indicator found: ${n}`),!1}else{if(e.querySelectorAll(t).length>0)return logger.debug(`Buyer indicator found: ${t}`),!1}logger.debug("No definitive role indicators found, using alternative heuristic");return!!e.querySelector('a[href*="/marketplace/item/"]')&&(logger.debug("Product link found, likely a buyer"),!1)}catch(e){return logger.error(`Error determining seller/buyer role: ${e.message}`,{},e),!1}}isMessageSentByUs(e){const t="row"===e?.getAttribute("role")?e:e?.closest('div[role="row"]');if(!t)return logger.debug("[isMessageSentByUs] Could not find the div[role='row'] container. Assuming foreign message."),!1;try{if(t.classList.contains("x1ja2u2z"))return logger.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1ja2u2z'. It's own."),!0;if(t.classList.contains("x1yc453h"))return logger.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1yc453h'. It's foreign."),!1;logger.debug("[isMessageSentByUs] CLASS INDICATOR: No conclusive class detected in the row.");const e=t.firstElementChild;if("gridcell"===e?.getAttribute("role")&&"messages_table"===e.getAttribute("data-scope"))return logger.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell has data-scope='messages_table'. It's own."),!0;logger.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell does not have data-scope='messages_table'.");try{const e=window.getComputedStyle(t).getPropertyValue("justify-content");if("flex-end"===e)return logger.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-end'. It's own."),!0;if("flex-start"===e)return logger.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-start'. It's foreign."),!1;logger.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is '${e}'. Not conclusive.`)}catch(e){logger.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: Error getting style: ${e.message}`)}if(Array.from(t.querySelectorAll("[aria-label]")).some((e=>{const t=e.getAttribute("aria-label");return t&&/you sent|enviaste/i.test(t)})))return logger.debug("[isMessageSentByUs] ARIA INDICATOR: Found 'you sent' in aria-label. It's own."),!0;logger.debug("[isMessageSentByUs] ARIA INDICATOR: No sending text found in aria-label.");if(domUtils.findElement(CONFIG.selectors.activeChat.senderAvatar,t))return logger.debug("[isMessageSentByUs] AVATAR INDICATOR: Avatar found in the row. It's foreign."),!1;logger.debug("[isMessageSentByUs] AVATAR INDICATOR: No avatar found in the row. Could be own.");const n=t.querySelector("h5 > span");return n&&/you sent|enviaste/i.test(n.textContent||"")?(logger.debug(`[isMessageSentByUs] TEXTUAL INDICATOR (H5): Found '${n.textContent.trim()}'. It's own.`),!0):(logger.warn("[isMessageSentByUs] Could not determine the sender with certainty after all checks. Assuming foreign message."),!1)}catch(e){return logger.error(`[isMessageSentByUs] General error processing the row: ${e.message}`,{html:t.outerHTML.substring(0,200)},e),!1}}async handleResponse(e){try{if(logger.log("[ChatManager] Initiating handleResponse..."),!e||!e.messages||0===e.messages.length)throw logger.error("[ChatManager] Invalid chat context or no messages."),new Error("Invalid chat context or no messages");const t="seller"===e.role?"seller":"buyer";logger.log(`[ChatManager] Role: ${t}, Total messages for context: ${e.messages.length}`),this.logAssistantContext(e);const n=window.CONFIG?.operationMode||"manual";logger.log(`[ChatManager] Configured operation mode (for sending): ${n}`);const o=window.openaiManager;let r=!1;if("object"==typeof o&&"function"==typeof o.generateResponse&&"function"==typeof o.isReady&&(r=o.isReady()),logger.debug(`[ChatManager] OpenAI Assistant Service (via window.openaiManager) Available: ${r}`),o&&"function"==typeof o.isReady?logger.debug(`[ChatManager] window.openaiManager details: apiKey=${!!o.apiKey}, isInitialized=${o.isInitialized}, isReady=${o.isReady()}`):o&&logger.debug(`[ChatManager] window.openaiManager details: apiKey=${!!o.apiKey}, isInitialized=${o.isInitialized}, isReady method not found.`),!r){logger.warn("[ChatManager] No AI services available (window.openaiManager not configured or not ready).");const n=`You are in a conversation as ${t}.\nProduct: ${e.productDetails?`${e.productDetails.title} (${e.productDetails.price})`:"No product information"}\nNo AI services configured. Please check options.`;return a(n,"info"),o?logger.debug(n+`\n[ChatManager] Debug: window.openaiManager ready state: ${o.isReady?o.isReady():"isReady method missing"}, isInitialized: ${o.isInitialized}`):logger.debug(n+"\n[ChatManager] Debug: window.openaiManager is not an object."),{text:n,error:!0,refusalReason:"No AI service configured"}}logger.log("[ChatManager] Attempting to use OpenAI Assistant API via window.openaiManager..."),a("Consulting the OpenAI Assistant...","info");try{const t=await o.generateResponse(e);if(t&&(t.error||t.parsingError)){const e=t.responseText||"An error occurred with the Assistant.";throw logger.error(`[ChatManager] Assistant API error or parsing issue: ${e}`,t),a(e,"error"),new Error(e)}if(t&&!1===t.isSafeResponse){const e=`Assistant response flagged as unsafe. Reason: ${t.refusalReason||"No specific reason provided."}`;throw logger.warn(`[ChatManager] ${e}`,t),a(e,"warning"),new Error(e)}if(t&&"string"==typeof t.responseText){logger.log(`[ChatManager] Response text from Assistant API: ${t.responseText.substring(0,100)}...`),t.buyerIntent&&logger.log(`Assistant perceived buyer intent: ${t.buyerIntent}`),t.suggestedAction&&logger.log(`Assistant suggested action: ${t.suggestedAction}`),t.sentiment&&logger.log(`Assistant perceived sentiment: ${t.sentiment}`);return(window.CONFIG?.autoSend||!1)&&"auto"===n?window.humanSimulator?(logger.log("[ChatManager] Sending Assistant response automatically..."),await window.humanSimulator.typeAndSendMessage(t.responseText),a("Response sent automatically","success")):(logger.error("[ChatManager] HumanSimulator not available for automatic sending."),this.insertResponseInInputField(t.responseText),a("Response inserted (HumanSimulator missing)","info")):(this.insertResponseInInputField(t.responseText),a("Response inserted. Review and send.","info")),await this.markChatAsRead(),t}{let e="[ChatManager] Could not generate a valid structured response from the Assistant API (via window.openaiManager).";throw t?"string"!=typeof t.responseText&&(e='[ChatManager] Assistant API response (from window.openaiManager) missing "responseText".'):e="[ChatManager] Received null/undefined response from window.openaiManager.",logger.error(e,{receivedResponse:t}),a(e,"error"),new Error(e)}}catch(e){throw logger.error(`[ChatManager] Error during Assistant API call (via window.openaiManager): ${e.message}`,{},e),a(`Assistant API Error: ${e.message}`,"error"),e}}catch(e){throw logger.error(`[ChatManager] Critical error in handleResponse: ${e.message}`,{},e),e.message.includes("API Error:")||e.message.includes("parsing issue")||e.message.includes("unsafe")||e.message.includes("Could not generate a valid structured response")||a(`Error generating response: ${e.message}`,"error"),e}}logAssistantContext(e){try{const t={timestamp:(new Date).toISOString(),chatId:this.currentChatId,totalMessages:e.messages?e.messages.length:0,ourUserRole:e.role||"unknown",hasProductDetails:!!e.productDetails},n={text:0,image:0,audio:0,video:0,file:0,location:0,gif:0,system:0,system_event:0,reply:0,unknown:0,other:0};e.messages&&Array.isArray(e.messages)&&e.messages.forEach((e=>{let t=e.content?.type||"unknown";t.includes("_reply")&&(n.reply++,t=t.replace("_reply","")),void 0!==n[t]?n[t]++:n.other++})),console.group("📤 Context prepared for Assistant/OpenAI"),console.log("%cMetadata:","font-weight:bold; color:blue;",t),console.log("%cContent statistics:","font-weight:bold; color:green;",n),e.productDetails&&console.log("%cProduct details (original):","font-weight:bold; color:purple;",e.productDetails),e.messages&&Array.isArray(e.messages)&&(console.log('%cMessage history (console display - roles based on "sentByUs"):',"font-weight:bold; color:brown;"),e.messages.forEach(((e,t)=>{let n=`${t+1}. ${e.sentByUs?"📤 ASSISTANT (Our User)":"📥 USER (Other Person)"}${e.timestamp?` (${e.timestamp})`:""}: `;if(e.content?.text?n+=e.content.text:e.content?.type&&"unknown"!==e.content.type?n+=`[${e.content.type.toUpperCase()}]`:n+="[Empty or unknown content]",console.log(n),e.content.media){const t=e.content.media;t.images&&t.images.length&&console.log(`   🖼️ ${t.images.length} images`),t.audio&&console.log("   🔊 Audio"+(t.audio.duration?` (${t.audio.duration})`:"")),t.video&&console.log("   🎬 Video"+(t.video.type?` (${t.video.type})`:"")),t.files&&t.files.length&&console.log(`   📎 ${t.files.length} files`),t.location&&console.log(`   📍 Location: ${t.location.label||""}`),t.gif&&console.log(`   ✨ GIF/Sticker: ${t.gif.type}`)}e.content.transcribedAudio&&console.log(`   🎤 Transcription: "${e.content.transcribedAudio}"`)})));const o={role:e.role,product:e.productDetails?{id:e.productDetails.listingId||e.productDetails.id||null,title:e.productDetails.title||null,price:e.productDetails.price||null,description:e.productDetails.description||null,condition:e.productDetails.condition||null,location:e.productDetails.locationInfo?.city||e.productDetails.city||null,category:e.productDetails.categoryName||null,imageUrls:e.productDetails.imageUrls||[]}:null,conversation:(e.messages||[]).map((e=>{let t=null;e.content.transcribedAudio&&!e.content.transcribedAudio.startsWith("[")&&(t=e.content.transcribedAudio);let n=null;const o=!(!e.content.media?.audio&&!e.content.audioUrl);return o&&e.content.transcribedAudio&&e.content.transcribedAudio.startsWith("[")&&(n=e.content.transcribedAudio),{fromUser:!e.sentByUs,timestamp:e.timestamp||null,text:e.content.text||null,transcribedAudio:t,hasAudio:o,audioStatus:n,imageUrls:e.content.media?.images?.map((e=>e.url))||e.content.imageUrls||[],analysis:e.context||null}}))},a={metadata:t,contentStats:n,assistantInputContext:o};console.log("%cComplete object for `console.dir` (includes metadata and custom context):","font-weight:bold; color:darkblue;"),console.dir(a),console.log("%cComplete JSON (custom structure for analysis/OpenAI input):","font-weight:bold; color:darkred;"),console.log(JSON.stringify(o,null,2)),console.groupEnd(),window.exportAssistantContext=()=>{const e=o,t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`assistant_context_${this.currentChatId}_${(new Date).toISOString().replace(/[:.]/g,"_")}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),console.log("✅ Context JSON file (custom structure) downloaded. To export again, run: exportAssistantContext()")},console.log("To export this context as a JSON file (custom structure), run: exportAssistantContext()")}catch(e){logger.error(`Error displaying assistant context: ${e.message}`,{},e)}}insertResponseInInputField(e){try{const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!t)return logger.error("Message input field not found"),!1;const n="auto"===window.CONFIG?.operationMode;return logger.debug("Operation mode when inserting response: "+(n?"AUTO":"MANUAL")),setTimeout((()=>{window.openaiManager&&"function"==typeof window.openaiManager.clearInputField&&(window.openaiManager.clearInputField(),logger.debug("First cleaning phase completed with openaiManager")),this.forceCleanInputField(t),logger.debug("Second direct cleaning phase completed");const o="true"===t.getAttribute("contenteditable")?(t.textContent||"").trim():(t.value||"").trim();if(o&&(logger.warn(`Field is NOT empty after two cleaning attempts. Current content: "${o.substring(0,20)}..."`),this.emergencyCleanField(t),n))return logger.debug("AUTO mode detected, applying additional pause to ensure complete cleaning"),setTimeout((()=>{this.insertTextAndPotentiallySend(t,e,n)}),500),!0;setTimeout((()=>{this.insertTextAndPotentiallySend(t,e,n)}),100)}),n?300:0),!0}catch(e){return logger.error(`Error inserting response in input field: ${e.message}`),!1}}insertTextAndPotentiallySend(e,t,n){try{if(logger.debug("Inserting text in input field"),domUtils.insertTextIntoField(e,t),CONFIG.autoSendMessages&&n){logger.debug("Automatic sending activated in AUTO mode, sending message...");const n=CONFIG.sendMessageDelay||2e3;logger.debug(`Waiting ${n}ms before sending so that Facebook processes the text...`),setTimeout((()=>{const n="true"===e.getAttribute("contenteditable")?e.textContent||"":e.value||"";n.trim()===t.trim()?(logger.debug("Text verified, sending message..."),this.sendMessage(!0)):logger.warn(`The final text (${n.length} chars) does not match the expected one (${t.length} chars), aborting automatic sending`)}),n)}else CONFIG.autoSendMessages?n||logger.debug(`MANUAL mode detected (operationMode: ${window.CONFIG?.operationMode})`):logger.debug("Automatic sending deactivated (autoSendMessages: false)")}catch(e){logger.error(`Error in insertTextAndPotentiallySend: ${e.message}`)}}sendMessage(e=!1){try{logger.debug(`Initiating message sending attempt (${e?"after inserting text":"direct"})`);const t=[...CONFIG.selectors.activeChat.sendButton,'div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][tabindex="0"][style*="transform: translateY(0px)"]','div.xjbqb8w:not([style*="opacity: 0"])','div.x1i10hfl[role="button"]:not(.x1hc1fzr)'];logger.debug(`Searching for send button with ${t.length} selectors...`);const n=domUtils.findElement(t);if(n){const e=n.getBoundingClientRect(),t=window.getComputedStyle(n);e.width>0&&e.height>0&&"hidden"!==t.visibility&&"none"!==t.display&&"0"!==t.opacity?(logger.debug(`Send button found and visible (${e.width}x${e.height}), clicking...`),setTimeout((()=>{try{return n.click(),logger.log("Message sent by clicking on the button"),this.markChatAsRead(),!0}catch(e){logger.warn(`Error when doing normal click: ${e.message}, trying simulated event...`);try{return n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),logger.log("Message sent using simulated click event"),this.markChatAsRead(),!0}catch(e){logger.error(`Error simulating click event: ${e.message}`)}}}),100)):logger.warn("Send button found but NOT visible/enabled. Using alternative method.")}else logger.debug("Send button not found, trying with Enter key...");const o=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(o){if(logger.debug("Simulating Enter key in the input field..."),domUtils.simulateKeyPress(o,"Enter",13))return logger.log("Message sent simulating Enter key with domUtils.simulateKeyPress"),this.markChatAsRead(),!0;o.focus();const t=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(o.dispatchEvent(t))return logger.log("Message sent simulating Enter key with KeyboardEvent"),this.markChatAsRead(),!0;logger.warn("The event was not sent correctly");try{if(document.execCommand("insertText",!1,"\n"))return logger.log("Message sent using execCommand insertText"),this.markChatAsRead(),!0}catch(e){logger.error(`Error using execCommand: ${e.message}`)}if(!e)return logger.debug("First attempt failed, scheduling retry after 1 second..."),setTimeout((()=>this.sendMessage(!0)),1e3),!0}return logger.error("Could not send the message after all attempts"),!1}catch(e){return logger.error(`Error sending message: ${e.message}`,{},e),!1}}forceCleanInputField(e){try{if(!e)return;if("true"===e.getAttribute("contenteditable")){e.innerHTML="",e.textContent="";try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n),document.execCommand("delete",!1,null)}catch(e){logger.debug(`Error using selection to clean: ${e.message}`)}}else e.value="";["input","change","keyup"].forEach((t=>{const n=new Event(t,{bubbles:!0});e.dispatchEvent(n)}))}catch(e){logger.debug(`Error in forced cleaning: ${e.message}`)}}emergencyCleanField(e){try{if(e.parentNode){const t=e.cloneNode(!1);e.parentNode.replaceChild(t,e);[new KeyboardEvent("keydown",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"Delete",keyCode:46,bubbles:!0}),new KeyboardEvent("keyup",{key:"Delete",keyCode:46,bubbles:!0})].forEach((e=>t.dispatchEvent(e))),logger.debug("Emergency cleaning applied (node replacement)")}else logger.warn("Could not apply emergency cleaning: the field has no parent node")}catch(e){logger.debug(`Error in emergency cleaning: ${e.message}`)}}sendMessage(){try{const e=domUtils.findElement(CONFIG.selectors.activeChat.sendButton);if(e)return logger.debug("Send button found, clicking..."),e.click(),logger.log("Message sent by clicking on the button"),!0;const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(t){if(logger.debug("Simulating Enter key in the input field..."),domUtils.simulateKeyPress(t,"Enter",13))return logger.log("Message sent simulating Enter key with simulateKeyPress"),!0;t.focus();const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(t.dispatchEvent(e))return logger.log("Message sent simulating Enter key"),!0;logger.warn("The keydown event was not processed by the input field");try{return document.execCommand("insertText",!1,"\n"),logger.log("Message sent using execCommand"),!0}catch(e){logger.debug(`execCommand failed: ${e.message}`)}}return logger.error("Could not send the message - send button or input field not found"),!1}catch(e){return logger.error(`Error sending message: ${e.message}`,{},e),!1}}async processChatAndAutoRespond(e){try{logger.log(`Extracting data from chat ${e}`);if(!("auto"===window.CONFIG?.operationMode))return logger.debug(`Auto-response deactivated for chat ${e}. The current mode is: ${window.CONFIG?.operationMode}`),!1;logger.log(`Automatic mode activated (operationMode: ${window.CONFIG?.operationMode}), processing automatic response...`);const t=await this.extractChatData(e);if(!t.success)return logger.error(`Error extracting chat data for automatic response: ${t.error||"Unknown error"}`),!1;if(logger.debug(`AUTO mode activated (${window.CONFIG?.operationMode}), processing automatic response`),!window.responseManager)return logger.error("responseManager not found to process automatic response"),!1;if(!window.openaiManager)return logger.error("openaiManager not found to process automatic response"),!1;if(!("function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.apiKey&&window.openaiManager.isInitialized))return logger.error("OpenAI Manager is not ready to process automatic response"),!1;const n=await window.responseManager.processAutoResponse(e,t.chatData);return logger.log("Result of processAutoResponse: "+(n?"success":"failed")),n}catch(e){return logger.error(`Error processing chat for automatic response: ${e.message}`,{},e),a(`Error processing automatic response: ${e.message}`,"error"),!1}}async markChatAsRead(e=null){const t=e||this.currentChatId;if(!t)return logger.error("No chat ID to mark as read"),!1;logger.log(`Attempting to mark chat as read: ${t}`);try{const e=['div[aria-label="Marcar como leído"]','div[aria-label="Mark as read"]','div[aria-label*="read"][role="button"]','div.xuk3077[role="row"] div[aria-label*="unread"]','div.x78zum5[role="row"] div.xzg4506:not(:empty)','div[role="grid"] div[role="row"] div.xzg4506:not(:empty)'];let n=null;if(document.querySelector(`[data-thread-id="${t}"]`)||document.querySelector(`[href*="${t}"]`))for(const t of e)if(n=document.querySelector(t),n){logger.debug(`Found unread message indicator with selector: ${t}`);break}if(n&&(logger.debug('Simulating click on "mark as read" indicator'),this.simulateCompatibleMouseEvents(n),await new Promise((e=>setTimeout(e,1e3))),!document.querySelector(e.join(", "))))return logger.log("Chat marked as read successfully (indicator disappeared)"),!0;try{const e=document.querySelectorAll(`[data-thread-id="${t}"], [href*="${t}"]`);for(const t of e){const e=Object.keys(t).find((e=>e.startsWith("__reactFiber$")));if(e){const n=t[e];if(n){const e=n.return?.stateNode;if(e&&"function"==typeof e.markRead)return logger.debug("Found Facebook internal markRead function, attempting to use"),e.markRead(),logger.log("Chat marked as read using Facebook internal API"),!0}}}}catch(e){logger.debug(`Error attempting to use internal API: ${e.message}`)}if(this.currentChatId===t){const e=domUtils.findElement(CONFIG.selectors.activeChat.container);if(e)return e.scrollTop=e.scrollHeight,await new Promise((e=>setTimeout(e,1500))),logger.debug("Chat marked as read by scrolling to most recent messages"),!0}return logger.warn(`Could not explicitly mark chat ${t} as read, but sending response may have done it automatically`),!0}catch(e){return logger.error(`Error marking chat as read: ${e.message}`),!1}}};window.chatManager=chatManager;const y={};function b(e){try{if(!e)return null;const t=[/marketplace\/item\/(\d+)/i,/marketplace\/item\.php\?id=(\d+)/i,/item\/(\d+)/i];for(const n of t){const t=e.match(n);if(t&&t[1])return t[1]}return null}catch(e){return logger.error("Error extracting product ID from URL",e),null}}function w(e,t){logger.debug("[ProductExtractor] Extracting basic data from DOM...");try{let n="Marketplace";const o=e.querySelectorAll("h1, span.x193iq5w");for(const e of o)if(e.textContent&&e.textContent.trim().length>0&&"Marketplace"!==e.textContent.trim()){n=e.textContent.trim();break}let a="";const r=e.querySelectorAll('.x193iq5w.xeuugli.x13faqbe.x1vvkbs, span[dir="auto"] > span');for(const e of r)if(e.textContent&&/\$|€|£|¥|₹|₽|¢|₩|₴|₦|₫|₱/i.test(e.textContent)){a=e.textContent.trim();break}let s="";const i=e.querySelectorAll('span[dir="auto"], div[data-ad-comet-preview="message"], div[data-contents="true"]');for(const e of i)if(e.textContent&&e.textContent.length>50&&!e.textContent.includes("Marketplace")){s=e.textContent.trim();break}if(!s||s.length<50){const t=e.querySelectorAll('div[role="row"] div[dir="auto"]');t.length>0&&(s=t[t.length-1].textContent.trim())}const l=[],c=e.querySelectorAll('img[src*="scontent"], img[src*="fbcdn"]');for(const e of c)if(e.src&&!e.src.includes("profile")&&!l.includes(e.src)&&(l.push(e.src),l.length>=5))break;const d={id:t,title:n,price:a,description:s,imageUrls:l,extractedFromDOM:!0,extractedFrom:"dom-fallback"};return logger.debug("[ProductExtractor] Extracted basic product details from DOM",d),d}catch(e){return logger.error("[ProductExtractor] Error extracting from DOM",e),{id:t,title:"Marketplace",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"dom-error"}}}function v(e,t){return new Promise(((n,o)=>(logger.debug("[ProductExtractor] Using GM_xmlhttpRequest to fetch HTML for product:",{productId:e,url:t}),y[e]?(logger.debug(`[ProductExtractor] Product ${e} found in cache`),console.log("--- CACHED PRODUCT DATA ---"),console.log(JSON.stringify(y[e],null,2)),console.log("--- END PRODUCT DATA ---"),n(y[e])):"function"!=typeof GM_xmlhttpRequest?o(new Error("GM_xmlhttpRequest not available")):void GM_xmlhttpRequest({method:"GET",url:t,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"},timeout:15e3,onload:function(a){if(a.status>=200&&a.status<300)try{const o=(new DOMParser).parseFromString(a.responseText,"text/html");let r=function(e,t){logger.debug("[ProductExtractor] Extracting data from embedded JSON...");const n=e.querySelectorAll("script");let o=null,a=null;for(const e of n){const t=e.textContent;if(!t)continue;const n='"adp_MarketplacePDPContainerQueryRelayPreloader_',r='"adp_MarketplacePDPC2CMediaViewerWithImagesQueryRelayPreloader_';let s=-1,i=!1;if(o||(s=t.indexOf(n),-1!==s&&(i=!0)),-1!==s||a||(s=t.indexOf(r),-1!==s&&(i=!1)),-1!==s)try{const e=t.indexOf('"',s+1);if(-1===e)continue;const n=t.indexOf(",",e);if(-1===n)continue;const r=t.indexOf("{",n);if(-1===r)continue;let l=1,c=r+1;for(;c<t.length&&l>0;){const e=t[c];if("{"===e)l++;else if("}"===e)l--;else if('"'===e)for(c++;c<t.length;){if("\\"===t[c])c++;else if('"'===t[c])break;c++}c++}if(0===l){const e=c-1,n=t.substring(r,e+1);try{const e=JSON.parse(n);if(logger.debug(`[ProductExtractor] Parsed JSON (${i?"Main":"Media"}).`),i?e?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?o=e:logger.debug("[ProductExtractor] Incorrect main structure."):e?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?.listing_photos?a=e:logger.debug("[ProductExtractor] Incorrect media structure."),o&&a)break}catch(e){logger.warn(`[ProductExtractor] Error parsing JSON (${i?"Main":"Media"}):`,e)}}}catch(e){logger.error(`[ProductExtractor] Error processing script (${i?"Main":"Media"}):`,e)}}if(o)try{const e=o.__bbox.result.data.viewer.marketplace_product_details_page.target,n=e.marketplace_listing_seller,r=e.location?.reverse_geocode_detailed;let s=[];if(a)try{const e=a.__bbox.result.data.viewer.marketplace_product_details_page.target.listing_photos;e&&Array.isArray(e)&&(s=e.map((e=>e?.image?.uri)).filter(Boolean))}catch(e){logger.warn("[ProductExtractor] Error extracting images from media JSON:",e)}const i=e.primary_listing_photo?.listing_image?.uri;i&&!s.includes(i)&&s.unshift(i);let l=e.formatted_price?.text||"";const c=e.listing_price?.amount||"",d=e.listing_price?.currency||"";!l&&c&&(l="COP"===d?`$${parseInt(c).toLocaleString("es-CO")} COP`:"USD"===d?`$${parseInt(c).toLocaleString("en-US")}`:"EUR"===d?`€${parseInt(c).toLocaleString("de-DE")}`:`${d} ${parseInt(c).toLocaleString()}`,logger.debug(`[ProductExtractor] Manually formatted price: ${l}`));const u={source:"inline_json",title:e.marketplace_listing_title||"",description:e.redacted_description?.text||"",price:l,currency:e.listing_price?.currency||"",amount:e.listing_price?.amount||"",url:e.story?.url||t,listingId:e.id||"",image:s.length>0?s[0]:"",imageUrls:s,sellerName:n?.name||"",sellerId:n?.id||"",sellerProfilePic:n?.profile_picture?.uri||"",categoryName:e.marketplace_listing_category_name||"",isSold:e.is_sold||!1,isLive:e.is_live||!1,city:r?.city||"",state:r?.state||"",postalCode:r?.postal_code||"",extractedFrom:"inline_json"};return logger.debug("[ProductExtractor] Extraction completed from embedded JSON."),u}catch(e){logger.error("[ProductExtractor] Error processing main JSON data:",e)}return null}(o,t);r||(logger.warn("[ProductExtractor] Inline JSON extraction failed for "+e+", trying DOM extraction fallback"),r=w(o,e)),y[e]=r,logger.debug(`[ProductExtractor] Product ${e} cached`),console.log("--- EXTRACTED PRODUCT DATA ---"),console.log(JSON.stringify(r,null,2)),console.log("--- END PRODUCT DATA ---"),n(r)}catch(t){logger.error("[ProductExtractor] Error parsing product HTML",t);try{const t=w((new DOMParser).parseFromString(a.responseText,"text/html"),e);y[e]=t,console.log("--- PRODUCT DATA (FALLBACK) ---"),console.log(JSON.stringify(t,null,2)),console.log("--- END PRODUCT DATA ---"),n(t)}catch(e){o(e)}}else o(new Error(`HTTP Error: ${a.status}`))},onerror:function(t){logger.error("[ProductExtractor] GM_xmlhttpRequest network error for product "+e,{error:JSON.stringify(t)}),o(t)},ontimeout:function(){o(new Error("Request timeout"))}}))))}!function(){try{const e=storageUtils.get("PRODUCT_CACHE",{});Object.assign(y,e),logger.debug(`Loaded ${Object.keys(y).length} cached products from storage`)}catch(e){logger.error("Error loading product cache",e)}}(),setInterval((()=>{try{storageUtils.set("PRODUCT_CACHE",y),logger.debug(`Saved ${Object.keys(y).length} product cache entries to storage`)}catch(e){logger.error("Error saving product cache",e)}}),6e4),window.productExtractor={getProductDetails:async function(e,t=null){try{if(!e)throw new Error("Product ID is required");if(y[e])return logger.debug(`Retrieved product ${e} from cache`),y[e];t||(t=`https://www.facebook.com/marketplace/item/${e}/`),logger.debug(`Fetching product details for ID: ${e} from URL: ${t}`);try{return await v(e,t)}catch(t){logger.warn(`Failed to fetch product ${e} from URL: ${t.message}`),logger.debug("Attempting DOM extraction fallback");const n=function(){logger.debug("[ProductExtractor] Attempting DOM extraction fallback for product details");try{let e=null;const t=document.querySelector('a[href*="/marketplace/item/"]');if(t&&(e=b(t.href)),!e)return logger.warn("[ProductExtractor] No product ID found in current page"),null;if(y[e])return console.log("--- CACHED PRODUCT DATA (DOM) ---"),console.log(JSON.stringify(y[e],null,2)),console.log("--- END PRODUCT DATA ---"),y[e];const n=w(document,e);return y[e]=n,logger.debug(`[ProductExtractor] Product ${e} cached from DOM extraction`),console.log("--- PRODUCT DATA EXTRACTED FROM DOM ---"),console.log(JSON.stringify(n,null,2)),console.log("--- END PRODUCT DATA ---"),n}catch(e){return logger.error("[ProductExtractor] Error extracting product details from current page",e),null}}()||{id:e,title:"Unknown Product",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"fallback-error"};return y[e]=n,"fallback-error"===n.extractedFrom&&(console.log("--- PRODUCT DATA (DEFAULT FALLBACK) ---"),console.log(JSON.stringify(n,null,2)),console.log("--- END PRODUCT DATA ---")),n}}catch(t){throw logger.error(`Error getting product details for ${e}:`,t),t}},extractProductIdFromUrl:b,extractProductIdFromCurrentChat:function(){try{logger.debug("Attempting to extract product ID from current chat");const e=document.querySelectorAll('a[href*="/marketplace/item/"]');if(0===e.length){const e=document.querySelectorAll('div[role="row"] div[dir="auto"] a');for(const t of e)if(t.href&&t.href.includes("/marketplace/item/")){const e=b(t.href);if(e)return logger.debug(`Found product ID ${e} from text reference`),e}const t=document.querySelectorAll('iframe[src*="marketplace"], div[data-testid*="marketplace"]');for(const e of t){const t=e.src||e.getAttribute("data-testid");if(t){const e=t.match(/marketplace\/item\/(\d+)/i);if(e&&e[1])return logger.debug(`Found product ID ${e[1]} from embedded element`),e[1]}}return logger.debug("No product links found in current chat"),null}const t=e[0].href,n=b(t);return n?(logger.debug(`Found product ID ${n} from link`),logger.debug(`Product link found: ${t}`),n):(logger.debug("Could not extract product ID from link"),null)}catch(e){return logger.error("Error extracting product ID from current chat:",e),null}},inspectProduct:function(e){if(!e){const t=document.querySelector('a[href*="/marketplace/item/"]');t&&(e=b(t.href))}return e&&y[e]?(console.log("--- MANUAL PRODUCT INSPECTION ---"),console.log(JSON.stringify(y[e],null,2)),console.log("--- END INSPECTION ---"),y[e]):(console.error("No product with ID "+e+" in cache to inspect"),null)}};class OpenAIManager{constructor(){this.apiKey=storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","")||"",this.model="gpt-4.1-mini",this.isInitialized=!1,this.activeThreads=new Map,this.threadTTL=18e5,this.assistants={seller:storageUtils.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),buyer:storageUtils.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),default:storageUtils.get("FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","")},this.metrics={totalCalls:0,successfulCalls:0,failedCalls:0,totalTokensUsed:0,avgResponseTime:0,totalResponseTime:0}}initialize(e=null){try{return e&&(this.apiKey=e,CONFIG.AI.apiKey=e,storageUtils.set("FB_CHAT_MONITOR_OPENAI_KEY",e),CONFIG.audioTranscription&&(CONFIG.audioTranscription.apiKey=e)),this.model="gpt-4.1-mini",CONFIG.AI.model="gpt-4.1-mini",this.apiKey?(this.isInitialized=!0,logger.debug("initialize(): API key present, setting isInitialized=true")):(this.isInitialized=!1,logger.debug("initialize(): No API key, setting isInitialized=false")),logger.log("OpenAI Manager initialized: "+(this.isInitialized?"SUCCESS":"FAILED - No API Key")),setInterval((()=>this.cleanupOldThreads()),9e5),this.schedulePeriodicChecks(),this.isInitialized}catch(e){return logger.error(`Error initializing OpenAI Manager: ${e.message}`),!1}}loadConfig(e=null){return logger.debug("loadConfig() called - redirecting to initialize()"),this.initialize(e)}async setApiKey(e){this.apiKey=e,CONFIG.AI.apiKey=e,storageUtils.set("FB_CHAT_MONITOR_OPENAI_KEY",e);const t=await this.validateApiKey();return this.isInitialized=t,t}verifyServiceState(){if(logger.log("Verifying OpenAI service status..."),this!==window.openaiManager&&(logger.warn("Incorrect openaiManager instance, correcting reference..."),Object.assign(this,window.openaiManager)),!this.isInitialized||!this.apiKey)if(logger.debug("OpenAI Manager is not initialized, attempting to recover state"),CONFIG?.AI?.apiKey)logger.debug("Using API key from CONFIG to initialize OpenAI Manager"),this.apiKey=CONFIG.AI.apiKey,this.isInitialized=!0;else{const e=storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(logger.debug("Using API key from localStorage to initialize OpenAI Manager"),this.apiKey=e,this.isInitialized=!0)}const e=!!this.apiKey;return e&&!this.isInitialized&&(this.isInitialized=!0,logger.debug("Correcting isInitialized to TRUE because we have apiKey")),logger.log("Final status of OpenAI Manager: "+(e?"AVAILABLE":"NOT AVAILABLE")),logger.debug(`Details: apiKey exists=${!!this.apiKey}, isInitialized=${this.isInitialized}, isReady()=${e}`),e}schedulePeriodicChecks(){setInterval((()=>this.verifyServiceState()),6e4),logger.debug("Periodic service checks scheduled")}isReady(){return!!this.apiKey&&(this.isInitialized||(this.isInitialized=!0,logger.debug("Auto-corrected isInitialized to true since API key exists")),!0)}async validateApiKey(){if(!this.apiKey)return!1;try{const e=await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"}});if(e.ok)return logger.log("API key validated successfully"),!0;{const t=await e.json();return logger.error(`API key validation failed: ${t.error?.message||"Unknown error"}`),!1}}catch(e){return logger.error(`API key validation error: ${e.message}`),!1}}async generateResponse(e){if(!this.isReady()&&(this.verifyServiceState(),!this.isReady()))return logger.warn("OpenAI Manager is not ready to generate responses"),{responseText:"I'm sorry, I can't generate a response because I don't have access to the OpenAI API. Please verify your API key in the configuration.",buyerIntent:"error",suggestedAction:"check_config",sentiment:"error",isSafeResponse:!1,refusalReason:"OpenAI Manager not ready.",error:!0};const t=Date.now();this.metrics.totalCalls++;try{const n=this.getAssistantIdForRole(e.role);if(!n)throw new Error(`No assistant configured for role: ${e.role}`);logger.debug(`Using assistant ${n} for role ${e.role}`);const o=await this.getOrCreateThread(e.chatId);await this.addMessageToThread(o.id,e);const a=await this.runAssistant(o.id,n);this.metrics.successfulCalls++;const r=Date.now()-t;return this.metrics.totalResponseTime+=r,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.successfulCalls,logger.debug(`Structured response generated in ${r}ms`),a}catch(e){return this.metrics.failedCalls++,logger.error(`Error generating structured response: ${e.message}`),{responseText:`Error generating response: ${e.message}`,buyerIntent:"error",suggestedAction:"retry_or_check_logs",sentiment:"error",isSafeResponse:!1,refusalReason:`Internal error: ${e.message}`,error:!0}}}clearInputField(){try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!e)return logger.error("Message input field to clear not found"),!1;const t="true"===e.getAttribute("contenteditable"),n=t?(e.textContent||"").trim():(e.value||"").trim();if(!n)return logger.debug("Field is already empty, no cleaning needed"),!0;logger.debug(`Field has previous content (${n.length} chars): "${n.substring(0,30)}..."`);const o=document.activeElement;if(t){e.innerHTML="",e.textContent="",e.focus(),document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null);const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t),n.deleteFromDocument(),setTimeout((()=>{e.textContent="",e.innerHTML=""}),0)}else"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(e.value="",e.setAttribute("value",""));if(["input","change","keyup","keydown"].forEach((t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))})),setTimeout((()=>{const n=t?(e.textContent||"").trim():(e.value||"").trim();if(n){logger.warn(`Cleaning not effective, remaining content: "${n.substring(0,30)}..."`);try{if(t){e.innerHTML="";const t=e.parentNode;if(t){const n=e.cloneNode(!1);t.replaceChild(n,e),n.dispatchEvent(new Event("input",{bubbles:!0}))}}else"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||(Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(e,""),e.dispatchEvent(new Event("input",{bubbles:!0})))}catch(e){logger.debug(`Error in emergency cleaning: ${e.message}`)}}else logger.debug("Verification: Field clean after process")}),50),o!==e&&o)try{o.focus()}catch(e){}return logger.debug("Aggressive cleaning of the input field completed"),!0}catch(e){return logger.error(`Error in clearInputField: ${e.message}`,{},e),!1}}getAssistantIdForRole(e){let t=this.assistants[e];return t||(t=this.assistants.default,logger.debug(`No assistant for role ${e}, using default assistant`)),t||("seller"===e&&CONFIG.AI?.assistants?.seller?.id?t=CONFIG.AI.assistants.seller.id:"buyer"===e&&CONFIG.AI?.assistants?.buyer?.id&&(t=CONFIG.AI.assistants.buyer.id)),t}async getOrCreateThread(e){const t=this.activeThreads.get(e);if(t&&Date.now()-t.lastUsed<this.threadTTL)return t.lastUsed=Date.now(),this.activeThreads.set(e,t),t;try{const t=await fetch("https://api.openai.com/v1/threads",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({})});if(!t.ok){const e=await t.json();throw new Error(e.error?.message||"Failed to create thread")}const n=await t.json();return this.activeThreads.set(e,{id:n.id,lastUsed:Date.now()}),logger.debug(`Created new thread ${n.id} for chat ${e}`),n}catch(e){throw logger.error(`Error creating thread: ${e.message}`),e}}async addMessageToThread(e,t){try{const n=this.prepareMessageContent(t),o=await fetch(`https://api.openai.com/v1/threads/${e}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({role:"user",content:n})});if(!o.ok){const e=await o.json();throw new Error(e.error?.message||"Failed to add message to thread")}return logger.debug(`Added message to thread ${e}`),await o.json()}catch(e){throw logger.error(`Error adding message to thread: ${e.message}`),e}}prepareMessageContent(e){const{role:t,messages:n,productDetails:o,analysis:a}=e,r={role:t,product:o?{id:o.id,title:o.title,price:o.price,description:o.description,condition:o.condition,location:o.location,category:o.category,imageUrls:o.imageUrls||[]}:null,conversation:n.slice(-(CONFIG.AI.messageHistoryLimit||100)).map((e=>{if(!e||!e.content)return{role:e?.sentByUs?"assistant":"user",content:"[Invalid message structure]",error:"Invalid message structure"};const t={role:e.sentByUs?"assistant":"user"};let n="";return e.content.text&&(n+=e.content.text,t.text=e.content.text),e.content.transcribedAudio&&"string"==typeof e.content.transcribedAudio&&!e.content.transcribedAudio.startsWith("[")?(n+=(n?" ":"")+`[Transcribed Audio: ${e.content.transcribedAudio}]`,t.transcribedAudio=e.content.transcribedAudio):e.content.audioUrl&&(n+=(n?" ":"")+"[Audio message present]",t.hasAudio=!0,"string"==typeof e.content.transcribedAudio&&e.content.transcribedAudio.startsWith("[")&&(t.audioStatus=e.content.transcribedAudio)),e.content.imageUrls&&Array.isArray(e.content.imageUrls)&&e.content.imageUrls.length>0&&(n+=(n?" ":"")+`[${e.content.imageUrls.length} image(s) sent]`,t.imageUrls=e.content.imageUrls),e.content.media&&(e.content.media.video&&(n+=(n?" ":"")+"[Video present]",t.video=e.content.media.video),e.content.media.files&&e.content.media.files.length>0&&(n+=(n?" ":"")+`[${e.content.media.files.length} file(s) present]`,t.files=e.content.media.files),e.content.media.location&&(n+=(n?" ":"")+"[Location shared]",t.location=e.content.media.location),e.content.media.gif&&(n+=(n?" ":"")+"[GIF/Sticker present]",t.gif=e.content.media.gif)),t.content=n||"[Media message without text]",e.timestamp&&(t.timestamp=e.timestamp),t})),analysis:a||null};logger.debug("[OpenAIManager] JSON Payload to be sent to Assistant:",r);const s=[{type:"text",text:JSON.stringify(r)}];return logger.debug("[OpenAIManager] Prepared message content for API:",{textLength:s[0].text.length}),s}async runAssistant(e,t){try{const n=await fetch(`https://api.openai.com/v1/threads/${e}/runs`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({assistant_id:t,response_format:{type:"json_object"}})});if(!n.ok){const e=await n.json().catch((()=>({error:{message:n.statusText}})));throw new Error(`Failed to start run: ${e.error?.message||n.statusText}`)}const o=await n.json();logger.debug(`Started run ${o.id} on thread ${e} with response_format: json_object`),await this.pollRunUntilComplete(e,o.id);const a=await this.getAssistantResponseFromRun(e,o.id);try{const e=JSON.parse(a);return"string"!=typeof e.responseText?(logger.warn('Parsed response is missing "responseText" or it is not a string. This may indicate the assistant instructions need adjustment to enforce the JSON schema.',{parsedResponse:e}),{responseText:a,buyerIntent:"parse_error",suggestedAction:"review_assistant_instructions",sentiment:"unknown",isSafeResponse:!0,refusalReason:"Response structure mismatch after parsing. Ensure assistant instructions enforce the desired JSON schema.",parsingError:!0,rawResponse:a}):(logger.debug("Successfully parsed assistant's JSON response."),e)}catch(e){throw logger.error(`Error parsing assistant's JSON response: ${e.message}`,{jsonStringResponse:a}),new Error(`Failed to parse assistant's JSON response: ${e.message}. Raw response: ${a.substring(0,200)}...`)}}catch(e){throw logger.error(`Error running assistant: ${e.message}`),e}}async pollRunUntilComplete(e,t){const n=1e3;let o=0;return logger.debug(`[pollRunUntilComplete] Starting polling for run ${t} on thread ${e}`),new Promise((async(a,r)=>{const s=async()=>{try{if(o++,o>60)return logger.error(`[pollRunUntilComplete] Polling timed out for run ${t} after 60 attempts.`),void r(new Error(`Polling timed out for run ${t}`));const i=await fetch(`https://api.openai.com/v1/threads/${e}/runs/${t}`,{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"}});if(!i.ok){const e=await i.json().catch((()=>({error:{message:i.statusText}})));return logger.error(`[pollRunUntilComplete] Error fetching run status for ${t}: ${e.error?.message||i.statusText}`),o<5&&(500===i.status||503===i.status)?(logger.warn(`[pollRunUntilComplete] Retrying due to server error (status ${i.status}). Attempt ${o}/5.`),void setTimeout(s,n*o)):void r(new Error(`Failed to fetch run status: ${e.error?.message||i.statusText}`))}const l=await i.json();switch(logger.debug(`[pollRunUntilComplete] Run ${t} status: ${l.status} (Attempt: ${o})`),l.status){case"queued":case"in_progress":case"requires_action":setTimeout(s,n);break;case"completed":logger.log(`[pollRunUntilComplete] Run ${t} completed successfully.`),a();break;case"failed":logger.error(`[pollRunUntilComplete] Run ${t} failed. Reason: ${l.last_error?.message||"Unknown error"}`),r(new Error(`Run failed: ${l.last_error?.message||"Unknown error"}`));break;case"cancelled":logger.warn(`[pollRunUntilComplete] Run ${t} was cancelled.`),r(new Error("Run was cancelled"));break;case"expired":logger.error(`[pollRunUntilComplete] Run ${t} expired.`),r(new Error("Run expired"));break;default:logger.error(`[pollRunUntilComplete] Unknown run status for ${t}: ${l.status}`),r(new Error(`Unknown run status: ${l.status}`))}}catch(e){if(logger.error(`[pollRunUntilComplete] Error during polling for run ${t}: ${e.message}`),o<5)return logger.warn(`[pollRunUntilComplete] Retrying due to polling error. Attempt ${o}/5.`),void setTimeout(s,n*o);r(e)}};s()}))}async getAssistantResponseFromRun(e,t){try{const t=await fetch(`https://api.openai.com/v1/threads/${e}/messages?limit=1&order=desc`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!t.ok){const e=await t.json().catch((()=>({error:{message:t.statusText}})));throw new Error(`Failed to retrieve messages: ${e.error?.message||t.statusText}`)}const n=await t.json(),o=n.data&&n.data.length>0?n.data[0]:null;if(!o||"assistant"!==o.role)throw logger.error("No assistant message found as the latest message, or latest message not from assistant.",{messagesData:n.data}),new Error("No assistant message found as the latest message in the thread.");if(o.content&&o.content.length>0){const e=o.content.find((e=>"text"===e.type));if(e&&e.text&&"string"==typeof e.text.value)return logger.debug("Retrieved assistant's message content (expected to be JSON string)."),e.text.value}throw logger.error("No text content found in assistant message or content is not in expected format.",{assistantMessage:o}),new Error("No text content found in assistant message or content is not in expected format.")}catch(e){throw logger.error(`Error retrieving assistant response: ${e.message}`),e}}setAssistantForRole(e,t){if(!["seller","buyer","default"].includes(e))throw new Error(`Invalid role: ${e}`);this.assistants[e]=t,storageUtils.set(`FB_CHAT_MONITOR_${e.toUpperCase()}_ASSISTANT_ID`,t),logger.log(`Set assistant ${t} for role ${e}`)}async createOrUpdateAssistant(e,t,n){if(!this.isInitialized&&!this.apiKey)throw logger.error("API key not initialized. Cannot create or update assistant."),new Error("API key not initialized");let o=this.assistants[e];const a={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},r=this.model||"gpt-4o-mini",s={name:t,instructions:n,model:r};let i,l;o?(i=`https://api.openai.com/v1/assistants/${o}`,l="POST",logger.debug(`Updating assistant ${o} for role ${e} with model ${r}.`)):(i="https://api.openai.com/v1/assistants",l="POST",logger.debug(`Creating new assistant for role ${e} with model ${r}.`));try{const t=await fetch(i,{method:l,headers:a,body:JSON.stringify(s)});if(!t.ok){const n=await t.text();logger.error(`Failed to ${o?"update":"create"} assistant for role ${e}: ${t.status} ${t.statusText}`,{errorBody:n});const a=JSON.parse(n);throw new Error(a.error?.message||`Failed to ${o?"update":"create"} assistant: ${t.status}`)}return o=(await t.json()).id,this.assistants[e]=o,storageUtils.set(`FB_CHAT_MONITOR_${e.toUpperCase()}_ASSISTANT_ID`,o),logger.log(`Assistant ${o} ${o&&"POST"===l&&i.includes(o)?"updated":"created"} successfully for role ${e}.`),o}catch(e){throw e.message?e:new Error(`Unexpected error during assistant ${o?"update":"creation"}: ${String(e)}`)}}async listAssistants(){try{const e=await fetch("https://api.openai.com/v1/assistants?limit=100",{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to list assistants")}return(await e.json()).data}catch(e){throw logger.error(`Error listing assistants: ${e.message}`),e}}cleanupOldThreads(){const e=Date.now();let t=0;for(const[n,o]of this.activeThreads.entries())e-o.lastUsed>this.threadTTL&&(this.activeThreads.delete(n),t++);t>0&&logger.debug(`Cleaned up ${t} expired threads`)}getMetrics(){return{...this.metrics,activeThreads:this.activeThreads.size}}}const openAIManager=new OpenAIManager;window.openaiManager=openAIManager,console.log("[OpenAI Manager] Instance exposed globally as window.openaiManager"),window.openaiManager&&window.openaiManager.isReady||(console.warn("[OpenAI Manager] OpenAI Manager not available or missing necessary methods, reinstalling..."),window.openaiManager=openAIManager,"function"!=typeof window.openaiManager.initialize&&(console.error("[OpenAI Manager] CRITICAL ERROR! The initialize method is not available after reinstalling"),window.openaiManager.initialize=function(e=null){return openAIManager.initialize(e)}),"function"!=typeof window.openaiManager.isReady&&(window.openaiManager.isReady=function(){return!!window.openaiManager.apiKey}),"function"!=typeof window.openaiManager.verifyServiceState&&(window.openaiManager.verifyServiceState=function(){return openAIManager.verifyServiceState()})),CONFIG?.AI?.apiKey&&!window.openaiManager.apiKey&&(window.openaiManager.apiKey=CONFIG.AI.apiKey,window.openaiManager.isInitialized=!0),console.log("[OpenAI Manager] Status after global verification:",`apiKey=${!!window.openaiManager.apiKey}`,`isInitialized=${window.openaiManager.isInitialized}`,`isReady=${"function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():"method not available"}`),window.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{window.openaiManager||(console.error("[OpenAI Manager] Error: openaiManager not detected in window after DOMContentLoaded. Reinstalling..."),window.openaiManager=openAIManager),window.openaiManager.isReady()&&"function"==typeof window.openaiManager.listAssistants&&(console.log("[OpenAI Manager] Starting automatic loading of assistants..."),window.openaiManager.listAssistants().then((e=>{console.log(`[OpenAI Manager] ${e.length} assistants found automatically`),window.updateAssistantsList&&window.updateAssistantsList(e)})).catch((e=>{console.warn("[OpenAI Manager] Error loading assistants automatically:",e.message)})))}),1e3)}));const assistantManagerUI=new class{constructor(){this.initialized=!1}initialize(){this.initialized||(this.createStyles(),this.createPanel(),this.attachEvents(),this.initialized=!0,logger.debug("Assistant Manager UI initialized"))}createStyles(){const e=document.createElement("style");e.textContent="\n          .assistant-manager-panel {\n            position: fixed;\n            right: 20px;\n            top: 60px;\n            width: 300px;\n            background: white;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n            overflow: hidden;\n            z-index: 9999;\n            font-family: Arial, sans-serif;\n            transition: all 0.3s ease;\n          }\n\n          .assistant-manager-header {\n            background: #1877f2;\n            color: white;\n            padding: 10px 15px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n          }\n\n          .assistant-manager-content {\n            padding: 15px;\n            max-height: 400px;\n            overflow-y: auto;\n          }\n\n          .assistant-manager-field {\n            margin-bottom: 15px;\n          }\n\n          .assistant-manager-field label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: bold;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field input,\n          .assistant-manager-field textarea {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field textarea {\n            height: 80px;\n            resize: vertical;\n          }\n\n          .assistant-manager-tabs {\n            display: flex;\n            border-bottom: 1px solid #ddd;\n          }\n\n          .assistant-manager-tab {\n            padding: 8px 15px;\n            cursor: pointer;\n            border-bottom: 2px solid transparent;\n          }\n\n          .assistant-manager-tab.active {\n            border-bottom: 2px solid #1877f2;\n            font-weight: bold;\n          }\n\n          .assistant-manager-tab-content {\n            display: none;\n            padding-top: 10px;\n          }\n\n          .assistant-manager-tab-content.active {\n            display: block;\n          }\n\n          .assistant-manager-button {\n            background: #1877f2;\n            color: white;\n            border: none;\n            padding: 8px 15px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin-top: 5px;\n          }\n\n          .assistant-manager-button:hover {\n            background: #166fe5;\n          }\n\n          .assistant-manager-status {\n            margin-top: 10px;\n            padding: 8px;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-status.success {\n            background: #e6f7e6;\n            color: #25a025;\n          }\n\n          .assistant-manager-status.error {\n            background: #ffebeb;\n            color: #e60000;\n          }\n\n          .assistant-manager-toggle {\n            position: fixed;\n            right: 20px;\n            top: 20px;\n            background: #1877f2;\n            color: white;\n            border: none;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n            z-index: 9999;\n            font-size: 20px;\n          }\n\n          .hidden {\n            display: none;\n          }\n        ",document.head.appendChild(e)}createPanel(){const e=document.createElement("button");e.className="assistant-manager-toggle",e.innerHTML="🤖",e.title="Manage Assistants",document.body.appendChild(e);const t=document.createElement("div");t.className="assistant-manager-panel hidden";const n=document.createElement("div");n.className="assistant-manager-header",n.innerHTML='<span>Assistant Management</span><span id="assistant-close">✕</span>',t.appendChild(n);const o=document.createElement("div");o.className="assistant-manager-content";const a=document.createElement("div");a.className="assistant-manager-field",a.innerHTML=`\n          <label for="openai-api-key">OpenAI API Key:</label>\n          <input type="password" id="openai-api-key" placeholder="sk-..." value="${CONFIG.AI.apiKey||""}">\n          <button id="save-api-key" class="assistant-manager-button">Save</button>\n        `,o.appendChild(a);const r=document.createElement("div");r.className="assistant-manager-tabs",r.innerHTML='\n          <div class="assistant-manager-tab active" data-tab="seller">Seller</div>\n          <div class="assistant-manager-tab" data-tab="buyer">Buyer</div>\n        ',o.appendChild(r);const s=document.createElement("div"),i=document.createElement("div");i.className="assistant-manager-tab-content active",i.id="tab-seller",i.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-name">Name:</label>\n            <input type="text" id="seller-assistant-name" value="${CONFIG.AI.assistants.seller.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-instructions">Instructions:</label>\n            <textarea id="seller-assistant-instructions">${CONFIG.AI.assistants.seller.instructions||""}</textarea>\n          </div>\n          <button id="save-seller-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="seller-assistant-status" class="assistant-manager-status hidden"></div>\n        `,s.appendChild(i);const l=document.createElement("div");l.className="assistant-manager-tab-content",l.id="tab-buyer",l.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-name">Name:</label>\n            <input type="text" id="buyer-assistant-name" value="${CONFIG.AI.assistants.buyer.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-instructions">Instructions:</label>\n            <textarea id="buyer-assistant-instructions">${CONFIG.AI.assistants.buyer.instructions||""}</textarea>\n          </div>\n          <button id="save-buyer-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="buyer-assistant-status" class="assistant-manager-status hidden"></div>\n        `,s.appendChild(l),o.appendChild(s),t.appendChild(o),document.body.appendChild(t),this.panel=t,this.toggleButton=e}attachEvents(){this.toggleButton.addEventListener("click",(()=>this.panel.classList.toggle("hidden"))),document.getElementById("assistant-close").addEventListener("click",(()=>this.panel.classList.add("hidden"))),document.querySelectorAll(".assistant-manager-tab").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".assistant-manager-tab").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".assistant-manager-tab-content").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.getElementById(`tab-${e.dataset.tab}`).classList.add("active")}))})),document.getElementById("save-api-key").addEventListener("click",(async()=>{const e=document.getElementById("openai-api-key").value.trim();if(e)try{CONFIG.AI.apiKey=e,localStorage.setItem("FB_CHAT_MONITOR_OPENAI_KEY",e);const t=this.openAIInitialized=openAIManager.initialize(e);this.showStatus(t?"success":"error",t?"API Key saved":"Invalid API Key")}catch(e){this.showStatus("error",`Error: ${e.message}`)}else this.showStatus("error","Please enter a valid API Key")})),document.getElementById("save-seller-assistant").addEventListener("click",(()=>this.saveAssistant("seller"))),document.getElementById("save-buyer-assistant").addEventListener("click",(()=>this.saveAssistant("buyer")))}async saveAssistant(e){const t=document.getElementById(`${e}-assistant-name`).value.trim(),n=document.getElementById(`${e}-assistant-instructions`).value.trim(),o=document.getElementById(`${e}-assistant-status`);if(t&&n)if(CONFIG.AI.apiKey){this.showStatus("info","Saving assistant...",o);try{const a=await openAIManager.createOrUpdateAssistant(e,t,n);CONFIG.AI.assistants[e]={id:a,name:t,instructions:n},localStorage.setItem(`FB_CHAT_MONITOR_${e.toUpperCase()}_ASSISTANT_ID`,a),this.showStatus("success",`Assistant "${t}" saved`,o)}catch(e){this.showStatus("error",`Error: ${e.message}`,o)}}else this.showStatus("error","Set API Key first",o);else this.showStatus("error","Complete all fields",o)}showStatus(e,t,n=null){const o=n||document.querySelector(".assistant-manager-status");o&&(o.textContent=t,o.className=`assistant-manager-status ${e}`,o.classList.remove("hidden"),setTimeout((()=>o.classList.add("hidden")),5e3))}};window.assistantManagerUI=assistantManagerUI;const A={isControlPanelVisible:!1,activeTab:"dashboard",floatingButton:null,controlPanel:null,statusIndicator:null,floatingResponseButton:null};function x(){A.floatingButton=function(){const e=document.createElement("div");e.id="fb-chat-monitor-button",e.style.position="fixed",e.style.top="20px",e.style.right="60px",e.style.bottom="auto",e.style.left="auto",e.style.padding="10px 15px",e.style.backgroundColor="#4267B2",e.style.color="white",e.style.borderRadius="5px",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.style.cursor="pointer",e.style.zIndex="9999",e.style.display="flex",e.style.alignItems="center",e.style.transition="all 0.3s ease",e.style.fontFamily="Arial, sans-serif";const t=document.createElement("div");t.id="fb-chat-monitor-status-dot",t.style.width="10px",t.style.height="10px",t.style.backgroundColor="#4CAF50",t.style.borderRadius="50%",t.style.marginRight="8px",e.appendChild(t);const n=document.createElement("span");return n.textContent="FB Chat Monitor",e.appendChild(n),e.addEventListener("mouseover",(function(){this.style.backgroundColor="#365899"})),e.addEventListener("mouseout",(function(){this.style.backgroundColor="#4267B2"})),e.addEventListener("click",I),document.body.appendChild(e),A.statusIndicator=t,e}(),function(){const e="\n        .fb-chat-monitor-panel {\n          position: fixed;\n          bottom: 80px;\n          right: 20px;\n          width: 380px;\n          max-width: 90vw;\n          background-color: white;\n          border-radius: 8px;\n          box-shadow: 0 2px 20px rgba(0,0,0,0.2);\n          z-index: 9998;\n          font-family: Arial, sans-serif;\n          display: flex;\n          flex-direction: column;\n          max-height: calc(100vh - 100px);\n          transition: all 0.3s ease;\n          overflow: hidden;\n        }\n\n        .fb-chat-monitor-panel-header {\n          padding: 15px;\n          background-color: #4267B2;\n          color: white;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-radius: 8px 8px 0 0;\n        }\n\n        .fb-chat-monitor-panel-header h2 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n        }\n\n        .fb-chat-monitor-close {\n          background: none;\n          border: none;\n          color: white;\n          font-size: 20px;\n          cursor: pointer;\n          padding: 0;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 24px;\n          height: 24px;\n        }\n\n        .fb-chat-monitor-panel-tabs {\n          display: flex;\n          border-bottom: 1px solid #ddd;\n          background-color: #f5f5f5;\n        }\n\n        .fb-chat-monitor-tab {\n          padding: 10px 15px;\n          cursor: pointer;\n          position: relative;\n          flex: 1;\n          text-align: center;\n          color: #666;\n          font-size: 14px;\n          transition: all 0.2s ease;\n        }\n\n        .fb-chat-monitor-tab:hover {\n          background-color: rgba(66, 103, 178, 0.05);\n        }\n\n        .fb-chat-monitor-tab.active {\n          color: #4267B2;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-tab.active::after {\n          content: '';\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          width: 100%;\n          height: 3px;\n          background-color: #4267B2;\n        }\n\n        .fb-chat-monitor-panel-content {\n          flex: 1;\n          overflow-y: auto;\n          padding: 15px;\n        }\n\n        .fb-chat-monitor-tab-content {\n          display: none;\n          animation: fadeIn 0.3s ease;\n        }\n\n        .fb-chat-monitor-tab-content.active {\n          display: block;\n        }\n\n        .fb-chat-monitor-status-section {\n          display: flex;\n          align-items: center;\n          margin-bottom: 15px;\n          padding-bottom: 10px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-status-indicator {\n          width: 12px;\n          height: 12px;\n          border-radius: 50%;\n          margin-right: 10px;\n        }\n\n        .fb-chat-monitor-status-text {\n          flex: 1;\n        }\n\n        .fb-chat-monitor-stats-grid {\n          display: grid;\n          grid-template-columns: repeat(2, 1fr);\n          gap: 10px;\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-stat-item {\n          background-color: #f9f9f9;\n          border-radius: 6px;\n          padding: 10px;\n          text-align: center;\n        }\n\n        .fb-chat-monitor-stat-value {\n          font-size: 18px;\n          font-weight: bold;\n          color: #4267B2;\n          margin-bottom: 5px;\n        }\n\n        .fb-chat-monitor-stat-label {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-form-group {\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-form-group label {\n          display: block;\n          font-size: 14px;\n          margin-bottom: 5px;\n          color: #444;\n        }\n\n        .fb-chat-monitor-form-group input,\n        .fb-chat-monitor-form-group select {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid #ddd;\n          border-radius: 4px;\n          font-size: 14px;\n        }\n\n        .fb-chat-monitor-radio-group {\n          margin: 10px 0;\n        }\n\n        .fb-chat-monitor-radio-option {\n          display: flex;\n          align-items: center;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-radio-option input {\n          margin-right: 8px;\n          width: auto;\n        }\n\n        .fb-chat-monitor-radio-label {\n          display: flex;\n          flex-direction: column;\n        }\n\n        .fb-chat-monitor-radio-label span:first-child {\n          font-weight: 500;\n        }\n\n        .fb-chat-monitor-radio-label span:last-child {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-button {\n          padding: 8px 12px;\n          background-color: #4267B2;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n          margin-right: 8px;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-button:hover {\n          background-color: #365899;\n        }\n\n        .fb-chat-monitor-button-secondary {\n          background-color: #eaeaea;\n          color: #333;\n        }\n\n        .fb-chat-monitor-button-secondary:hover {\n          background-color: #d5d5d5;\n        }\n\n        .fb-chat-monitor-button-danger {\n          background-color: #f44336;\n        }\n\n        .fb-chat-monitor-button-danger:hover {\n          background-color: #d32f2f;\n        }\n\n        .fb-chat-monitor-button-success {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-button-success:hover {\n          background-color: #388E3C;\n        }\n\n        .fb-chat-monitor-logs-container {\n          border: 1px solid #eee;\n          border-radius: 4px;\n          max-height: 200px;\n          overflow-y: auto;\n          font-size: 12px;\n          font-family: monospace;\n        }\n\n        .fb-chat-monitor-log-entry {\n          padding: 5px 8px;\n          border-bottom: 1px solid #f0f0f0;\n        }\n\n        .fb-chat-monitor-log-entry:last-child {\n          border-bottom: none;\n        }\n\n        .fb-chat-monitor-log-INFO {\n          color: #2196F3;\n        }\n\n        .fb-chat-monitor-log-ERROR {\n          color: #f44336;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-log-WARN {\n          color: #ff9800;\n        }\n\n        .fb-chat-monitor-log-time {\n          color: #666;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-history-container {\n          width: 100%;\n          border-collapse: collapse;\n          margin-top: 10px;\n          font-size: 13px;\n        }\n\n        .fb-chat-monitor-history-container th {\n          background-color: #f5f5f5;\n          text-align: left;\n          padding: 8px;\n          border-bottom: 2px solid #ddd;\n        }\n\n        .fb-chat-monitor-history-container td {\n          padding: 8px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-history-container tr:hover {\n          background-color: #f9f9f9;\n          cursor: pointer;\n        }\n\n        .fb-chat-monitor-badge {\n          display: inline-block;\n          padding: 3px 6px;\n          border-radius: 10px;\n          font-size: 11px;\n          color: white;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-badge-auto {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-manual {\n          background-color: #2196F3;\n        }\n\n        .fb-chat-monitor-badge-generate {\n          background-color: #ff9800;\n        }\n\n        .fb-chat-monitor-badge-sent {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-notsent {\n          background-color: #f44336;\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        /* Tooltip styles */\n        .fb-chat-monitor-tooltip {\n          position: relative;\n          display: inline-block;\n        }\n\n        .fb-chat-monitor-tooltip .fb-chat-monitor-tooltiptext {\n          visibility: hidden;\n          width: 200px;\n          background-color: rgba(0, 0, 0, 0.8);\n          color: #fff;\n          text-align: center;\n          border-radius: 6px;\n          padding: 5px;\n          position: absolute;\n          z-index: 1;\n          bottom: 125%;\n          left: 50%;\n          transform: translateX(-50%);\n          opacity: 0;\n          transition: opacity 0.3s;\n          font-size: 12px;\n        }\n\n        .fb-chat-monitor-tooltip:hover .fb-chat-monitor-tooltiptext {\n          visibility: visible;\n          opacity: 1;\n        }\n      ";domUtils.injectStyles(e)}();const e=storageUtils.get("UI_STATE",{});e.activeTab&&(A.activeTab=e.activeTab),logger.debug("UI initialized"),A.floatingResponseButton=function(){const e=document.createElement("button");return e.id="fbChatMonitorQuickResponse",e.classList.add("fb-chat-monitor-floating-button"),e.textContent="✨ Generate Response",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="9998",e.style.padding="8px 12px",e.style.backgroundColor="#1877f2",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="13px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",e.style.display="none",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#166fe5"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#1877f2"})),e.addEventListener("click",(e=>{e.stopPropagation(),window.chatManager&&"function"==typeof window.chatManager.generateResponseForCurrentChat?window.chatManager.generateResponseForCurrentChat():(console.error("chatManager not available or generateResponseForCurrentChat method not found"),a("Error: Could not generate response. Try opening the full panel.","error"))})),e}(),document.body.appendChild(A.floatingResponseButton),setInterval(P,2e3)}function I(){if(A.controlPanel)return A.controlPanel.remove(),A.controlPanel=null,A.isControlPanelVisible=!1,A.isControlPanelMinimized=!1,void P();A.controlPanel=function(){const e=document.createElement("div");e.id="fbChatMonitorPanel",e.className="fb-chat-monitor-panel";const t=document.getElementById("fbChatMonitorButton");if(e.style.position="fixed",e.style.width="390px",e.style.padding="10px",e.style.backgroundColor="#fff",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",e.style.borderRadius="8px",e.style.zIndex="9999",e.style.display="block",t){const n=t.getBoundingClientRect();e.style.top=`${n.bottom+5}px`,e.style.right=window.innerWidth-n.right+"px"}else e.style.top="60px",e.style.right="20px";e.style.height="500px",e.style.overflowY="auto";const n=document.createElement("div");n.className="fb-chat-monitor-panel-header";const o=document.createElement("h2");o.textContent=`FB Chat Monitor v${CONFIG.version||"1.0"}`;const r=document.createElement("button");r.className="fb-chat-monitor-close",r.innerHTML="&times;",r.addEventListener("click",I),n.appendChild(o),n.appendChild(r),e.appendChild(n);const s=document.createElement("div");s.className="fb-chat-monitor-panel-tabs";[{id:"dashboard",label:"Dashboard"},{id:"assistants",label:"Assistants"},{id:"config",label:"Settings"},{id:"logs",label:"Logs"},{id:"history",label:"History"}].forEach((e=>{const t=document.createElement("div");t.className="fb-chat-monitor-tab "+(A.activeTab===e.id?"active":""),t.setAttribute("data-tab",e.id),t.textContent=e.label,t.addEventListener("click",(()=>{document.querySelectorAll(".fb-chat-monitor-tab").forEach((e=>{e.classList.remove("active")})),t.classList.add("active"),C(e.id),A.activeTab=e.id,storageUtils.set("UI_STATE",{activeTab:e.id})})),s.appendChild(t)})),e.appendChild(s);const i=document.createElement("div");i.className="fb-chat-monitor-panel-content";const l=document.createElement("div");l.className="fb-chat-monitor-tab-content",l.id="fb-chat-monitor-tab-dashboard",l.innerHTML='\n        <div class="fb-chat-monitor-form-group"\n             style="display:flex; justify-content:center; align-items:center; gap:8px; text-align:center;">\n          <label for="fb-chat-monitor-mode-toggle" style="margin:0;">\n            Auto Mode (Automatically send responses)\n          </label>\n          <select id="fb-chat-monitor-mode-toggle"\n                  style="width:auto; padding:4px 8px; text-align:center;\n                         background-color:#dc3545; color:white; border:none; border-radius:4px;">\n            <option value="on">ON</option>\n            <option value="off" selected>OFF</option>\n          </select>\n        </div>\n\n        <div class="fb-chat-monitor-stats-grid">\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-processed" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Chats Processed</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-responses" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Responses Sent</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-uptime" class="fb-chat-monitor-stat-value">0m</div>\n            <div class="fb-chat-monitor-stat-label">Uptime</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-errors" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Errors</div>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group" style="text-align:center;">\n          <button\n            id="fb-chat-monitor-generate-response"\n            class="fb-chat-monitor-button"\n            disabled\n          >\n            Generate Response\n          </button>\n        </div>\n      ',i.appendChild(l);const c=document.createElement("div");c.className="fb-chat-monitor-tab-content",c.id="fb-chat-monitor-tab-assistants",c.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <label for="fb-chat-monitor-openai-key">OpenAI API Key</label>\n          <input type="password" id="fb-chat-monitor-openai-key" placeholder="sk-..." value="${CONFIG.AI.apiKey||""}">\n          <button id="fb-chat-monitor-save-api-key" class="fb-chat-monitor-button" style="margin-top: 8px;">Save API Key</button>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Seller Assistant</h4>\n          <div id="fb-chat-monitor-seller-assistant-container">\n            <label for="fb-chat-monitor-seller-assistant">Select Seller Assistant</label>\n            <select id="fb-chat-monitor-seller-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're selling an item</small>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Buyer Assistant</h4>\n          <div id="fb-chat-monitor-buyer-assistant-container">\n            <label for="fb-chat-monitor-buyer-assistant">Select Buyer Assistant</label>\n            <select id="fb-chat-monitor-buyer-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're buying an item</small>\n          </div>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-refresh-assistants" class="fb-chat-monitor-button">Refresh Assistants</button>\n        </div>\n      `,i.appendChild(c);const d=document.createElement("div");d.className="fb-chat-monitor-tab-content",d.id="fb-chat-monitor-tab-config",d.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 0; margin-bottom: 10px;">Monitoring Settings</h4>\n\n          <label for="fb-chat-monitor-scan-interval">Scan interval (seconds)</label>\n          <input type="number" id="fb-chat-monitor-scan-interval" min="5" max="300" value="${Math.floor((CONFIG.scanInterval||3e4)/1e3)}">\n          <small style="display:block; margin-top:5px; color:#666;">How often to check for new messages</small>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Human Simulation</h4>\n\n          <label for="fb-chat-monitor-typing-speed">Typing speed (characters per second)</label>\n          <input type="number" id="fb-chat-monitor-typing-speed" min="1" max="20" value="${CONFIG.AI?.humanSimulation?.baseTypingSpeed||5}">\n          <small style="display:block; margin-top:5px; color:#666;">Higher values = faster typing</small>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-save-config" class="fb-chat-monitor-button">Save Settings</button>\n          <button id="fb-chat-monitor-reset-config" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Reset to Defaults</button>\n        </div>\n      `,i.appendChild(d);const u=document.createElement("div");u.className="fb-chat-monitor-tab-content",u.id="fb-chat-monitor-tab-logs",u.innerHTML='\n        <div class="fb-chat-monitor-form-group" style="display:flex; justify-content:space-between; align-items:center;">\n          <div>\n            <label for="fb-chat-monitor-log-level">Log Level</label>\n            <select id="fb-chat-monitor-log-level">\n              <option value="all">All Logs</option>\n              <option value="error">Errors Only</option>\n              <option value="warn">Warnings & Errors</option>\n              <option value="info">Info & Above</option>\n            </select>\n          </div>\n          <div>\n            <button id="fb-chat-monitor-refresh-logs" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-logs" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear Logs</button>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-logs-container" id="fb-chat-monitor-logs-list">\n          <div class="fb-chat-monitor-log-entry">\n            <span class="fb-chat-monitor-log-time">Loading logs...</span>\n          </div>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-logs" class="fb-chat-monitor-button">Export Logs</button>\n        </div>\n      ',i.appendChild(u);const g=document.createElement("div");return g.className="fb-chat-monitor-tab-content",g.id="fb-chat-monitor-tab-history",g.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">\n          <h4 style="margin: 0;">Conversation History</h4>\n          <div>\n            <button id="fb-chat-monitor-refresh-history" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-history" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear</button>\n          </div>\n        </div>\n\n        <div id="fb-chat-monitor-history-container" style="max-height: 300px; overflow-y: auto;">\n          <table class="fb-chat-monitor-history-container">\n            <thead>\n              <tr>\n                <th>Time</th>\n                <th>Mode</th>\n                <th>Content</th>\n                <th>Status</th>\n              </tr>\n            </thead>\n            <tbody id="fb-chat-monitor-history-list">\n              <tr>\n                <td colspan="4" style="text-align: center;">Loading history...</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-history" class="fb-chat-monitor-button">Export History</button>\n        </div>\n      ',i.appendChild(g),e.appendChild(i),document.body.appendChild(e),function(){const e=[{value:"on",text:"ON",color:"#28a745"},{value:"off",text:"OFF",color:"#dc3545"}],t=document.getElementById("fb-chat-monitor-mode-toggle").parentNode,n="auto"===CONFIG.operationMode?"on":"off",o=document.createElement("div");o.className="fb-chat-monitor-custom-dropdown",o.style.position="relative",o.style.display="inline-block",o.style.minWidth="60px";const r=document.createElement("div");r.className="fb-chat-monitor-dropdown-button",r.setAttribute("tabindex","0"),r.style.padding="4px 8px",r.style.borderRadius="4px",r.style.cursor="pointer",r.style.userSelect="none",r.style.textAlign="center",r.style.fontWeight="bold",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="6px",r.style.transition="background-color 0.2s ease-in-out",r.title="Click to toggle Auto Mode";const s=document.createElement("span");s.innerHTML="▼",s.style.fontSize="10px",s.style.marginLeft="2px",s.style.position="relative",s.style.top="1px";const i=document.createElement("div");i.className="fb-chat-monitor-dropdown-content",i.style.display="none",i.style.position="absolute",i.style.zIndex="10000",i.style.left="0",i.style.right="0",i.style.marginTop="2px",i.style.borderRadius="4px",i.style.overflow="hidden",i.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",o.appendChild(r),o.appendChild(i);const l=document.getElementById("fb-chat-monitor-mode-toggle");function c(t){const n=e.find((e=>e.value===t));if(!n)return;r.innerHTML="";const o=document.createElement("span");o.textContent=n.text,r.appendChild(o),r.appendChild(s.cloneNode(!0)),r.style.backgroundColor=n.color,r.style.color="white",r.onmouseover=function(){this.style.backgroundColor=d(n.color,-15)},r.onmouseout=function(){this.style.backgroundColor=n.color},r.dataset.value=t,u()}function d(e,t){let n=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),a=parseInt(e.substring(5,7),16);return n=Math.max(0,Math.min(255,n+t)),o=Math.max(0,Math.min(255,o+t)),a=Math.max(0,Math.min(255,a+t)),"#"+((1<<24)+(n<<16)+(o<<8)+a).toString(16).slice(1)}function u(){i.innerHTML="";const t=r.dataset.value,n=e.find((e=>e.value!==t));if(!n)return;const o=document.createElement("div");o.className="fb-chat-monitor-dropdown-item",o.textContent=n.text,o.dataset.value=n.value,o.style.padding="4px 8px",o.style.cursor="pointer",o.style.backgroundColor=n.color,o.style.color="white",o.style.textAlign="center",o.style.fontWeight="bold",o.style.transition="background-color 0.2s ease-in-out",o.onmouseover=function(){this.style.backgroundColor=d(n.color,-15)},o.onmouseout=function(){this.style.backgroundColor=n.color},o.addEventListener("click",(function(e){e.stopPropagation(),i.style.display="none";const t=this.dataset.value;c(t),g(t)})),i.appendChild(o)}function g(e){const t=document.getElementById("fb-chat-monitor-generate-response");"on"===e?(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("auto"),window.FBChatMonitor.toggleMonitoring(!0)):logger.error("FBChatMonitor no disponible"),t&&t.setAttribute("disabled","")):(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("manual"),window.FBChatMonitor.toggleMonitoring(!1)):logger.error("FBChatMonitor no disponible"),t&&t.removeAttribute("disabled"))}t.replaceChild(o,l),r.addEventListener("click",(function(e){e.stopPropagation();const t="block"===i.style.display;i.style.display=t?"none":"block",t||u()})),document.addEventListener("click",(function(){i.style.display="none"})),c(n),g(n),document.getElementById("fb-chat-monitor-generate-response").addEventListener("click",(async()=>{try{await chatManager.generateResponseForCurrentChat()||logger.debug("Failed to generate response via UI button")}catch(e){a(`Error generating response: ${e.message}`,"error")}})),document.getElementById("fb-chat-monitor-save-api-key").addEventListener("click",(async()=>{const e=document.getElementById("fb-chat-monitor-openai-key").value.trim();if(e)try{const t=document.getElementById("fb-chat-monitor-save-api-key");t.textContent="Validating...",t.disabled=!0;await openAIManager.setApiKey(e)?(a("API Key validated and saved successfully","success"),M()):a("Invalid API Key","error")}catch(e){a(`Error: ${e.message}`,"error")}finally{const e=document.getElementById("fb-chat-monitor-save-api-key");e.textContent="Save API Key",e.disabled=!1}else a("Please enter a valid API Key","error")})),document.getElementById("fb-chat-monitor-refresh-assistants").addEventListener("click",M),document.getElementById("fb-chat-monitor-save-config").addEventListener("click",T),document.getElementById("fb-chat-monitor-reset-config").addEventListener("click",S),document.getElementById("fb-chat-monitor-refresh-logs").addEventListener("click",O),document.getElementById("fb-chat-monitor-clear-logs").addEventListener("click",k),document.getElementById("fb-chat-monitor-export-logs").addEventListener("click",$),document.getElementById("fb-chat-monitor-log-level").addEventListener("change",O),document.getElementById("fb-chat-monitor-refresh-history").addEventListener("click",_),document.getElementById("fb-chat-monitor-clear-history").addEventListener("click",R),document.getElementById("fb-chat-monitor-export-history").addEventListener("click",N)}(),e}(),A.isControlPanelVisible=!0,A.floatingResponseButton&&(A.floatingResponseButton.style.display="none"),document.body.appendChild(A.controlPanel);const e=A.controlPanel.getBoundingClientRect();e.bottom>window.innerHeight&&(A.controlPanel.style.top=window.innerHeight-e.height-10+"px"),e.right>window.innerWidth&&(A.controlPanel.style.right="10px"),E();const t=setInterval((()=>{A.isControlPanelVisible?E():clearInterval(t)}),3e3);C(A.activeTab)}function C(e){document.querySelectorAll(".fb-chat-monitor-tab-content").forEach((e=>{e.classList.remove("active")}));const t=document.getElementById(`fb-chat-monitor-tab-${e}`);t&&(t.classList.add("active"),"logs"===e?O():"history"===e&&_())}function E(){try{const e=window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.getMonitoringStats?window.FBChatMonitor.getMonitoringStats():{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1,nextScanIn:null};document.getElementById("fb-chat-monitor-stat-processed").textContent=e.chatsProcessed||0,document.getElementById("fb-chat-monitor-stat-responses").textContent=e.responsesSent||0,document.getElementById("fb-chat-monitor-stat-errors").textContent=e.errors||0;let t="Inactive";if(e.uptime>0){const n=Math.floor(e.uptime/1e3/60),o=Math.floor(n/60);t=o>0?`${o}h ${n%60}m`:`${n}m`}document.getElementById("fb-chat-monitor-stat-uptime").textContent=t,A.statusIndicator&&(A.statusIndicator.style.backgroundColor=e.isMonitoring?"#4CAF50":"#f44336")}catch(e){logger.error("Error updating stats",{},e)}}async function M(){try{const e=document.getElementById("fb-chat-monitor-seller-assistant"),t=document.getElementById("fb-chat-monitor-buyer-assistant");e&&(e.innerHTML='<option value="">Loading assistants...</option>'),t&&(t.innerHTML='<option value="">Loading assistants...</option>');const n=await openAIManager.listAssistants();if(!n||0===n.length)return e&&(e.innerHTML='<option value="">No assistants found</option>'),void(t&&(t.innerHTML='<option value="">No assistants found</option>'));const o=(e,t)=>{e&&(e.innerHTML='<option value="">Select an assistant</option>',n.forEach((n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,n.id===t&&(o.selected=!0),e.appendChild(o)})),e.addEventListener("change",(function(){const e="fb-chat-monitor-seller-assistant"===this.id?"seller":"buyer";openAIManager.setAssistantForRole(e,this.value),a(`${e.charAt(0).toUpperCase()+e.slice(1)} assistant updated`,"success")})))};o(e,CONFIG.AI?.assistants?.seller?.id),o(t,CONFIG.AI?.assistants?.buyer?.id)}catch(e){logger.error("Error refreshing assistants",{},e),a(`Error loading assistants: ${e.message}`,"error");const t=document.getElementById("fb-chat-monitor-seller-assistant"),n=document.getElementById("fb-chat-monitor-buyer-assistant");t&&(t.innerHTML='<option value="">Error loading assistants</option>'),n&&(n.innerHTML='<option value="">Error loading assistants</option>')}}function T(){if("function"==typeof GM_setValue)try{GM_setValue("CONFIG_operationMode",window.CONFIG.operationMode||"manual"),GM_setValue("CONFIG_autoSendMessages",window.CONFIG.autoSendMessages||!1),window.CONFIG.AI&&window.CONFIG.AI.apiKey&&GM_setValue("CONFIG_AI_apiKey",window.CONFIG.AI.apiKey),logger.log("Configuration saved to persistent storage")}catch(e){logger.error(`Error saving configuration: ${e.message}`)}else logger.warn("GM_setValue not available. Cannot save persistent configuration.")}function S(){confirm("Are you sure you want to reset all settings to default values?")&&(storageUtils.remove("CONFIG"),a("Settings reset to defaults. Reloading...","info"),setTimeout((()=>window.location.reload()),2e3))}function O(){try{const e=document.getElementById("fb-chat-monitor-logs-list"),t=document.getElementById("fb-chat-monitor-log-level").value,n=logger.getAllLogs();if(0===n.length)return void(e.innerHTML='<div class="fb-chat-monitor-log-entry">No logs recorded</div>');let o=n;"error"===t?o=n.filter((e=>"ERROR"===e.type)):"warn"===t?o=n.filter((e=>"ERROR"===e.type||"WARN"===e.type)):"info"===t&&(o=n.filter((e=>"ERROR"===e.type||"WARN"===e.type||"INFO"===e.type))),e.innerHTML="",o.slice(0,100).forEach((t=>{const n=document.createElement("div");n.className=`fb-chat-monitor-log-entry fb-chat-monitor-log-${t.type}`;const o=`${new Date(t.timestamp).toLocaleTimeString()}`;n.innerHTML=`\n            <span class="fb-chat-monitor-log-time">${o}</span>\n            <span class="fb-chat-monitor-log-message">${t.message}</span>\n          `,e.appendChild(n)})),e.scrollTop=e.scrollHeight}catch(e){console.error("Error refreshing logs",e)}}function k(){confirm("Are you sure you want to clear all logs?")&&(logger.clearLogs(),O(),a("Logs cleared","success"))}function $(){try{const e=logger.getAllLogs(),t={timestamp:(new Date).toISOString(),version:CONFIG.version||"1.0",logs:e},n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r,s.download=`fb-chat-monitor-logs-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),a("Logs exported successfully","success")}catch(e){logger.error("Error exporting logs",{},e),a(`Error exporting logs: ${e.message}`,"error")}}function _(){try{const e=document.getElementById("fb-chat-monitor-history-list"),t=f();if(!t||0===t.length)return void(e.innerHTML='<tr><td colspan="4" style="text-align: center;">No conversation history</td></tr>');e.innerHTML="",t.slice(0,50).forEach((t=>{const o=document.createElement("tr");o.addEventListener("click",(()=>function(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="10000";const o=document.createElement("div");o.style.backgroundColor="white",o.style.borderRadius="8px",o.style.padding="20px",o.style.width="600px",o.style.maxWidth="90%",o.style.maxHeight="80%",o.style.overflowY="auto",o.style.position="relative";const a=document.createElement("button");a.innerHTML="&times;",a.style.position="absolute",a.style.top="10px",a.style.right="10px",a.style.background="none",a.style.border="none",a.style.fontSize="24px",a.style.cursor="pointer",a.addEventListener("click",(()=>document.body.removeChild(t))),o.appendChild(a);const r=document.createElement("h2");r.textContent="Conversation Details",r.style.marginTop="0",r.style.marginBottom="20px",o.appendChild(r);const s=document.createElement("div"),i=new Date(e.timestamp);if(s.innerHTML=`\n        <p><strong>Time:</strong> ${n.formatDate(i)}</p>\n        <p><strong>Mode:</strong> ${e.mode}</p>\n        <p><strong>Status:</strong> ${e.sent?"Sent":"Not sent"}</p>\n      `,e.context){const t=document.createElement("div");if(t.style.marginTop="15px",t.style.marginBottom="15px",t.innerHTML='<h3 style="margin-top:0;">Context</h3>',e.context.role&&(t.innerHTML+=`<p><strong>Role:</strong> ${e.context.role}</p>`),e.context.productDetails){const n=e.context.productDetails;t.innerHTML+=`\n            <div style="margin-top: 10px; margin-bottom: 15px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Product Details</h4>\n              <p style="margin: 2px 0;"><strong>Title:</strong> ${n.title||"N/A"}</p>\n              <p style="margin: 2px 0;"><strong>Price:</strong> ${n.price||"N/A"}</p>\n              ${n.id?`<p style="margin: 2px 0;"><strong>ID:</strong> ${n.id}</p>`:""}\n            </div>\n          `}e.context.lastMessage&&(t.innerHTML+=`\n            <div style="margin-top: 10px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Last Message</h4>\n              <div style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${e.context.lastMessage}</div>\n            </div>\n          `),s.appendChild(t)}if(e.response){const t=document.createElement("div");t.style.marginTop="15px",t.innerHTML=`\n          <h3 style="margin-top: 0;">Response</h3>\n          <div style="background-color: #e9f5ff; padding: 10px; border-radius: 4px; white-space: pre-wrap; margin-bottom: 15px; border: 1px solid #2196F3;">${e.response}</div>\n          <button id="copy-response-btn" style="padding: 5px 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Copy Response</button>\n        `,s.appendChild(t)}o.appendChild(s),t.appendChild(o),document.body.appendChild(t);const l=document.getElementById("copy-response-btn");l&&e.response&&l.addEventListener("click",(()=>{navigator.clipboard.writeText(e.response),l.textContent="Copied!",setTimeout((()=>l.textContent="Copy Response"),2e3)}))}(t)));const a=document.createElement("td"),r=new Date(t.timestamp);a.textContent=n.formatDate(r).split(",")[1].trim();const s=document.createElement("td"),i=document.createElement("span");i.textContent=t.mode,i.className=`fb-chat-monitor-badge fb-chat-monitor-badge-${t.mode}`,s.appendChild(i);const l=document.createElement("td"),c=t.context?.lastMessage||"No content";l.textContent="string"==typeof c?c.substring(0,30)+(c.length>30?"...":""):"Complex content";const d=document.createElement("td"),u=document.createElement("span");u.textContent=t.sent?"Sent":"Not sent",u.className="fb-chat-monitor-badge fb-chat-monitor-badge-"+(t.sent?"sent":"notsent"),d.appendChild(u),o.appendChild(a),o.appendChild(s),o.appendChild(l),o.appendChild(d),e.appendChild(o)}))}catch(e){logger.error("Error refreshing history",{},e);document.getElementById("fb-chat-monitor-history-list").innerHTML='<tr><td colspan="4" style="text-align: center;">Error loading history</td></tr>'}}function R(){confirm("Are you sure you want to clear all conversation history?")&&(storageUtils.remove("RESPONSE_LOGS"),_(),a("Conversation history cleared","success"))}function N(){try{const e=f(),t={timestamp:(new Date).toISOString(),version:CONFIG.version||"1.0",conversations:e},n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r,s.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),a("History exported successfully","success")}catch(e){logger.error("Error exporting history",{},e),a(`Error exporting history: ${e.message}`,"error")}}function f(){return storageUtils.get("RESPONSE_LOGS",[])}function F(e){try{const t=document.getElementById("fb-chat-auto-btn"),n=document.getElementById("fb-chat-manual-btn");return t&&n?(t.classList.remove("active","inactive"),n.classList.remove("active","inactive"),"auto"===e?(t.classList.add("active"),n.classList.add("inactive"),logger.debug("UI updated: AUTO mode activated")):(t.classList.add("inactive"),n.classList.add("active"),logger.debug("UI updated: MANUAL mode activated")),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:e}})),!0):(logger.debug("Mode buttons not found to update UI"),!1)}catch(e){return logger.error(`Error updating mode UI: ${e.message}`),!1}}function P(){if(!A.floatingResponseButton)return;if(window.CONFIG&&"manual"===window.CONFIG.operationMode&&!A.isControlPanelVisible&&window.chatManager&&window.chatManager.currentChatId){const e=document.querySelector(CONFIG.selectors.activeChat.messageInput),t=domUtils.findElement(CONFIG.selectors.activeChat.sendButton);if(e||t){const n=(e||t).getBoundingClientRect();A.floatingResponseButton.style.bottom=window.innerHeight-n.top+10+"px",A.floatingResponseButton.style.right="20px"}A.floatingResponseButton.style.display="block"}else A.floatingResponseButton.style.display="none"}function a(e,t="info",n=3e3){const o=document.createElement("div");o.className="fb-chat-monitor-alert";const a=function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n={top:"60px",right:"20px",left:"auto"};if(e&&A.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}return n}();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)}window.initializeUI=x,window.toggleControlPanel=I,window.updateMonitoringStatus=function(e){A.statusIndicator&&(A.statusIndicator.style.backgroundColor=e?"#4CAF50":"#f44336"),A.isControlPanelVisible&&E()},window.ui={updateModeUI:F,handleModeClick:function(e){try{if("auto"!==e&&"manual"!==e)return logger.error(`Invalid mode: ${e}`),!1;if(!window.CONFIG.updateOperationMode(e))return logger.error(`Could not update mode to ${e}`),!1;F(e);return a(`Mode ${"auto"===e?"automatic":"manual"} activated`,"success"),!0}catch(e){return logger.error(`Error changing mode: ${e.message}`),!1}}};const L={isMonitoring:!1,monitorInterval:null,errorCount:0,scansSinceLastSuccess:0,startTime:null,stats:{chatsProcessed:0,messagesProcessed:0,responsesSent:0,errors:0},lastScanTime:null,baseInterval:CONFIG.scanInterval||3e4};async function initialize(){logger.log("Initializing FB-Chat-Monitor",{version:CONFIG.version});try{const t=storageUtils.get("OPENAI_KEY",null);if(t&&(CONFIG.AI.apiKey=t,logger.log("Loaded OpenAI API Key from storageUtils")),o.redirectToMarketplace())return void logger.log("Redirecting to Marketplace messenger, please wait...");assistantManagerUI.initialize(),logger.debug("UI components initialized");openAIManager.initialize(CONFIG.AI.apiKey,CONFIG.AI.model)?logger.log("OpenAI Manager initialized successfully"):logger.warn("OpenAI Manager initialized but no valid API key is set"),function(){const e=storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY",null);if(e)CONFIG.AI.apiKey=e,logger.debug("OpenAI API Key loaded from storageUtils");else{const e=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");e&&(CONFIG.AI.apiKey=e,storageUtils.set("FB_CHAT_MONITOR_OPENAI_KEY",e),logger.debug("OpenAI API Key migrated from localStorage to storageUtils"))}CONFIG.operationMode=storageUtils.get("OPERATION_MODE",CONFIG.defaultOperationMode),CONFIG.AI.assistants||(CONFIG.AI.assistants={seller:{},buyer:{}});CONFIG.AI.assistants.seller.id=storageUtils.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),CONFIG.AI.assistants.buyer.id=storageUtils.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),logger.debug("Saved settings loaded",{operationMode:CONFIG.operationMode,hasApiKey:!!CONFIG.AI.apiKey,sellerAssistant:!!CONFIG.AI.assistants.seller.id,buyerAssistant:!!CONFIG.AI.assistants.buyer.id})}(),e.onActivityChange((e=>{L.isMonitoring&&D(),logger.debug("User activity changed",{isActive:e})}));return storageUtils.get("MONITORING_ACTIVE",!1)&&(logger.log("Restoring previous monitoring state"),B(!0)),a("FB-Chat-Monitor initialized successfully","success"),logger.log("Initialization complete",{status:"success"}),!0}catch(e){return logger.error("Error during initialization",{},e),a("Error initializing FB-Chat-Monitor: "+e.message,"error"),!1}}function D(){let t=L.baseInterval;return e.isActive||(t*=1.5),L.errorCount>0&&(t=Math.min(t*Math.pow(1.5,L.errorCount),CONFIG.maxScanInterval||3e5)),L.isMonitoring&&L.monitorInterval&&(clearTimeout(L.monitorInterval),L.monitorInterval=setTimeout(U,t),logger.debug("Scan interval updated",{interval:t,userActive:e.isActive,errorCount:L.errorCount})),t}function B(e){return L.isMonitoring=e,e?(L.startTime=Date.now(),L.monitorInterval=setTimeout(U,1e3),storageUtils.set("MONITORING_ACTIVE",!0),logger.log("Chat monitoring started")):(L.monitorInterval&&(clearTimeout(L.monitorInterval),L.monitorInterval=null),storageUtils.set("MONITORING_ACTIVE",!1),logger.log("Chat monitoring stopped")),e?a("Chat monitoring started","success"):a("Chat monitoring stopped","info"),e}async function U(){if(L.isMonitoring){L.lastScanTime=Date.now(),logger.debug("Starting chat scan");try{if(!o.isMarketplaceMessenger())return logger.warn("Not on marketplace messenger page, skipping scan"),void H();const e=await t.withExponentialBackoff((()=>chatManager.scanForUnreadChats()),{maxRetries:2,baseDelay:1e3});if(e>0){logger.log(`Found ${e} unread chats`);await chatManager.openNextPendingChat()?(logger.log("Chat opened and processed successfully"),L.stats.chatsProcessed++,L.errorCount=0,L.scansSinceLastSuccess=0):(logger.error("Could not open the chat"),z())}else logger.debug("No unread chats found"),L.scansSinceLastSuccess++}catch(e){logger.error("Error during chat monitoring",{errorCount:L.errorCount,scansSinceLastSuccess:L.scansSinceLastSuccess},e),z()}H()}}function H(){if(!L.isMonitoring)return;L.monitorInterval&&clearTimeout(L.monitorInterval);const e=D();L.monitorInterval=setTimeout(U,e),logger.debug(`Next scan scheduled in ${e}ms`)}function z(){L.errorCount++,L.stats.errors++,L.scansSinceLastSuccess++,L.scansSinceLastSuccess>=CONFIG.maxConsecutiveFailures&&(logger.warn(`Too many consecutive failures (${L.scansSinceLastSuccess}), pausing monitoring`),a("Monitoring paused due to consecutive failures. Check console for details.","warning",{buttons:[{text:"Resume",action:()=>{L.errorCount=0,L.scansSinceLastSuccess=0,H()}}]}),L.errorCount=Math.min(L.errorCount,5))}function K(){const e=Date.now();return{...L.stats,isMonitoring:L.isMonitoring,uptime:L.startTime?e-L.startTime:0,lastScan:L.lastScanTime?e-L.lastScanTime:null,nextScanIn:L.monitorInterval?L.lastScanTime+D()-e:null,errorRate:L.stats.chatsProcessed>0?(L.stats.errors/L.stats.chatsProcessed).toFixed(2):0}}function initialize(){if(window.initializationInProgress)return;window.initializationInProgress=!0,logger.log("Initializing FB Chat Monitor"),x();const e=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");if(e&&(CONFIG.AI.apiKey=e,CONFIG.AI.enabled=!0,logger.log("API Key loaded from localStorage in init")),CONFIG.operationMode=localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||CONFIG.defaultOperationMode,CONFIG.AI.apiKey)if(CONFIG.AI.enabled=!0,logger.log("API key loaded from localStorage"),window.openAIManager){const e=openAIManager.initialize(CONFIG.AI.apiKey,CONFIG.AI.model);logger.log(`OpenAI Manager auto-initialized: ${e}`)}else logger.error("openAIManager not available for auto-initialization.");window.openaiManager?logger.log("OpenAI Manager is available to generate responses"):logger.warn("OpenAI Manager is not available. Some functions may not be operational."),window.assistantManager&&logger.log("Assistant Manager is available to generate responses");try{window.location.href.includes("/marketplace/")?(logger.log("We are in Marketplace, starting monitoring..."),setTimeout((()=>{window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.manualScan?window.FBChatMonitor.manualScan():logger.warn("FBChatMonitor.manualScan not available yet")}),2500)):(logger.log("We are not in Marketplace, trying redirection..."),window.pageUtils&&window.pageUtils.redirectToMarketplace?window.pageUtils.redirectToMarketplace():logger.error("pageUtils.redirectToMarketplace not available"))}catch(e){logger.error(`Error in initialization: ${e.message}`)}finally{window.initializationInProgress=!1}}window.FBChatMonitor={initialize:initialize,toggleMonitoring:B,manualScan:async function(){logger.log("Manual chat scan triggered");const e=L.isMonitoring;e&&clearTimeout(L.monitorInterval);try{await U()}catch(e){logger.error("Error during manual scan",{},e),a("Error during manual scan: "+e.message,"error")}finally{e&&H()}},getMonitoringStats:K,changeOperationMode:e=>("auto"!==e&&"manual"!==e&&(e="manual"),CONFIG.operationMode=e,storageUtils.set("OPERATION_MODE",e),B("auto"===e),!0)},window.getMonitoringStats=K,"loading"!==document.readyState?initialize():document.addEventListener("DOMContentLoaded",initialize),window.addEventListener("load",(()=>{function e(){if(logger.log("Verifying OpenAI Manager consistency..."),window.openaiManager||(logger.warn("OpenAI Manager is not available, creating backup instance"),window.openaiManager=new OpenAIManager),!window.openaiManager.isInitialized)if(CONFIG?.AI?.apiKey)logger.log("Recovering OpenAI Manager state with API key from CONFIG"),window.openaiManager.initialize(CONFIG.AI.apiKey);else{const e=storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(logger.log("Recovering OpenAI Manager state with API key from localStorage"),window.openaiManager.initialize(e))}let e=!1;"function"==typeof window.openaiManager.isReady?(e=window.openaiManager.isReady(),logger.debug(`openaiManager.isReady() = ${e}`)):(e=window.openaiManager.isInitialized&&!!window.openaiManager.apiKey,logger.debug(`Fallback isReady check = ${e}`)),!e&&window.openaiManager.apiKey&&(logger.warn("Inconsistency detected - forcing isInitialized=true since there is API key"),window.openaiManager.isInitialized=!0,e=!0),logger.log("Final state of OpenAI Manager: "+(e?"READY":"NOT AVAILABLE"))}window.storageUtils?(storageUtils.checkStorageHealth(),storageUtils.migrateSettings(),function(){try{if(!window.CONFIG||!window.CONFIG.AI)return void console.warn("CONFIG is not correctly initialized");CONFIG.AI.apiKey=storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","")||localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY")||"",CONFIG.AI.assistants.seller.id=storageUtils.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID")||"",CONFIG.AI.assistants.buyer.id=storageUtils.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID")||"",CONFIG.operationMode=storageUtils.get("FB_CHAT_MONITOR_OPERATION_MODE",CONFIG.defaultOperationMode)||localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||CONFIG.defaultOperationMode,CONFIG.audioTranscription&&(CONFIG.audioTranscription.apiKey=CONFIG.AI.apiKey),console.log("[CONFIG] Configuration loaded:",{apiKey:CONFIG.AI.apiKey?"********":"(no key)",model:CONFIG.AI.model,assistants:{seller:CONFIG.AI.assistants.seller.id?"(configured)":"(not configured)",buyer:CONFIG.AI.assistants.buyer.id?"(configured)":"(not configured)"},mode:CONFIG.operationMode})}catch(e){console.error("[CONFIG] Error loading configuration:",e)}}()):console.error("storageUtils is not available for migration and verification"),window.FBChatMonitor||(window.FBChatMonitor={},console.error("FBChatMonitor is not available on load. An empty object has been created to prevent errors.")),window.FBChatMonitor.getMonitoringStats||(window.FBChatMonitor.getMonitoringStats=function(){return{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1}},console.warn("A temporary version of getMonitoringStats has been created")),window.FBChatMonitor.initialized||"function"!=typeof window.FBChatMonitor.initialize||(window.FBChatMonitor.initialized=!0,window.FBChatMonitor.initialize()),function(){if(logger.log("Verifying availability of AI services..."),window.openaiManager){const e=window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.isInitialized&&!!window.openaiManager.apiKey;if(logger.log(`OpenAI Manager auto-initialized: ${e}`),!e&&window.storageUtils){const e=window.storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","");e&&(window.openaiManager.setApiKey(e),logger.log("OpenAI Manager re-initialized with stored API key"))}}else logger.warn("OpenAI Manager is not available. Some functions will not be operational."),window.openaiManager={isInitialized:!1,generateResponse:async()=>{throw new Error("OpenAI Manager is not initialized correctly")},isReady:()=>!1},logger.debug("A backup implementation of OpenAI Manager has been created");window.assistantManager&&logger.log("Assistant Manager is available to generate responses")}(),e(),setInterval(e,6e4)}))}();