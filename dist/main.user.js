// ==UserScript==
// @name         FB-Chat-Monitor
// @namespace    https://github.com/JuanHopla/FB-Chat-Monitor
// @version      1.0.0
// @description  Monitor and auto-respond to Facebook Marketplace messages with AI assistance
// @author       JuanHopla
// @match        https://www.messenger.com/*
// @match        https://www.facebook.com/marketplace/inbox*
// @match        https://www.facebook.com/messages*
// @match        https://www.facebook.com/marketplace/item/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_deleteValue
// @grant        GM_listValues
// @connect      api.openai.com
// @connect      facebook.com
// @connect      messenger.com
// @updateURL    https://juanhopla.github.io/FB-Chat-Monitor/main.user.js
// @downloadURL  https://juanhopla.github.io/FB-Chat-Monitor/main.user.js
// @license      MIT
// @run-at       document-idle
// ==/UserScript==

!function(){var CONFIG={};Object.assign(CONFIG,{version:"1.0.0",operationMode:"manual",get modo(){return this.operationMode},set modo(t){"auto"!==t&&"manual"!==t||(this.operationMode=t,void 0!==e&&e.debug(`Mode updated via 'modo' property: ${t}`))},apiKey:null,AI:{apiKey:null,model:"gpt-4.1-mini",maxTokens:2048,temperature:.7,useAssistantAPI:!0,provider:"openai",assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},syncWithLegacyConfig:function(){CONFIG.apiKey&&!this.apiKey?this.apiKey=CONFIG.apiKey:this.apiKey&&!CONFIG.apiKey&&(CONFIG.apiKey=this.apiKey),CONFIG.model&&CONFIG.model!==this.model&&(this.model=CONFIG.model),CONFIG.assistants&&(CONFIG.assistants.seller&&(this.assistants.seller={...this.assistants.seller,...CONFIG.assistants.seller}),CONFIG.assistants.buyer&&(this.assistants.buyer={...this.assistants.buyer,...CONFIG.assistants.buyer}))}},model:"gpt-4.1-mini",autoResponseDelay:5e3,simulateHumanTyping:!0,audioTranscription:{enabled:!1,apiKey:null,model:"whisper-1",maxDuration:120},assistants:{seller:{id:null,name:"Seller Assistant",instructions:"Act as a professional, friendly, and concise salesperson."},buyer:{id:null,name:"Buyer Assistant",instructions:"Act as an interested buyer, asking relevant questions about the product."}},autoSendMessages:!0,sendMessageDelay:2e3,selectors:{chatList:{container:'div[class*="x78zum5"][class*="xdt5ytf"], div[role="main"]',chatItem:'a[href*="/marketplace/t/"][role="link"]',unreadIndicator:'span[class*="x6s0dn4"][data-visualcompletion="ignore"]',chatUserName:{selector:["span.x1lliihq.x193iq5w.x6ikm8r.x10wlt62.xlyipyv.xuxw1ft:not(.x1j85h84)",'span[dir="auto"][class*="x1lliihq"]:not([class*="x1j85h84"])'],filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}))},timestamp:'span[aria-hidden="true"]',messagePreview:{selector:'span[dir="auto"]:not([class*="x1lliihq"])',filter:e=>Array.from(e).filter((e=>{const t=e.innerText||"",n=/^\s*\d+[smhdwy]\s*$/i.test(t),o=t.includes("Marketplace ·"),a=t.includes(":")||t.length>8;return!n&&!o&&a}))}},activeChat:{container:'div.x1ey2m1c.xds687c.xixxii4.x1vjfegm, div[role="main"] > div > div > div:last-child',messageWrapper:'div.x4k7w5x > div > div > div, div[role="main"] > div > div > div:last-child > div',messageRow:'div[role="row"]',senderAvatar:'img.x1rg5ohu[alt]:not([alt="Open photo"])',messageContent:['span.x1lliihq.x1plvlek > div[dir="auto"]','div[role="presentation"] span.x1lliihq > div[dir="auto"]','div[dir="auto"].html-div[class*="xexx8yu"]'],messageTimestamp:["span[data-tooltip-content][aria-label]",'span[title][aria-label*=":"]',"span.x1lliihq.x1plvlek.xryxfnj[aria-label]",'span[aria-label*="sent at"]','span[aria-label*="enviado a las"]'],messageImageElement:['a[href*="/messenger_media/"] img.x1rg5ohu','img[alt]:not([width="16"]):not([height="16"])','img[data-visualcompletion="media-vc-image"]',"div.x1ey2m1c img",'div[role="img"]',"div.x6ikm8r.x10wlt62 > img"],messageAudioElement:'div[aria-label="Play"][role="button"] ~ audio[src], div[aria-label*="audio message"] audio[src], audio[src]',messageAudioPlayButton:['div.x6s0dn4 div[aria-label="Play"][role="button"]','div[role="button"][aria-label="Play"]','div[aria-label="Play"][role="button"]','div[role="button"][aria-label*="audio"]','div[aria-label*="reproducir"][role="button"]','div[aria-label*="Audio message"]','div.xzg4506 > div.x1qjc9v5 > div[role="button"]','div[aria-label*="Play" i][role="button"]'],messageAudioUrlSource:null,messageAudioUrlAttribute:null,messageVideoElement:["video",'div[aria-label="Expand video"] video','div[aria-label="Play video"][role="button"]','div[data-testid="media-container"] video','div[data-visualcompletion="media-vc-image"][style*="background-image"]','div[role="button"][aria-label*="video"]','a[href*="video_redirect"]','div.x78zum5.xdt5ytf.x16ldp7u > div[role="button"]'],messageFileElement:['a[href*="attachment.php"]','a[href*="cdn.fbsbx.com"][download]','div[data-testid="attachment"]','div[role="button"][aria-label*="file"]','div[aria-label*="archivo adjunto"]'],messageLocationElement:['div[data-testid="map_container"]','a[href*="l.facebook.com/l.php"][href*="maps"]','a[href*="google.com/maps"]','div[aria-label*="location"]','div[aria-label*="ubicación"]'],messageGifElement:['div[data-testid="sticker"] img','img[src*="tenor.com"]','img[src*="giphy.com"]','div[aria-label*="GIF"]'],sellerIndicators:['div[aria-label="Mark as pending"]','span:contains("Mark as pending")','div[aria-label="Create plan"]','div[aria-label="Mark as available"]','div[aria-label="Mark as sold"]'],buyerIndicators:['a[aria-label="See details"]','span:contains("See details")'],productLink:'a[href*="/marketplace/item/"]',productInfo:'div[class*="x1sliqq"], div[role="main"] > div > div > div:first-child',messageInput:'div[contenteditable="true"][role="textbox"], div[aria-label="Message"], p.xat24cr.xdj266r',sendButton:['div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][aria-label*="send"]','div[role="button"][aria-label*="enviar"]','div.x1i10hfl[role="button"].xjbqb8w','div.x78zum5[role="button"].xjbqb8w','div.x1i10hfl[role="button"]:not([aria-hidden="true"])','div[role="button"][tabindex="0"]:not([style*="visibility: hidden"])'],scrollbar:[".x1uipg7g > div:nth-child(1) > div:nth-child(1)",'div[style*="overflow-y: auto"][style*="height"]','div[style*="overflow: auto"][style*="height"]','div.x4k7w5x > div[style*="height"]','div[role="main"] div.x1n2onr6[style*="height"]'],chatBeginningIndicators:['div[role="img"][aria-label]',"h4.xdj266r.x11i5rnm.xat24cr.x1mh8g0r","ul.x6s0dn4.x78zum5.xl56j7k.xsag5q8.x1y1aw1k","div.x1eb86dx.xsag5q8.x1ye3gou.xn6708d.x1cnzs8"]}},init(){if(this.loadFromStorage(),this.initializeExtras(),this.AI&&"function"==typeof this.AI.syncWithLegacyConfig&&this.AI.syncWithLegacyConfig(),void 0!==e){e.debug(`Configuration initialized. Mode: ${this.operationMode}, modo property: ${this.modo}`);const t="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):null,n="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):null,o=localStorage.getItem("FB_CHAT_MODE"),a=localStorage.getItem("FB_CHAT_OPERATION_MODE");e.debug(`Storage status - GM: modo=${t}, opMode=${n} | LS: modo=${o}, opMode=${a}`)}return!0},initializeExtras(){return document.addEventListener("configUpdated",(t=>{const n=t?.detail||{};n.operationMode&&(this.operationMode=n.operationMode,e.debug(`Mode updated by event: ${this.operationMode}, source: ${n.source||"unknown"}`))})),!0},loadFromStorage(){try{const t=this.getStorage(),n=t.FB_CHAT_OPERATION_MODE,o=t.FB_CHAT_MODE;void 0!==e&&e.debug(`Mode values found - FB_CHAT_OPERATION_MODE: ${n}, FB_CHAT_MODE: ${o}`);let a=null;if("auto"===n||"manual"===n?(a=n,void 0!==e&&e.debug(`Mode loaded from FB_CHAT_OPERATION_MODE: ${a}`)):"auto"===o||"manual"===o?(a=o,void 0!==e&&e.debug(`Mode loaded from FB_CHAT_MODE (legacy): ${a}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",o),void 0!==e&&e.debug(`Mode migrated from FB_CHAT_MODE to FB_CHAT_OPERATION_MODE: ${o}`)):(a="manual",void 0!==e&&e.debug(`No saved value found for mode. Assigning default value: ${a}`),this.saveToStorage("FB_CHAT_OPERATION_MODE",a),this.saveToStorage("FB_CHAT_MODE",a)),a&&(this.operationMode=a),t.FB_CHAT_API_KEY&&(this.apiKey=t.FB_CHAT_API_KEY,this.AI&&(this.AI.apiKey=t.FB_CHAT_API_KEY)),t.FB_CHAT_MODEL&&(this.model=t.FB_CHAT_MODEL,this.AI&&(this.AI.model=t.FB_CHAT_MODEL)),t.FB_CHAT_ASSISTANTS)try{const e="string"==typeof t.FB_CHAT_ASSISTANTS?JSON.parse(t.FB_CHAT_ASSISTANTS):t.FB_CHAT_ASSISTANTS;e&&"object"==typeof e&&(e.seller&&(this.assistants.seller={...this.assistants.seller,...e.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...e.seller})),e.buyer&&(this.assistants.buyer={...this.assistants.buyer,...e.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...e.buyer})))}catch(t){void 0!==e&&e.error(`Error parsing assistants: ${t.message}`)}return void 0!==e&&(e.log("Configuration loaded from storage"),e.debug(`Final state after loading: operationMode=${this.operationMode}, modo=${this.modo}`)),this}catch(t){return void 0!==e&&e.error(`Error loading configuration: ${t.message}`),this}},updateOperationMode(t){return"auto"!==t&&"manual"!==t?(e.error(`Invalid operation mode: ${t}. Must be 'auto' or 'manual'`),!1):(this.operationMode=t,"function"==typeof GM_setValue?(GM_setValue("FB_CHAT_OPERATION_MODE",t),GM_setValue("FB_CHAT_MODE",t)):(localStorage.setItem("FB_CHAT_OPERATION_MODE",t),localStorage.setItem("FB_CHAT_MODE",t)),e.log(`Operation mode updated to: ${t.toUpperCase()}`),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:t,modo:t,source:"updateOperationMode"}})),window.ui&&"function"==typeof window.ui.updateModeUI&&window.ui.updateModeUI(t),window.responseManager&&(window.responseManager.isAutomodeEnabled="auto"===t,e.debug(`ResponseManager updated: automode=${window.responseManager.isAutomodeEnabled}`)),e.debug(`Mode updated: operationMode=${this.operationMode}, modo=${this.modo}`),!0)},saveApiKey(t){return t&&"string"==typeof t?(this.apiKey=t,this.AI&&(this.AI.apiKey=t),this.saveToStorage("FB_CHAT_API_KEY",t),e.log("API Key saved"),!0):(e.error("Invalid API Key"),!1)},saveModel(t){return t&&"string"==typeof t?(this.model=t,this.AI&&(this.AI.model=t),this.saveToStorage("FB_CHAT_MODEL",t),e.log(`Model changed to: ${t}`),!0):(e.error("Invalid model"),!1)},saveAssistants(t){return t&&"object"==typeof t?(t.seller&&(this.assistants.seller={...this.assistants.seller,...t.seller},this.AI&&this.AI.assistants&&(this.AI.assistants.seller={...this.AI.assistants.seller,...t.seller})),t.buyer&&(this.assistants.buyer={...this.assistants.buyer,...t.buyer},this.AI&&this.AI.assistants&&(this.AI.assistants.buyer={...this.AI.assistants.buyer,...t.buyer})),this.saveToStorage("FB_CHAT_ASSISTANTS",JSON.stringify(this.assistants)),e.log("Assistants configuration updated"),!0):(e.error("Invalid assistants configuration"),!1)},getStorage(){const t={};if("function"==typeof GM_getValue&&"function"==typeof GM_setValue){let n=[];"function"==typeof GM_listValues&&(n=GM_listValues()),n.length||(n=["FB_CHAT_MODE","FB_CHAT_OPERATION_MODE","FB_CHAT_API_KEY","FB_CHAT_MODEL","FB_CHAT_ASSISTANTS"]),n.forEach((n=>{try{t[n]=GM_getValue(n)}catch(t){e.debug(`Error reading key ${n} from GM_getValue: ${t.message}`)}}))}else for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o&&o.startsWith("FB_CHAT_"))try{let e=localStorage.getItem(o);try{e=JSON.parse(e)}catch(e){}t[o]=e}catch(t){e.debug(`Error reading key ${o} from localStorage: ${t.message}`)}}return t},saveToStorage(t,n){try{if("function"==typeof GM_setValue)return GM_setValue(t,n),!0;const e="object"==typeof n?JSON.stringify(n):n;return localStorage.setItem(t,e),!0}catch(n){return e.error(`Error saving to storage [${t}]: ${n.message}`),!1}},checkStatus(){const e=!!this.apiKey||this.AI&&!!this.AI.apiKey,t=!!this.model||this.AI&&!!this.AI.model,n="auto"===this.operationMode||"manual"===this.operationMode,o=this.assistants.seller&&this.assistants.seller.id||this.assistants.buyer&&this.assistants.buyer.id||this.AI&&this.AI.assistants&&(this.AI.assistants.seller&&this.AI.assistants.seller.id||this.AI.assistants.buyer&&this.AI.assistants.buyer.id);return{isReady:e&&t&&n,isApiKeySet:e,isModelSet:t,isOperationModeValid:n,operationMode:this.operationMode,hasAssistants:o}}}),window.CONFIG=CONFIG,window.diagnoseModeConfig=function(){const e="function"==typeof GM_getValue?GM_getValue("FB_CHAT_MODE"):"N/A",t="function"==typeof GM_getValue?GM_getValue("FB_CHAT_OPERATION_MODE"):"N/A",n=localStorage.getItem("FB_CHAT_MODE"),o=localStorage.getItem("FB_CHAT_OPERATION_MODE"),a={currentConfig:{operationMode:CONFIG.operationMode,modo:CONFIG.modo,areSynced:CONFIG.operationMode===CONFIG.modo},storage:{GM:{FB_CHAT_MODE:e,FB_CHAT_OPERATION_MODE:t},localStorage:{FB_CHAT_MODE:n,FB_CHAT_OPERATION_MODE:o}},responseManager:window.responseManager?{isAutomodeEnabled:window.responseManager.isAutomodeEnabled}:"Not available"};return console.log("[Mode Diagnosis]",a),a};const e={logs:[],maxLogs:100,log(e,t={}){const n={type:"INFO",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.log(`[FB-Chat-Monitor] ${e}`,t)},debug(e,t={}){if(CONFIG.debug){const n={type:"DEBUG",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.log(`[FB-Chat-Monitor][DEBUG] ${e}`,t)}},error(e,t={},n=null){const o={type:"ERROR",timestamp:(new Date).toISOString(),message:e,data:t,stack:n?.stack||(new Error).stack};this._addLog(o),console.error(`[FB-Chat-Monitor][ERROR] ${e}`,t,n)},warn(e,t={}){const n={type:"WARN",timestamp:(new Date).toISOString(),message:e,data:t};this._addLog(n),console.warn(`[FB-Chat-Monitor][WARN] ${e}`,t)},notify(e,t="success",n={}){const o={type:"NOTIFICATION",notificationType:t,timestamp:(new Date).toISOString(),message:e};this._addLog(o);const a=document.createElement("div");a.style.position="fixed",a.style.bottom="20px",a.style.right="20px",a.style.padding="10px 15px",a.style.color="white",a.style.borderRadius="5px",a.style.zIndex="9999",a.style.opacity="0.9",a.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="14px",a.style.display="flex",a.style.alignItems="center",a.style.transition="all 0.3s ease",a.style.maxWidth="80%",a.style.wordBreak="break-word","success"===t?(a.style.backgroundColor="#4CAF50",a.innerHTML=`<span style="margin-right:8px;">✓</span>${e}`):"error"===t?(a.style.backgroundColor="#f44336",a.innerHTML=`<span style="margin-right:8px;">⚠️</span>${e}`):"warning"===t?(a.style.backgroundColor="#ff9800",a.innerHTML=`<span style="margin-right:8px;">⚠</span>${e}`):"info"===t&&(a.style.backgroundColor="#2196F3",a.innerHTML=`<span style="margin-right:8px;">ℹ</span>${e}`);const i=document.createElement("span");if(i.innerHTML="×",i.style.marginLeft="10px",i.style.cursor="pointer",i.style.fontWeight="bold",i.style.fontSize="18px",i.onclick=()=>document.body.removeChild(a),a.appendChild(i),document.body.appendChild(a),n.buttons&&Array.isArray(n.buttons)){const e=document.createElement("div");e.style.marginTop="10px",e.style.display="flex",e.style.gap="10px",n.buttons.forEach((t=>{if(t.text&&"function"==typeof t.action){const n=document.createElement("button");n.textContent=t.text,n.style.padding="5px 10px",n.style.border="none",n.style.borderRadius="3px",n.style.cursor="pointer",n.style.backgroundColor=t.color||"#fff",n.style.color=t.textColor||"#333",n.onclick=()=>{t.action(),!1!==t.closeOnClick&&document.body.removeChild(a)},e.appendChild(n)}})),a.appendChild(e)}if(n.timeoutSeconds){const e=document.createElement("span");e.className="countdown",e.textContent=n.timeoutSeconds,e.style.marginLeft="8px",e.style.padding="2px 6px",e.style.backgroundColor="rgba(255,255,255,0.2)",e.style.borderRadius="10px",a.appendChild(e)}const r=n.duration||5e3;return setTimeout((()=>{document.body.contains(a)&&(a.style.opacity="0",setTimeout((()=>{document.body.contains(a)&&document.body.removeChild(a)}),300))}),r),a},_addLog(e){this.logs.unshift(e),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs)),CONFIG.logging&&CONFIG.logging.saveLogs&&this._saveLogs()},_saveLogs(){try{localStorage.setItem("FB_CHAT_MONITOR_LOGS",JSON.stringify(this.logs))}catch(e){console.error("Error saving logs to localStorage",e)}},loadLogs(){try{const e=localStorage.getItem("FB_CHAT_MONITOR_LOGS");e&&(this.logs=JSON.parse(e))}catch(e){console.error("Error loading logs from localStorage",e)}},getAllLogs(){return[...this.logs]},getLogsByType(e){return this.logs.filter((t=>t.type===e))},clearLogs(){this.logs=[];try{localStorage.removeItem("FB_CHAT_MONITOR_LOGS")}catch(e){console.error("Error clearing logs from localStorage",e)}},notify:function(e,t="info",n=2e3){console.log(`[${t.toUpperCase()}] ${e}`);const o=document.createElement("div");o.className="fb-chat-monitor-notification";const a=this.getOptimalAlertPosition();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)},getOptimalAlertPosition:function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n=document.getElementById("fbChatMonitorQuickResponse");if(e&&window.uiState?.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}if(n&&"none"!==window.getComputedStyle(n).display){const e=n.getBoundingClientRect();return{top:e.top-10-40+"px",right:window.innerWidth-e.right+"px",left:"auto"}}return{top:"60px",right:"20px",left:"auto"}}},t={findElement(t,n=document){if(Array.isArray(t)){for(const o of t)try{const e=n.querySelector(o);if(e)return e}catch(t){e.debug(`Error with selector "${o}": ${t.message}`)}return null}try{return n.querySelector(t)}catch(n){return e.debug(`Error with selector "${t}": ${n.message}`),null}},findAllElements(t,n=document){try{return[...n.querySelectorAll(t)]}catch(n){return e.debug(`Error with selector "${t}": ${n.message}`),[]}},waitForElement:(e,t=CONFIG.waitElementTimeout)=>new Promise(((n,o)=>{let a=0;const i=Array.isArray(e)?e:[e],r=()=>{for(const e of i)try{const t=document.querySelector(e);if(t)return void n(t)}catch(e){}a+=100,a>=t?o(new Error(`Timeout waiting for elements: ${JSON.stringify(i)}`)):setTimeout(r,100)};r()})),scrollToTop:(e,t=10)=>new Promise((n=>{let o=e.scrollHeight,a=0,i=0;const r=()=>{e.scrollTop=0,setTimeout((()=>{if(i++,e.scrollHeight===o){if(a++,a>=3||i>=t)return void n({success:!0,fullyScrolled:!0})}else a=0,o=e.scrollHeight;r()}),300)};r()})),scrollToBottom:e=>new Promise((t=>{e?(e.scrollTop=e.scrollHeight,setTimeout((()=>t(!0)),100)):t(!1)})),injectStyles(e){const t=document.createElement("style");return t.textContent=e,document.head.appendChild(t),t},insertTextIntoField(t,n){if(!t)return!1;try{t.focus();const o=[()=>(document.execCommand("selectAll",!1,null),document.execCommand("insertText",!1,n)),()=>"true"===t.contentEditable&&(t.innerText=n,t.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>"value"in t&&(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),!0),()=>{for(;t.firstChild;)t.removeChild(t.firstChild);return t.appendChild(document.createTextNode(n)),t.dispatchEvent(new Event("input",{bubbles:!0})),!0}];for(const t of o)try{if(t())return e.debug("Text inserted successfully"),!0}catch(e){}return t.innerText=n,t.value=n,t.textContent=n,["input","change","keyup"].forEach((e=>{try{t.dispatchEvent(new Event(e,{bubbles:!0}))}catch(e){}})),!0}catch(t){return e.error(`Error inserting text into field: ${t.message}`),!1}},insertTextIntoField(t,n){if(!t||!n)return!1;try{if("true"===t.getAttribute("contenteditable")){t.innerHTML="",t.focus();if(!document.execCommand("insertText",!1,n)){t.textContent=n;const e=new Event("input",{bubbles:!0,cancelable:!0});t.dispatchEvent(e)}return!0}return"INPUT"===t.tagName||"TEXTAREA"===t.tagName?(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),!0):(t.innerText=n,!0)}catch(t){return e.error(`Error insertando texto en campo: ${t.message}`),!1}},insertTextIntoField(t,n){if(!t||!n)return!1;try{if(("true"===t.getAttribute("contenteditable")?!t.textContent||""===t.textContent.trim():!t.value||""===t.value.trim())||("true"===t.getAttribute("contenteditable")?(t.innerHTML="",t.textContent=""):"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(t.value=""),e.debug("Campo limpiado adicionalmente antes de insertar texto")),"true"===t.getAttribute("contenteditable")){t.innerHTML="",t.focus();if(!document.execCommand("insertText",!1,n)){t.textContent=n;const e=new Event("input",{bubbles:!0,cancelable:!0});t.dispatchEvent(e)}return!0}return"INPUT"===t.tagName||"TEXTAREA"===t.tagName?(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),!0):(t.innerText=n,!0)}catch(t){return e.error(`Error insertando texto en campo: ${t.message}`),!1}},insertTextIntoField(t,n){if(!t||!n)return!1;try{const o="true"===t.getAttribute("contenteditable"),a=o?(t.textContent||"").trim():(t.value||"").trim();if(a){if(e.warn(`Campo aún contiene texto antes de insertar: "${a.substring(0,30)}..."`),o){t.innerHTML="",t.textContent="";try{const e=window.getSelection(),n=document.createRange();n.selectNodeContents(t),e.removeAllRanges(),e.addRange(n),e.deleteFromDocument()}catch(t){e.debug(`Error usando selection API: ${t.message}`)}}else t.value="";["input","change"].forEach((e=>{t.dispatchEvent(new Event(e,{bubbles:!0}))}))}if(o){t.focus();document.execCommand("insertText",!1,n)||(t.textContent=n,t.dispatchEvent(new Event("input",{bubbles:!0})))}else"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})));return setTimeout((()=>{const a=o?t.textContent:t.value;a!==n?e.warn(`Posible problema al insertar texto. Esperado: "${n.substring(0,30)}...", Actual: "${a.substring(0,30)}..."`):e.debug("Texto insertado correctamente verificado")}),50),!0}catch(t){return e.error(`Error insertando texto en campo: ${t.message}`),!1}},simulateKeyPress(t,n="Enter",o=13){if(!t)return!1;try{t.focus();const e=[new KeyboardEvent("keydown",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0}),new KeyboardEvent("keypress",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0}),new KeyboardEvent("keyup",{key:n,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0})];let a=!0;return e.forEach((e=>{t.dispatchEvent(e)||(a=!1)})),a}catch(t){return e.error(`Error simulando tecla ${n}: ${t.message}`),!1}},simulateKeyPress(t,n,o){if(!t)return!1;try{return t.focus(),setTimeout((()=>{try{let a=!0;return["keydown","keypress","keyup"].forEach((i=>{const r=new KeyboardEvent(i,{key:n,code:1===n.length?`Key${n.toUpperCase()}`:n,keyCode:o,which:o,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(r)||(e.warn(`Evento ${i} no fue despachado correctamente`),a=!1),"keyup"!==i&&setTimeout((()=>{}),0)})),e.debug(`Simulación de tecla ${n} ${a?"exitosa":"con problemas"}`),a}catch(t){return e.error(`Error en simulación de tecla: ${t.message}`),!1}}),50),!0}catch(t){return e.error(`Error preparando simulación de tecla: ${t.message}`),!1}}},n={set:function(t,n){try{if("function"==typeof GM_setValue&&GM_setValue(t,n),"undefined"!=typeof localStorage){const e="object"==typeof n?JSON.stringify(n):n;localStorage.setItem(t,e)}return!0}catch(n){return e.error(`Error storing data: ${n.message}`,{key:t}),!1}},get:function(t,n=null){try{if("function"==typeof GM_getValue){const e=GM_getValue(t,void 0);if(void 0!==e)return e}if("undefined"!=typeof localStorage){const e=localStorage.getItem(t);if(null!==e)try{return JSON.parse(e)}catch(t){return e}}return n}catch(o){return e.error(`Error retrieving data: ${o.message}`,{key:t}),n}},remove:function(t){try{return"function"==typeof GM_deleteValue&&GM_deleteValue(t),"undefined"!=typeof localStorage&&localStorage.removeItem(t),!0}catch(n){return e.error(`Error removing data: ${n.message}`,{key:t}),!1}},migrateSettings:function(){e.debug("Running settings migration check...");let t=0;return"function"==typeof GM_setValue&&"undefined"!=typeof localStorage&&["FB_CHAT_MONITOR_OPENAI_KEY","FB_CHAT_MONITOR_AI_MODEL","FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","FB_CHAT_MONITOR_OPERATION_MODE","FB_CHAT_MONITOR_SELLER_ASSISTANT_NAME","FB_CHAT_MONITOR_BUYER_ASSISTANT_NAME","FB_CHAT_MONITOR_SELLER_INSTRUCTIONS","FB_CHAT_MONITOR_BUYER_INSTRUCTIONS","FB_CHAT_MONITOR_AI_TEMP"].forEach((n=>{const o=localStorage.getItem(n);if(null!==o&&void 0===GM_getValue(n,void 0)){let a=o;try{a=JSON.parse(o)}catch(e){}GM_setValue(n,a),t++,e.debug(`Migrated ${n} from localStorage to GM_storage`)}})),t>0?e.log(`Settings migration complete: ${t} items migrated`):e.debug("No settings needed migration"),t},checkStorageHealth:function(){const t="function"==typeof GM_setValue&&"function"==typeof GM_getValue,n="undefined"!=typeof localStorage;if(e.debug(`Storage availability: GM_storage=${t}, localStorage=${n}`),!t&&!n)return e.error("No storage mechanisms available. Data persistence will not work."),!1;try{const t="STORAGE_TEST_"+Date.now(),n="test_"+Date.now();this.set(t,n);return this.get(t,null)!==n?(e.error("Storage verification failed: write/read mismatch"),!1):(this.remove(t),e.debug("Storage health check passed successfully"),!0)}catch(t){return e.error("Storage health check failed",t),!1}}},o={isActive:!1,lastActivity:Date.now(),listeners:[],initialize(){document.addEventListener("mousemove",(()=>this.recordActivity())),document.addEventListener("keydown",(()=>this.recordActivity())),document.addEventListener("click",(()=>this.recordActivity())),setInterval((()=>this.checkInactivity()),6e4),e.debug("User activity tracker initialized")},recordActivity(){const e=!this.isActive;this.isActive=!0,this.lastActivity=Date.now(),e&&this.notifyListeners()},checkInactivity(){Date.now()-this.lastActivity>3e5&&this.isActive&&(this.isActive=!1,this.notifyListeners())},onActivityChange(e){"function"==typeof e&&this.listeners.push(e)},notifyListeners(){for(const t of this.listeners)try{t(this.isActive,this.lastActivity)}catch(t){e.error("Error in activity listener",{},t)}}},a={async withExponentialBackoff(t,n={}){const{maxRetries:o=3,baseDelay:a=1e3,maxDelay:i=3e4,factor:r=2,jitter:s=.1}=n;let l=0,c=null;for(;l<=o;)try{return await t()}catch(t){if(c=t,l++,l>o)throw e.error(`Operation failed after ${o} retries`,{},t),t;const n=Math.min(a*Math.pow(r,l-1),i),d=n*s,u=n+(Math.random()*d*2-d);e.debug(`Retry attempt ${l} after ${Math.round(u)}ms`),await new Promise((e=>setTimeout(e,u)))}throw c}},i={formatDate:e=>new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e),getRelativeTime(e){const t=new Intl.RelativeTimeFormat("en",{numeric:"auto"}),n=e-Date.now(),o=Math.floor(n/1e3),a=Math.floor(o/60),i=Math.floor(a/60),r=Math.floor(i/24);return Math.abs(r)>0?t.format(r,"day"):Math.abs(i)>0?t.format(i,"hour"):Math.abs(a)>0?t.format(a,"minute"):t.format(o,"second")},sleep:e=>new Promise((t=>setTimeout(t,e)))},r={isMarketplaceMessenger(){const e=window.location.href;return e.includes("facebook.com/messages")||e.includes("messenger.com")},redirectToMarketplace:()=>!(!window.location.href.includes("messenger.com")||window.location.href.includes("marketplace"))&&(window.location.href="https://www.facebook.com/messages/t/marketplace",!0)};function s(t,n="info",o={}){return e.notify(t,n,o)}async function l(e){return i.sleep(e)}e.loadLogs(),o.initialize(),window.logger=e,window.domUtils=t,window.storageUtils=n,window.userActivityTracker=o,window.retryUtils=a,window.timeUtils=i,window.pageUtils=r,window.showSimpleAlert=s,window.delay=l,window.insertTextDirectly=function(e,n){return t.insertTextIntoField(e,n)},window.getFbDtsg=function(){const e=document.querySelector('input[name="fb_dtsg"], meta[name="fb_dtsg"]');if(e)return e.value||e.content||"";const t=document.body.innerHTML.match(/"DTSGInitData",\[\],\{"token":"([^"]+)"/);return t?t[1]:""},window.getFacebookUserID=function(){const e=document.cookie.match(/c_user=(\d+)/);return e?e[1]:""},window.__reqCounter||(window.__reqCounter=0),window.nextReq=function(){return(++window.__reqCounter).toString(36)},window.getRevision=function(){return document.querySelector('meta[name="revision"]')?.content||"1007773680"},window.jsonToFormUrlEncoded=function(e){return Object.entries(e).map((([e,t])=>encodeURIComponent(e)+"="+encodeURIComponent(t))).join("&")},window.diagnoseModeConfig=function(){const t={storage:{GM:"function"==typeof GM_getValue?{FB_CHAT_MODE:GM_getValue("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:GM_getValue("FB_CHAT_OPERATION_MODE")}:"GM storage no disponible",localStorage:{FB_CHAT_MODE:localStorage.getItem("FB_CHAT_MODE"),FB_CHAT_OPERATION_MODE:localStorage.getItem("FB_CHAT_OPERATION_MODE")}},memory:{CONFIG_operationMode:window.CONFIG?.operationMode,CONFIG_modo:window.CONFIG?.modo,ui_modeState:window.ui?.currentMode||"No disponible"},responseManager:{isAutomodeEnabled:window.responseManager?.isAutomodeEnabled||"No disponible"}};return e.log("=== DIAGNÓSTICO DE MODO OPERACIÓN ==="),e.log(JSON.stringify(t,null,2)),e.log("====================================="),t};const c={isTyping:!1,intervalId:null,chatId:null};function d(e){const t=e.length*CONFIG.humanSimulation.baseTypingSpeed,n=Math.random()*CONFIG.humanSimulation.typingVariation*e.length;return Math.max(CONFIG.humanSimulation.minResponseDelay,t+n)}function u(){return Math.floor(Math.random()*(CONFIG.humanSimulation.maxResponseDelay-CONFIG.humanSimulation.minResponseDelay)+CONFIG.humanSimulation.minResponseDelay)}function g(e){return/[áéíóúñ¿¡]/i.test(e)||/\b(hola|gracias|buenos días|buenas tardes|disponible)\b/i.test(e)?"es":/[ãõçâêôáéíóú]/i.test(e)||/\b(obrigado|bom dia|boa tarde|disponível)\b/i.test(e)?"pt":/[àââçéèêëîïôœùûüÿ]/i.test(e)||/\b(bonjour|merci|bonne journée|disponible)\b/i.test(e)?"fr":"en"}function m(e){const t={en:"Hello! Thank you for your message. I'll get back to you as soon as possible.",es:"¡Hola! Gracias por tu mensaje. Te responderé lo antes posible.",pt:"Olá! Obrigado pela sua mensagem. Responderei o mais rápido possível.",fr:"Bonjour! Merci pour votre message. Je vous répondrai dès que possible."};return t[g("string"==typeof e?e:e?.text||"")]||t.en}async function p(t=null){try{const n=document.querySelector(CONFIG.selectors.activeChat.messageInput);return n?(n.focus(),c.isTyping=!0,c.chatId=t,c.intervalId=setInterval((()=>{if(n&&c.isTyping){const e=new KeyboardEvent("keypress",{bubbles:!0,cancelable:!0,key:" ",code:"Space"});n.dispatchEvent(e),n.innerText.endsWith(" ")?n.innerText=n.innerText.slice(0,-1):n.innerText+=" ",n.dispatchEvent(new Event("input",{bubbles:!0}))}}),2e3),e.debug("Typing indicator activated"),!0):(e.debug("Input field not found for typing indicator"),!1)}catch(t){return e.debug(`Error activating typing indicator: ${t.message}`),!1}}async function h(){try{c.intervalId&&(clearInterval(c.intervalId),c.intervalId=null),c.isTyping=!1;try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);e&&e.innerText&&(e.innerText="",e.dispatchEvent(new Event("input",{bubbles:!0}))),e.blur()}catch(e){}return e.debug("Typing indicator deactivated"),!0}catch(t){return e.debug(`Error deactivating typing indicator: ${t.message}`),!1}}async function f(t){try{return t.focus(),["keydown","keypress","keyup"].forEach((e=>{t.dispatchEvent(new KeyboardEvent(e,{key:"Enter",code:"Enter",bubbles:!0}))})),!0}catch(t){return e.debug(`Error sending via Enter: ${t.message}`),!1}}async function y(o,a,i){try{e.debug("Processing auto mode response");const r=u();let s;await l(r),await p(a.chatId);try{s=await S.generateResponse(a),e.debug(`AI response generated: "${s.substring(0,30)}..."`)}catch(t){e.error(`Error generating AI response: ${t.message}`),s=m(o[o.length-1]?.content||"")}const c=d(s);e.debug(`Simulating typing for ${Math.round(c/1e3)} seconds`),await l(c),await h();const g=await t.waitForElement(CONFIG.selectors.activeChat.messageInput);if(!g)throw new Error("Message input field not found");t.insertTextIntoField(g,s),await f(g),e.log("Auto response sent successfully");const y=w();return y.unshift({timestamp:(new Date).toISOString(),mode:"auto",context:{chatId:a.chatId,role:a.role,productDetails:a.productDetails?{id:a.productDetails.id,title:a.productDetails.title}:null,lastMessage:o[o.length-1]?.content||null},response:s,sent:!0}),n.set("RESPONSE_LOGS",y),i&&i(s),s}catch(t){throw e.error(`Auto mode error: ${t.message}`),await h(),i&&i(null),t}}async function b(o,a,i){try{let r;e.debug("Processing manual mode response"),await p(a.chatId);try{r=await S.generateResponse(a),e.debug(`AI response generated in manual mode: "${r.substring(0,30)}..."`)}catch(t){e.error(`Error generating AI response: ${t.message}`),r=m(o[o.length-1]?.content||"")}await h();const l=await t.waitForElement(CONFIG.selectors.activeChat.messageInput);if(!l)throw new Error("Message input field not found");t.insertTextIntoField(l,r),s("Response generated and inserted in the chat input field. Review and press Enter to send.","info"),e.log("Manual response generated and inserted");const c=w();return c.unshift({timestamp:(new Date).toISOString(),mode:"manual",context:{chatId:a.chatId,role:a.role,productDetails:a.productDetails?{id:a.productDetails.id,title:a.productDetails.title}:null,lastMessage:o[o.length-1]?.content||null},response:r,sent:!1}),n.set("RESPONSE_LOGS",c),i&&i(r),r}catch(t){throw e.error(`Manual mode error: ${t.message}`),await h(),i&&i(null),t}}function w(){return window.storageUtils.get("RESPONSE_LOGS",[])}const v={typingState:c,calculateTypingTime:d,getRandomResponseDelay:u,detectLanguage:g,getDefaultResponse:m,startTypingIndicator:p,stopTypingIndicator:h,sendViaEnter:f,generateAndHandleResponse:async function(t,n,o,a){try{if(t.length>0&&t[t.length-1].sentByUs)return;switch(o){case"auto":await y(t,n,a);break;case"manual":await b(t,n,a);break;default:e.debug(`Unknown operation mode: ${o}`),"function"==typeof a&&a({success:!1,error:"Unknown operation mode"})}}catch(t){e.debug(`Error handling response: ${t.message}`),await h(),"function"==typeof a&&a({success:!1,error:t.message})}},handleAutoMode:y,handleManualMode:b,getConversationHistory:w,clearConversationHistory:function(){window.storageUtils.remove("RESPONSE_LOGS")},exportConversationHistory:function(){const e=w(),t={timestamp:(new Date).toISOString(),history:e},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}};window.responseManager=v;window.responseManager=new class{constructor(){this.isAutomodeEnabled=!1,this.lastChatId=null,this.lastResponseTime=0,this.cooldownPeriod=3e4,this.processingChat=!1,this.initialize()}initialize(){this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,e.debug(`ResponseManager initialized with automode: ${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`),document.addEventListener("configUpdated",(t=>{this.isAutomodeEnabled="auto"===window.CONFIG?.operationMode,e.debug(`ResponseManager detected mode change: Auto=${this.isAutomodeEnabled} (operationMode: ${window.CONFIG?.operationMode})`)}))}setAutoMode(t){this.isAutomodeEnabled=t,e.log("Automatic mode "+(t?"activated":"deactivated")),t&&this.verifyOpenAIAvailability()}verifyOpenAIAvailability(){if(!window.openaiManager)return e.error("OpenAI Manager is not available. Automatic mode will not work."),s("OpenAI Manager is not available. Automatic mode will not work.","error"),!1;const t="function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():!!window.openaiManager.apiKey;return t?(t&&!window.openaiManager.isInitialized&&(window.openaiManager.isInitialized=!0,e.debug("isInitialized=true has been corrected since the API key is present")),e.log("OpenAI Manager is ready for automatic responses."),!0):(e.error("OpenAI Manager does not have an API key configured. Automatic mode will not work correctly."),s("OpenAI does not have an API key configured. Configure it in the options.","error"),!1)}async processAutoResponse(n,o){if(this.processingChat||n===this.lastChatId)return e.debug(`Skipping chat ${n} - already processed or in process`),!1;try{if(this.processingChat=!0,e.debug(`Processing chat ${n} for automatic response`),!this.checkForUnrespondedMessages(o.messages))return e.debug(`No unresponded messages in chat ${n}`),!1;let a;if("function"==typeof this.handleAutoMode?(e.debug("Using handleAutoMode to generate automatic response"),a=await this.handleAutoMode(o.messages,o)):(e.debug("Generating response with OpenAI Manager directly"),a=await window.openaiManager.generateResponse(o)),!a||!a.text&&"string"!=typeof a)throw new Error("A valid response was not received");const i=a.text||a;if(window.chatManager&&"function"==typeof window.chatManager.insertResponseInInputField)window.chatManager.insertResponseInInputField(i);else{e.debug("chatManager.insertResponseInInputField not available, using alternative method");const n=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!n)throw new Error("Could not find the input field to insert the response");t.insertTextIntoField(n,i)}return await this.simulateTypingAndSend(),this.lastChatId=n,this.lastResponseTime=Date.now(),e.log(`Automatic response sent successfully to chat ${n}`),!0}catch(t){return e.error(`Error in processAutoResponse for chat ${n}: ${t.message}`,{chatId:n},t),!1}finally{this.processingChat=!1}}checkForUnrespondedMessages(e){if(!e||0===e.length)return!1;const t=e.slice(-10);let n=0;for(let e=t.length-1;e>=0;e--){if(t[e].sentByUs)break;n++}return n>0}async simulateTypingAndSend(){try{const t=document.querySelector('div[aria-label="Press Enter to send"] button, button[data-testid="send-button"]');if(!t)return void e.warn("Send button not found");const n=window.CONFIG?.humanSimulation?.autoSendDelay||2e3;e.debug(`Sending automatic message in ${n/1e3} seconds...`),await new Promise((e=>setTimeout(e,n))),t.click(),e.log("Automatic message sent")}catch(t){e.error(`Error sending automatic message: ${t.message}`,{},t)}}};const A=new class{constructor(){this.config=CONFIG.AI.humanSimulation,this.recentMessages=[],this.maxRecentMessages=10}async processMessageNaturally(t){try{await this.startTypingIndicator();const e=this.calculateTypingTime(t);if(await l(e),await this.stopTypingIndicator(),this.shouldSplitMessage(t))return await this.sendSplitMessage(t);{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!e)throw new Error("Input field not found");return await this.insertTextNaturally(e,t),await this.sendViaEnter(e),this.recordMessageLength(t),!0}}catch(t){return e.error(`Error processing message: ${t.message}`),await this.stopTypingIndicator(),!1}}async insertTextNaturally(t,n){if(!t||!n)return!1;try{t.focus(),t.innerText="",t.textContent="",document.execCommand&&(document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null)),t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(200);let o=!1;if("true"===t.contentEditable&&(t.innerText=n,t.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,e.debug("Text inserted using contentEditable innerText method")),!o&&document.execCommand)try{document.execCommand("insertText",!1,n),o=!0,e.debug("Text inserted using execCommand method")}catch(t){e.debug(`execCommand failed: ${t.message}`)}if(!o&&"value"in t&&(t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,e.debug("Text inserted using value property method")),!o){for(;t.firstChild;)t.removeChild(t.firstChild);const a=document.createTextNode(n);t.appendChild(a),t.dispatchEvent(new Event("input",{bubbles:!0})),o=!0,e.debug("Text inserted using DOM manipulation method")}return t.innerText&&""!==t.innerText.trim()?e.debug(`Text verification: field contains "${t.innerText.substring(0,30)}..."`):(e.warn("Text insertion succeeded but field appears empty"),t.textContent=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))),!0}catch(t){return e.error(`Error in insertTextNaturally: ${t.message}`),!1}}createTypoVersion(e){if(e.length<10)return e;const t=Math.floor(Math.random()*(e.length-3)+1),n=Math.random();if(n<.33)return e.substring(0,t)+e[t]+e.substring(t);if(!(n<.66))return e.substring(0,t)+e.substring(t+1);{const n={a:"sqzw",b:"vghn",c:"xdfv",d:"serfcx",e:"wsrdf",f:"drtgv",g:"ftyhb",h:"gyujn",i:"ujko",j:"hyuikn",k:"jiol",l:"kop",m:"njk",n:"bhjm",o:"iklp",p:"ol",q:"wa",r:"edft",s:"awedxz",t:"rfgy",u:"yhji",v:"cfgb",w:"qase",x:"zsdc",y:"tghu",z:"asx"},o=e[t].toLowerCase();if(n[o]){const a=n[o][Math.floor(Math.random()*n[o].length)];return e.substring(0,t)+a+e.substring(t+1)}}return e}async sendViaEnter(t){try{t.focus();const e=new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"Enter",code:"Enter",keyCode:13});return t.dispatchEvent(e),setTimeout((()=>{if(t.innerText&&""!==t.innerText.trim()){const e=document.querySelector(CONFIG.selectors.activeChat.sendButton);e&&e.click()}}),200),!0}catch(t){return e.error(`Error sending message: ${t.message}`),!1}}shouldSplitMessage(e){return!!this.config.fragmentMessages&&(!!(e&&e.length>2*this.config.fragmentThreshold)||!!(e&&e.length>this.config.fragmentThreshold)&&Math.random()<.7)}async sendSplitMessage(t){try{const e=this.splitTextIntoFragments(t);for(let t=0;t<e.length;t++){if(t>0){const n=this.calculateFragmentInterval();await l(n),await this.startTypingIndicator(),await l(Math.min(30*e[t].length,1500)),await this.stopTypingIndicator()}const n=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!n)throw new Error("Input field not found");await this.insertTextNaturally(n,e[t]),await this.sendViaEnter(n)}return this.recordMessageLength(t),!0}catch(t){return e.error(`Error sending split message: ${t.message}`),!1}}splitTextIntoFragments(e){if(!e)return[e];if(e.includes("\n\n"))return e.split(/\n\n+/).filter((e=>e.trim()));const t=e.match(/[^.!?]+[.!?]+/g)||[e],n=[];let o="",a=0;for(const e of t)o.length+e.length>this.config.fragmentThreshold||a>=2&&Math.random()<.5?(o&&n.push(o.trim()),o=e,a=1):(o+=e,a++);return o&&n.push(o.trim()),n.length>0?n:[e]}calculateFragmentInterval(){const e=this.config.fragmentDelay[0],t=this.config.fragmentDelay[1],n=Math.random()<.3?1e3+2e3*Math.random():0;return Math.floor(e+Math.random()*(t-e)+n)}calculateTypingTime(e){if(!e)return this.config.minResponseDelay;let t=e.length*(this.config.baseTypingSpeed/1e3);const n=Math.random()*this.config.typingVariation*e.length/100;return Math.max(this.config.minResponseDelay,Math.min(t+n,this.config.maxResponseDelay))}recordMessageLength(e){e&&(this.recentMessages.push(e),this.recentMessages.length>this.maxRecentMessages&&this.recentMessages.shift())}getAverageMessageLength(){if(0===this.recentMessages.length)return 50;return this.recentMessages.reduce(((e,t)=>e+t.length),0)/this.recentMessages.length}async startTypingIndicator(){try{const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);return t?(t.focus(),!0):(e.debug("Input field not found for typing indicator"),!1)}catch(t){return e.debug(`Error activating indicator: ${t.message}`),!1}}async stopTypingIndicator(){try{const e=document.querySelector(CONFIG.selectors.activeChat.messageInput);return e&&e.innerText&&(e.innerText="",e.dispatchEvent(new Event("input",{bubbles:!0}))),!0}catch(t){return e.debug(`Error deactivating indicator: ${t.message}`),!1}}};window.humanSimulator=A;const x=new class{constructor(){this.pendingChats=[],this.currentChatId=null,this.chatHistory=new Map,this.isProcessing=!1,this.conversationLogs=JSON.parse(localStorage.getItem("FB_CHAT_MONITOR_LOGS")||"[]"),this.lastProcessedMessageCount=0,this.manualChatChangeDetected=!1,this.activeChatObserver=null,this.lastScrollHeight=0,this.isProcessingChat=!1,this.typingState={isTyping:!1,intervalId:null,chatId:null},this._setupUrlChangeDetection()}_setupUrlChangeDetection(){this._lastUrl=window.location.href,setInterval((()=>{const e=window.location.href;this._lastUrl!==e&&(this._lastUrl=e,this._handleUrlChange(e))}),1e3)}_handleUrlChange(t){try{const n=t.match(/\/marketplace\/t\/(\d+)/);if(n&&n[1]){const t=n[1];t!==this.currentChatId&&(e.debug(`Manual chat change detected to ID: ${t}`),this.currentChatId=t,e.debug("Chat ID updated. The chat will be processed when Generate Response is clicked."))}}catch(t){e.error("Error handling URL change",{},t)}}async scanForUnreadChats(){e.log("Scanning for unread chats...");try{const n=t.findElement(CONFIG.selectors.chatList.container);if(!n)return e.error("Chat list container not found"),0;const o=t.findAllElements(CONFIG.selectors.chatList.chatItem,n);e.log(`Found ${o.length} chat elements`),this.pendingChats=[];for(const t of o)if(this.isUnreadChat(t)){const n=this.extractChatId(t),o=this.extractChatUsername(t),a=this.extractMessageTime(t);if(n&&/^\d+$/.test(n)){const i=this.convertTimeToMinutes(a);this.pendingChats.push({chatId:n,userName:o,messageTime:i,formattedTime:a,element:t}),e.debug(`Chat added to queue: ${o} (${n}), time: ${a}`)}else e.debug(`Chat ignored with non-numeric ID: ${n}`)}return this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime)),e.log(`Total valid unread chats: ${this.pendingChats.length}`),this.pendingChats.length>0?e.notify(`${this.pendingChats.length} unread chats found`,"success"):e.notify("No unread chats found","info"),this.pendingChats.length}catch(t){return e.error(`Error scanning chats: ${t.message}`),0}}isUnreadChat(t){try{const n=t.querySelector(CONFIG.selectors.chatList.unreadIndicator);if(n){if(!(n.textContent||"").includes("Marketplace ·"))return e.debug("Unread chat detected with specific indicator"),!0}const o=Array.from(t.querySelectorAll(CONFIG.selectors.chatList.chatUserName.selector.join(", ")));for(const t of o){const n=window.getComputedStyle(t);if(n&&parseInt(n.fontWeight)>=600)return e.debug("Unread chat detected by bold font style"),!0}return!1}catch(t){return e.error(`Error evaluating unread chat: ${t.message}`),!1}}extractChatId(t){const n=t.getAttribute("href");if(n&&n.includes("/marketplace/t/")){const t=n.match(/\/marketplace\/t\/(\d+)\//);if(t&&t[1])return e.debug(`ID extracted from href: ${t[1]}`),t[1]}const o=t.querySelectorAll('a[href*="/marketplace/t/"]');for(const t of o){const n=t.getAttribute("href").match(/\/marketplace\/t\/(\d+)\//);if(n&&n[1])return e.debug(`ID extracted from secondary link: ${n[1]}`),n[1]}const a=t.getAttribute("data-testid");if(a&&/^\d+$/.test(a))return e.debug(`ID extracted from data-testid: ${a}`),a;const i=`chat_${this.extractChatUsername(t).replace(/\s+/g,"_").toLowerCase()}`;return e.debug(`ID generated as fallback: ${i}`),i}extractChatUsername(t){try{if(Array.isArray(CONFIG.selectors.chatList.chatUserName.selector)){const e=CONFIG.selectors.chatList.chatUserName.selector.join(", "),n=Array.from(t.querySelectorAll(e)),o=CONFIG.selectors.chatList.chatUserName.filter?CONFIG.selectors.chatList.chatUserName.filter(n):n;if(o&&o.length>0){const e=o[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}else{const e=Array.isArray(CONFIG.selectors.chatList.chatUserName)?CONFIG.selectors.chatList.chatUserName.join(", "):CONFIG.selectors.chatList.chatUserName,n=Array.from(t.querySelectorAll(e)).filter((e=>{const t=e.innerText||"";return t.includes("·")&&!t.includes(":")}));if(n.length>0){const e=n[0].innerText;return e.split("·")[0].trim()||"Unknown User"}}const e=Array.from(t.querySelectorAll(CONFIG.selectors.chatList.chatUserName.selector.join(", ")))[0];return e?.innerText?.trim()||"Unknown User"}catch(t){return e.error(`Error extracting username: ${t.message}`),"Unknown User"}}extractMessageTime(n){try{const e=t.findElement(CONFIG.selectors.chatList.timestamp,n);return e?.innerText||"0m"}catch(t){return e.error(`Error extracting message time: ${t.message}`),"0m"}}convertTimeToMinutes(e){if(!e)return 0;const t=e.match(/(\d+)([mhdsw])/);if(!t)return 0;const n=parseInt(t[1]);switch(t[2]){case"m":default:return n;case"h":return 60*n;case"d":return 60*n*24;case"w":return 60*n*24*7}}async openNextPendingChat(){if(0===this.pendingChats.length)return e.log("No pending chats"),!1;this.pendingChats.sort(((e,t)=>t.messageTime-e.messageTime));const t=this.pendingChats.shift();e.log(`Opening chat with ${t.userName} (${t.chatId})`);try{if(t.element&&"function"==typeof t.element.click){e.log("Using direct click method to open chat"),t.element.scrollIntoView({behavior:"smooth",block:"center"}),e.notify(`Opening chat: ${t.userName}`,"info"),await new Promise((e=>setTimeout(e,1e3))),t.element.click(),this.currentChatId=t.chatId,await new Promise((e=>setTimeout(e,4e3)));const n="auto"===window.CONFIG?.operationMode;return e.debug(`Processing chat in ${n?"AUTO":"MANUAL"} mode (operationMode: ${window.CONFIG?.operationMode})`),await this.processCurrentChat(n),await this.markChatAsRead(),!0}if(/^\d+$/.test(t.chatId)){e.log("Using direct URL navigation to open chat");const n=`https://www.messenger.com/marketplace/t/${t.chatId}/`;return e.notify(`Navigating to: ${t.userName}`,"info"),window.location.href=n,await this.markChatAsRead(),!0}return e.error("Could not open chat - neither by click nor by URL"),!1}catch(t){return e.error(`Error opening chat: ${t.message}`),!1}}async generateResponseForCurrentChat(){if(!this.currentChatId)return e.error("No active chat to generate response"),s("No active chat detected. Please select a chat first.","error"),!1;try{e.debug("Generate Response button clicked - processing current chat"),await this.extractCurrentChatData();const t=this.chatHistory.get(this.currentChatId);if(!t||!t.messages||0===t.messages.length)return e.error("Could not extract chat data"),s("Could not extract chat data. Please try again.","error"),!1;const n={chatId:this.currentChatId,role:t.isSeller?"seller":"buyer",messages:t.messages,productDetails:t.productDetails};return await this.handleResponse(n),!0}catch(t){return e.error(`Error generating response: ${t.message}`),s(`Error generating response: ${t.message}`,"error"),!1}}async extractCurrentChatData(){if(!this.currentChatId)return e.error("No active chat to extract data"),{success:!1,error:"No active chat"};e.log(`Extracting data from chat ${this.currentChatId}`);try{const n=await t.waitForElement(CONFIG.selectors.activeChat.container),o=this.determineIfSeller(n);e.log("Role in chat: "+(o?"seller":"buyer"));let a=null;const i=productExtractor.extractProductIdFromCurrentChat(),r=this.extractProductLink(n);i&&(e.log(`Product ID found: ${i}`),e.debug(`Product link found: ${r}`),a=await productExtractor.getProductDetails(i,r));const s=await t.waitForElement(CONFIG.selectors.activeChat.messageWrapper),l=t.findElement(CONFIG.selectors.activeChat.scrollbar,s)||s;await t.scrollToTop(l),l.scrollTop=l.scrollHeight;const c=await this.extractChatHistory(s);e.log(`Extracted ${c.length} messages from chat`);const d={messages:c,productDetails:a,isSeller:o,lastUpdated:new Date};return this.chatHistory.set(this.currentChatId,d),{success:!0,chatData:d}}catch(t){return e.error(`Error extracting chat data: ${t.message}`),{success:!1,error:t}}}async processCurrentChat(t=!1){if(null==t&&(t="auto"===window.CONFIG?.operationMode,e.debug("Auto-respond not specified, using global setting: "+(t?"AUTO":"MANUAL"))),t)try{e.debug("AUTO mode detected - Preventively clearing input field");const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(t){"true"===t.getAttribute("contenteditable")?(t.innerHTML="",t.textContent=""):t.value="";const e=new Event("input",{bubbles:!0});t.dispatchEvent(e)}}catch(t){e.error(`Error in preventive cleaning: ${t.message}`)}const n=await this.extractCurrentChatData();if(!n.success)return e.error("Failed to extract chat data during processCurrentChat."),!1;if(t){e.debug(`Automatic response enabled for chat ${this.currentChatId} (operationMode: ${window.CONFIG?.operationMode})`);const t=n.chatData;if(!t||!t.messages||0===t.messages.length)return e.warn("No messages found in extracted data, cannot auto-respond."),!0;const o={chatId:this.currentChatId,role:t.isSeller?"seller":"buyer",messages:t.messages,productDetails:t.productDetails};try{return e.log(`Generating automatic response as ${o.role} for chat ${this.currentChatId}`),await this.handleResponse(o),e.log("Automatic response generated and sent successfully"),!0}catch(t){return e.error(`Error during automatic response generation: ${t.message}`),!1}}else e.debug(`Automatic response disabled for chat ${this.currentChatId}. Only data was extracted.`);return!0}extractProductLink(e){const n=t.findElement(CONFIG.selectors.activeChat.productLink,e);return n?.href||null}getAudioTranscription(t){if(!t||!CONFIG.audioTranscription.enabled)return null;if("[Audio URL will be detected by Performance API]"===t)return null;if(!window.audioTranscriber)return e.debug(`Audio transcriber not available for URL: ${t}`),null;try{const n=window.audioTranscriber.getTranscription(t);if(n)return e.debug(`Transcription found for audio: ${t.substring(0,50)}...`),n}catch(t){e.warn(`Error accessing audio transcription: ${t.message}`)}return null}async extractChatHistory(n){if(this.isProcessingChat)return e.warn("Chat history extraction already in progress. Skipping."),[];if(!n)return e.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,e.debug("Starting chat history extraction with improved selectors...");const o=[];let a=[],i=null;try{if(e.debug(`Finding message rows using selector: ${CONFIG.selectors.activeChat.messageRow}`),a=t.findAllElements(CONFIG.selectors.activeChat.messageRow,n),e.debug(`Found ${a.length} message row elements`),0===a.length){e.warn("Main message row selector failed. Trying fallback selectors...");const t=n.querySelectorAll('div[dir="auto"][role="none"]');if(!(t.length>0))throw new Error("No message elements found with main or fallback selectors");a=Array.from(t),e.debug(`Fallback found ${a.length} potential message elements`)}for(let n=0;n<a.length;n++){const r=a[n],s=r,l=s.outerHTML;if(l===i){e.debug(`Message #${n}: Duplicate row skipped`);continue}i=l;const c=t.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],r)||r,d={id:`msg_${this.currentChatId}_${n}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}}};try{d.sentByUs=this.isMessageSentByUs(s);const e=t.findElement(CONFIG.selectors.activeChat.messageContent,c);let n="";e&&(n=(e.innerText||e.textContent||"").trim(),n=n.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^Sent \d+d ago:\s*/i,"").trim(),n=n.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const a=this.isSystemMessage(n),i=this.isDividerElement(r);!n||a||i||(d.content.text=n,d.content.type="text");const l=t.findElement(CONFIG.selectors.activeChat.messageTimestamp,s);let u=null;l&&(u=l.getAttribute("data-tooltip-content")||l.getAttribute("aria-label")||l.getAttribute("title")||l.textContent.trim(),this.isValidTimestamp(u)?d.timestamp=u:d.timestamp=null),this.detectAndAddImageContent(c,d),this.detectAndAddAudioContent(c,d),this.detectAndAddVideoContent(c,d),this.detectAndAddFileContent(c,d),this.detectAndAddLocationContent(c,d),this.detectAndAddGifContent(c,d),"unknown"===d.content.type&&(d.content.text?d.content.type="text":d.content.media.images.length>0?d.content.type="image":d.content.media.audio?d.content.type="audio":d.content.media.video?d.content.type="video":d.content.media.files.length>0?d.content.type="file":d.content.media.location?d.content.type="location":d.content.media.gif&&(d.content.type="gif")),"unknown"===d.content.type||a||i||o.push(d)}catch(t){e.error(`Error processing message element #${n}:`,{},t)}}this.lastProcessedMessageCount=o.length,e.log(`Extraction completed: ${o.length} messages found`)}catch(t){e.error("Error during chat history extraction:",{},t)}finally{this.isProcessingChat=!1}return o}isValidTimestamp(e){if(!e||"string"!=typeof e)return!1;const t=e.trim();if([/^\d{1,2}:\d{2}$/,/^[a-záéíóúüñ\s]+$/i,/^(Play|Reproducir|Pause|Pausar)$/i,/^Message replied to:/i,/^Message:/i].some((e=>e.test(t))))return!1;return[/\d{1,2}:\d{2}\s*(AM|PM)/i,/\d{1,2}\/\d{1,2}\/\d{2,4}/,/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)/i,/(Today|Yesterday|Hoy|Ayer)/i,/minutes? ago|hours? ago|minutes?|hours?/i,/sent at \d{1,2}:\d{2}\s*(AM|PM)?/i,/sent at \d{1,2}:\d{2}/i].some((e=>e.test(t)))}detectAndAddImageContent(t,n){try{const e=Array.isArray(CONFIG.selectors.activeChat.messageImageElement)?CONFIG.selectors.activeChat.messageImageElement.join(", "):CONFIG.selectors.activeChat.messageImageElement,o=t.querySelectorAll(e);if(o.length>0){const e=Array.from(o).filter((e=>{const t=e.src||"";return t&&!t.startsWith("data:")&&(e.width>30||!e.width)&&(e.height>30||!e.height)&&!t.includes("/emoji.")&&!t.includes("/avatar/")}));e.length>0&&(n.content.imageUrls=e.map((e=>e.src)),n.content.media.images=e.map((e=>({url:e.src,alt:e.alt||"",width:e.width||0,height:e.height||0}))),"unknown"===n.content.type&&(n.content.type="image"))}const a=t.querySelectorAll('div[style*="background-image"]');if(a.length>0)for(const e of a){const t=(e.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(t&&t[1]&&!t[1].startsWith("data:")){const o=t[1];n.content.imageUrls.includes(o)||(n.content.imageUrls.push(o),n.content.media.images.push({url:o,alt:"Background Image",width:e.clientWidth||0,height:e.clientHeight||0}),"unknown"===n.content.type&&(n.content.type="image"))}}}catch(t){e.error(`Error detecting images: ${t.message}`,{},t)}}detectAndAddAudioContent(t,n){try{const e=Array.isArray(CONFIG.selectors.activeChat.messageAudioPlayButton)?CONFIG.selectors.activeChat.messageAudioPlayButton.join(", "):CONFIG.selectors.activeChat.messageAudioPlayButton,o=t.querySelector(e);if(o){const e=o.getAttribute("aria-label")||"";if(e.toLowerCase().includes("video"))return;const a=this.extractAudioDuration(t)||"",i=this.extractAudioUrl(t)||null;if(n.content.hasAudio=!0,n.content.audioUrl=i,n.content.media.audio={exists:!0,url:i,duration:a,label:e},"unknown"===n.content.type&&(n.content.type="audio"),i&&"function"==typeof this.getAudioTranscription){const e=this.getAudioTranscription(i);n.content.transcribedAudio=e||"[Audio Transcription Pending]"}}else{const e=t.querySelector("audio[src]");if(e){const t=e.src;if(n.content.hasAudio=!0,n.content.audioUrl=t,n.content.media.audio={exists:!0,url:t,duration:e.duration?`${Math.round(e.duration)}s`:"",label:"Audio message"},"unknown"===n.content.type&&(n.content.type="audio"),"function"==typeof this.getAudioTranscription){const e=this.getAudioTranscription(t);n.content.transcribedAudio=e||"[Audio Transcription Pending]"}}}}catch(t){e.error(`Error detecting audio: ${t.message}`,{},t)}}extractAudioDuration(t){try{const e=['span[style*="color: rgba"]',"span.x193iq5w",'div[dir="auto"] > span'];for(const n of e){const e=t.querySelectorAll(n);for(const t of e){const e=t.textContent.trim();if(/^\d{1,2}:\d{2}$/.test(e))return e}}return null}catch(t){return e.debug(`Error extracting audio duration: ${t.message}`),null}}extractAudioUrl(t){try{const e=t.querySelector("audio[src]");if(e&&e.src)return e.src;const n=t.querySelector('a[href*=".mp3"], a[href*=".m4a"], a[href*=".wav"], a[href*=".ogg"]');return n&&n.href?n.href:null}catch(t){return e.debug(`Error extracting audio URL: ${t.message}`),null}}detectAndAddVideoContent(t,n){try{const e=t.querySelector('video, a[href*="video_redirect"]');if(e){if("VIDEO"===e.tagName){const t={exists:!0,url:e.src||null,type:"video",thumbnail:this.extractVideoThumbnail(e)||null,duration:e.duration?`${Math.round(e.duration)}s`:null};n.content.media.video=t,"unknown"===n.content.type&&(n.content.type="video")}else if("A"===e.tagName&&e.href){const t={exists:!0,url:e.href,type:"video_link",thumbnail:null,duration:null};n.content.media.video=t,"unknown"===n.content.type&&(n.content.type="video")}}else{const e=Array.isArray(CONFIG.selectors.activeChat.messageVideoElement)?CONFIG.selectors.activeChat.messageVideoElement.join(", "):CONFIG.selectors.activeChat.messageVideoElement,o=t.querySelector(e);if(o){const e=o.getAttribute("aria-label")||"Video Player",t={exists:!0,url:null,type:o.style.backgroundImage||o.querySelector('div[style*="background-image"]')?"video_thumbnail":"video_player",thumbnail:this.extractBackgroundImage(o),label:e};n.content.media.video=t,"unknown"===n.content.type&&(n.content.type="video")}}}catch(t){e.error(`Error detecting video: ${t.message}`,{},t)}}extractBackgroundImage(t){try{const e=(t.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(e&&e[1])return e[1];const n=t.querySelector('div[style*="background-image"]');if(n){const e=(n.getAttribute("style")||"").match(/background-image:\s*url\(['"]?(.*?)['"]?\)/i);if(e&&e[1])return e[1]}return null}catch(t){return e.debug(`Error extracting background image: ${t.message}`),null}}extractVideoThumbnail(t){try{if(t.poster)return t.poster;const e=t.querySelector('source[type^="video/"]');return e&&e.src?e.src.replace(/\.mp4$/,".jpg"):null}catch(t){return e.debug(`Error extracting video thumbnail: ${t.message}`),null}}detectAndAddFileContent(t,n){try{const e=Array.isArray(CONFIG.selectors.activeChat.messageFileElement)?CONFIG.selectors.activeChat.messageFileElement.join(", "):CONFIG.selectors.activeChat.messageFileElement,o=Array.from(t.querySelectorAll(e));if(o.length>0){const e=[];o.forEach((t=>{const n=t.href||null,o=this.extractFileName(t),a=this.detectFileType(t,o);(n||o)&&e.push({url:n,name:o,type:a})})),e.length>0&&(n.content.media.files=e,"unknown"===n.content.type&&(n.content.type="file"))}}catch(t){e.error(`Error detecting files: ${t.message}`,{},t)}}extractFileName(t){try{if(t.hasAttribute("download"))return t.getAttribute("download")||this.extractFileNameFromPath(t.href);const e=t.textContent?.trim();if(e&&e.includes(".")){const t=e.match(/[\w\s\-]+\.\w+/);if(t)return t[0]}if(t.hasAttribute("title"))return t.getAttribute("title");if(t.hasAttribute("aria-label")){const e=t.getAttribute("aria-label");if(e.includes("file")||e.includes("archivo")){const t=e.split(":");if(t.length>1)return t[1].trim()}return e}return t.href?this.extractFileNameFromPath(t.href):"Unnamed file"}catch(t){return e.debug(`Error extracting file name: ${t.message}`),"Unnamed file"}}extractFileNameFromPath(e){if(!e)return"Unnamed file";try{const t=new URL(e).pathname.split("/"),n=t[t.length-1].split("?")[0];return decodeURIComponent(n)||"Unnamed file"}catch(t){const n=e.match(/\/([^\/\?]+)(?:\?|$)/);return n?decodeURIComponent(n[1]):"Unnamed file"}}detectFileType(t,n){try{if(!n)return"unknown";const e=n.split(".").pop().toLowerCase();return{pdf:"pdf",doc:"document",docx:"document",odt:"document",rtf:"document",xls:"spreadsheet",xlsx:"spreadsheet",ods:"spreadsheet",ppt:"presentation",pptx:"presentation",odp:"presentation",txt:"text",zip:"archive",rar:"archive","7z":"archive",jpg:"image",jpeg:"image",png:"image",gif:"image",bmp:"image",mp3:"audio",wav:"audio",ogg:"audio",m4a:"audio",mp4:"video",avi:"video",mov:"video",wmv:"video"}[e]||"unknown"}catch(t){return e.debug(`Error detecting file type: ${t.message}`),"unknown"}}detectAndAddLocationContent(t,n){try{const e=Array.isArray(CONFIG.selectors.activeChat.messageLocationElement)?CONFIG.selectors.activeChat.messageLocationElement.join(", "):CONFIG.selectors.activeChat.messageLocationElement,o=t.querySelector(e);if(o){let e=null;if("A"===o.tagName&&o.href){const t=this.extractLocationLabel(o)||"Shared location",n=this.extractCoordinates(o.href);e={url:o.href,label:t,coordinates:n}}else{const t=this.extractLocationLabel(o)||"Shared location",n=o.querySelector('a[href*="maps"]'),a=n?n.href:null;e={url:a,label:t,coordinates:a?this.extractCoordinates(a):null}}e&&(n.content.media.location=e,"unknown"===n.content.type&&(n.content.type="location"))}}catch(t){e.error(`Error detecting location: ${t.message}`,{},t)}}extractLocationLabel(t){try{if(t.hasAttribute("aria-label"))return t.getAttribute("aria-label").replace(/location|ubicación|shared/i,"").trim();const e=t.textContent?.trim();return e&&!e.startsWith("http")?e:null}catch(t){return e.debug(`Error extracting location label: ${t.message}`),null}}extractCoordinates(t){if(!t)return null;try{if(t.includes("maps")){let e=t.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/i);if(e||(e=t.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/i)),e)return{latitude:parseFloat(e[1]),longitude:parseFloat(e[2])}}return null}catch(t){return e.debug(`Error extracting coordinates: ${t.message}`),null}}detectAndAddGifContent(t,n){try{const e=Array.isArray(CONFIG.selectors.activeChat.messageGifElement)?CONFIG.selectors.activeChat.messageGifElement.join(", "):CONFIG.selectors.activeChat.messageGifElement,o=t.querySelector(e);if(o){let e=null;if("IMG"===o.tagName){const n=o.src,a=n&&(n.includes("giphy.com")||n.includes("tenor.com")||n.endsWith(".gif"));e={url:n,type:!!t.querySelector('[data-testid="sticker"]')?"sticker":a?"gif":"animated_content",alt:o.alt||""}}else{const t=o.getAttribute("aria-label")||"GIF",n=o.querySelector("img");e={url:n?n.src:null,type:t.toLowerCase().includes("sticker")?"sticker":"gif",label:t}}e&&(n.content.media.gif=e,"unknown"===n.content.type&&(n.content.type="gif"))}}catch(t){e.error(`Error detecting GIF/sticker: ${t.message}`,{},t)}}isSystemMessage(t){if(!t)return!1;const n=[/^You sent an attachment\.$/i,/^You sent a photo\.$/i,/^You sent a video\.$/i,/^You sent a GIF\.$/i,/^You shared a location\.$/i,/^You set the nickname for .* to .*$/i,/^You changed the chat colors\.$/i,/^You named the group .*$/i,/^You added .* to the group\.$/i,/^You removed .* from the group\.$/i,/^.* left the group\.$/i,/^You missed a call from .*$/i,/^Missed call$/i,/^Enviaste un adjunto\.$/i,/^Enviaste una foto\.$/i,/^Enviaste un video\.$/i,/^Enviaste un GIF\.$/i,/^Compartiste una ubicación\.$/i,/^Cambiaste los colores del chat\.$/i,/^Llamada perdida$/i,/^Llamada perdida de .*$/i,/^Nombraste al grupo .*$/i,/^Agregaste a .* al grupo\.$/i,/^Eliminaste a .* del grupo\.$/i,/^.* salió del grupo\.$/i,/^Definiste el apodo de .* como .*$/i,/^.*? bumped their message:?/i].some((e=>e.test(t)));return n&&e.debug(`[isSystemMessage] System message detected: "${t.substring(0,30)}..."`),n}isDividerElement(t){try{const n=t.innerText||"";if(t.classList&&(t.classList.contains("x1e56ztr")||t.classList.contains("x78zum5")||t.classList.contains("xh8yej3"))){const n=t.querySelector('div[dir="auto"], span[dir="auto"]');if(!n||n.textContent.length<5)return e.debug(`[isDivider] Element with divider class and little/no text: ${t.className}`),!0}return/^(Today|Yesterday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday|Hoy|Ayer|Lunes|Martes|Miércoles|Jueves|Viernes|Sábado|Domingo)$/i.test(n)?(e.debug(`[isDivider] Element with day text: ${n}`),!0):/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(n)||/^\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)(\w*)(\s+\d{2,4})?$/i.test(n)||/^\d{1,2}\s+(Ene|Feb|Mar|Abr|May|Jun|Jul|Ago|Sep|Oct|Nov|Dic)(\w*)(\s+\d{2,4})?$/i.test(n)?(e.debug(`[isDivider] Element with date text: ${n}`),!0):("separator"===t.getAttribute("role")||"HR"===t.tagName||0===t.children.length&&"separator"===t.parentElement?.getAttribute("role"))&&(e.debug("[isDivider] Element with separator role/tag"),!0)}catch(t){return e.error(`Error in isDividerElement: ${t.message}`),!1}}extractMentions(t){try{const e=[];return t.querySelectorAll('a[href*="/user/"], span.xngnso2, span[data-hovercard]').forEach((t=>{const n=t.innerText.trim();let o=null;if(t.href){const e=t.href.match(/\/user\/(\d+)|\?id=(\d+)/);e&&(o=e[1]||e[2])}else if(t.getAttribute("data-hovercard")){const e=t.getAttribute("data-hovercard").match(/id=(\d+)/);e&&(o=e[1])}n&&e.push({name:n,id:o})})),e.length>0?e:null}catch(t){return e.debug(`Error extracting mentions: ${t.message}`),null}}enhanceMessageContext(t,n){try{const e=this.detectQuotedMessage(t);e&&(n.context={...n.context||{},...e},n.content.type="unknown"===n.content.type?"reply":`${n.content.type}_reply`);const o=this.extractMentions(t);o&&(n.context={...n.context||{},mentions:o});const a=this.detectReactions(t);a&&(n.context={...n.context||{},reactions:a});const i=this.detectProductMention(t);i&&(n.context={...n.context||{},productMention:i})}catch(t){e.debug(`Error enhancing message context: ${t.message}`)}}detectReactions(t){try{const e=t.querySelector('div.xq8finb, div.x6s0dn4.x78zum5.xl56j7k, div[role="toolbar"][aria-label*="reaction"]');if(!e)return null;const n=[];return e.querySelectorAll('img.emoji, span[aria-label*=":"], div[aria-label*="Reacted"]').forEach((e=>{let t="unknown",o="";if("IMG"===e.tagName)t="emoji",o=e.alt||e.getAttribute("aria-label")||"";else{const n=e.getAttribute("aria-label")||"";if(n.includes("Like"))t="like",o="👍";else if(n.includes("Love"))t="love",o="❤️";else if(n.match(/Reacted with/i)){t="emoji";const e=n.match(/Reacted with :([^:]+):/);o=e?e[1]:n.replace(/Reacted with\s*/i,"")}else o=n}o&&n.push({type:t,value:o})})),n.length>0?n:null}catch(t){return e.debug(`Error detecting reactions: ${t.message}`),null}}detectProductMention(t){try{const e=t.querySelector('a[href*="/marketplace/item/"]');if(!e)return null;const n=e.href;let o=null;const a=n.match(/\/marketplace\/item\/(\d+)/);a&&(o=a[1]);let i="",r="";const s=e.querySelector('span[dir="auto"], div[dir="auto"]');s&&(i=s.innerText.trim());const l=t.querySelector('a[href*="/marketplace/item/"] img, div.x1ey2m1c img');return l&&l.src&&(r=l.src),{type:"product",productId:o,productUrl:n,title:i,imageUrl:r}}catch(t){return e.debug(`Error detecting product mention: ${t.message}`),null}}detectSpecialSystemEvents(e){if(!e)return null;const t=[{pattern:/marked this item as (sold|pending|available)/i,type:"status_change",action:e=>e[1].toLowerCase()},{pattern:/changed the price from ([\d,\.]+) to ([\d,\.]+)/i,type:"price_change",action:e=>({oldPrice:e[1],newPrice:e[2]})},{pattern:/(canceled|completed) this sale/i,type:"sale_event",action:e=>e[1].toLowerCase()},{pattern:/requested more details about/i,type:"request",action:()=>"details_request"},{pattern:/marcó este artículo como (vendido|pendiente|disponible)/i,type:"status_change",action:e=>{const t=e[1].toLowerCase();return"vendido"===t?"sold":"pendiente"===t?"pending":"available"}}];for(const n of t){const t=e.match(n.pattern);if(t)return{type:n.type,action:n.action(t),originalText:e}}return null}async extractChatHistoryEnhanced(n){if(this.isProcessingChat)return e.warn("Chat history extraction already in progress. Skipping."),[];if(!n)return e.error("messagesWrapper element not provided to extractChatHistory."),[];this.isProcessingChat=!0,e.debug("Starting enhanced chat history extraction...");const o=[];let a=[],i=null;try{if(a=t.findAllElements(CONFIG.selectors.activeChat.messageRow,n),e.debug(`Found ${a.length} message row elements`),0===a.length){const e=n.querySelectorAll('div[dir="auto"][role="none"]');if(!(e.length>0))throw new Error("No message elements found with main or fallback selectors");a=Array.from(e)}const r=20,s=Math.ceil(a.length/r);for(let t=0;t<s;t++){const n=t*r,l=Math.min(n+r,a.length),c=a.slice(n,l);e.debug(`Processing batch ${t+1}/${s} (${c.length} messages)`);const d=await this.processBatchOfMessages(c,i,t);d.lastProcessed&&(i=d.lastProcessed),d.messages&&d.messages.length>0&&o.push(...d.messages),t<s-1&&await new Promise((e=>setTimeout(e,5)))}this.lastProcessedMessageCount=o.length,e.log(`Enhanced extraction completed: ${o.length} messages processed in ${s} batches`),this.buildMessageReferences(o)}catch(t){e.error("Error during enhanced chat history extraction:",{},t)}finally{this.isProcessingChat=!1}return o}async processBatchOfMessages(n,o,a){const i=[];let r=o;for(let o=0;o<n.length;o++){const s=n[o],l=s,c=l.outerHTML;if(c===r)continue;r=c;const d=t.findElement(["div.x1cy8zhl",'div[data-testid*="message-container"]','span.x1lliihq.x1plvlek > div[dir="auto"]'],s)||s,u={id:`msg_${this.currentChatId}_${100*a+o}`,timestamp:null,sentByUs:!1,content:{text:"",type:"unknown",imageUrls:[],audioUrl:null,transcribedAudio:null,media:{images:[],audio:null,video:null,files:[],location:null,gif:null}},context:{}};try{u.sentByUs=this.isMessageSentByUs(l);const e=t.findElement(CONFIG.selectors.activeChat.messageContent,d);let n="";e&&(n=(e.innerText||e.textContent||"").trim(),n=n.replace(/^(\d{1,2}\/\d{1,2}\/\d{2,4},\s*)?\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},\s+\d{4},\s*\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim(),n=n.replace(/^Sent \d+d ago:\s*/i,"").trim(),n=n.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}\s*(?:AM|PM)?\s*:\s*/i,"").trim());const o=this.isSystemMessage(n),a=this.isDividerElement(s);if(n&&!a)if(u.content.text=n,o){const e=this.detectSpecialSystemEvents(n);e?(u.content.type="system_event",u.context.systemEvent=e):u.content.type="system"}else u.content.type="text";this.enhanceMessageContext(d,u);const r=t.findElement(CONFIG.selectors.activeChat.messageTimestamp,l);if(r){const e=r.getAttribute("data-tooltip-content")||r.getAttribute("aria-label")||r.getAttribute("title")||r.textContent.trim();this.isValidTimestamp(e)&&(u.timestamp=e)}this.detectAndAddImageContent(d,u),this.detectAndAddAudioContent(d,u),this.detectAndAddVideoContent(d,u),this.detectAndAddFileContent(d,u),this.detectAndAddLocationContent(d,u),this.detectAndAddGifContent(d,u),"unknown"===u.content.type&&(u.content.text?u.content.type="text":u.content.media.images.length>0?u.content.type="image":u.content.media.audio?u.content.type="audio":u.content.media.video?u.content.type="video":u.content.media.files.length>0?u.content.type="file":u.content.media.location?u.content.type="location":u.content.media.gif&&(u.content.type="gif")),"unknown"===u.content.type||a||i.push(u)}catch(t){e.error(`Error processing message element in batch ${a}, item ${o}:`,{},t)}}return{messages:i,lastProcessed:r}}buildMessageReferences(t){if(t&&0!==t.length)try{const n=new Map;for(let e=0;e<t.length;e++){const o=t[e];if(o.content.text){const t=o.content.text.substring(0,50).toLowerCase();n.has(t)||n.set(t,[]),n.get(t).push({index:e,id:o.id})}}for(let e=0;e<t.length;e++){const o=t[e];if(o.context&&"reply"===o.context.type&&o.context.quotedText){const a=o.context.quotedText.substring(0,50).toLowerCase();if(n.has(a)){const i=n.get(a).filter((t=>t.index<e));if(i.length>0){const e=i.reverse()[0];o.context.referencesMessageId=e.id;const n=t[e.index];n&&(n.context=n.context||{},n.context.referencedBy=n.context.referencedBy||[],n.context.referencedBy.push(o.id))}}}}e.debug(`Message references built for ${t.length} messages`)}catch(t){e.error("Error building message references:",{},t)}}determineIfSeller(t){try{for(const n of CONFIG.selectors.activeChat.sellerIndicators)if(n.includes(":contains")){const o=n.match(/:contains\("(.+?)"\)/)[1];if(Array.from(t.querySelectorAll("*")).filter((e=>e.textContent&&e.textContent.includes(o))).length>0)return e.debug(`Seller indicator found: ${o}`),!0}else{if(t.querySelectorAll(n).length>0)return e.debug(`Seller indicator found: ${n}`),!0}for(const n of CONFIG.selectors.activeChat.buyerIndicators)if(n.includes(":contains")){const o=n.match(/:contains\("(.+?)"\)/)[1];if(Array.from(t.querySelectorAll("*")).filter((e=>e.textContent&&e.textContent.includes(o))).length>0)return e.debug(`Buyer indicator found: ${o}`),!1}else{if(t.querySelectorAll(n).length>0)return e.debug(`Buyer indicator found: ${n}`),!1}e.debug("No definitive role indicators found, using alternative heuristic");return!!t.querySelector('a[href*="/marketplace/item/"]')&&(e.debug("Product link found, likely a buyer"),!1)}catch(t){return e.error(`Error determining seller/buyer role: ${t.message}`,{},t),!1}}isMessageSentByUs(n){const o="row"===n?.getAttribute("role")?n:n?.closest('div[role="row"]');if(!o)return e.debug("[isMessageSentByUs] Could not find the div[role='row'] container. Assuming foreign message."),!1;try{if(o.classList.contains("x1ja2u2z"))return e.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1ja2u2z'. It's own."),!0;if(o.classList.contains("x1yc453h"))return e.debug("[isMessageSentByUs] CLASS INDICATOR: Row has 'x1yc453h'. It's foreign."),!1;e.debug("[isMessageSentByUs] CLASS INDICATOR: No conclusive class detected in the row.");const n=o.firstElementChild;if("gridcell"===n?.getAttribute("role")&&"messages_table"===n.getAttribute("data-scope"))return e.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell has data-scope='messages_table'. It's own."),!0;e.debug("[isMessageSentByUs] GRIDCELL INDICATOR: First gridcell does not have data-scope='messages_table'.");try{const t=window.getComputedStyle(o).getPropertyValue("justify-content");if("flex-end"===t)return e.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-end'. It's own."),!0;if("flex-start"===t)return e.debug("[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is 'flex-start'. It's foreign."),!1;e.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: justify-content is '${t}'. Not conclusive.`)}catch(t){e.debug(`[isMessageSentByUs] ALIGNMENT INDICATOR: Error getting style: ${t.message}`)}if(Array.from(o.querySelectorAll("[aria-label]")).some((e=>{const t=e.getAttribute("aria-label");return t&&/you sent|enviaste/i.test(t)})))return e.debug("[isMessageSentByUs] ARIA INDICATOR: Found 'you sent' in aria-label. It's own."),!0;e.debug("[isMessageSentByUs] ARIA INDICATOR: No sending text found in aria-label.");if(t.findElement(CONFIG.selectors.activeChat.senderAvatar,o))return e.debug("[isMessageSentByUs] AVATAR INDICATOR: Avatar found in the row. It's foreign."),!1;e.debug("[isMessageSentByUs] AVATAR INDICATOR: No avatar found in the row. Could be own.");const a=o.querySelector("h5 > span");return a&&/you sent|enviaste/i.test(a.textContent||"")?(e.debug(`[isMessageSentByUs] TEXTUAL INDICATOR (H5): Found '${a.textContent.trim()}'. It's own.`),!0):(e.warn("[isMessageSentByUs] Could not determine the sender with certainty after all checks. Assuming foreign message."),!1)}catch(t){return e.error(`[isMessageSentByUs] General error processing the row: ${t.message}`,{html:o.outerHTML.substring(0,200)},t),!1}}async handleResponse(t){try{if(e.log("Generating response for chat..."),!t||!t.messages||0===t.messages.length)throw new Error("Invalid chat context or no messages");const n="seller"===t.role?"seller":"buyer";e.log(`Role in the conversation: ${n}, total messages: ${t.messages.length}`),this.logAssistantContext(t);const o=window.CONFIG?.operationMode||"manual";e.log(`Configured response mode: ${o}`),window.openaiManager&&"function"==typeof window.openaiManager.verifyServiceState&&window.openaiManager.verifyServiceState();const a="object"==typeof window.openaiManager&&"function"==typeof window.openaiManager.generateResponse&&(window.openaiManager.isInitialized||window.openaiManager.apiKey),i="object"==typeof window.assistantManager&&"function"==typeof window.assistantManager.generateResponse;if(e.debug(`Available services: Assistant=${i}, OpenAI=${a}`),e.debug(`openaiManager exists: ${!!window.openaiManager}`),window.openaiManager&&(e.debug(`openaiManager.isInitialized: ${window.openaiManager.isInitialized}`),e.debug(`openaiManager.isReady: ${"function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():"method missing"}`)),i){e.log("Using the OpenAI Assistant..."),s("Consulting the OpenAI Assistant...","info");const n=await window.assistantManager.generateResponse(t);if(n&&n.text){e.log(`Response generated by Assistant: ${n.text.substring(0,100)}...`);return window.CONFIG?.autoSend||!1?window.humanSimulator?(e.log("Sending response automatically..."),await window.humanSimulator.typeAndSendMessage(n.text),s("Response sent automatically","success")):(e.error("HumanSimulator not available for automatic sending"),this.insertResponseInInputField(n.text),s("Response inserted in the input field","info")):(this.insertResponseInInputField(n.text),s("Response inserted in the input field. Review and send when you are ready.","info")),await this.markChatAsRead(),n}throw new Error("Could not generate a valid response from the Assistant")}if(!a){e.log("No AI services available: showing help information");const o=`You are in a conversation as ${n}.\nProduct: ${t.productDetails?`${t.productDetails.title} (${t.productDetails.price})`:"No product information"}\nNo AI services configured. Please configure OpenAI or an Assistant in the options.`,a=o+"\n\n"+`Debug: openaiManager=${!!window.openaiManager}, `+`assistantManager=${!!window.assistantManager}, `+`config.AI.apiKey=${!!window.CONFIG?.AI?.apiKey}`;return s(o,"info"),e.debug(a),{text:o}}e.log("Generating response with OpenAI API..."),s("Generating response with OpenAI...","info"),window.openaiManager&&!window.openaiManager.isInitialized&&(e.debug("Attempting to reinitialize OpenAI Manager..."),"function"==typeof window.openaiManager.verifyServiceState?window.openaiManager.verifyServiceState():"function"==typeof window.openaiManager.initialize?window.openaiManager.initialize():"function"==typeof window.openaiManager.loadConfig&&window.openaiManager.loadConfig());try{const n=await window.openaiManager.generateResponse(t);if(n&&(n.text||"string"==typeof n)){const t=n.text||n;return e.log(`Response generated by OpenAI: ${t.substring(0,100)}...`),this.insertResponseInInputField(t),s("Response inserted in the input field. Review and send when you are ready.","info"),await this.markChatAsRead(),n}throw new Error("Could not generate a valid response from OpenAI")}catch(t){throw e.error(`Error generating response with OpenAI: ${t.message}`,{},t),t}}catch(t){throw e.error(`Error generating response: ${t.message}`,{},t),s(`Error generating response: ${t.message}`,"error"),t}}logAssistantContext(t){try{const e=JSON.parse(JSON.stringify(t)),n={timestamp:(new Date).toISOString(),chatId:this.currentChatId,totalMessages:e.messages?e.messages.length:0,role:e.role||"unknown",hasProductDetails:!!e.productDetails},o={text:0,image:0,audio:0,video:0,file:0,location:0,other:0};e.messages&&Array.isArray(e.messages)&&e.messages.forEach((e=>{const t=e.content?.type||"unknown";"text"===t?o.text++:"image"===t?o.image++:"audio"===t?o.audio++:"video"===t?o.video++:"file"===t?o.file++:"location"===t?o.location++:o.other++}));const a={metadata:n,contentStats:o,context:e};console.group("📤 Context sent to Assistant/OpenAI"),console.log("%cMetadata:","font-weight:bold; color:blue;",n),console.log("%cContent statistics:","font-weight:bold; color:green;",o),e.productDetails&&console.log("%cProduct details:","font-weight:bold; color:purple;",e.productDetails),e.messages&&Array.isArray(e.messages)&&(console.log("%cMessage history:","font-weight:bold; color:brown;"),e.messages.forEach(((e,t)=>{const n=e.sentByUs?"📤 ME":"📥 OTHER",o=e.timestamp?` (${e.timestamp})`:"";if(console.log(`${t+1}. ${n}${o}: ${e.content.text||`[${e.content.type.toUpperCase()}]`}`),e.content.media){const t=e.content.media;t.images&&t.images.length&&console.log(`   🖼️ ${t.images.length} images`),t.audio&&console.log("   🔊 Audio"+(t.audio.duration?` (${t.audio.duration})`:"")),t.video&&console.log("   🎬 Video"+(t.video.type?` (${t.video.type})`:"")),t.files&&t.files.length&&console.log(`   📎 ${t.files.length} files`),t.location&&console.log(`   📍 Location: ${t.location.label||""}`)}e.content.transcribedAudio&&console.log(`   🎤 Transcription: "${e.content.transcribedAudio}"`)}))),console.log("%cComplete object (expand):","font-weight:bold; color:darkblue;"),console.dir(a),console.log("%cComplete JSON (copy from console):","font-weight:bold; color:darkred;"),console.log(JSON.stringify(a,null,2)),console.groupEnd(),window.exportAssistantContext=()=>{const e=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`assistant_context_${this.currentChatId}_${(new Date).toISOString().replace(/[:.]/g,"_")}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),console.log("✅ Context JSON file downloaded. To export again at any time, run: exportAssistantContext()")},console.log("To export this context as a JSON file, run: exportAssistantContext()")}catch(t){e.error(`Error displaying assistant context: ${t.message}`,{},t)}}insertResponseInInputField(t){try{const n=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!n)return e.error("Message input field not found"),!1;const o="auto"===window.CONFIG?.operationMode;return e.debug("Operation mode when inserting response: "+(o?"AUTO":"MANUAL")),setTimeout((()=>{window.openaiManager&&"function"==typeof window.openaiManager.clearInputField&&(window.openaiManager.clearInputField(),e.debug("First cleaning phase completed with openaiManager")),this.forceCleanInputField(n),e.debug("Second direct cleaning phase completed");const a="true"===n.getAttribute("contenteditable")?(n.textContent||"").trim():(n.value||"").trim();if(a&&(e.warn(`Field is NOT empty after two cleaning attempts. Current content: "${a.substring(0,20)}..."`),this.emergencyCleanField(n),o))return e.debug("AUTO mode detected, applying additional pause to ensure complete cleaning"),setTimeout((()=>{this.insertTextAndPotentiallySend(n,t,o)}),500),!0;setTimeout((()=>{this.insertTextAndPotentiallySend(n,t,o)}),100)}),o?300:0),!0}catch(t){return e.error(`Error inserting response in input field: ${t.message}`),!1}}insertTextAndPotentiallySend(n,o,a){try{if(e.debug("Inserting text in input field"),t.insertTextIntoField(n,o),CONFIG.autoSendMessages&&a){e.debug("Automatic sending activated in AUTO mode, sending message...");const t=CONFIG.sendMessageDelay||2e3;e.debug(`Waiting ${t}ms before sending so that Facebook processes the text...`),setTimeout((()=>{const t="true"===n.getAttribute("contenteditable")?n.textContent||"":n.value||"";t.trim()===o.trim()?(e.debug("Text verified, sending message..."),this.sendMessage(!0)):e.warn(`The final text (${t.length} chars) does not match the expected one (${o.length} chars), aborting automatic sending`)}),t)}else CONFIG.autoSendMessages?a||e.debug(`MANUAL mode detected (operationMode: ${window.CONFIG?.operationMode})`):e.debug("Automatic sending deactivated (autoSendMessages: false)")}catch(t){e.error(`Error in insertTextAndPotentiallySend: ${t.message}`)}}sendMessage(n=!1){try{e.debug(`Initiating message sending attempt (${n?"after inserting text":"direct"})`);const o=[...CONFIG.selectors.activeChat.sendButton,'div[aria-label="Press enter to send"]','div[aria-label="Pulsa Intro para enviar"]','div[role="button"][tabindex="0"][style*="transform: translateY(0px)"]','div.xjbqb8w:not([style*="opacity: 0"])','div.x1i10hfl[role="button"]:not(.x1hc1fzr)'];e.debug(`Searching for send button with ${o.length} selectors...`);const a=t.findElement(o);if(a){const t=a.getBoundingClientRect(),n=window.getComputedStyle(a);t.width>0&&t.height>0&&"hidden"!==n.visibility&&"none"!==n.display&&"0"!==n.opacity?(e.debug(`Send button found and visible (${t.width}x${t.height}), clicking...`),setTimeout((()=>{try{return a.click(),e.log("Message sent by clicking on the button"),this.markChatAsRead(),!0}catch(t){e.warn(`Error when doing normal click: ${t.message}, trying simulated event...`);try{return a.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),e.log("Message sent using simulated click event"),this.markChatAsRead(),!0}catch(t){e.error(`Error simulating click event: ${t.message}`)}}}),100)):e.warn("Send button found but NOT visible/enabled. Using alternative method.")}else e.debug("Send button not found, trying with Enter key...");const i=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(i){if(e.debug("Simulating Enter key in the input field..."),t.simulateKeyPress(i,"Enter",13))return e.log("Message sent simulating Enter key with domUtils.simulateKeyPress"),this.markChatAsRead(),!0;i.focus();const o=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(i.dispatchEvent(o))return e.log("Message sent simulating Enter key with KeyboardEvent"),this.markChatAsRead(),!0;e.warn("The event was not sent correctly");try{if(document.execCommand("insertText",!1,"\n"))return e.log("Message sent using execCommand insertText"),this.markChatAsRead(),!0}catch(t){e.error(`Error using execCommand: ${t.message}`)}if(!n)return e.debug("First attempt failed, scheduling retry after 1 second..."),setTimeout((()=>this.sendMessage(!0)),1e3),!0}return e.error("Could not send the message after all attempts"),!1}catch(t){return e.error(`Error sending message: ${t.message}`,{},t),!1}}forceCleanInputField(t){try{if(!t)return;if("true"===t.getAttribute("contenteditable")){t.innerHTML="",t.textContent="";try{const e=window.getSelection(),n=document.createRange();n.selectNodeContents(t),e.removeAllRanges(),e.addRange(n),document.execCommand("delete",!1,null)}catch(t){e.debug(`Error using selection to clean: ${t.message}`)}}else t.value="";["input","change","keyup"].forEach((e=>{const n=new Event(e,{bubbles:!0});t.dispatchEvent(n)}))}catch(t){e.debug(`Error in forced cleaning: ${t.message}`)}}emergencyCleanField(t){try{if(t.parentNode){const n=t.cloneNode(!1);t.parentNode.replaceChild(n,t);[new KeyboardEvent("keydown",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"a",keyCode:65,bubbles:!0}),new KeyboardEvent("keyup",{key:"Control",keyCode:17,bubbles:!0}),new KeyboardEvent("keydown",{key:"Delete",keyCode:46,bubbles:!0}),new KeyboardEvent("keyup",{key:"Delete",keyCode:46,bubbles:!0})].forEach((e=>n.dispatchEvent(e))),e.debug("Emergency cleaning applied (node replacement)")}else e.warn("Could not apply emergency cleaning: the field has no parent node")}catch(t){e.debug(`Error in emergency cleaning: ${t.message}`)}}sendMessage(){try{const n=t.findElement(CONFIG.selectors.activeChat.sendButton);if(n)return e.debug("Send button found, clicking..."),n.click(),e.log("Message sent by clicking on the button"),!0;const o=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(o){if(e.debug("Simulating Enter key in the input field..."),t.simulateKeyPress(o,"Enter",13))return e.log("Message sent simulating Enter key with simulateKeyPress"),!0;o.focus();const n=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});if(o.dispatchEvent(n))return e.log("Message sent simulating Enter key"),!0;e.warn("The keydown event was not processed by the input field");try{return document.execCommand("insertText",!1,"\n"),e.log("Message sent using execCommand"),!0}catch(t){e.debug(`execCommand failed: ${t.message}`)}}return e.error("Could not send the message - send button or input field not found"),!1}catch(t){return e.error(`Error sending message: ${t.message}`,{},t),!1}}async processChatAndAutoRespond(t){try{e.log(`Extracting data from chat ${t}`);if(!("auto"===window.CONFIG?.operationMode))return e.debug(`Auto-response deactivated for chat ${t}. The current mode is: ${window.CONFIG?.operationMode}`),!1;e.log(`Automatic mode activated (operationMode: ${window.CONFIG?.operationMode}), processing automatic response...`);const n=await this.extractChatData(t);if(!n.success)return e.error(`Error extracting chat data for automatic response: ${n.error||"Unknown error"}`),!1;if(e.debug(`AUTO mode activated (${window.CONFIG?.operationMode}), processing automatic response`),!window.responseManager)return e.error("responseManager not found to process automatic response"),!1;if(!window.openaiManager)return e.error("openaiManager not found to process automatic response"),!1;if(!("function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.apiKey&&window.openaiManager.isInitialized))return e.error("OpenAI Manager is not ready to process automatic response"),!1;const o=await window.responseManager.processAutoResponse(t,n.chatData);return e.log("Result of processAutoResponse: "+(o?"success":"failed")),o}catch(t){return e.error(`Error processing chat for automatic response: ${t.message}`,{},t),s(`Error processing automatic response: ${t.message}`,"error"),!1}}async markChatAsRead(n=null){const o=n||this.currentChatId;if(!o)return e.error("No chat ID to mark as read"),!1;e.log(`Attempting to mark chat as read: ${o}`);try{const n=['div[aria-label="Marcar como leído"]','div[aria-label="Mark as read"]','div[aria-label*="read"][role="button"]','div.xuk3077[role="row"] div[aria-label*="unread"]','div.x78zum5[role="row"] div.xzg4506:not(:empty)','div[role="grid"] div[role="row"] div.xzg4506:not(:empty)'];let a=null;if(document.querySelector(`[data-thread-id="${o}"]`)||document.querySelector(`[href*="${o}"]`))for(const t of n)if(a=document.querySelector(t),a){e.debug(`Found unread message indicator with selector: ${t}`);break}if(a&&(e.debug('Simulating click on "mark as read" indicator'),this.simulateCompatibleMouseEvents(a),await new Promise((e=>setTimeout(e,1e3))),!document.querySelector(n.join(", "))))return e.log("Chat marked as read successfully (indicator disappeared)"),!0;try{const t=document.querySelectorAll(`[data-thread-id="${o}"], [href*="${o}"]`);for(const n of t){const t=Object.keys(n).find((e=>e.startsWith("__reactFiber$")));if(t){const o=n[t];if(o){const t=o.return?.stateNode;if(t&&"function"==typeof t.markRead)return e.debug("Found Facebook internal markRead function, attempting to use"),t.markRead(),e.log("Chat marked as read using Facebook internal API"),!0}}}}catch(t){e.debug(`Error attempting to use internal API: ${t.message}`)}if(this.currentChatId===o){const n=t.findElement(CONFIG.selectors.activeChat.container);if(n)return n.scrollTop=n.scrollHeight,await new Promise((e=>setTimeout(e,1500))),e.debug("Chat marked as read by scrolling to most recent messages"),!0}return e.warn(`Could not explicitly mark chat ${o} as read, but sending response may have done it automatically`),!0}catch(t){return e.error(`Error marking chat as read: ${t.message}`),!1}}};window.chatManager=x;const I={};function C(t){try{if(!t)return null;const e=[/marketplace\/item\/(\d+)/i,/marketplace\/item\.php\?id=(\d+)/i,/item\/(\d+)/i];for(const n of e){const e=t.match(n);if(e&&e[1])return e[1]}return null}catch(t){return e.error("Error extracting product ID from URL",t),null}}function E(t,n){e.debug("[ProductExtractor] Extracting basic data from DOM...");try{let o="Marketplace";const a=t.querySelectorAll("h1, span.x193iq5w");for(const e of a)if(e.textContent&&e.textContent.trim().length>0&&"Marketplace"!==e.textContent.trim()){o=e.textContent.trim();break}let i="";const r=t.querySelectorAll('.x193iq5w.xeuugli.x13faqbe.x1vvkbs, span[dir="auto"] > span');for(const e of r)if(e.textContent&&/\$|€|£|¥|₹|₽|¢|₩|₴|₦|₫|₱/i.test(e.textContent)){i=e.textContent.trim();break}let s="";const l=t.querySelectorAll('span[dir="auto"], div[data-ad-comet-preview="message"], div[data-contents="true"]');for(const e of l)if(e.textContent&&e.textContent.length>50&&!e.textContent.includes("Marketplace")){s=e.textContent.trim();break}if(!s||s.length<50){const e=t.querySelectorAll('div[role="row"] div[dir="auto"]');e.length>0&&(s=e[e.length-1].textContent.trim())}const c=[],d=t.querySelectorAll('img[src*="scontent"], img[src*="fbcdn"]');for(const e of d)if(e.src&&!e.src.includes("profile")&&!c.includes(e.src)&&(c.push(e.src),c.length>=5))break;const u={id:n,title:o,price:i,description:s,imageUrls:c,extractedFromDOM:!0,extractedFrom:"dom-fallback"};return e.debug("[ProductExtractor] Extracted basic product details from DOM",u),u}catch(t){return e.error("[ProductExtractor] Error extracting from DOM",t),{id:n,title:"Marketplace",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"dom-error"}}}function M(t,n){return new Promise(((o,a)=>(e.debug("[ProductExtractor] Using GM_xmlhttpRequest to fetch HTML for product:",{productId:t,url:n}),I[t]?(e.debug(`[ProductExtractor] Product ${t} found in cache`),console.log("--- CACHED PRODUCT DATA ---"),console.log(JSON.stringify(I[t],null,2)),console.log("--- END PRODUCT DATA ---"),o(I[t])):"function"!=typeof GM_xmlhttpRequest?a(new Error("GM_xmlhttpRequest not available")):void GM_xmlhttpRequest({method:"GET",url:n,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"},timeout:15e3,onload:function(i){if(i.status>=200&&i.status<300)try{const a=(new DOMParser).parseFromString(i.responseText,"text/html");let r=function(t,n){e.debug("[ProductExtractor] Extracting data from embedded JSON...");const o=t.querySelectorAll("script");let a=null,i=null;for(const t of o){const n=t.textContent;if(!n)continue;const o='"adp_MarketplacePDPContainerQueryRelayPreloader_',r='"adp_MarketplacePDPC2CMediaViewerWithImagesQueryRelayPreloader_';let s=-1,l=!1;if(a||(s=n.indexOf(o),-1!==s&&(l=!0)),-1!==s||i||(s=n.indexOf(r),-1!==s&&(l=!1)),-1!==s)try{const t=n.indexOf('"',s+1);if(-1===t)continue;const o=n.indexOf(",",t);if(-1===o)continue;const r=n.indexOf("{",o);if(-1===r)continue;let c=1,d=r+1;for(;d<n.length&&c>0;){const e=n[d];if("{"===e)c++;else if("}"===e)c--;else if('"'===e)for(d++;d<n.length;){if("\\"===n[d])d++;else if('"'===n[d])break;d++}d++}if(0===c){const t=d-1,o=n.substring(r,t+1);try{const t=JSON.parse(o);if(e.debug(`[ProductExtractor] Parsed JSON (${l?"Main":"Media"}).`),l?t?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?a=t:e.debug("[ProductExtractor] Incorrect main structure."):t?.__bbox?.result?.data?.viewer?.marketplace_product_details_page?.target?.listing_photos?i=t:e.debug("[ProductExtractor] Incorrect media structure."),a&&i)break}catch(t){e.warn(`[ProductExtractor] Error parsing JSON (${l?"Main":"Media"}):`,t)}}}catch(t){e.error(`[ProductExtractor] Error processing script (${l?"Main":"Media"}):`,t)}}if(a)try{const t=a.__bbox.result.data.viewer.marketplace_product_details_page.target,o=t.marketplace_listing_seller,r=t.location?.reverse_geocode_detailed;let s=[];if(i)try{const e=i.__bbox.result.data.viewer.marketplace_product_details_page.target.listing_photos;e&&Array.isArray(e)&&(s=e.map((e=>e?.image?.uri)).filter(Boolean))}catch(t){e.warn("[ProductExtractor] Error extracting images from media JSON:",t)}const l=t.primary_listing_photo?.listing_image?.uri;l&&!s.includes(l)&&s.unshift(l);let c=t.formatted_price?.text||"";const d=t.listing_price?.amount||"",u=t.listing_price?.currency||"";!c&&d&&(c="COP"===u?`$${parseInt(d).toLocaleString("es-CO")} COP`:"USD"===u?`$${parseInt(d).toLocaleString("en-US")}`:"EUR"===u?`€${parseInt(d).toLocaleString("de-DE")}`:`${u} ${parseInt(d).toLocaleString()}`,e.debug(`[ProductExtractor] Manually formatted price: ${c}`));const g={source:"inline_json",title:t.marketplace_listing_title||"",description:t.redacted_description?.text||"",price:c,currency:t.listing_price?.currency||"",amount:t.listing_price?.amount||"",url:t.story?.url||n,listingId:t.id||"",image:s.length>0?s[0]:"",imageUrls:s,sellerName:o?.name||"",sellerId:o?.id||"",sellerProfilePic:o?.profile_picture?.uri||"",categoryName:t.marketplace_listing_category_name||"",isSold:t.is_sold||!1,isLive:t.is_live||!1,city:r?.city||"",state:r?.state||"",postalCode:r?.postal_code||"",extractedFrom:"inline_json"};return e.debug("[ProductExtractor] Extraction completed from embedded JSON."),g}catch(t){e.error("[ProductExtractor] Error processing main JSON data:",t)}return null}(a,n);r||(e.warn("[ProductExtractor] Inline JSON extraction failed for "+t+", trying DOM extraction fallback"),r=E(a,t)),I[t]=r,e.debug(`[ProductExtractor] Product ${t} cached`),console.log("--- EXTRACTED PRODUCT DATA ---"),console.log(JSON.stringify(r,null,2)),console.log("--- END PRODUCT DATA ---"),o(r)}catch(n){e.error("[ProductExtractor] Error parsing product HTML",n);try{const e=E((new DOMParser).parseFromString(i.responseText,"text/html"),t);I[t]=e,console.log("--- PRODUCT DATA (FALLBACK) ---"),console.log(JSON.stringify(e,null,2)),console.log("--- END PRODUCT DATA ---"),o(e)}catch(e){a(e)}}else a(new Error(`HTTP Error: ${i.status}`))},onerror:function(n){e.error("[ProductExtractor] GM_xmlhttpRequest network error for product "+t,{error:JSON.stringify(n)}),a(n)},ontimeout:function(){a(new Error("Request timeout"))}}))))}!function(){try{const t=n.get("PRODUCT_CACHE",{});Object.assign(I,t),e.debug(`Loaded ${Object.keys(I).length} cached products from storage`)}catch(t){e.error("Error loading product cache",t)}}(),setInterval((()=>{try{n.set("PRODUCT_CACHE",I),e.debug(`Saved ${Object.keys(I).length} product cache entries to storage`)}catch(t){e.error("Error saving product cache",t)}}),6e4),window.productExtractor={getProductDetails:async function(t,n=null){try{if(!t)throw new Error("Product ID is required");if(I[t])return e.debug(`Retrieved product ${t} from cache`),I[t];n||(n=`https://www.facebook.com/marketplace/item/${t}/`),e.debug(`Fetching product details for ID: ${t} from URL: ${n}`);try{return await M(t,n)}catch(n){e.warn(`Failed to fetch product ${t} from URL: ${n.message}`),e.debug("Attempting DOM extraction fallback");const o=function(){e.debug("[ProductExtractor] Attempting DOM extraction fallback for product details");try{let t=null;const n=document.querySelector('a[href*="/marketplace/item/"]');if(n&&(t=C(n.href)),!t)return e.warn("[ProductExtractor] No product ID found in current page"),null;if(I[t])return console.log("--- CACHED PRODUCT DATA (DOM) ---"),console.log(JSON.stringify(I[t],null,2)),console.log("--- END PRODUCT DATA ---"),I[t];const o=E(document,t);return I[t]=o,e.debug(`[ProductExtractor] Product ${t} cached from DOM extraction`),console.log("--- PRODUCT DATA EXTRACTED FROM DOM ---"),console.log(JSON.stringify(o,null,2)),console.log("--- END PRODUCT DATA ---"),o}catch(t){return e.error("[ProductExtractor] Error extracting product details from current page",t),null}}()||{id:t,title:"Unknown Product",price:"",description:"",imageUrls:[],extractedFromDOM:!0,extractedFrom:"fallback-error"};return I[t]=o,"fallback-error"===o.extractedFrom&&(console.log("--- PRODUCT DATA (DEFAULT FALLBACK) ---"),console.log(JSON.stringify(o,null,2)),console.log("--- END PRODUCT DATA ---")),o}}catch(n){throw e.error(`Error getting product details for ${t}:`,n),n}},extractProductIdFromUrl:C,extractProductIdFromCurrentChat:function(){try{e.debug("Attempting to extract product ID from current chat");const t=document.querySelectorAll('a[href*="/marketplace/item/"]');if(0===t.length){const t=document.querySelectorAll('div[role="row"] div[dir="auto"] a');for(const n of t)if(n.href&&n.href.includes("/marketplace/item/")){const t=C(n.href);if(t)return e.debug(`Found product ID ${t} from text reference`),t}const n=document.querySelectorAll('iframe[src*="marketplace"], div[data-testid*="marketplace"]');for(const t of n){const n=t.src||t.getAttribute("data-testid");if(n){const t=n.match(/marketplace\/item\/(\d+)/i);if(t&&t[1])return e.debug(`Found product ID ${t[1]} from embedded element`),t[1]}}return e.debug("No product links found in current chat"),null}const n=t[0].href,o=C(n);return o?(e.debug(`Found product ID ${o} from link`),e.debug(`Product link found: ${n}`),o):(e.debug("Could not extract product ID from link"),null)}catch(t){return e.error("Error extracting product ID from current chat:",t),null}},inspectProduct:function(e){if(!e){const t=document.querySelector('a[href*="/marketplace/item/"]');t&&(e=C(t.href))}return e&&I[e]?(console.log("--- MANUAL PRODUCT INSPECTION ---"),console.log(JSON.stringify(I[e],null,2)),console.log("--- END INSPECTION ---"),I[e]):(console.error("No product with ID "+e+" in cache to inspect"),null)}};class T{constructor(){this.apiKey=n.get("FB_CHAT_MONITOR_OPENAI_KEY","")||"",this.model="gpt-4.1-mini",this.isInitialized=!1,this.activeThreads=new Map,this.threadTTL=18e5,this.assistants={seller:n.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),buyer:n.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),default:n.get("FB_CHAT_MONITOR_DEFAULT_ASSISTANT_ID","")},this.metrics={totalCalls:0,successfulCalls:0,failedCalls:0,totalTokensUsed:0,avgResponseTime:0,totalResponseTime:0}}initialize(t=null){try{return t&&(this.apiKey=t,CONFIG.AI.apiKey=t,n.set("FB_CHAT_MONITOR_OPENAI_KEY",t),CONFIG.audioTranscription&&(CONFIG.audioTranscription.apiKey=t)),this.model="gpt-4.1-mini",CONFIG.AI.model="gpt-4.1-mini",this.apiKey?(this.isInitialized=!0,e.debug("initialize(): API key present, setting isInitialized=true")):(this.isInitialized=!1,e.debug("initialize(): No API key, setting isInitialized=false")),e.log("OpenAI Manager initialized: "+(this.isInitialized?"SUCCESS":"FAILED - No API Key")),setInterval((()=>this.cleanupOldThreads()),9e5),this.schedulePeriodicChecks(),this.isInitialized}catch(t){return e.error(`Error initializing OpenAI Manager: ${t.message}`),!1}}loadConfig(t=null){return e.debug("loadConfig() called - redirecting to initialize()"),this.initialize(t)}async setApiKey(e){this.apiKey=e,CONFIG.AI.apiKey=e,n.set("FB_CHAT_MONITOR_OPENAI_KEY",e);const t=await this.validateApiKey();return this.isInitialized=t,t}verifyServiceState(){if(e.log("Verifying OpenAI service status..."),this!==window.openaiManager&&(e.warn("Incorrect openaiManager instance, correcting reference..."),Object.assign(this,window.openaiManager)),!this.isInitialized||!this.apiKey)if(e.debug("OpenAI Manager is not initialized, attempting to recover state"),CONFIG?.AI?.apiKey)e.debug("Using API key from CONFIG to initialize OpenAI Manager"),this.apiKey=CONFIG.AI.apiKey,this.isInitialized=!0;else{const t=n.get("FB_CHAT_MONITOR_OPENAI_KEY","");t&&(e.debug("Using API key from localStorage to initialize OpenAI Manager"),this.apiKey=t,this.isInitialized=!0)}const t=!!this.apiKey;return t&&!this.isInitialized&&(this.isInitialized=!0,e.debug("Correcting isInitialized to TRUE because we have apiKey")),e.log("Final status of OpenAI Manager: "+(t?"AVAILABLE":"NOT AVAILABLE")),e.debug(`Details: apiKey exists=${!!this.apiKey}, isInitialized=${this.isInitialized}, isReady()=${t}`),t}schedulePeriodicChecks(){setInterval((()=>this.verifyServiceState()),6e4),e.debug("Periodic service checks scheduled")}isReady(){return!!this.apiKey&&(this.isInitialized||(this.isInitialized=!0,e.debug("Auto-corrected isInitialized to true since API key exists")),!0)}async validateApiKey(){if(!this.apiKey)return!1;try{const t=await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"}});if(t.ok)return e.log("API key validated successfully"),!0;{const n=await t.json();return e.error(`API key validation failed: ${n.error?.message||"Unknown error"}`),!1}}catch(t){return e.error(`API key validation error: ${t.message}`),!1}}async generateResponse(t){if(!this.isReady()&&(this.verifyServiceState(),!this.isReady()))return e.warn("OpenAI Manager is not ready to generate responses"),{text:"I'm sorry, I can't generate a response because I don't have access to the OpenAI API. Please verify your API key in the configuration.",error:!0};const n=Date.now();this.metrics.totalCalls++;try{this.clearInputField();const o=this.getAssistantIdForRole(t.role);if(!o)throw new Error(`No assistant configured for role: ${t.role}`);e.debug(`Using assistant ${o} for role ${t.role}`);const a=await this.getOrCreateThread(t.chatId);await this.addMessageToThread(a.id,t);const i=await this.runAssistant(a.id,o);this.metrics.successfulCalls++;const r=Date.now()-n;return this.metrics.totalResponseTime+=r,this.metrics.avgResponseTime=this.metrics.totalResponseTime/this.metrics.successfulCalls,e.debug(`Response generated in ${r}ms`),i}catch(t){throw this.metrics.failedCalls++,e.error(`Error generating response: ${t.message}`),t}}clearInputField(){try{const t=document.querySelector(CONFIG.selectors.activeChat.messageInput);if(!t)return e.error("Message input field to clear not found"),!1;const n="true"===t.getAttribute("contenteditable"),o=n?(t.textContent||"").trim():(t.value||"").trim();if(!o)return e.debug("Field is already empty, no cleaning needed"),!0;e.debug(`Field has previous content (${o.length} chars): "${o.substring(0,30)}..."`);const a=document.activeElement;if(n){t.innerHTML="",t.textContent="",t.focus(),document.execCommand("selectAll",!1,null),document.execCommand("delete",!1,null);const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e),n.deleteFromDocument(),setTimeout((()=>{t.textContent="",t.innerHTML=""}),0)}else"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(t.value="",t.setAttribute("value",""));if(["input","change","keyup","keydown"].forEach((e=>{t.dispatchEvent(new Event(e,{bubbles:!0}))})),setTimeout((()=>{const o=n?(t.textContent||"").trim():(t.value||"").trim();if(o){e.warn(`Cleaning not effective, remaining content: "${o.substring(0,30)}..."`);try{if(n){t.innerHTML="";const e=t.parentNode;if(e){const n=t.cloneNode(!1);e.replaceChild(n,t),n.dispatchEvent(new Event("input",{bubbles:!0}))}}else"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||(Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(t,""),t.dispatchEvent(new Event("input",{bubbles:!0})))}catch(t){e.debug(`Error in emergency cleaning: ${t.message}`)}}else e.debug("Verification: Field clean after process")}),50),a!==t&&a)try{a.focus()}catch(e){}return e.debug("Aggressive cleaning of the input field completed"),!0}catch(t){return e.error(`Error in clearInputField: ${t.message}`,{},t),!1}}getAssistantIdForRole(t){let n=this.assistants[t];return n||(n=this.assistants.default,e.debug(`No assistant for role ${t}, using default assistant`)),n||("seller"===t&&CONFIG.AI?.assistants?.seller?.id?n=CONFIG.AI.assistants.seller.id:"buyer"===t&&CONFIG.AI?.assistants?.buyer?.id&&(n=CONFIG.AI.assistants.buyer.id)),n}async getOrCreateThread(t){const n=this.activeThreads.get(t);if(n&&Date.now()-n.lastUsed<this.threadTTL)return n.lastUsed=Date.now(),this.activeThreads.set(t,n),n;try{const n=await fetch("https://api.openai.com/v1/threads",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({})});if(!n.ok){const e=await n.json();throw new Error(e.error?.message||"Failed to create thread")}const o=await n.json();return this.activeThreads.set(t,{id:o.id,lastUsed:Date.now()}),e.debug(`Created new thread ${o.id} for chat ${t}`),o}catch(t){throw e.error(`Error creating thread: ${t.message}`),t}}async addMessageToThread(t,n){try{const o=this.prepareMessageContent(n),a=await fetch(`https://api.openai.com/v1/threads/${t}/messages`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({role:"user",content:o})});if(!a.ok){const e=await a.json();throw new Error(e.error?.message||"Failed to add message to thread")}return e.debug(`Added message to thread ${t}`),await a.json()}catch(t){throw e.error(`Error adding message to thread: ${t.message}`),t}}prepareMessageContent(t){const{role:n,messages:o,productDetails:a,analysis:i}=t,r=[{type:"text",text:JSON.stringify({role:n,product:a?{id:a.id,title:a.title,price:a.price,description:a.description,condition:a.condition,location:a.location,category:a.category,imageUrls:a.imageUrls||[]}:null,conversation:o.slice(-(CONFIG.AI.messageHistoryLimit||100)).map((e=>{if(!e||!e.content)return{fromUser:!e?.sentByUs,error:"Invalid message structure"};const t={fromUser:!e.sentByUs,timestamp:e.timestamp};return e.content.text&&(t.text=e.content.text),e.content.transcribedAudio&&"string"==typeof e.content.transcribedAudio&&!e.content.transcribedAudio.startsWith("[")?t.transcribedAudio=e.content.transcribedAudio:e.content.audioUrl&&(t.hasAudio=!0,"string"==typeof e.content.transcribedAudio&&e.content.transcribedAudio.startsWith("[")&&(t.audioStatus=e.content.transcribedAudio)),e.content.imageUrls&&Array.isArray(e.content.imageUrls)&&e.content.imageUrls.length>0&&(t.imageUrls=e.content.imageUrls),t})),analysis:i||null})}];return e.debug("[OpenAIManager] Prepared message content for API:",{textLength:r[0].text.length}),r}async runAssistant(t,n){try{const o=await fetch(`https://api.openai.com/v1/threads/${t}/runs`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"},body:JSON.stringify({assistant_id:n})});if(!o.ok){const e=await o.json();throw new Error(e.error?.message||"Failed to start run")}const a=await o.json();e.debug(`Started run ${a.id} on thread ${t}`);await this.pollRunUntilComplete(t,a.id);return await this.getAssistantResponseFromRun(t,a.id)}catch(t){throw e.error(`Error running assistant: ${t.message}`),t}}async pollRunUntilComplete(t,n){let o=0,a=null,i=1e3;const r=Date.now();for(;o<60&&Date.now()-r<3e4;){o++;const r=await fetch(`https://api.openai.com/v1/threads/${t}/runs/${n}`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!r.ok){const e=await r.json();throw new Error(e.error?.message||"Failed to check run status")}if(a=await r.json(),["completed","failed","cancelled","expired"].includes(a.status))break;e.debug(`Run ${n} status: ${a.status}, attempt ${o}`),await new Promise((e=>setTimeout(e,i))),i=Math.min(1.5*i,5e3)}if("completed"!==a.status)throw new Error(`Run failed with status: ${a.status}`);return a}async getAssistantResponseFromRun(t,n){try{const e=await fetch(`https://api.openai.com/v1/threads/${t}/messages`,{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to retrieve messages")}const n=(await e.json()).data.find((e=>"assistant"===e.role));if(!n)throw new Error("No assistant message found");if(n.content&&n.content.length>0){const e=n.content.find((e=>"text"===e.type));if(e)return e.text.value}throw new Error("No text content found in assistant message")}catch(t){throw e.error(`Error retrieving assistant response: ${t.message}`),t}}setAssistantForRole(t,o){if(!["seller","buyer","default"].includes(t))throw new Error(`Invalid role: ${t}`);this.assistants[t]=o,n.set(`FB_CHAT_MONITOR_${t.toUpperCase()}_ASSISTANT_ID`,o),e.log(`Set assistant ${o} for role ${t}`)}async createOrUpdateAssistant(e,t,n){if(!this.isInitialized)throw new Error("API key not initialized");let o=this.assistants[e];const a={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","OpenAI-Beta":"assistants=v2"};if(o){const e=await fetch(`https://api.openai.com/v1/assistants/${o}`,{method:"PATCH",headers:a,body:JSON.stringify({name:t,instructions:n})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to update assistant")}}else{const e=await fetch("https://api.openai.com/v1/assistants",{method:"POST",headers:a,body:JSON.stringify({name:t,instructions:n})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to create assistant")}o=(await e.json()).id}return this.assistants[e]=o,o}async listAssistants(){try{const e=await fetch("https://api.openai.com/v1/assistants?limit=100",{headers:{Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v2"}});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Failed to list assistants")}return(await e.json()).data}catch(t){throw e.error(`Error listing assistants: ${t.message}`),t}}cleanupOldThreads(){const t=Date.now();let n=0;for(const[e,o]of this.activeThreads.entries())t-o.lastUsed>this.threadTTL&&(this.activeThreads.delete(e),n++);n>0&&e.debug(`Cleaned up ${n} expired threads`)}getMetrics(){return{...this.metrics,activeThreads:this.activeThreads.size}}}const S=new T;window.openaiManager=S,console.log("[OpenAI Manager] Instance exposed globally as window.openaiManager"),window.openaiManager&&window.openaiManager.isReady||(console.warn("[OpenAI Manager] OpenAI Manager not available or missing necessary methods, reinstalling..."),window.openaiManager=S,"function"!=typeof window.openaiManager.initialize&&(console.error("[OpenAI Manager] CRITICAL ERROR! The initialize method is not available after reinstalling"),window.openaiManager.initialize=function(e=null){return S.initialize(e)}),"function"!=typeof window.openaiManager.isReady&&(window.openaiManager.isReady=function(){return!!window.openaiManager.apiKey}),"function"!=typeof window.openaiManager.verifyServiceState&&(window.openaiManager.verifyServiceState=function(){return S.verifyServiceState()})),CONFIG?.AI?.apiKey&&!window.openaiManager.apiKey&&(window.openaiManager.apiKey=CONFIG.AI.apiKey,window.openaiManager.isInitialized=!0),console.log("[OpenAI Manager] Status after global verification:",`apiKey=${!!window.openaiManager.apiKey}`,`isInitialized=${window.openaiManager.isInitialized}`,`isReady=${"function"==typeof window.openaiManager.isReady?window.openaiManager.isReady():"method not available"}`),window.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{window.openaiManager||(console.error("[OpenAI Manager] Error: openaiManager not detected in window after DOMContentLoaded. Reinstalling..."),window.openaiManager=S),window.openaiManager.isReady()&&"function"==typeof window.openaiManager.listAssistants&&(console.log("[OpenAI Manager] Starting automatic loading of assistants..."),window.openaiManager.listAssistants().then((e=>{console.log(`[OpenAI Manager] ${e.length} assistants found automatically`),window.updateAssistantsList&&window.updateAssistantsList(e)})).catch((e=>{console.warn("[OpenAI Manager] Error loading assistants automatically:",e.message)})))}),1e3)}));const O=new class{constructor(){this.initialized=!1}initialize(){this.initialized||(this.createStyles(),this.createPanel(),this.attachEvents(),this.initialized=!0,e.debug("Assistant Manager UI initialized"))}createStyles(){const e=document.createElement("style");e.textContent="\n          .assistant-manager-panel {\n            position: fixed;\n            right: 20px;\n            top: 60px;\n            width: 300px;\n            background: white;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n            overflow: hidden;\n            z-index: 9999;\n            font-family: Arial, sans-serif;\n            transition: all 0.3s ease;\n          }\n\n          .assistant-manager-header {\n            background: #1877f2;\n            color: white;\n            padding: 10px 15px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            cursor: pointer;\n          }\n\n          .assistant-manager-content {\n            padding: 15px;\n            max-height: 400px;\n            overflow-y: auto;\n          }\n\n          .assistant-manager-field {\n            margin-bottom: 15px;\n          }\n\n          .assistant-manager-field label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: bold;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field input,\n          .assistant-manager-field textarea {\n            width: 100%;\n            padding: 8px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-field textarea {\n            height: 80px;\n            resize: vertical;\n          }\n\n          .assistant-manager-tabs {\n            display: flex;\n            border-bottom: 1px solid #ddd;\n          }\n\n          .assistant-manager-tab {\n            padding: 8px 15px;\n            cursor: pointer;\n            border-bottom: 2px solid transparent;\n          }\n\n          .assistant-manager-tab.active {\n            border-bottom: 2px solid #1877f2;\n            font-weight: bold;\n          }\n\n          .assistant-manager-tab-content {\n            display: none;\n            padding-top: 10px;\n          }\n\n          .assistant-manager-tab-content.active {\n            display: block;\n          }\n\n          .assistant-manager-button {\n            background: #1877f2;\n            color: white;\n            border: none;\n            padding: 8px 15px;\n            border-radius: 4px;\n            cursor: pointer;\n            margin-top: 5px;\n          }\n\n          .assistant-manager-button:hover {\n            background: #166fe5;\n          }\n\n          .assistant-manager-status {\n            margin-top: 10px;\n            padding: 8px;\n            border-radius: 4px;\n            font-size: 14px;\n          }\n\n          .assistant-manager-status.success {\n            background: #e6f7e6;\n            color: #25a025;\n          }\n\n          .assistant-manager-status.error {\n            background: #ffebeb;\n            color: #e60000;\n          }\n\n          .assistant-manager-toggle {\n            position: fixed;\n            right: 20px;\n            top: 20px;\n            background: #1877f2;\n            color: white;\n            border: none;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n            z-index: 9999;\n            font-size: 20px;\n          }\n\n          .hidden {\n            display: none;\n          }\n        ",document.head.appendChild(e)}createPanel(){const e=document.createElement("button");e.className="assistant-manager-toggle",e.innerHTML="🤖",e.title="Manage Assistants",document.body.appendChild(e);const t=document.createElement("div");t.className="assistant-manager-panel hidden";const n=document.createElement("div");n.className="assistant-manager-header",n.innerHTML='<span>Assistant Management</span><span id="assistant-close">✕</span>',t.appendChild(n);const o=document.createElement("div");o.className="assistant-manager-content";const a=document.createElement("div");a.className="assistant-manager-field",a.innerHTML=`\n          <label for="openai-api-key">OpenAI API Key:</label>\n          <input type="password" id="openai-api-key" placeholder="sk-..." value="${CONFIG.AI.apiKey||""}">\n          <button id="save-api-key" class="assistant-manager-button">Save</button>\n        `,o.appendChild(a);const i=document.createElement("div");i.className="assistant-manager-tabs",i.innerHTML='\n          <div class="assistant-manager-tab active" data-tab="seller">Seller</div>\n          <div class="assistant-manager-tab" data-tab="buyer">Buyer</div>\n        ',o.appendChild(i);const r=document.createElement("div"),s=document.createElement("div");s.className="assistant-manager-tab-content active",s.id="tab-seller",s.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-name">Name:</label>\n            <input type="text" id="seller-assistant-name" value="${CONFIG.AI.assistants.seller.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="seller-assistant-instructions">Instructions:</label>\n            <textarea id="seller-assistant-instructions">${CONFIG.AI.assistants.seller.instructions||""}</textarea>\n          </div>\n          <button id="save-seller-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="seller-assistant-status" class="assistant-manager-status hidden"></div>\n        `,r.appendChild(s);const l=document.createElement("div");l.className="assistant-manager-tab-content",l.id="tab-buyer",l.innerHTML=`\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-name">Name:</label>\n            <input type="text" id="buyer-assistant-name" value="${CONFIG.AI.assistants.buyer.name||""}">\n          </div>\n          <div class="assistant-manager-field">\n            <label for="buyer-assistant-instructions">Instructions:</label>\n            <textarea id="buyer-assistant-instructions">${CONFIG.AI.assistants.buyer.instructions||""}</textarea>\n          </div>\n          <button id="save-buyer-assistant" class="assistant-manager-button">Save Assistant</button>\n          <div id="buyer-assistant-status" class="assistant-manager-status hidden"></div>\n        `,r.appendChild(l),o.appendChild(r),t.appendChild(o),document.body.appendChild(t),this.panel=t,this.toggleButton=e}attachEvents(){this.toggleButton.addEventListener("click",(()=>this.panel.classList.toggle("hidden"))),document.getElementById("assistant-close").addEventListener("click",(()=>this.panel.classList.add("hidden"))),document.querySelectorAll(".assistant-manager-tab").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".assistant-manager-tab").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".assistant-manager-tab-content").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.getElementById(`tab-${e.dataset.tab}`).classList.add("active")}))})),document.getElementById("save-api-key").addEventListener("click",(async()=>{const e=document.getElementById("openai-api-key").value.trim();if(e)try{CONFIG.AI.apiKey=e,localStorage.setItem("FB_CHAT_MONITOR_OPENAI_KEY",e);const t=this.openAIInitialized=S.initialize(e);this.showStatus(t?"success":"error",t?"API Key saved":"Invalid API Key")}catch(e){this.showStatus("error",`Error: ${e.message}`)}else this.showStatus("error","Please enter a valid API Key")})),document.getElementById("save-seller-assistant").addEventListener("click",(()=>this.saveAssistant("seller"))),document.getElementById("save-buyer-assistant").addEventListener("click",(()=>this.saveAssistant("buyer")))}async saveAssistant(e){const t=document.getElementById(`${e}-assistant-name`).value.trim(),n=document.getElementById(`${e}-assistant-instructions`).value.trim(),o=document.getElementById(`${e}-assistant-status`);if(t&&n)if(CONFIG.AI.apiKey){this.showStatus("info","Saving assistant...",o);try{const a=await S.createOrUpdateAssistant(e,t,n);CONFIG.AI.assistants[e]={id:a,name:t,instructions:n},localStorage.setItem(`FB_CHAT_MONITOR_${e.toUpperCase()}_ASSISTANT_ID`,a),this.showStatus("success",`Assistant "${t}" saved`,o)}catch(e){this.showStatus("error",`Error: ${e.message}`,o)}}else this.showStatus("error","Set API Key first",o);else this.showStatus("error","Complete all fields",o)}showStatus(e,t,n=null){const o=n||document.querySelector(".assistant-manager-status");o&&(o.textContent=t,o.className=`assistant-manager-status ${e}`,o.classList.remove("hidden"),setTimeout((()=>o.classList.add("hidden")),5e3))}};window.assistantManagerUI=O;const k={isControlPanelVisible:!1,activeTab:"dashboard",floatingButton:null,controlPanel:null,statusIndicator:null,floatingResponseButton:null};function _(){k.floatingButton=function(){const e=document.createElement("div");e.id="fb-chat-monitor-button",e.style.position="fixed",e.style.top="20px",e.style.right="60px",e.style.bottom="auto",e.style.left="auto",e.style.padding="10px 15px",e.style.backgroundColor="#4267B2",e.style.color="white",e.style.borderRadius="5px",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.style.cursor="pointer",e.style.zIndex="9999",e.style.display="flex",e.style.alignItems="center",e.style.transition="all 0.3s ease",e.style.fontFamily="Arial, sans-serif";const t=document.createElement("div");t.id="fb-chat-monitor-status-dot",t.style.width="10px",t.style.height="10px",t.style.backgroundColor="#4CAF50",t.style.borderRadius="50%",t.style.marginRight="8px",e.appendChild(t);const n=document.createElement("span");return n.textContent="FB Chat Monitor",e.appendChild(n),e.addEventListener("mouseover",(function(){this.style.backgroundColor="#365899"})),e.addEventListener("mouseout",(function(){this.style.backgroundColor="#4267B2"})),e.addEventListener("click",$),document.body.appendChild(e),k.statusIndicator=t,e}(),function(){const e="\n        .fb-chat-monitor-panel {\n          position: fixed;\n          bottom: 80px;\n          right: 20px;\n          width: 380px;\n          max-width: 90vw;\n          background-color: white;\n          border-radius: 8px;\n          box-shadow: 0 2px 20px rgba(0,0,0,0.2);\n          z-index: 9998;\n          font-family: Arial, sans-serif;\n          display: flex;\n          flex-direction: column;\n          max-height: calc(100vh - 100px);\n          transition: all 0.3s ease;\n          overflow: hidden;\n        }\n\n        .fb-chat-monitor-panel-header {\n          padding: 15px;\n          background-color: #4267B2;\n          color: white;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          border-radius: 8px 8px 0 0;\n        }\n\n        .fb-chat-monitor-panel-header h2 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n        }\n\n        .fb-chat-monitor-close {\n          background: none;\n          border: none;\n          color: white;\n          font-size: 20px;\n          cursor: pointer;\n          padding: 0;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 24px;\n          height: 24px;\n        }\n\n        .fb-chat-monitor-panel-tabs {\n          display: flex;\n          border-bottom: 1px solid #ddd;\n          background-color: #f5f5f5;\n        }\n\n        .fb-chat-monitor-tab {\n          padding: 10px 15px;\n          cursor: pointer;\n          position: relative;\n          flex: 1;\n          text-align: center;\n          color: #666;\n          font-size: 14px;\n          transition: all 0.2s ease;\n        }\n\n        .fb-chat-monitor-tab:hover {\n          background-color: rgba(66, 103, 178, 0.05);\n        }\n\n        .fb-chat-monitor-tab.active {\n          color: #4267B2;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-tab.active::after {\n          content: '';\n          position: absolute;\n          bottom: 0;\n          left: 0;\n          width: 100%;\n          height: 3px;\n          background-color: #4267B2;\n        }\n\n        .fb-chat-monitor-panel-content {\n          flex: 1;\n          overflow-y: auto;\n          padding: 15px;\n        }\n\n        .fb-chat-monitor-tab-content {\n          display: none;\n          animation: fadeIn 0.3s ease;\n        }\n\n        .fb-chat-monitor-tab-content.active {\n          display: block;\n        }\n\n        .fb-chat-monitor-status-section {\n          display: flex;\n          align-items: center;\n          margin-bottom: 15px;\n          padding-bottom: 10px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-status-indicator {\n          width: 12px;\n          height: 12px;\n          border-radius: 50%;\n          margin-right: 10px;\n        }\n\n        .fb-chat-monitor-status-text {\n          flex: 1;\n        }\n\n        .fb-chat-monitor-stats-grid {\n          display: grid;\n          grid-template-columns: repeat(2, 1fr);\n          gap: 10px;\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-stat-item {\n          background-color: #f9f9f9;\n          border-radius: 6px;\n          padding: 10px;\n          text-align: center;\n        }\n\n        .fb-chat-monitor-stat-value {\n          font-size: 18px;\n          font-weight: bold;\n          color: #4267B2;\n          margin-bottom: 5px;\n        }\n\n        .fb-chat-monitor-stat-label {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-form-group {\n          margin-bottom: 15px;\n        }\n\n        .fb-chat-monitor-form-group label {\n          display: block;\n          font-size: 14px;\n          margin-bottom: 5px;\n          color: #444;\n        }\n\n        .fb-chat-monitor-form-group input,\n        .fb-chat-monitor-form-group select {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid #ddd;\n          border-radius: 4px;\n          font-size: 14px;\n        }\n\n        .fb-chat-monitor-radio-group {\n          margin: 10px 0;\n        }\n\n        .fb-chat-monitor-radio-option {\n          display: flex;\n          align-items: center;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-radio-option input {\n          margin-right: 8px;\n          width: auto;\n        }\n\n        .fb-chat-monitor-radio-label {\n          display: flex;\n          flex-direction: column;\n        }\n\n        .fb-chat-monitor-radio-label span:first-child {\n          font-weight: 500;\n        }\n\n        .fb-chat-monitor-radio-label span:last-child {\n          font-size: 12px;\n          color: #666;\n        }\n\n        .fb-chat-monitor-button {\n          padding: 8px 12px;\n          background-color: #4267B2;\n          color: white;\n          border: none;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background-color 0.2s;\n          margin-right: 8px;\n          margin-bottom: 8px;\n        }\n\n        .fb-chat-monitor-button:hover {\n          background-color: #365899;\n        }\n\n        .fb-chat-monitor-button-secondary {\n          background-color: #eaeaea;\n          color: #333;\n        }\n\n        .fb-chat-monitor-button-secondary:hover {\n          background-color: #d5d5d5;\n        }\n\n        .fb-chat-monitor-button-danger {\n          background-color: #f44336;\n        }\n\n        .fb-chat-monitor-button-danger:hover {\n          background-color: #d32f2f;\n        }\n\n        .fb-chat-monitor-button-success {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-button-success:hover {\n          background-color: #388E3C;\n        }\n\n        .fb-chat-monitor-logs-container {\n          border: 1px solid #eee;\n          border-radius: 4px;\n          max-height: 200px;\n          overflow-y: auto;\n          font-size: 12px;\n          font-family: monospace;\n        }\n\n        .fb-chat-monitor-log-entry {\n          padding: 5px 8px;\n          border-bottom: 1px solid #f0f0f0;\n        }\n\n        .fb-chat-monitor-log-entry:last-child {\n          border-bottom: none;\n        }\n\n        .fb-chat-monitor-log-INFO {\n          color: #2196F3;\n        }\n\n        .fb-chat-monitor-log-ERROR {\n          color: #f44336;\n          font-weight: bold;\n        }\n\n        .fb-chat-monitor-log-WARN {\n          color: #ff9800;\n        }\n\n        .fb-chat-monitor-log-time {\n          color: #666;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-history-container {\n          width: 100%;\n          border-collapse: collapse;\n          margin-top: 10px;\n          font-size: 13px;\n        }\n\n        .fb-chat-monitor-history-container th {\n          background-color: #f5f5f5;\n          text-align: left;\n          padding: 8px;\n          border-bottom: 2px solid #ddd;\n        }\n\n        .fb-chat-monitor-history-container td {\n          padding: 8px;\n          border-bottom: 1px solid #eee;\n        }\n\n        .fb-chat-monitor-history-container tr:hover {\n          background-color: #f9f9f9;\n          cursor: pointer;\n        }\n\n        .fb-chat-monitor-badge {\n          display: inline-block;\n          padding: 3px 6px;\n          border-radius: 10px;\n          font-size: 11px;\n          color: white;\n          margin-right: 5px;\n        }\n\n        .fb-chat-monitor-badge-auto {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-manual {\n          background-color: #2196F3;\n        }\n\n        .fb-chat-monitor-badge-generate {\n          background-color: #ff9800;\n        }\n\n        .fb-chat-monitor-badge-sent {\n          background-color: #4CAF50;\n        }\n\n        .fb-chat-monitor-badge-notsent {\n          background-color: #f44336;\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        /* Tooltip styles */\n        .fb-chat-monitor-tooltip {\n          position: relative;\n          display: inline-block;\n        }\n\n        .fb-chat-monitor-tooltip .fb-chat-monitor-tooltiptext {\n          visibility: hidden;\n          width: 200px;\n          background-color: rgba(0, 0, 0, 0.8);\n          color: #fff;\n          text-align: center;\n          border-radius: 6px;\n          padding: 5px;\n          position: absolute;\n          z-index: 1;\n          bottom: 125%;\n          left: 50%;\n          transform: translateX(-50%);\n          opacity: 0;\n          transition: opacity 0.3s;\n          font-size: 12px;\n        }\n\n        .fb-chat-monitor-tooltip:hover .fb-chat-monitor-tooltiptext {\n          visibility: visible;\n          opacity: 1;\n        }\n      ";t.injectStyles(e)}();const o=n.get("UI_STATE",{});o.activeTab&&(k.activeTab=o.activeTab),e.debug("UI initialized"),k.floatingResponseButton=function(){const e=document.createElement("button");return e.id="fbChatMonitorQuickResponse",e.classList.add("fb-chat-monitor-floating-button"),e.textContent="✨ Generate Response",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="9998",e.style.padding="8px 12px",e.style.backgroundColor="#1877f2",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.fontSize="13px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",e.style.display="none",e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="#166fe5"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="#1877f2"})),e.addEventListener("click",(e=>{e.stopPropagation(),window.chatManager&&"function"==typeof window.chatManager.generateResponseForCurrentChat?window.chatManager.generateResponseForCurrentChat():(console.error("chatManager not available or generateResponseForCurrentChat method not found"),s("Error: Could not generate response. Try opening the full panel.","error"))})),e}(),document.body.appendChild(k.floatingResponseButton),setInterval(q,2e3)}function $(){if(k.controlPanel)return k.controlPanel.remove(),k.controlPanel=null,k.isControlPanelVisible=!1,k.isControlPanelMinimized=!1,void q();k.controlPanel=function(){const t=document.createElement("div");t.id="fbChatMonitorPanel",t.className="fb-chat-monitor-panel";const o=document.getElementById("fbChatMonitorButton");if(t.style.position="fixed",t.style.width="390px",t.style.padding="10px",t.style.backgroundColor="#fff",t.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",t.style.borderRadius="8px",t.style.zIndex="9999",t.style.display="block",o){const e=o.getBoundingClientRect();t.style.top=`${e.bottom+5}px`,t.style.right=window.innerWidth-e.right+"px"}else t.style.top="60px",t.style.right="20px";t.style.height="500px",t.style.overflowY="auto";const a=document.createElement("div");a.className="fb-chat-monitor-panel-header";const i=document.createElement("h2");i.textContent=`FB Chat Monitor v${CONFIG.version||"1.0"}`;const r=document.createElement("button");r.className="fb-chat-monitor-close",r.innerHTML="&times;",r.addEventListener("click",$),a.appendChild(i),a.appendChild(r),t.appendChild(a);const l=document.createElement("div");l.className="fb-chat-monitor-panel-tabs";[{id:"dashboard",label:"Dashboard"},{id:"assistants",label:"Assistants"},{id:"config",label:"Settings"},{id:"logs",label:"Logs"},{id:"history",label:"History"}].forEach((e=>{const t=document.createElement("div");t.className="fb-chat-monitor-tab "+(k.activeTab===e.id?"active":""),t.setAttribute("data-tab",e.id),t.textContent=e.label,t.addEventListener("click",(()=>{document.querySelectorAll(".fb-chat-monitor-tab").forEach((e=>{e.classList.remove("active")})),t.classList.add("active"),N(e.id),k.activeTab=e.id,n.set("UI_STATE",{activeTab:e.id})})),l.appendChild(t)})),t.appendChild(l);const c=document.createElement("div");c.className="fb-chat-monitor-panel-content";const d=document.createElement("div");d.className="fb-chat-monitor-tab-content",d.id="fb-chat-monitor-tab-dashboard",d.innerHTML='\n        <div class="fb-chat-monitor-form-group"\n             style="display:flex; justify-content:center; align-items:center; gap:8px; text-align:center;">\n          <label for="fb-chat-monitor-mode-toggle" style="margin:0;">\n            Auto Mode (Automatically send responses)\n          </label>\n          <select id="fb-chat-monitor-mode-toggle"\n                  style="width:auto; padding:4px 8px; text-align:center;\n                         background-color:#dc3545; color:white; border:none; border-radius:4px;">\n            <option value="on">ON</option>\n            <option value="off" selected>OFF</option>\n          </select>\n        </div>\n\n        <div class="fb-chat-monitor-stats-grid">\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-processed" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Chats Processed</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-responses" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Responses Sent</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-uptime" class="fb-chat-monitor-stat-value">0m</div>\n            <div class="fb-chat-monitor-stat-label">Uptime</div>\n          </div>\n          <div class="fb-chat-monitor-stat-item">\n            <div id="fb-chat-monitor-stat-errors" class="fb-chat-monitor-stat-value">0</div>\n            <div class="fb-chat-monitor-stat-label">Errors</div>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group" style="text-align:center;">\n          <button\n            id="fb-chat-monitor-generate-response"\n            class="fb-chat-monitor-button"\n            disabled\n          >\n            Generate Response\n          </button>\n        </div>\n      ',c.appendChild(d);const u=document.createElement("div");u.className="fb-chat-monitor-tab-content",u.id="fb-chat-monitor-tab-assistants",u.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <label for="fb-chat-monitor-openai-key">OpenAI API Key</label>\n          <input type="password" id="fb-chat-monitor-openai-key" placeholder="sk-..." value="${CONFIG.AI.apiKey||""}">\n          <button id="fb-chat-monitor-save-api-key" class="fb-chat-monitor-button" style="margin-top: 8px;">Save API Key</button>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Seller Assistant</h4>\n          <div id="fb-chat-monitor-seller-assistant-container">\n            <label for="fb-chat-monitor-seller-assistant">Select Seller Assistant</label>\n            <select id="fb-chat-monitor-seller-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're selling an item</small>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Buyer Assistant</h4>\n          <div id="fb-chat-monitor-buyer-assistant-container">\n            <label for="fb-chat-monitor-buyer-assistant">Select Buyer Assistant</label>\n            <select id="fb-chat-monitor-buyer-assistant">\n              <option value="">Loading assistants...</option>\n            </select>\n            <small style="display:block; margin-top:5px; color:#666;">Used when you're buying an item</small>\n          </div>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-refresh-assistants" class="fb-chat-monitor-button">Refresh Assistants</button>\n        </div>\n      `,c.appendChild(u);const g=document.createElement("div");g.className="fb-chat-monitor-tab-content",g.id="fb-chat-monitor-tab-config",g.innerHTML=`\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 0; margin-bottom: 10px;">Monitoring Settings</h4>\n\n          <label for="fb-chat-monitor-scan-interval">Scan interval (seconds)</label>\n          <input type="number" id="fb-chat-monitor-scan-interval" min="5" max="300" value="${Math.floor((CONFIG.scanInterval||3e4)/1e3)}">\n          <small style="display:block; margin-top:5px; color:#666;">How often to check for new messages</small>\n        </div>\n\n        <div class="fb-chat-monitor-form-group">\n          <h4 style="margin-top: 20px; margin-bottom: 10px;">Human Simulation</h4>\n\n          <label for="fb-chat-monitor-typing-speed">Typing speed (characters per second)</label>\n          <input type="number" id="fb-chat-monitor-typing-speed" min="1" max="20" value="${CONFIG.AI?.humanSimulation?.baseTypingSpeed||5}">\n          <small style="display:block; margin-top:5px; color:#666;">Higher values = faster typing</small>\n        </div>\n\n        <div>\n          <button id="fb-chat-monitor-save-config" class="fb-chat-monitor-button">Save Settings</button>\n          <button id="fb-chat-monitor-reset-config" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Reset to Defaults</button>\n        </div>\n      `,c.appendChild(g);const m=document.createElement("div");m.className="fb-chat-monitor-tab-content",m.id="fb-chat-monitor-tab-logs",m.innerHTML='\n        <div class="fb-chat-monitor-form-group" style="display:flex; justify-content:space-between; align-items:center;">\n          <div>\n            <label for="fb-chat-monitor-log-level">Log Level</label>\n            <select id="fb-chat-monitor-log-level">\n              <option value="all">All Logs</option>\n              <option value="error">Errors Only</option>\n              <option value="warn">Warnings & Errors</option>\n              <option value="info">Info & Above</option>\n            </select>\n          </div>\n          <div>\n            <button id="fb-chat-monitor-refresh-logs" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-logs" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear Logs</button>\n          </div>\n        </div>\n\n        <div class="fb-chat-monitor-logs-container" id="fb-chat-monitor-logs-list">\n          <div class="fb-chat-monitor-log-entry">\n            <span class="fb-chat-monitor-log-time">Loading logs...</span>\n          </div>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-logs" class="fb-chat-monitor-button">Export Logs</button>\n        </div>\n      ',c.appendChild(m);const p=document.createElement("div");return p.className="fb-chat-monitor-tab-content",p.id="fb-chat-monitor-tab-history",p.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">\n          <h4 style="margin: 0;">Conversation History</h4>\n          <div>\n            <button id="fb-chat-monitor-refresh-history" class="fb-chat-monitor-button fb-chat-monitor-button-secondary">Refresh</button>\n            <button id="fb-chat-monitor-clear-history" class="fb-chat-monitor-button fb-chat-monitor-button-danger">Clear</button>\n          </div>\n        </div>\n\n        <div id="fb-chat-monitor-history-container" style="max-height: 300px; overflow-y: auto;">\n          <table class="fb-chat-monitor-history-container">\n            <thead>\n              <tr>\n                <th>Time</th>\n                <th>Mode</th>\n                <th>Content</th>\n                <th>Status</th>\n              </tr>\n            </thead>\n            <tbody id="fb-chat-monitor-history-list">\n              <tr>\n                <td colspan="4" style="text-align: center;">Loading history...</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n\n        <div style="margin-top: 15px;">\n          <button id="fb-chat-monitor-export-history" class="fb-chat-monitor-button">Export History</button>\n        </div>\n      ',c.appendChild(p),t.appendChild(c),document.body.appendChild(t),function(){const t=[{value:"on",text:"ON",color:"#28a745"},{value:"off",text:"OFF",color:"#dc3545"}],n=document.getElementById("fb-chat-monitor-mode-toggle").parentNode,o="auto"===CONFIG.operationMode?"on":"off",a=document.createElement("div");a.className="fb-chat-monitor-custom-dropdown",a.style.position="relative",a.style.display="inline-block",a.style.minWidth="60px";const i=document.createElement("div");i.className="fb-chat-monitor-dropdown-button",i.setAttribute("tabindex","0"),i.style.padding="4px 8px",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.userSelect="none",i.style.textAlign="center",i.style.fontWeight="bold",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.gap="6px",i.style.transition="background-color 0.2s ease-in-out",i.title="Click to toggle Auto Mode";const r=document.createElement("span");r.innerHTML="▼",r.style.fontSize="10px",r.style.marginLeft="2px",r.style.position="relative",r.style.top="1px";const l=document.createElement("div");l.className="fb-chat-monitor-dropdown-content",l.style.display="none",l.style.position="absolute",l.style.zIndex="10000",l.style.left="0",l.style.right="0",l.style.marginTop="2px",l.style.borderRadius="4px",l.style.overflow="hidden",l.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",a.appendChild(i),a.appendChild(l);const c=document.getElementById("fb-chat-monitor-mode-toggle");function d(e){const n=t.find((t=>t.value===e));if(!n)return;i.innerHTML="";const o=document.createElement("span");o.textContent=n.text,i.appendChild(o),i.appendChild(r.cloneNode(!0)),i.style.backgroundColor=n.color,i.style.color="white",i.onmouseover=function(){this.style.backgroundColor=u(n.color,-15)},i.onmouseout=function(){this.style.backgroundColor=n.color},i.dataset.value=e,g()}function u(e,t){let n=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),a=parseInt(e.substring(5,7),16);return n=Math.max(0,Math.min(255,n+t)),o=Math.max(0,Math.min(255,o+t)),a=Math.max(0,Math.min(255,a+t)),"#"+((1<<24)+(n<<16)+(o<<8)+a).toString(16).slice(1)}function g(){l.innerHTML="";const e=i.dataset.value,n=t.find((t=>t.value!==e));if(!n)return;const o=document.createElement("div");o.className="fb-chat-monitor-dropdown-item",o.textContent=n.text,o.dataset.value=n.value,o.style.padding="4px 8px",o.style.cursor="pointer",o.style.backgroundColor=n.color,o.style.color="white",o.style.textAlign="center",o.style.fontWeight="bold",o.style.transition="background-color 0.2s ease-in-out",o.onmouseover=function(){this.style.backgroundColor=u(n.color,-15)},o.onmouseout=function(){this.style.backgroundColor=n.color},o.addEventListener("click",(function(e){e.stopPropagation(),l.style.display="none";const t=this.dataset.value;d(t),m(t)})),l.appendChild(o)}function m(t){const n=document.getElementById("fb-chat-monitor-generate-response");"on"===t?(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("auto"),window.FBChatMonitor.toggleMonitoring(!0)):e.error("FBChatMonitor no disponible"),n&&n.setAttribute("disabled","")):(window.FBChatMonitor?(window.FBChatMonitor.changeOperationMode("manual"),window.FBChatMonitor.toggleMonitoring(!1)):e.error("FBChatMonitor no disponible"),n&&n.removeAttribute("disabled"))}n.replaceChild(a,c),i.addEventListener("click",(function(e){e.stopPropagation();const t="block"===l.style.display;l.style.display=t?"none":"block",t||g()})),document.addEventListener("click",(function(){l.style.display="none"})),d(o),m(o),document.getElementById("fb-chat-monitor-generate-response").addEventListener("click",(async()=>{try{await x.generateResponseForCurrentChat()||e.debug("Failed to generate response via UI button")}catch(e){s(`Error generating response: ${e.message}`,"error")}})),document.getElementById("fb-chat-monitor-save-api-key").addEventListener("click",(async()=>{const e=document.getElementById("fb-chat-monitor-openai-key").value.trim();if(e)try{const t=document.getElementById("fb-chat-monitor-save-api-key");t.textContent="Validating...",t.disabled=!0;await S.setApiKey(e)?(s("API Key validated and saved successfully","success"),F()):s("Invalid API Key","error")}catch(e){s(`Error: ${e.message}`,"error")}finally{const e=document.getElementById("fb-chat-monitor-save-api-key");e.textContent="Save API Key",e.disabled=!1}else s("Please enter a valid API Key","error")})),document.getElementById("fb-chat-monitor-refresh-assistants").addEventListener("click",F),document.getElementById("fb-chat-monitor-save-config").addEventListener("click",L),document.getElementById("fb-chat-monitor-reset-config").addEventListener("click",P),document.getElementById("fb-chat-monitor-refresh-logs").addEventListener("click",B),document.getElementById("fb-chat-monitor-clear-logs").addEventListener("click",D),document.getElementById("fb-chat-monitor-export-logs").addEventListener("click",U),document.getElementById("fb-chat-monitor-log-level").addEventListener("change",B),document.getElementById("fb-chat-monitor-refresh-history").addEventListener("click",H),document.getElementById("fb-chat-monitor-clear-history").addEventListener("click",z),document.getElementById("fb-chat-monitor-export-history").addEventListener("click",K)}(),t}(),k.isControlPanelVisible=!0,k.floatingResponseButton&&(k.floatingResponseButton.style.display="none"),document.body.appendChild(k.controlPanel);const t=k.controlPanel.getBoundingClientRect();t.bottom>window.innerHeight&&(k.controlPanel.style.top=window.innerHeight-t.height-10+"px"),t.right>window.innerWidth&&(k.controlPanel.style.right="10px"),R();const o=setInterval((()=>{k.isControlPanelVisible?R():clearInterval(o)}),3e3);N(k.activeTab)}function N(e){document.querySelectorAll(".fb-chat-monitor-tab-content").forEach((e=>{e.classList.remove("active")}));const t=document.getElementById(`fb-chat-monitor-tab-${e}`);t&&(t.classList.add("active"),"logs"===e?B():"history"===e&&H())}function R(){try{const e=window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.getMonitoringStats?window.FBChatMonitor.getMonitoringStats():{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1,nextScanIn:null};document.getElementById("fb-chat-monitor-stat-processed").textContent=e.chatsProcessed||0,document.getElementById("fb-chat-monitor-stat-responses").textContent=e.responsesSent||0,document.getElementById("fb-chat-monitor-stat-errors").textContent=e.errors||0;let t="Inactive";if(e.uptime>0){const n=Math.floor(e.uptime/1e3/60),o=Math.floor(n/60);t=o>0?`${o}h ${n%60}m`:`${n}m`}document.getElementById("fb-chat-monitor-stat-uptime").textContent=t,k.statusIndicator&&(k.statusIndicator.style.backgroundColor=e.isMonitoring?"#4CAF50":"#f44336")}catch(t){e.error("Error updating stats",{},t)}}async function F(){try{const e=document.getElementById("fb-chat-monitor-seller-assistant"),t=document.getElementById("fb-chat-monitor-buyer-assistant");e&&(e.innerHTML='<option value="">Loading assistants...</option>'),t&&(t.innerHTML='<option value="">Loading assistants...</option>');const n=await S.listAssistants();if(!n||0===n.length)return e&&(e.innerHTML='<option value="">No assistants found</option>'),void(t&&(t.innerHTML='<option value="">No assistants found</option>'));const o=(e,t)=>{e&&(e.innerHTML='<option value="">Select an assistant</option>',n.forEach((n=>{const o=document.createElement("option");o.value=n.id,o.textContent=n.name,n.id===t&&(o.selected=!0),e.appendChild(o)})),e.addEventListener("change",(function(){const e="fb-chat-monitor-seller-assistant"===this.id?"seller":"buyer";S.setAssistantForRole(e,this.value),s(`${e.charAt(0).toUpperCase()+e.slice(1)} assistant updated`,"success")})))};o(e,CONFIG.AI?.assistants?.seller?.id),o(t,CONFIG.AI?.assistants?.buyer?.id)}catch(t){e.error("Error refreshing assistants",{},t),s(`Error loading assistants: ${t.message}`,"error");const n=document.getElementById("fb-chat-monitor-seller-assistant"),o=document.getElementById("fb-chat-monitor-buyer-assistant");n&&(n.innerHTML='<option value="">Error loading assistants</option>'),o&&(o.innerHTML='<option value="">Error loading assistants</option>')}}function L(){if("function"==typeof GM_setValue)try{GM_setValue("CONFIG_operationMode",window.CONFIG.operationMode||"manual"),GM_setValue("CONFIG_autoSendMessages",window.CONFIG.autoSendMessages||!1),window.CONFIG.AI&&window.CONFIG.AI.apiKey&&GM_setValue("CONFIG_AI_apiKey",window.CONFIG.AI.apiKey),e.log("Configuration saved to persistent storage")}catch(t){e.error(`Error saving configuration: ${t.message}`)}else e.warn("GM_setValue not available. Cannot save persistent configuration.")}function P(){confirm("Are you sure you want to reset all settings to default values?")&&(n.remove("CONFIG"),s("Settings reset to defaults. Reloading...","info"),setTimeout((()=>window.location.reload()),2e3))}function B(){try{const t=document.getElementById("fb-chat-monitor-logs-list"),n=document.getElementById("fb-chat-monitor-log-level").value,o=e.getAllLogs();if(0===o.length)return void(t.innerHTML='<div class="fb-chat-monitor-log-entry">No logs recorded</div>');let a=o;"error"===n?a=o.filter((e=>"ERROR"===e.type)):"warn"===n?a=o.filter((e=>"ERROR"===e.type||"WARN"===e.type)):"info"===n&&(a=o.filter((e=>"ERROR"===e.type||"WARN"===e.type||"INFO"===e.type))),t.innerHTML="",a.slice(0,100).forEach((e=>{const n=document.createElement("div");n.className=`fb-chat-monitor-log-entry fb-chat-monitor-log-${e.type}`;const o=`${new Date(e.timestamp).toLocaleTimeString()}`;n.innerHTML=`\n            <span class="fb-chat-monitor-log-time">${o}</span>\n            <span class="fb-chat-monitor-log-message">${e.message}</span>\n          `,t.appendChild(n)})),t.scrollTop=t.scrollHeight}catch(e){console.error("Error refreshing logs",e)}}function D(){confirm("Are you sure you want to clear all logs?")&&(e.clearLogs(),B(),s("Logs cleared","success"))}function U(){try{const t=e.getAllLogs(),n={timestamp:(new Date).toISOString(),version:CONFIG.version||"1.0",logs:t},o=JSON.stringify(n,null,2),a=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(a),r=document.createElement("a");r.href=i,r.download=`fb-chat-monitor-logs-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),s("Logs exported successfully","success")}catch(t){e.error("Error exporting logs",{},t),s(`Error exporting logs: ${t.message}`,"error")}}function H(){try{const e=document.getElementById("fb-chat-monitor-history-list"),t=w();if(!t||0===t.length)return void(e.innerHTML='<tr><td colspan="4" style="text-align: center;">No conversation history</td></tr>');e.innerHTML="",t.slice(0,50).forEach((t=>{const n=document.createElement("tr");n.addEventListener("click",(()=>function(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="10000";const n=document.createElement("div");n.style.backgroundColor="white",n.style.borderRadius="8px",n.style.padding="20px",n.style.width="600px",n.style.maxWidth="90%",n.style.maxHeight="80%",n.style.overflowY="auto",n.style.position="relative";const o=document.createElement("button");o.innerHTML="&times;",o.style.position="absolute",o.style.top="10px",o.style.right="10px",o.style.background="none",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.addEventListener("click",(()=>document.body.removeChild(t))),n.appendChild(o);const a=document.createElement("h2");a.textContent="Conversation Details",a.style.marginTop="0",a.style.marginBottom="20px",n.appendChild(a);const r=document.createElement("div"),s=new Date(e.timestamp);if(r.innerHTML=`\n        <p><strong>Time:</strong> ${i.formatDate(s)}</p>\n        <p><strong>Mode:</strong> ${e.mode}</p>\n        <p><strong>Status:</strong> ${e.sent?"Sent":"Not sent"}</p>\n      `,e.context){const t=document.createElement("div");if(t.style.marginTop="15px",t.style.marginBottom="15px",t.innerHTML='<h3 style="margin-top:0;">Context</h3>',e.context.role&&(t.innerHTML+=`<p><strong>Role:</strong> ${e.context.role}</p>`),e.context.productDetails){const n=e.context.productDetails;t.innerHTML+=`\n            <div style="margin-top: 10px; margin-bottom: 15px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Product Details</h4>\n              <p style="margin: 2px 0;"><strong>Title:</strong> ${n.title||"N/A"}</p>\n              <p style="margin: 2px 0;"><strong>Price:</strong> ${n.price||"N/A"}</p>\n              ${n.id?`<p style="margin: 2px 0;"><strong>ID:</strong> ${n.id}</p>`:""}\n            </div>\n          `}e.context.lastMessage&&(t.innerHTML+=`\n            <div style="margin-top: 10px;">\n              <h4 style="margin-top: 0; margin-bottom: 5px;">Last Message</h4>\n              <div style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${e.context.lastMessage}</div>\n            </div>\n          `),r.appendChild(t)}if(e.response){const t=document.createElement("div");t.style.marginTop="15px",t.innerHTML=`\n          <h3 style="margin-top: 0;">Response</h3>\n          <div style="background-color: #e9f5ff; padding: 10px; border-radius: 4px; white-space: pre-wrap; margin-bottom: 15px; border: 1px solid #2196F3;">${e.response}</div>\n          <button id="copy-response-btn" style="padding: 5px 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Copy Response</button>\n        `,r.appendChild(t)}n.appendChild(r),t.appendChild(n),document.body.appendChild(t);const l=document.getElementById("copy-response-btn");l&&e.response&&l.addEventListener("click",(()=>{navigator.clipboard.writeText(e.response),l.textContent="Copied!",setTimeout((()=>l.textContent="Copy Response"),2e3)}))}(t)));const o=document.createElement("td"),a=new Date(t.timestamp);o.textContent=i.formatDate(a).split(",")[1].trim();const r=document.createElement("td"),s=document.createElement("span");s.textContent=t.mode,s.className=`fb-chat-monitor-badge fb-chat-monitor-badge-${t.mode}`,r.appendChild(s);const l=document.createElement("td"),c=t.context?.lastMessage||"No content";l.textContent="string"==typeof c?c.substring(0,30)+(c.length>30?"...":""):"Complex content";const d=document.createElement("td"),u=document.createElement("span");u.textContent=t.sent?"Sent":"Not sent",u.className="fb-chat-monitor-badge fb-chat-monitor-badge-"+(t.sent?"sent":"notsent"),d.appendChild(u),n.appendChild(o),n.appendChild(r),n.appendChild(l),n.appendChild(d),e.appendChild(n)}))}catch(t){e.error("Error refreshing history",{},t);document.getElementById("fb-chat-monitor-history-list").innerHTML='<tr><td colspan="4" style="text-align: center;">Error loading history</td></tr>'}}function z(){confirm("Are you sure you want to clear all conversation history?")&&(n.remove("RESPONSE_LOGS"),H(),s("Conversation history cleared","success"))}function K(){try{const e=w(),t={timestamp:(new Date).toISOString(),version:CONFIG.version||"1.0",conversations:e},n=JSON.stringify(t,null,2),o=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download=`fb-chat-monitor-history-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),s("History exported successfully","success")}catch(t){e.error("Error exporting history",{},t),s(`Error exporting history: ${t.message}`,"error")}}function w(){return n.get("RESPONSE_LOGS",[])}function G(t){try{const n=document.getElementById("fb-chat-auto-btn"),o=document.getElementById("fb-chat-manual-btn");return n&&o?(n.classList.remove("active","inactive"),o.classList.remove("active","inactive"),"auto"===t?(n.classList.add("active"),o.classList.add("inactive"),e.debug("UI updated: AUTO mode activated")):(n.classList.add("inactive"),o.classList.add("active"),e.debug("UI updated: MANUAL mode activated")),document.dispatchEvent(new CustomEvent("configUpdated",{detail:{operationMode:t}})),!0):(e.debug("Mode buttons not found to update UI"),!1)}catch(t){return e.error(`Error updating mode UI: ${t.message}`),!1}}function q(){if(!k.floatingResponseButton)return;if(window.CONFIG&&"manual"===window.CONFIG.operationMode&&!k.isControlPanelVisible&&window.chatManager&&window.chatManager.currentChatId){const e=document.querySelector(CONFIG.selectors.activeChat.messageInput),n=t.findElement(CONFIG.selectors.activeChat.sendButton);if(e||n){const t=(e||n).getBoundingClientRect();k.floatingResponseButton.style.bottom=window.innerHeight-t.top+10+"px",k.floatingResponseButton.style.right="20px"}k.floatingResponseButton.style.display="block"}else k.floatingResponseButton.style.display="none"}function s(e,t="info",n=3e3){const o=document.createElement("div");o.className="fb-chat-monitor-alert";const a=function(){const e=document.getElementById("fbChatMonitorPanel"),t=document.getElementById("fbChatMonitorButton"),n={top:"60px",right:"20px",left:"auto"};if(e&&k.isControlPanelVisible){const t=e.getBoundingClientRect();return{top:`${t.bottom+10}px`,right:window.innerWidth-t.right+"px",left:"auto"}}if(t){const e=t.getBoundingClientRect();return{top:`${e.bottom+10}px`,right:window.innerWidth-e.right+"px",left:"auto"}}return n}();switch(o.style.position="fixed",o.style.zIndex="10000",o.style.padding="10px 15px",o.style.borderRadius="6px",o.style.boxShadow="0 3px 10px rgba(0,0,0,0.2)",o.style.fontSize="14px",o.style.transition="opacity 0.3s ease-in-out, transform 0.3s ease-in-out",o.style.opacity="0",o.style.transform="translateY(20px)",o.style.pointerEvents="none",o.style.left=a.left,o.style.top=a.top,o.style.right=a.right,o.style.maxWidth="300px",t){case"success":o.style.backgroundColor="#4CAF50",o.style.color="white";break;case"error":o.style.backgroundColor="#F44336",o.style.color="white";break;case"warning":o.style.backgroundColor="#FF9800",o.style.color="white";break;default:o.style.backgroundColor="#2196F3",o.style.color="white"}o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),50),setTimeout((()=>{o.style.opacity="0",o.style.transform="translateY(-20px)",setTimeout((()=>{o.parentElement&&o.parentElement.removeChild(o)}),300)}),n)}window.initializeUI=_,window.toggleControlPanel=$,window.updateMonitoringStatus=function(e){k.statusIndicator&&(k.statusIndicator.style.backgroundColor=e?"#4CAF50":"#f44336"),k.isControlPanelVisible&&R()},window.ui={updateModeUI:G,handleModeClick:function(t){try{if("auto"!==t&&"manual"!==t)return e.error(`Invalid mode: ${t}`),!1;if(!window.CONFIG.updateOperationMode(t))return e.error(`Could not update mode to ${t}`),!1;G(t);return s(`Mode ${"auto"===t?"automatic":"manual"} activated`,"success"),!0}catch(t){return e.error(`Error changing mode: ${t.message}`),!1}}};const j={isMonitoring:!1,monitorInterval:null,errorCount:0,scansSinceLastSuccess:0,startTime:null,stats:{chatsProcessed:0,messagesProcessed:0,responsesSent:0,errors:0},lastScanTime:null,baseInterval:CONFIG.scanInterval||3e4};async function V(){e.log("Initializing FB-Chat-Monitor",{version:CONFIG.version});try{const t=n.get("OPENAI_KEY",null);if(t&&(CONFIG.AI.apiKey=t,e.log("Loaded OpenAI API Key from storageUtils")),r.redirectToMarketplace())return void e.log("Redirecting to Marketplace messenger, please wait...");O.initialize(),e.debug("UI components initialized");S.initialize(CONFIG.AI.apiKey,CONFIG.AI.model)?e.log("OpenAI Manager initialized successfully"):e.warn("OpenAI Manager initialized but no valid API key is set"),function(){const t=n.get("FB_CHAT_MONITOR_OPENAI_KEY",null);if(t)CONFIG.AI.apiKey=t,e.debug("OpenAI API Key loaded from storageUtils");else{const t=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");t&&(CONFIG.AI.apiKey=t,n.set("FB_CHAT_MONITOR_OPENAI_KEY",t),e.debug("OpenAI API Key migrated from localStorage to storageUtils"))}CONFIG.operationMode=n.get("OPERATION_MODE",CONFIG.defaultOperationMode),CONFIG.AI.assistants||(CONFIG.AI.assistants={seller:{},buyer:{}});CONFIG.AI.assistants.seller.id=n.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID",""),CONFIG.AI.assistants.buyer.id=n.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID",""),e.debug("Saved settings loaded",{operationMode:CONFIG.operationMode,hasApiKey:!!CONFIG.AI.apiKey,sellerAssistant:!!CONFIG.AI.assistants.seller.id,buyerAssistant:!!CONFIG.AI.assistants.buyer.id})}(),o.onActivityChange((t=>{j.isMonitoring&&J(),e.debug("User activity changed",{isActive:t})}));return n.get("MONITORING_ACTIVE",!1)&&(e.log("Restoring previous monitoring state"),Y(!0)),s("FB-Chat-Monitor initialized successfully","success"),e.log("Initialization complete",{status:"success"}),!0}catch(t){return e.error("Error during initialization",{},t),s("Error initializing FB-Chat-Monitor: "+t.message,"error"),!1}}function J(){let t=j.baseInterval;return o.isActive||(t*=1.5),j.errorCount>0&&(t=Math.min(t*Math.pow(1.5,j.errorCount),CONFIG.maxScanInterval||3e5)),j.isMonitoring&&j.monitorInterval&&(clearTimeout(j.monitorInterval),j.monitorInterval=setTimeout(W,t),e.debug("Scan interval updated",{interval:t,userActive:o.isActive,errorCount:j.errorCount})),t}function Y(t){return j.isMonitoring=t,t?(j.startTime=Date.now(),j.monitorInterval=setTimeout(W,1e3),n.set("MONITORING_ACTIVE",!0),e.log("Chat monitoring started")):(j.monitorInterval&&(clearTimeout(j.monitorInterval),j.monitorInterval=null),n.set("MONITORING_ACTIVE",!1),e.log("Chat monitoring stopped")),t?s("Chat monitoring started","success"):s("Chat monitoring stopped","info"),t}async function W(){if(j.isMonitoring){j.lastScanTime=Date.now(),e.debug("Starting chat scan");try{if(!r.isMarketplaceMessenger())return e.warn("Not on marketplace messenger page, skipping scan"),void X();const t=await a.withExponentialBackoff((()=>x.scanForUnreadChats()),{maxRetries:2,baseDelay:1e3});if(t>0){e.log(`Found ${t} unread chats`);await x.openNextPendingChat()?(e.log("Chat opened and processed successfully"),j.stats.chatsProcessed++,j.errorCount=0,j.scansSinceLastSuccess=0):(e.error("Could not open the chat"),Q())}else e.debug("No unread chats found"),j.scansSinceLastSuccess++}catch(t){e.error("Error during chat monitoring",{errorCount:j.errorCount,scansSinceLastSuccess:j.scansSinceLastSuccess},t),Q()}X()}}function X(){if(!j.isMonitoring)return;j.monitorInterval&&clearTimeout(j.monitorInterval);const t=J();j.monitorInterval=setTimeout(W,t),e.debug(`Next scan scheduled in ${t}ms`)}function Q(){j.errorCount++,j.stats.errors++,j.scansSinceLastSuccess++,j.scansSinceLastSuccess>=CONFIG.maxConsecutiveFailures&&(e.warn(`Too many consecutive failures (${j.scansSinceLastSuccess}), pausing monitoring`),s("Monitoring paused due to consecutive failures. Check console for details.","warning",{buttons:[{text:"Resume",action:()=>{j.errorCount=0,j.scansSinceLastSuccess=0,X()}}]}),j.errorCount=Math.min(j.errorCount,5))}function Z(){const e=Date.now();return{...j.stats,isMonitoring:j.isMonitoring,uptime:j.startTime?e-j.startTime:0,lastScan:j.lastScanTime?e-j.lastScanTime:null,nextScanIn:j.monitorInterval?j.lastScanTime+J()-e:null,errorRate:j.stats.chatsProcessed>0?(j.stats.errors/j.stats.chatsProcessed).toFixed(2):0}}function V(){if(window.initializationInProgress)return;window.initializationInProgress=!0,e.log("Initializing FB Chat Monitor"),_();const t=localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY");if(t&&(CONFIG.AI.apiKey=t,CONFIG.AI.enabled=!0,e.log("API Key loaded from localStorage in init")),CONFIG.operationMode=localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||CONFIG.defaultOperationMode,CONFIG.AI.apiKey)if(CONFIG.AI.enabled=!0,e.log("API key loaded from localStorage"),window.openAIManager){const t=S.initialize(CONFIG.AI.apiKey,CONFIG.AI.model);e.log(`OpenAI Manager auto-initialized: ${t}`)}else e.error("openAIManager not available for auto-initialization.");window.openaiManager?e.log("OpenAI Manager is available to generate responses"):e.warn("OpenAI Manager is not available. Some functions may not be operational."),window.assistantManager&&e.log("Assistant Manager is available to generate responses");try{window.location.href.includes("/marketplace/")?(e.log("We are in Marketplace, starting monitoring..."),setTimeout((()=>{window.FBChatMonitor&&"function"==typeof window.FBChatMonitor.manualScan?window.FBChatMonitor.manualScan():e.warn("FBChatMonitor.manualScan not available yet")}),2500)):(e.log("We are not in Marketplace, trying redirection..."),window.pageUtils&&window.pageUtils.redirectToMarketplace?window.pageUtils.redirectToMarketplace():e.error("pageUtils.redirectToMarketplace not available"))}catch(t){e.error(`Error in initialization: ${t.message}`)}finally{window.initializationInProgress=!1}}window.FBChatMonitor={initialize:V,toggleMonitoring:Y,manualScan:async function(){e.log("Manual chat scan triggered");const t=j.isMonitoring;t&&clearTimeout(j.monitorInterval);try{await W()}catch(t){e.error("Error during manual scan",{},t),s("Error during manual scan: "+t.message,"error")}finally{t&&X()}},getMonitoringStats:Z,changeOperationMode:e=>("auto"!==e&&"manual"!==e&&(e="manual"),CONFIG.operationMode=e,n.set("OPERATION_MODE",e),Y("auto"===e),!0)},window.getMonitoringStats=Z,"loading"!==document.readyState?V():document.addEventListener("DOMContentLoaded",V),window.addEventListener("load",(()=>{function t(){if(e.log("Verifying OpenAI Manager consistency..."),window.openaiManager||(e.warn("OpenAI Manager is not available, creating backup instance"),window.openaiManager=new T),!window.openaiManager.isInitialized)if(CONFIG?.AI?.apiKey)e.log("Recovering OpenAI Manager state with API key from CONFIG"),window.openaiManager.initialize(CONFIG.AI.apiKey);else{const t=n.get("FB_CHAT_MONITOR_OPENAI_KEY","");t&&(e.log("Recovering OpenAI Manager state with API key from localStorage"),window.openaiManager.initialize(t))}let t=!1;"function"==typeof window.openaiManager.isReady?(t=window.openaiManager.isReady(),e.debug(`openaiManager.isReady() = ${t}`)):(t=window.openaiManager.isInitialized&&!!window.openaiManager.apiKey,e.debug(`Fallback isReady check = ${t}`)),!t&&window.openaiManager.apiKey&&(e.warn("Inconsistency detected - forcing isInitialized=true since there is API key"),window.openaiManager.isInitialized=!0,t=!0),e.log("Final state of OpenAI Manager: "+(t?"READY":"NOT AVAILABLE"))}window.storageUtils?(n.checkStorageHealth(),n.migrateSettings(),function(){try{if(!window.CONFIG||!window.CONFIG.AI)return void console.warn("CONFIG is not correctly initialized");CONFIG.AI.apiKey=n.get("FB_CHAT_MONITOR_OPENAI_KEY","")||localStorage.getItem("FB_CHAT_MONITOR_OPENAI_KEY")||"",CONFIG.AI.assistants.seller.id=n.get("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_SELLER_ASSISTANT_ID")||"",CONFIG.AI.assistants.buyer.id=n.get("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID","")||localStorage.getItem("FB_CHAT_MONITOR_BUYER_ASSISTANT_ID")||"",CONFIG.operationMode=n.get("FB_CHAT_MONITOR_OPERATION_MODE",CONFIG.defaultOperationMode)||localStorage.getItem("FB_CHAT_MONITOR_OPERATION_MODE")||CONFIG.defaultOperationMode,CONFIG.audioTranscription&&(CONFIG.audioTranscription.apiKey=CONFIG.AI.apiKey),console.log("[CONFIG] Configuration loaded:",{apiKey:CONFIG.AI.apiKey?"********":"(no key)",model:CONFIG.AI.model,assistants:{seller:CONFIG.AI.assistants.seller.id?"(configured)":"(not configured)",buyer:CONFIG.AI.assistants.buyer.id?"(configured)":"(not configured)"},mode:CONFIG.operationMode})}catch(e){console.error("[CONFIG] Error loading configuration:",e)}}()):console.error("storageUtils is not available for migration and verification"),window.FBChatMonitor||(window.FBChatMonitor={},console.error("FBChatMonitor is not available on load. An empty object has been created to prevent errors.")),window.FBChatMonitor.getMonitoringStats||(window.FBChatMonitor.getMonitoringStats=function(){return{chatsProcessed:0,responsesSent:0,errors:0,uptime:0,isMonitoring:!1}},console.warn("A temporary version of getMonitoringStats has been created")),window.FBChatMonitor.initialized||"function"!=typeof window.FBChatMonitor.initialize||(window.FBChatMonitor.initialized=!0,window.FBChatMonitor.initialize()),function(){if(e.log("Verifying availability of AI services..."),window.openaiManager){const t=window.openaiManager.isReady?window.openaiManager.isReady():window.openaiManager.isInitialized&&!!window.openaiManager.apiKey;if(e.log(`OpenAI Manager auto-initialized: ${t}`),!t&&window.storageUtils){const t=window.storageUtils.get("FB_CHAT_MONITOR_OPENAI_KEY","");t&&(window.openaiManager.setApiKey(t),e.log("OpenAI Manager re-initialized with stored API key"))}}else e.warn("OpenAI Manager is not available. Some functions will not be operational."),window.openaiManager={isInitialized:!1,generateResponse:async()=>{throw new Error("OpenAI Manager is not initialized correctly")},isReady:()=>!1},e.debug("A backup implementation of OpenAI Manager has been created");window.assistantManager&&e.log("Assistant Manager is available to generate responses")}(),t(),setInterval(t,6e4)}))}();